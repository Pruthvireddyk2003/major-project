module.exports=[21517,(a,b,c)=>{b.exports=a.x("http",()=>require("http"))},92509,(a,b,c)=>{b.exports=a.x("url",()=>require("url"))},24836,(a,b,c)=>{b.exports=a.x("https",()=>require("https"))},6461,(a,b,c)=>{b.exports=a.x("zlib",()=>require("zlib"))},1051,a=>{"use strict";let b,c=Symbol("buffer"),d=Symbol("type");class e{constructor(){this[d]="";const a=arguments[0],b=arguments[1],f=[];if(a){const b=Number(a.length);for(let d=0;d<b;d++){let b;const g=a[d];b=g instanceof Buffer?g:ArrayBuffer.isView(g)?Buffer.from(g.buffer,g.byteOffset,g.byteLength):g instanceof ArrayBuffer?Buffer.from(g):g instanceof e?g[c]:Buffer.from("string"==typeof g?g:String(g)),f.push(b)}}this[c]=Buffer.concat(f);let g=b&&void 0!==b.type&&String(b.type).toLowerCase();g&&!/[^\u0020-\u007E]/.test(g)&&(this[d]=g)}get size(){return this[c].length}get type(){return this[d]}slice(){let a,b=this.size,d=arguments[0],f=arguments[1];a=void 0===d?0:d<0?Math.max(b+d,0):Math.min(d,b);let g=Math.max((void 0===f?b:f<0?Math.max(b+f,0):Math.min(f,b))-a,0),h=this[c].slice(a,a+g),i=new e([],{type:arguments[2]});return i[c]=h,i}}function f(a,b,c){Error.call(this,a),this.message=a,this.type=b,c&&(this.code=this.errno=c.code),Error.captureStackTrace(this,this.constructor)}Object.defineProperties(e.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}}),Object.defineProperty(e.prototype,Symbol.toStringTag,{value:"Blob",writable:!1,enumerable:!1,configurable:!0}),f.prototype=Object.create(Error.prototype),f.prototype.constructor=f,f.prototype.name="FetchError";let g=a.r(88947),h=a.r(88947).PassThrough;try{b=(()=>{let a=Error("Cannot find module 'encoding'");throw a.code="MODULE_NOT_FOUND",a})().convert}catch(a){}let i=Symbol("Body internals");function j(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},d=c.size,h=c.timeout;null==a?a=null:"string"==typeof a||l(a)||a instanceof e||Buffer.isBuffer(a)||"[object ArrayBuffer]"===Object.prototype.toString.call(a)||a instanceof g||(a=String(a)),this[i]={body:a,disturbed:!1,error:null},this.size=void 0===d?0:d,this.timeout=void 0===h?0:h,a instanceof g&&a.on("error",function(a){b[i].error=new f(`Invalid response body while trying to fetch ${b.url}: ${a.message}`,"system",a)})}function k(){var a=this;if(this[i].disturbed)return j.Promise.reject(TypeError(`body used already for: ${this.url}`));if(this[i].disturbed=!0,this[i].error)return j.Promise.reject(this[i].error);if(null===this.body)return j.Promise.resolve(Buffer.alloc(0));if("string"==typeof this.body)return j.Promise.resolve(Buffer.from(this.body));if(this.body instanceof e)return j.Promise.resolve(this.body[c]);if(Buffer.isBuffer(this.body))return j.Promise.resolve(this.body);if("[object ArrayBuffer]"===Object.prototype.toString.call(this.body))return j.Promise.resolve(Buffer.from(this.body));if(!(this.body instanceof g))return j.Promise.resolve(Buffer.alloc(0));let b=[],d=0,h=!1;return new j.Promise(function(c,e){let g;a.timeout&&(g=setTimeout(function(){h=!0,e(new f(`Response timeout while trying to fetch ${a.url} (over ${a.timeout}ms)`,"body-timeout"))},a.timeout)),a.body.on("error",function(b){e(new f(`Invalid response body while trying to fetch ${a.url}: ${b.message}`,"system",b))}),a.body.on("data",function(c){if(!h&&null!==c){if(a.size&&d+c.length>a.size){h=!0,e(new f(`content size at ${a.url} over limit: ${a.size}`,"max-size"));return}d+=c.length,b.push(c)}}),a.body.on("end",function(){if(!h){clearTimeout(g);try{c(Buffer.concat(b))}catch(b){e(new f(`Could not create Buffer from response body for ${a.url}: ${b.message}`,"system",b))}}})})}function l(a){return"object"==typeof a&&"function"==typeof a.append&&"function"==typeof a.delete&&"function"==typeof a.get&&"function"==typeof a.getAll&&"function"==typeof a.has&&"function"==typeof a.set&&("URLSearchParams"===a.constructor.name||"[object URLSearchParams]"===Object.prototype.toString.call(a)||"function"==typeof a.sort)}function m(a){let b,c,d=a.body;if(a.bodyUsed)throw Error("cannot clone body after it is used");return d instanceof g&&"function"!=typeof d.getBoundary&&(b=new h,c=new h,d.pipe(b),d.pipe(c),a[i].body=b,d=c),d}function n(a){let b=a.body;if(null===b)return 0;if("string"==typeof b)return Buffer.byteLength(b);if(l(b))return Buffer.byteLength(String(b));if(b instanceof e)return b.size;if(Buffer.isBuffer(b))return b.length;else if("[object ArrayBuffer]"===Object.prototype.toString.call(b))return b.byteLength;else if(!b||"function"!=typeof b.getLengthSync)return null;else return b._lengthRetrievers&&0==b._lengthRetrievers.length||b.hasKnownLength&&b.hasKnownLength()?b.getLengthSync():null}j.prototype={get body(){return this[i].body},get bodyUsed(){return this[i].disturbed},arrayBuffer(){return k.call(this).then(function(a){return a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength)})},blob(){let a=this.headers&&this.headers.get("content-type")||"";return k.call(this).then(function(b){return Object.assign(new e([],{type:a.toLowerCase()}),{[c]:b})})},json(){var a=this;return k.call(this).then(function(b){try{return JSON.parse(b.toString())}catch(b){return j.Promise.reject(new f(`invalid json response body at ${a.url} reason: ${b.message}`,"invalid-json"))}})},text(){return k.call(this).then(function(a){return a.toString()})},buffer(){return k.call(this)},textConverted(){var a=this;return k.call(this).then(function(c){return function(a,c){let d,e;if("function"!=typeof b)throw Error("The package `encoding` must be installed to use the textConverted() function");let f=c.get("content-type"),g="utf-8";return f&&(d=/charset=([^;]*)/i.exec(f)),e=a.slice(0,1024).toString(),!d&&e&&(d=/<meta.+?charset=(['"])(.+?)\1/i.exec(e)),!d&&e&&(d=/<meta[\s]+?http-equiv=(['"])content-type\1[\s]+?content=(['"])(.+?)\2/i.exec(e))&&(d=/charset=(.*)/i.exec(d.pop())),!d&&e&&(d=/<\?xml.+?encoding=(['"])(.+?)\1/i.exec(e)),d&&("gb2312"===(g=d.pop())||"gbk"===g)&&(g="gb18030"),b(a,"UTF-8",g).toString()}(c,a.headers)})}},Object.defineProperties(j.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0}}),j.mixIn=function(a){for(let b of Object.getOwnPropertyNames(j.prototype))if(!(b in a)){let c=Object.getOwnPropertyDescriptor(j.prototype,b);Object.defineProperty(a,b,c)}},j.Promise=a.g.Promise;let o=/[^\^_`a-zA-Z\-0-9!#$%&'*+.|~]/,p=/[^\t\x20-\x7e\x80-\xff]/;function q(a){if(a=`${a}`,o.test(a))throw TypeError(`${a} is not a legal HTTP header name`)}function r(a){if(a=`${a}`,p.test(a))throw TypeError(`${a} is not a legal HTTP header value`)}function s(a,b){for(let c in b=b.toLowerCase(),a)if(c.toLowerCase()===b)return c}let t=Symbol("map");class u{constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;if(this[t]=Object.create(null),a instanceof u){const b=a.raw();for(const a of Object.keys(b))for(const c of b[a])this.append(a,c);return}if(null==a);else if("object"==typeof a){const b=a[Symbol.iterator];if(null!=b){if("function"!=typeof b)throw TypeError("Header pairs must be iterable");const c=[];for(const b of a){if("object"!=typeof b||"function"!=typeof b[Symbol.iterator])throw TypeError("Each header pair must be iterable");c.push(Array.from(b))}for(const a of c){if(2!==a.length)throw TypeError("Each header pair must be a name/value tuple");this.append(a[0],a[1])}}else for(const b of Object.keys(a)){const c=a[b];this.append(b,c)}}else throw TypeError("Provided initializer must be an object")}get(a){q(a=`${a}`);let b=s(this[t],a);return void 0===b?null:this[t][b].join(", ")}forEach(a){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,c=v(this),d=0;for(;d<c.length;){var e=c[d];let f=e[0],g=e[1];a.call(b,g,f,this),c=v(this),d++}}set(a,b){a=`${a}`,b=`${b}`,q(a),r(b);let c=s(this[t],a);this[t][void 0!==c?c:a]=[b]}append(a,b){a=`${a}`,b=`${b}`,q(a),r(b);let c=s(this[t],a);void 0!==c?this[t][c].push(b):this[t][a]=[b]}has(a){return q(a=`${a}`),void 0!==s(this[t],a)}delete(a){q(a=`${a}`);let b=s(this[t],a);void 0!==b&&delete this[t][b]}raw(){return this[t]}keys(){return x(this,"key")}values(){return x(this,"value")}[Symbol.iterator](){return x(this,"key+value")}}function v(a){let b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"key+value";return Object.keys(a[t]).sort().map("key"===b?function(a){return a.toLowerCase()}:"value"===b?function(b){return a[t][b].join(", ")}:function(b){return[b.toLowerCase(),a[t][b].join(", ")]})}u.prototype.entries=u.prototype[Symbol.iterator],Object.defineProperty(u.prototype,Symbol.toStringTag,{value:"Headers",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(u.prototype,{get:{enumerable:!0},forEach:{enumerable:!0},set:{enumerable:!0},append:{enumerable:!0},has:{enumerable:!0},delete:{enumerable:!0},keys:{enumerable:!0},values:{enumerable:!0},entries:{enumerable:!0}});let w=Symbol("internal");function x(a,b){let c=Object.create(y);return c[w]={target:a,kind:b,index:0},c}let y=Object.setPrototypeOf({next(){if(!this||Object.getPrototypeOf(this)!==y)throw TypeError("Value of `this` is not a HeadersIterator");var a=this[w];let b=a.target,c=a.kind,d=a.index,e=v(b,c);return d>=e.length?{value:void 0,done:!0}:(this[w].index=d+1,{value:e[d],done:!1})}},Object.getPrototypeOf(Object.getPrototypeOf([][Symbol.iterator]())));Object.defineProperty(y,Symbol.toStringTag,{value:"HeadersIterator",writable:!1,enumerable:!1,configurable:!0});let z=a.r(21517).STATUS_CODES,A=Symbol("Response internals");class B{constructor(){let a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};j.call(this,a,b);const c=b.status||200;this[A]={url:b.url,status:c,statusText:b.statusText||z[c],headers:new u(b.headers)}}get url(){return this[A].url}get status(){return this[A].status}get ok(){return this[A].status>=200&&this[A].status<300}get statusText(){return this[A].statusText}get headers(){return this[A].headers}clone(){return new B(m(this),{url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok})}}j.mixIn(B.prototype),Object.defineProperties(B.prototype,{url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}}),Object.defineProperty(B.prototype,Symbol.toStringTag,{value:"Response",writable:!1,enumerable:!1,configurable:!0});var C=a.r(92509);let D=C.format,E=C.parse,F=Symbol("Request internals");function G(a){return"object"==typeof a&&"object"==typeof a[F]}class H{constructor(a){let b,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};G(a)?b=E(a.url):(b=a&&a.href?E(a.href):E(`${a}`),a={});let d=c.method||a.method||"GET";if(d=d.toUpperCase(),(null!=c.body||G(a)&&null!==a.body)&&("GET"===d||"HEAD"===d))throw TypeError("Request with GET/HEAD method cannot have body");let f=null!=c.body?c.body:G(a)&&null!==a.body?m(a):null;j.call(this,f,{timeout:c.timeout||a.timeout||0,size:c.size||a.size||0});const g=new u(c.headers||a.headers||{});if(null!=c.body){const a=function(a){let b=a.body;if(null===b)return null;if("string"==typeof b)return"text/plain;charset=UTF-8";if(l(b))return"application/x-www-form-urlencoded;charset=UTF-8";if(b instanceof e)return b.type||null;if(Buffer.isBuffer(b))return null;else if("[object ArrayBuffer]"===Object.prototype.toString.call(b))return null;else if("function"==typeof b.getBoundary)return`multipart/form-data;boundary=${b.getBoundary()}`;else return null}(this);null===a||g.has("Content-Type")||g.append("Content-Type",a)}this[F]={method:d,redirect:c.redirect||a.redirect||"follow",headers:g,parsedURL:b},this.follow=void 0!==c.follow?c.follow:void 0!==a.follow?a.follow:20,this.compress=void 0!==c.compress?c.compress:void 0===a.compress||a.compress,this.counter=c.counter||a.counter||0,this.agent=c.agent||a.agent}get method(){return this[F].method}get url(){return D(this[F].parsedURL)}get headers(){return this[F].headers}get redirect(){return this[F].redirect}clone(){return new H(this)}}j.mixIn(H.prototype),Object.defineProperty(H.prototype,Symbol.toStringTag,{value:"Request",writable:!1,enumerable:!1,configurable:!0}),Object.defineProperties(H.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0}});let I=a.r(21517),J=a.r(24836),K=a.r(88947).PassThrough,L=a.r(92509).resolve,M=a.r(6461);function N(a,b){if(!N.Promise)throw Error("native promise missing, set fetch.Promise to your favorite alternative");return j.Promise=N.Promise,new N.Promise(function(d,g){let h,i,j=new H(a,b),k=function(a){let b,c,d=a[F].parsedURL,e=new u(a[F].headers);if(e.has("Accept")||e.set("Accept","*/*"),!d.protocol||!d.hostname)throw TypeError("Only absolute URLs are supported");if(!/^https?:$/.test(d.protocol))throw TypeError("Only HTTP(S) protocols are supported");let f=null;if(null==a.body&&/^(POST|PUT)$/i.test(a.method)&&(f="0"),null!=a.body){let b=n(a);"number"==typeof b&&(f=String(b))}return f&&e.set("Content-Length",f),e.has("User-Agent")||e.set("User-Agent","node-fetch/1.0 (+https://github.com/bitinn/node-fetch)"),a.compress&&e.set("Accept-Encoding","gzip,deflate"),e.has("Connection")||a.agent||e.set("Connection","close"),Object.assign({},d,{method:a.method,headers:(b=Object.assign({__proto__:null},e[t]),void 0!==(c=s(e[t],"Host"))&&(b[c]=b[c][0]),b),agent:a.agent})}(j),m=(0,("https:"===k.protocol?J:I).request)(k);function q(){m.abort(),clearTimeout(h)}j.timeout&&m.once("socket",function(a){h=setTimeout(function(){g(new f(`network timeout at: ${j.url}`,"request-timeout")),q()},j.timeout)}),m.on("error",function(a){g(new f(`request to ${j.url} failed, reason: ${a.message}`,"system",a)),q()}),m.on("response",function(a){clearTimeout(h);let b=function(a){let b=new u;for(let c of Object.keys(a))if(!o.test(c))if(Array.isArray(a[c]))for(let d of a[c])p.test(d)||(void 0===b[t][c]?b[t][c]=[d]:b[t][c].push(d));else p.test(a[c])||(b[t][c]=[a[c]]);return b}(a.headers);if(N.isRedirect(a.statusCode)){let c=b.get("Location"),e=null===c?null:L(j.url,c);switch(j.redirect){case"error":g(new f(`redirect mode is set to error: ${j.url}`,"no-redirect")),q();return;case"manual":null!==e&&b.set("Location",e);break;case"follow":if(null===e)break;if(j.counter>=j.follow){g(new f(`maximum redirect reached at: ${j.url}`,"max-redirect")),q();return}let h={headers:new u(j.headers),follow:j.follow,counter:j.counter+1,agent:j.agent,compress:j.compress,method:j.method,body:j.body};if(303!==a.statusCode&&j.body&&null===n(j)){g(new f("Cannot follow redirect with body being a readable stream","unsupported-redirect")),q();return}(303===a.statusCode||(301===a.statusCode||302===a.statusCode)&&"POST"===j.method)&&(h.method="GET",h.body=void 0,h.headers.delete("content-length")),d(N(new H(e,h))),q();return}}let c=a.pipe(new K),e={url:j.url,status:a.statusCode,statusText:a.statusMessage,headers:b,size:j.size,timeout:j.timeout},i=b.get("Content-Encoding");if(!j.compress||"HEAD"===j.method||null===i||204===a.statusCode||304===a.statusCode)return void d(new B(c,e));let k={flush:M.Z_SYNC_FLUSH,finishFlush:M.Z_SYNC_FLUSH};"gzip"==i||"x-gzip"==i?d(new B(c=c.pipe(M.createGunzip(k)),e)):"deflate"==i||"x-deflate"==i?a.pipe(new K).once("data",function(a){d(new B(c=(15&a[0])==8?c.pipe(M.createInflate()):c.pipe(M.createInflateRaw()),e))}):d(new B(c,e))}),null===(i=j.body)?m.end():"string"==typeof i?(m.write(i),m.end()):l(i)?(m.write(Buffer.from(String(i))),m.end()):i instanceof e?(m.write(i[c]),m.end()):Buffer.isBuffer(i)?(m.write(i),m.end()):"[object ArrayBuffer]"===Object.prototype.toString.call(i)?(m.write(Buffer.from(i)),m.end()):i.pipe(m)})}N.isRedirect=function(a){return 301===a||302===a||303===a||307===a||308===a},N.default=N,N.Promise=a.g.Promise,a.s(["FetchError",()=>f,"Headers",()=>u,"Request",()=>H,"Response",()=>B,"default",0,N])},22734,(a,b,c)=>{b.exports=a.x("fs",()=>require("fs"))},7910,a=>{"use strict";var b,c,d,e,f,g,h,i,j,k=a.i(87924),l=a.i(72131);function m({videoRef:a,onData:b,className:c}){return(0,l.useEffect)(()=>{if(a.current)return b(),()=>{a.current?.srcObject&&a.current.srcObject.getTracks().forEach(a=>a.stop())};async function b(){try{let b=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});a.current&&(a.current.srcObject=b)}catch(a){console.error("Error accessing webcam:",a)}}},[a]),(0,k.jsx)("div",{className:"relative w-full h-full",children:(0,k.jsx)("video",{ref:a,autoPlay:!0,muted:!0,playsInline:!0,className:`w-full h-full object-cover ${c??""}`})})}a.i(6704);var n=a.i(27045),o=a.i(97045);function p({sampleIntervalMs:a=200,analyserFftSize:b=2048,smoothingTimeConstant:c=.3,silenceDbThreshold:d=-55,silenceSeconds:e=5,varianceWindowSize:f=8,lowBandStartHz:g=50,lowBandEndHz:h=300,autoStart:i=!1}={}){let[j,k]=(0,l.useState)(0),[m,n]=(0,l.useState)(0),[o,q]=(0,l.useState)(!1),[r,s]=(0,l.useState)(null),[t,u]=(0,l.useState)(!1),v=(0,l.useRef)(null),w=(0,l.useRef)(null),x=(0,l.useRef)(null),y=(0,l.useRef)(null),z=(0,l.useRef)(null),A=(0,l.useRef)({sampleIntervalMs:a,analyserFftSize:b,smoothingTimeConstant:c,silenceDbThreshold:d,silenceSeconds:e,varianceWindowSize:f,lowBandStartHz:g,lowBandEndHz:h}),B=(0,l.useRef)(0),C=(0,l.useRef)(null),D=(0,l.useRef)([]),E=(0,l.useRef)([]),F=(0,l.useRef)([]),G=(0,l.useRef)(j),H=(0,l.useRef)(m),I=(0,l.useRef)(o);(0,l.useEffect)(()=>{A.current={sampleIntervalMs:a,analyserFftSize:b,smoothingTimeConstant:c,silenceDbThreshold:d,silenceSeconds:e,varianceWindowSize:f,lowBandStartHz:g,lowBandEndHz:h}},[a,b,c,d,e,f,g,h]);let J=(0,l.useRef)(()=>{});(0,l.useEffect)(()=>(J.current=function(){let a=w.current;if(!a){y.current=requestAnimationFrame(J.current);return}let b=performance.now();if(b-B.current<A.current.sampleIntervalMs){y.current=requestAnimationFrame(J.current);return}B.current=b;let c=new Float32Array(a.fftSize);try{a.getFloatTimeDomainData(c)}catch(a){y.current=requestAnimationFrame(J.current);return}let d=(a=>{let b=0;for(let c=0;c<a.length;c++){let d=a[c];b+=d*d}return Math.max(20*Math.log10(Math.sqrt(b/Math.max(1,a.length))||1e-12),-120)})(c),e=a.frequencyBinCount,f=new Float32Array(e);a.getFloatFrequencyData(f);let g=new Float32Array(e);for(let a=0;a<e;a++){let b=f[a];g[a]=Number.isFinite(b)?Math.pow(10,b/20):0}let h=(a=>{if(!a.length)return 0;let b=0;for(let c=0;c<a.length;c++)b+=a[c];b/=a.length;let c=0;for(let d=0;d<a.length;d++){let e=a[d]-b;c+=e*e}return c/a.length})(g),i=d<A.current.silenceDbThreshold&&h<1e-8,j=Math.max(0,Math.min(1,(d+120)/120)),l=((a,b,c)=>{try{let d=a.frequencyBinCount,e=new Float32Array(d);a.getFloatFrequencyData(e);let f=v.current?.sampleRate??48e3,g=a.fftSize,h=f/g,i=Math.max(0,Math.floor(b/h)),j=Math.min(d-1,Math.floor(c/h)),k=0;for(let a=i;a<=j;a++){let b=e[a];Number.isFinite(b)&&(k+=Math.pow(10,b/20))}let l=0;for(let a=0;a<d;a++){let b=e[a];Number.isFinite(b)&&(l+=Math.pow(10,b/20))}if(l<=0)return 0;return Math.max(0,Math.min(1,k/l))}catch(a){return 0}})(a,A.current.lowBandStartHz,A.current.lowBandEndHz),m=Math.round(100*l);E.current.push(m),F.current.push(Date.now()),E.current.length>512&&(E.current.shift(),F.current.shift());let o=D.current;o.push(h),o.length>A.current.varianceWindowSize&&o.shift(),i?(null===C.current&&(C.current=b),b-(C.current??b)>=1e3*A.current.silenceSeconds&&!I.current&&(I.current=!0,q(!0))):(I.current&&(I.current=!1,q(!1)),C.current=null),Math.abs(j-G.current)>.005&&(G.current=j,k(j)),Math.abs(l-H.current)>.005&&(H.current=l,n(l)),y.current=requestAnimationFrame(J.current)},()=>{}),[]);let K=(0,l.useCallback)(async()=>{if(!v.current)try{let a=await navigator.mediaDevices.getUserMedia({audio:!0});x.current=a,s(!0);let b=new(window.AudioContext||window.webkitAudioContext);if(v.current=b,"suspended"===b.state)try{await b.resume()}catch(a){}let c=b.createMediaStreamSource(a),d=b.createAnalyser();d.fftSize=A.current.analyserFftSize,d.smoothingTimeConstant=A.current.smoothingTimeConstant;try{d.minDecibels=-120,d.maxDecibels=-10}catch{}let e=b.createGain();e.gain.value=0,c.connect(d),d.connect(e);try{e.connect(b.destination)}catch{}w.current=d,z.current=e,B.current=0,C.current=null,D.current=[],E.current=[],F.current=[],G.current=0,H.current=0,I.current=!1,u(!0),y.current&&cancelAnimationFrame(y.current),y.current=requestAnimationFrame(J.current)}catch(a){throw console.error("useSoundAnalysis start failed",a),s(!1),a}},[]),L=(0,l.useCallback)(()=>{y.current&&(cancelAnimationFrame(y.current),y.current=null);try{if(v.current){try{v.current.close()}catch{}v.current=null}if(x.current&&(x.current.getTracks().forEach(a=>a.stop()),x.current=null),z.current){try{z.current.disconnect()}catch{}z.current=null}w.current=null}finally{u(!1),q(!1),n(0),E.current=[],F.current=[],G.current=0,H.current=0,I.current=!1}},[]);return(0,l.useEffect)(()=>(i&&K().catch(a=>console.error("auto start failed",a)),()=>{L()}),[]),{volume:j,bandEnergyLow:m,isSilent:o,permissionGranted:r,isRunning:t,start:K,stop:L,recentEnvelope:(0,l.useCallback)((a=120)=>({envelope:E.current.slice(-a),times:F.current.slice(-a)}),[])}}var q=function(a,b){return(q=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])})(a,b)};function r(a,b){function c(){this.constructor=a}q(a,b),a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)}function s(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})}function t(a,b){var c,d,e,f,g={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]};return f={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(f[Symbol.iterator]=function(){return this}),f;function h(f){return function(h){var i=[f,h];if(c)throw TypeError("Generator is already executing.");for(;g;)try{if(c=1,d&&(e=2&i[0]?d.return:i[0]?d.throw||((e=d.return)&&e.call(d),0):d.next)&&!(e=e.call(d,i[1])).done)return e;switch(d=0,e&&(i=[2&i[0],e.value]),i[0]){case 0:case 1:e=i;break;case 4:return g.label++,{value:i[1],done:!1};case 5:g.label++,d=i[1],i=[0];continue;case 7:i=g.ops.pop(),g.trys.pop();continue;default:if(!(e=(e=g.trys).length>0&&e[e.length-1])&&(6===i[0]||2===i[0])){g=0;continue}if(3===i[0]&&(!e||i[1]>e[0]&&i[1]<e[3])){g.label=i[1];break}if(6===i[0]&&g.label<e[1]){g.label=e[1],e=i;break}if(e&&g.label<e[2]){g.label=e[2],g.ops.push(i);break}e[2]&&g.ops.pop(),g.trys.pop();continue}i=b.call(a,g)}catch(a){i=[6,a],d=0}finally{c=e=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}}}var u=function(){function a(a){this.global=a,this.flags={},this.flagRegistry={},this.urlFlags={},this.populateURLFlags()}return a.prototype.setPlatform=function(a,b){null!=this.platform&&console.warn("Platform "+this.platformName+" has already been set. Overwriting the platform with "+b+"."),this.platformName=a,this.platform=b},a.prototype.registerFlag=function(a,b,c){if(this.flagRegistry[a]={evaluationFn:b,setHook:c},null!=this.urlFlags[a]){var d=this.urlFlags[a];console.warn("Setting feature override from URL "+a+": "+d+"."),this.set(a,d)}},a.prototype.get=function(a){return a in this.flags||(this.flags[a]=this.evaluateFlag(a)),this.flags[a]},a.prototype.getNumber=function(a){return this.get(a)},a.prototype.getBool=function(a){return this.get(a)},a.prototype.getFlags=function(){return this.flags},Object.defineProperty(a.prototype,"features",{get:function(){return this.flags},enumerable:!0,configurable:!0}),a.prototype.set=function(a,b){if(null==this.flagRegistry[a])throw Error("Cannot set flag "+a+" as it has not been registered.");this.flags[a]=b,null!=this.flagRegistry[a].setHook&&this.flagRegistry[a].setHook(b)},a.prototype.evaluateFlag=function(a){if(null==this.flagRegistry[a])throw Error("Cannot evaluate flag '"+a+"': no evaluation function found.");return this.flagRegistry[a].evaluationFn()},a.prototype.setFlags=function(a){this.flags=Object.assign({},a)},a.prototype.reset=function(){this.flags={},this.urlFlags={},this.populateURLFlags()},a.prototype.populateURLFlags=function(){var a=this;if(void 0!==this.global&&void 0!==this.global.location&&void 0!==this.global.location.search){var b,c,d=(b=this.global.location.search,c={},b.replace(/[?&]([^=?&]+)(?:=([^&]*))?/g,function(a){for(var b,d,e,f=[],g=1;g<arguments.length;g++)f[g-1]=arguments[g];return b=c,d=f[0],e=f[1],b[decodeURIComponent(d)]=decodeURIComponent(e||""),f.join("=")}),c);"tfjsflags"in d&&d.tfjsflags.split(",").forEach(function(b){var c=b.split(":"),d=c[0],e=c[1];a.urlFlags[d]=function(a,b){if("true"===(b=b.toLowerCase())||"false"===b)return"true"===b;if(""+ +b===b)return+b;throw Error("Could not parse value flag value "+b+" for flag "+a+".")}(d,e)})}},a}();function v(){return w}var w=null,x=new Map,y=new Map;function z(a,b){var c=b+"_"+a;return x.get(c)}function A(a){return y.get(a)}function B(a){for(var b=x.entries(),c=[];;){var d=b.next(),e=d.done,f=d.value;if(e)break;var g=f[0],h=f[1];g.split("_")[0]===a&&c.push(h)}return c}function C(a){var b=a.kernelName,c=a.backendName,d=c+"_"+b;if(x.has(d))throw Error("The kernel '"+b+"' for backend '"+c+"' is already registered");x.set(d,a)}function D(a){var b=a.kernelName;y.has(b)&&console.warn("Overriding the gradient for '"+b+"'"),y.set(b,a)}function E(a,b){var c=b+"_"+a;if(!x.has(c))throw Error("The kernel '"+a+"' for backend '"+b+"' is not registered");x.delete(c)}function F(a){if(!y.has(a))throw Error("The gradient '"+a+"' for backend is not registered");y.delete(a)}function G(a){for(var b=a.length,c=0,d=0;b>0;)d=Math.random()*b|0,c=a[--b],a[b]=a[d],a[d]=c}function H(a,b,c){return Math.max(a,Math.min(b,c))}function I(a){return a%2==0?a:a+1}function J(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b}function K(a,b){if(!a)throw Error("string"==typeof b?b:b())}function L(a,b,c){void 0===c&&(c=""),K(P(a,b),function(){return c+" Shapes "+a+" and "+b+" must match"})}function M(a){K(null!=a,function(){return"The input to the tensor constructor must be a non-null value."})}function N(a,b,c){if(void 0===b&&(b=[]),void 0===c&&(c=!1),null==b&&(b=[]),Array.isArray(a)||ab(a)&&!c)for(var d=0;d<a.length;++d)N(a[d],b,c);else b.push(a);return b}function O(a){if(0===a.length)return 1;for(var b=a[0],c=1;c<a.length;c++)b*=a[c];return b}function P(a,b){if(a===b)return!0;if(null==a||null==b||a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}function Q(a){return a%1==0}function R(a){if(null!=Math.tanh)return Math.tanh(a);if(a===1/0)return 1;if(a===-1/0)return -1;var b=Math.exp(2*a);return(b-1)/(b+1)}function S(a){var b=Math.ceil(Math.sqrt(a));return[b,Math.ceil(a/b)]}function T(a,b){return b<=a.length?a:a+" ".repeat(b-a.length)}function U(a,b,c){return void 0===b&&(b=function(a){return 0}),new Promise(function(d,e){var f=0,g=function(){if(a())d();else{f++;var h=b(f);null!=c&&f>=c?e():setTimeout(g,h)}};g()})}function V(a,b){for(var c=1,d=-1,e=0;e<a.length;++e)if(a[e]>=0)c*=a[e];else if(-1===a[e]){if(-1!==d)throw Error("Shapes can only have 1 implicit size. Found -1 at dim "+d+" and dim "+e);d=e}else if(a[e]<0)throw Error("Shapes can not be < 0. Found "+a[e]+" at dim "+e);if(-1===d){if(b>0&&b!==c)throw Error("Size("+b+") must match the product of shape "+a);return a}if(0===c)throw Error("Cannot infer the missing size in ["+a+"] when there are 0 elements");if(b%c!=0)throw Error("The implicit shape can't be a fractional number. Got "+b+" / "+c);var f=a.slice();return f[d]=b/c,f}function W(a,b){var c=b.length;return K((a=null==a?b.map(function(a,b){return b}):[].concat(a)).every(function(a){return a>=-c&&a<c}),function(){return"All values in axis param must be in range [-"+c+", "+c+") but got axis "+a}),K(a.every(function(a){return Q(a)}),function(){return"All values in axis param must be integers but got axis "+a}),a.map(function(a){return a<0?c+a:a})}function X(a,b){for(var c=[],d=[],e=null!=b&&Array.isArray(b)&&0===b.length,f=null==b||e?null:W(b,a).sort(),g=0,h=0;h<a.length;++h){if(null!=f){if(f[g]===h&&1!==a[h])throw Error("Can't squeeze axis "+h+" since its dim '"+a[h]+"' is not 1");(null==f[g]||f[g]>h)&&1===a[h]&&(c.push(a[h]),d.push(h)),f[g]<=h&&g++}1!==a[h]&&(c.push(a[h]),d.push(h))}return{newShape:c,keptDims:d}}function Y(a,b){var c=null;if(null==a||"float32"===a)c=new Float32Array(b);else if("int32"===a)c=new Int32Array(b);else{if("bool"!==a)throw Error("Unknown data type "+a);c=new Uint8Array(b)}return c}function Z(a,b){var c=null;if(null==a||"float32"===a)c=new Float32Array(b);else if("int32"===a)c=new Int32Array(b);else if("bool"===a)c=new Uint8Array(b);else{if("string"!==a)throw Error("Unknown data type "+a);c=Array(b)}return c}function $(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(isNaN(d)||!isFinite(d))throw Error("A tensor of type "+b+" being uploaded contains "+d+".")}}function _(a){return"bool"===a||"complex64"===a||"float32"===a||"int32"===a||"string"===a}function aa(a,b){return"complex64"!==b&&("float32"!==b||"complex64"===a)&&("int32"!==b||"float32"===a||"complex64"===a)&&("bool"!==b||"bool"!==a)}function ab(a){return a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array}function ac(a){if("float32"===a||"int32"===a)return 4;if("complex64"===a)return 8;if("bool"===a)return 1;throw Error("Unknown dtype "+a)}function ad(a){if(null==a)return 0;var b=0;return a.forEach(function(a){return b+=a.length}),b}function ae(a){return"string"==typeof a||a instanceof String}function af(a){return"boolean"==typeof a}function ag(a){return"number"==typeof a}function ah(a){return Array.isArray(a)?ah(a[0]):a instanceof Float32Array?"float32":a instanceof Int32Array||a instanceof Uint8Array?"int32":ag(a)?"float32":ae(a)?"string":af(a)?"bool":"float32"}function ai(a){return!!(a&&a.constructor&&a.call&&a.apply)}function aj(a,b){for(var c=b;c<a;++c)if(a%c==0)return c;return a}function ak(a){var b=a.length;if(b<2)return[];var c=Array(b-1);c[b-2]=a[b-1];for(var d=b-3;d>=0;--d)c[d]=c[d+1]*a[d+1];return c}function al(a,b,c){if("string"===b)throw Error("Cannot convert a string[] to a TypedArray");if(Array.isArray(a)&&(a=N(a)),c&&$(a,b),(d=a)instanceof Float32Array&&"float32"===b||d instanceof Int32Array&&"int32"===b||d instanceof Uint8Array&&"bool"===b)return a;if(null==b||"float32"===b||"complex64"===b)return new Float32Array(a);if("int32"===b)return new Int32Array(a);if("bool"===b){for(var d,e=new Uint8Array(a.length),f=0;f<e.length;++f)0!==Math.round(a[f])&&(e[f]=1);return e}throw Error("Unknown data type "+b)}function am(a,b){if(0===a.length)return b[0];var c=a.reduce(function(a,b){return a*b});if(0===c)return[];if(c!==b.length)throw Error("["+a+"] does not match the input size.");return function a(b,c,d){var e=[];if(1===c.length)for(var f=c[0],g=0;g<f;g++)e[g]=d[b+g];else{f=c[0];var h=c.slice(1),i=h.reduce(function(a,b){return a*b});for(g=0;g<f;g++)e[g]=a(b+g*i,h,d)}return e}(0,a,b)}function an(a,b){for(var c=ao(a,b),d=0;d<c.length;d++)c[d]=1;return c}function ao(a,b){if(null==b||"float32"===b||"complex64"===b)return new Float32Array(a);if("int32"===b)return new Int32Array(a);if("bool"===b)return new Uint8Array(a);throw Error("Unknown data type "+b)}function ap(){return w.platform.now()}function aq(a){a.forEach(function(b){K(Number.isInteger(b)&&b>=0,function(){return"Tensor must have a shape comprised of positive integers but got shape ["+a+"]."})})}function ar(a,b){return void 0===b&&(b="utf-8"),b=b||"utf-8",w.platform.encode(a,b)}function as(a,b){return void 0===b&&(b="utf-8"),b=b||"utf-8",w.platform.decode(a,b)}function at(a,b,c){if(0===b)return 0;if(1===b)return a[0];for(var d=a[a.length-1],e=0;e<a.length-1;++e)d+=c[e]*a[e];return d}function au(a,b,c){if(0===b)return[];if(1===b)return[a];for(var d=Array(b),e=0;e<d.length-1;++e)d[e]=Math.floor(a/c[e]),a-=d[e]*c[e];return d[d.length-1]=a,d}var av=Object.freeze({shuffle:G,clamp:H,nearestLargerEven:I,sum:J,randUniform:function(a,b){var c=Math.random();return b*c+(1-c)*a},distSquared:function(a,b){for(var c=0,d=0;d<a.length;d++){var e=Number(a[d])-Number(b[d]);c+=e*e}return c},assert:K,assertShapesMatch:L,assertNonNull:M,flatten:N,sizeFromShape:O,isScalarShape:function(a){return 0===a.length},arraysEqual:P,isInt:Q,tanh:R,sizeToSquarishShape:S,createShuffledIndices:function(a){for(var b=new Uint32Array(a),c=0;c<a;++c)b[c]=c;return G(b),b},rightPad:T,repeatedTry:U,inferFromImplicitShape:V,parseAxisParam:W,squeezeShape:X,getTypedArrayFromDType:Y,getArrayFromDType:Z,checkConversionForErrors:$,isValidDtype:_,hasEncodingLoss:aa,isTypedArray:ab,bytesPerElement:ac,bytesFromStringArray:ad,isString:ae,isBoolean:af,isNumber:ag,inferDtype:ah,isFunction:ai,nearestDivisor:aj,computeStrides:ak,toTypedArray:al,toNestedArray:am,makeOnesTypedArray:an,makeZerosTypedArray:ao,now:ap,assertNonNegativeIntegerDimensions:aq,fetch:function(a,b){return w.platform.fetch(a,b)},encodeString:ar,decodeString:as,locToIndex:at,indexToLoc:au}),aw=function(){function a(a,b){this.backendTimer=a,this.logger=b,null==b&&(this.logger=new ax)}return a.prototype.profileKernel=function(a,b,c){var d,e=this,f=this.backendTimer.time(function(){d=c()});return d.forEach(function(c){c.data().then(function(d){!function(a,b,c){if("float32"===b)for(var d=0;d<a.length;d++){var e=a[d];if(isNaN(e)||!isFinite(e))return console.warn("Found "+e+" in the result of '"+c+"'"),!0}}(d,c.dtype,a),f.then(function(f){var g="";null!=f.getExtraProfileInfo&&(g=f.getExtraProfileInfo()),e.logger.logKernelProfile(a,c,d,f.kernelMs,b,g)})})}),d},a}(),ax=function(){function a(){}return a.prototype.logKernelProfile=function(a,b,c,d,e,f){var g="number"==typeof d?T(d+"ms",9):d.error,h=T(a,25),i=b.rank,j=b.size,k=T(b.shape.toString(),14),l="";for(var m in e){var n=e[m].shape||b.shape,o=n.length;l+=m+": "+o+"D "+(o>0?n:"")+" "}console.log("%c"+h+"	%c"+g+"	%c"+i+"D "+k+"	%c"+j+"	%c"+l+"	%c"+f,"font-weight:bold","color:red","color:blue","color: orange","color: green","color: steelblue")},a}();function ay(a,b,c){return T(Array.isArray(a)?parseFloat(a[0].toFixed(7))+" + "+parseFloat(a[1].toFixed(7))+"j":ae(a)?"'"+a+"'":"bool"===c?az(a):parseFloat(a.toFixed(7)).toString(),b)}function az(a){return 0===a?"false":"true"}function aA(a){for(var b=[],c=0;c<a.length;c+=2)b.push([a[c],a[c+1]]);return b}var aB=function(){function a(a,b,c){var d=this;if(this.dtype=b,this.shape=a.slice(),this.size=O(a),null!=c){var e=c.length;K(e===this.size,function(){return"Length of values '"+e+"' does not match the size inferred by the shape '"+d.size+"'."})}if("complex64"===b)throw Error("complex64 dtype TensorBuffers are not supported. Please create a TensorBuffer for the real and imaginary parts separately and call tf.complex(real, imag).");this.values=c||Z(b,this.size),this.strides=ak(a)}return a.prototype.set=function(a){for(var b=this,c=[],d=1;d<arguments.length;d++)c[d-1]=arguments[d];0===c.length&&(c=[0]),K(c.length===this.rank,function(){return"The number of provided coordinates ("+c.length+") must match the rank ("+b.rank+")"});var e=this.locToIndex(c);this.values[e]=a},a.prototype.get=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];0===a.length&&(a=[0]);for(var c=0,d=0,e=a;d<e.length;d++){var f=e[d];if(f<0||f>=this.shape[c])throw Error("Requested out of range element at "+a+".   Buffer shape="+this.shape);c++}for(var g=a[a.length-1],h=0;h<a.length-1;++h)g+=this.strides[h]*a[h];return this.values[g]},a.prototype.locToIndex=function(a){if(0===this.rank)return 0;if(1===this.rank)return a[0];for(var b=a[a.length-1],c=0;c<a.length-1;++c)b+=this.strides[c]*a[c];return b},a.prototype.indexToLoc=function(a){if(0===this.rank)return[];if(1===this.rank)return[a];for(var b=Array(this.shape.length),c=0;c<b.length-1;++c)b[c]=Math.floor(a/this.strides[c]),a-=b[c]*this.strides[c];return b[b.length-1]=a,b},Object.defineProperty(a.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),a.prototype.toTensor=function(){return aC().makeTensor(this.values,this.shape,this.dtype)},a}(),aC=null,aD=null,aE=null,aF=function(){function a(a,b,c,d){this.kept=!1,this.isDisposedInternal=!1,this.shape=a.slice(),this.dtype=b||"float32",this.size=O(a),this.strides=ak(a),this.dataId=c,this.id=d,this.rankType=this.rank<5?this.rank.toString():"higher"}return a.prototype.flatten=function(){return this.throwIfDisposed(),this.as1D()},a.prototype.asScalar=function(){return this.throwIfDisposed(),K(1===this.size,function(){return"The array must have only 1 element."}),this.reshape([])},a.prototype.as1D=function(){return this.throwIfDisposed(),this.reshape([this.size])},a.prototype.as2D=function(a,b){return this.throwIfDisposed(),this.reshape([a,b])},a.prototype.as3D=function(a,b,c){return this.throwIfDisposed(),this.reshape([a,b,c])},a.prototype.as4D=function(a,b,c,d){return this.throwIfDisposed(),this.reshape([a,b,c,d])},a.prototype.as5D=function(a,b,c,d,e){return this.throwIfDisposed(),this.reshape([a,b,c,d,e])},a.prototype.asType=function(a){return this.throwIfDisposed(),aD.cast(this,a)},Object.defineProperty(a.prototype,"rank",{get:function(){return this.shape.length},enumerable:!0,configurable:!0}),a.prototype.buffer=function(){return s(this,void 0,void 0,function(){var a;return t(this,function(b){switch(b.label){case 0:return[4,this.data()];case 1:return a=b.sent(),[2,aD.buffer(this.shape,this.dtype,a)]}})})},a.prototype.bufferSync=function(){return aD.buffer(this.shape,this.dtype,this.dataSync())},a.prototype.array=function(){return s(this,void 0,void 0,function(){var a;return t(this,function(b){switch(b.label){case 0:return[4,this.data()];case 1:return a=b.sent(),[2,am(this.shape,a)]}})})},a.prototype.arraySync=function(){return am(this.shape,this.dataSync())},a.prototype.data=function(){return s(this,void 0,void 0,function(){var a,b;return t(this,function(c){switch(c.label){case 0:return this.throwIfDisposed(),a=aC().read(this.dataId),"string"!==this.dtype?[3,2]:[4,a];case 1:b=c.sent();try{return[2,b.map(function(a){return as(a)})]}catch(a){throw Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}case 2:return[2,a]}})})},a.prototype.dataSync=function(){this.throwIfDisposed();var a=aC().readSync(this.dataId);if("string"===this.dtype)try{return a.map(function(a){return as(a)})}catch(a){throw Error("Failed to decode the string bytes into utf-8. To get the original bytes, call tensor.bytes().")}return a},a.prototype.bytes=function(){return s(this,void 0,void 0,function(){var a;return t(this,function(b){switch(b.label){case 0:return this.throwIfDisposed(),[4,aC().read(this.dataId)];case 1:return a=b.sent(),"string"===this.dtype?[2,a]:[2,new Uint8Array(a.buffer)]}})})},a.prototype.dispose=function(){this.isDisposed||(aC().disposeTensor(this),this.isDisposedInternal=!0)},Object.defineProperty(a.prototype,"isDisposed",{get:function(){return this.isDisposedInternal},enumerable:!0,configurable:!0}),a.prototype.throwIfDisposed=function(){if(this.isDisposed)throw Error("Tensor is disposed.")},a.prototype.toFloat=function(){return this.asType("float32")},a.prototype.toInt=function(){return this.asType("int32")},a.prototype.toBool=function(){return this.asType("bool")},a.prototype.print=function(a){return void 0===a&&(a=!1),aD.print(this,a)},a.prototype.reshape=function(a){return this.throwIfDisposed(),aD.reshape(this,a)},a.prototype.reshapeAs=function(a){return this.throwIfDisposed(),this.reshape(a.shape)},a.prototype.expandDims=function(a){return void 0===a&&(a=0),aD.expandDims(this,a)},a.prototype.cumsum=function(a,b,c){return void 0===a&&(a=0),void 0===b&&(b=!1),void 0===c&&(c=!1),aD.cumsum(this,a,b,c)},a.prototype.squeeze=function(a){return this.throwIfDisposed(),aD.squeeze(this,a)},a.prototype.clone=function(){return this.throwIfDisposed(),aD.clone(this)},a.prototype.oneHot=function(a,b,c){return this.throwIfDisposed(),aD.oneHot(this,a,b,c)},a.prototype.toString=function(a){var b,c,d,e,f,g,h,i,j;return void 0===a&&(a=!1),b=this.dataSync(),c=this.shape,d=this.dtype,e=a,f=ak(c),g=function(a,b,c,d){var e=O(b),f=d[d.length-1],g=Array(f).fill(0),h=b.length,i="complex64"===c?aA(a):a;if(h>1)for(var j=0;j<e/f;j++)for(var k=j*f,l=0;l<f;l++)g[l]=Math.max(g[l],ay(i[k+l],0,c).length);return g}(b,c,d,f),h=c.length,i=function a(b,c,d,e,f,g){void 0===g&&(g=!0);var h,i="complex64"===d?2:1,j=c[0],k=c.length;if(0===k)return"complex64"===d?[ay(aA(b)[0],0,d)]:"bool"===d?[az(b[0])]:[b[0].toString()];if(1===k){if(j>20){var l=Array.from(b.slice(0,3*i)),m=Array.from(b.slice((j-3)*i,j*i));return"complex64"===d&&(l=aA(l),m=aA(m)),["["+l.map(function(a,b){return ay(a,f[b],d)}).join(", ")+", ..., "+m.map(function(a,b){return ay(a,f[j-3+b],d)}).join(", ")+"]"]}return["["+("complex64"===d?aA(b):Array.from(b)).map(function(a,b){return ay(a,f[b],d)}).join(", ")+"]"]}var n=c.slice(1),o=e.slice(1),p=e[0]*i,q=[];if(j>20){for(var r=0;r<3;r++){var s=(h=r*p)+p;q.push.apply(q,a(b.slice(h,s),n,d,o,f,!1))}for(q.push("..."),r=j-3;r<j;r++)s=(h=r*p)+p,q.push.apply(q,a(b.slice(h,s),n,d,o,f,r===j-1))}else for(r=0;r<j;r++)s=(h=r*p)+p,q.push.apply(q,a(b.slice(h,s),n,d,o,f,r===j-1));var t=2===k?",":"";for(r=1,q[0]="["+q[0]+t;r<q.length-1;r++)q[r]=" "+q[r]+t;var u=",\n";for(r=2;r<k;r++)u+="\n";return q[q.length-1]=" "+q[q.length-1]+"]"+(g?"":u),q}(b,c,d,f,g),j=["Tensor"],e&&(j.push("  dtype: "+d),j.push("  rank: "+h),j.push("  shape: ["+c+"]"),j.push("  values:")),j.push(i.map(function(a){return"    "+a}).join("\n")),j.join("\n")},a.prototype.tile=function(a){return this.throwIfDisposed(),aD.tile(this,a)},a.prototype.gather=function(a,b){return void 0===b&&(b=0),this.throwIfDisposed(),aD.gather(this,a,b)},a.prototype.matMul=function(a,b,c){return void 0===b&&(b=!1),void 0===c&&(c=!1),this.throwIfDisposed(),aD.matMul(this,a,b,c)},a.prototype.dot=function(a){return this.throwIfDisposed(),aD.dot(this,a)},a.prototype.norm=function(a,b,c){return void 0===a&&(a="euclidean"),void 0===b&&(b=null),void 0===c&&(c=!1),this.throwIfDisposed(),aD.norm(this,a,b,c)},a.prototype.slice=function(a,b){return this.throwIfDisposed(),aD.slice(this,a,b)},a.prototype.reverse=function(a){return this.throwIfDisposed(),aD.reverse(this,a)},a.prototype.concat=function(b,c){return void 0===c&&(c=0),this.throwIfDisposed(),b instanceof a&&(b=[b]),aD.concat([this].concat(b),c)},a.prototype.split=function(a,b){return void 0===b&&(b=0),this.throwIfDisposed(),aD.split(this,a,b)},a.prototype.stack=function(a,b){return void 0===b&&(b=0),aD.stack([this,a],b)},a.prototype.unstack=function(a){return void 0===a&&(a=0),aD.unstack(this,a)},a.prototype.pad=function(a,b){return void 0===b&&(b=0),aD.pad(this,a,b)},a.prototype.batchNormalization=function(a,b,c,d,e){return void 0===c&&(c=.001),aE("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon"),this.batchNorm(a,b,e,d,c)},a.prototype.batchNorm=function(a,b,c,d,e){return void 0===e&&(e=.001),this.throwIfDisposed(),aD.batchNorm(this,a,b,c,d,e)},a.prototype.all=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.all(this,a,b)},a.prototype.any=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.any(this,a,b)},a.prototype.logSumExp=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.logSumExp(this,a,b)},a.prototype.sum=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.sum(this,a,b)},a.prototype.prod=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.prod(this,a,b)},a.prototype.mean=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.mean(this,a,b)},a.prototype.min=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.min(this,a,b)},a.prototype.max=function(a,b){return void 0===a&&(a=null),void 0===b&&(b=!1),this.throwIfDisposed(),aD.max(this,a,b)},a.prototype.argMin=function(a){return void 0===a&&(a=null),this.throwIfDisposed(),aD.argMin(this,a)},a.prototype.argMax=function(a){return void 0===a&&(a=null),this.throwIfDisposed(),aD.argMax(this,a)},a.prototype.cast=function(a){return this.throwIfDisposed(),aD.cast(this,a)},a.prototype.add=function(a){return this.throwIfDisposed(),aD.add(this,a)},a.prototype.addStrict=function(a){return this.throwIfDisposed(),aD.addStrict(this,a)},a.prototype.atan2=function(a){return this.throwIfDisposed(),aD.atan2(this,a)},a.prototype.sub=function(a){return this.throwIfDisposed(),aD.sub(this,a)},a.prototype.subStrict=function(a){return this.throwIfDisposed(),aD.subStrict(this,a)},a.prototype.pow=function(a){return this.throwIfDisposed(),aD.pow(this,a)},a.prototype.powStrict=function(a){return this.throwIfDisposed(),aD.powStrict(this,a)},a.prototype.mul=function(a){return this.throwIfDisposed(),aD.mul(this,a)},a.prototype.mulStrict=function(a){return this.throwIfDisposed(),aD.mulStrict(this,a)},a.prototype.div=function(a){return this.throwIfDisposed(),aD.div(this,a)},a.prototype.divNoNan=function(a){return this.throwIfDisposed(),aD.divNoNan(this,a)},a.prototype.floorDiv=function(a){return this.throwIfDisposed(),aD.floorDiv(this,a)},a.prototype.divStrict=function(a){return this.throwIfDisposed(),aD.divStrict(this,a)},a.prototype.minimum=function(a){return this.throwIfDisposed(),aD.minimum(this,a)},a.prototype.minimumStrict=function(a){return this.throwIfDisposed(),aD.minimumStrict(this,a)},a.prototype.maximum=function(a){return this.throwIfDisposed(),aD.maximum(this,a)},a.prototype.maximumStrict=function(a){return this.throwIfDisposed(),aD.maximumStrict(this,a)},a.prototype.mod=function(a){return this.throwIfDisposed(),aD.mod(this,a)},a.prototype.modStrict=function(a){return this.throwIfDisposed(),aD.modStrict(this,a)},a.prototype.squaredDifferenceStrict=function(a){return this.throwIfDisposed(),aD.squaredDifferenceStrict(this,a)},a.prototype.transpose=function(a){return this.throwIfDisposed(),aD.transpose(this,a)},a.prototype.notEqual=function(a){return this.throwIfDisposed(),aD.notEqual(this,a)},a.prototype.notEqualStrict=function(a){return this.throwIfDisposed(),aD.notEqualStrict(this,a)},a.prototype.less=function(a){return this.throwIfDisposed(),aD.less(this,a)},a.prototype.lessStrict=function(a){return this.throwIfDisposed(),aD.lessStrict(this,a)},a.prototype.equal=function(a){return this.throwIfDisposed(),aD.equal(this,a)},a.prototype.equalStrict=function(a){return this.throwIfDisposed(),aD.equalStrict(this,a)},a.prototype.lessEqual=function(a){return this.throwIfDisposed(),aD.lessEqual(this,a)},a.prototype.lessEqualStrict=function(a){return this.throwIfDisposed(),aD.lessEqualStrict(this,a)},a.prototype.greater=function(a){return this.throwIfDisposed(),aD.greater(this,a)},a.prototype.greaterStrict=function(a){return this.throwIfDisposed(),aD.greaterStrict(this,a)},a.prototype.greaterEqual=function(a){return this.throwIfDisposed(),aD.greaterEqual(this,a)},a.prototype.greaterEqualStrict=function(a){return this.throwIfDisposed(),aD.greaterEqualStrict(this,a)},a.prototype.logicalAnd=function(a){return this.throwIfDisposed(),aD.logicalAnd(this,a)},a.prototype.logicalOr=function(a){return this.throwIfDisposed(),aD.logicalOr(this,a)},a.prototype.logicalNot=function(){return this.throwIfDisposed(),aD.logicalNot(this)},a.prototype.logicalXor=function(a){return this.throwIfDisposed(),aD.logicalXor(this,a)},a.prototype.where=function(a,b){return this.throwIfDisposed(),aD.where(a,this,b)},a.prototype.neg=function(){return this.throwIfDisposed(),aD.neg(this)},a.prototype.ceil=function(){return this.throwIfDisposed(),aD.ceil(this)},a.prototype.floor=function(){return this.throwIfDisposed(),aD.floor(this)},a.prototype.sign=function(){return this.throwIfDisposed(),aD.sign(this)},a.prototype.isNaN=function(){return this.throwIfDisposed(),aD.isNaN(this)},a.prototype.isInf=function(){return this.throwIfDisposed(),aD.isInf(this)},a.prototype.isFinite=function(){return this.throwIfDisposed(),aD.isFinite(this)},a.prototype.exp=function(){return this.throwIfDisposed(),aD.exp(this)},a.prototype.expm1=function(){return this.throwIfDisposed(),aD.expm1(this)},a.prototype.log=function(){return this.throwIfDisposed(),aD.log(this)},a.prototype.log1p=function(){return this.throwIfDisposed(),aD.log1p(this)},a.prototype.sqrt=function(){return this.throwIfDisposed(),aD.sqrt(this)},a.prototype.rsqrt=function(){return this.throwIfDisposed(),aD.rsqrt(this)},a.prototype.square=function(){return this.throwIfDisposed(),aD.square(this)},a.prototype.reciprocal=function(){return this.throwIfDisposed(),aD.reciprocal(this)},a.prototype.abs=function(){return this.throwIfDisposed(),aD.abs(this)},a.prototype.clipByValue=function(a,b){return this.throwIfDisposed(),aD.clipByValue(this,a,b)},a.prototype.relu=function(){return this.throwIfDisposed(),aD.relu(this)},a.prototype.relu6=function(){return this.throwIfDisposed(),aD.relu6(this)},a.prototype.elu=function(){return this.throwIfDisposed(),aD.elu(this)},a.prototype.selu=function(){return this.throwIfDisposed(),aD.selu(this)},a.prototype.leakyRelu=function(a){return void 0===a&&(a=.2),this.throwIfDisposed(),aD.leakyRelu(this,a)},a.prototype.prelu=function(a){return this.throwIfDisposed(),aD.prelu(this,a)},a.prototype.sigmoid=function(){return this.throwIfDisposed(),aD.sigmoid(this)},a.prototype.logSigmoid=function(){return this.throwIfDisposed(),aD.logSigmoid(this)},a.prototype.softplus=function(){return this.throwIfDisposed(),aD.softplus(this)},a.prototype.zerosLike=function(){return this.throwIfDisposed(),aD.zerosLike(this)},a.prototype.onesLike=function(){return this.throwIfDisposed(),aD.onesLike(this)},a.prototype.sin=function(){return this.throwIfDisposed(),aD.sin(this)},a.prototype.cos=function(){return this.throwIfDisposed(),aD.cos(this)},a.prototype.tan=function(){return this.throwIfDisposed(),aD.tan(this)},a.prototype.asin=function(){return this.throwIfDisposed(),aD.asin(this)},a.prototype.acos=function(){return this.throwIfDisposed(),aD.acos(this)},a.prototype.atan=function(){return this.throwIfDisposed(),aD.atan(this)},a.prototype.sinh=function(){return this.throwIfDisposed(),aD.sinh(this)},a.prototype.cosh=function(){return this.throwIfDisposed(),aD.cosh(this)},a.prototype.tanh=function(){return this.throwIfDisposed(),aD.tanh(this)},a.prototype.asinh=function(){return this.throwIfDisposed(),aD.asinh(this)},a.prototype.acosh=function(){return this.throwIfDisposed(),aD.acosh(this)},a.prototype.atanh=function(){return this.throwIfDisposed(),aD.atanh(this)},a.prototype.erf=function(){return this.throwIfDisposed(),aD.erf(this)},a.prototype.round=function(){return this.throwIfDisposed(),aD.round(this)},a.prototype.step=function(a){return void 0===a&&(a=0),this.throwIfDisposed(),aD.step(this,a)},a.prototype.softmax=function(a){return void 0===a&&(a=-1),this.throwIfDisposed(),aD.softmax(this,a)},a.prototype.logSoftmax=function(a){return void 0===a&&(a=-1),this.throwIfDisposed(),aD.logSoftmax(this,a)},a.prototype.resizeBilinear=function(a,b){return void 0===b&&(b=!1),this.throwIfDisposed(),aD.image.resizeBilinear(this,a,b)},a.prototype.resizeNearestNeighbor=function(a,b){return void 0===b&&(b=!1),this.throwIfDisposed(),aD.image.resizeNearestNeighbor(this,a,b)},a.prototype.conv1d=function(a,b,c,d,e,f){return void 0===d&&(d="NWC"),void 0===e&&(e=1),this.throwIfDisposed(),aD.conv1d(this,a,b,c,d,e,f)},a.prototype.conv2d=function(a,b,c,d,e,f){return void 0===d&&(d="NHWC"),void 0===e&&(e=[1,1]),this.throwIfDisposed(),aD.conv2d(this,a,b,c,d,e,f)},a.prototype.conv2dTranspose=function(a,b,c,d,e){return this.throwIfDisposed(),aD.conv2dTranspose(this,a,b,c,d,e)},a.prototype.depthwiseConv2D=function(a,b,c,d,e,f){return void 0===d&&(d="NHWC"),void 0===e&&(e=[1,1]),this.throwIfDisposed(),aD.depthwiseConv2d(this,a,b,c,d,e,f)},a.prototype.separableConv2d=function(a,b,c,d,e,f){return void 0===e&&(e=[1,1]),void 0===f&&(f="NHWC"),this.throwIfDisposed(),aD.separableConv2d(this,a,b,c,d,e,f)},a.prototype.avgPool=function(a,b,c,d){return this.throwIfDisposed(),aD.avgPool(this,a,b,c,d)},a.prototype.maxPool=function(a,b,c,d){return this.throwIfDisposed(),aD.maxPool(this,a,b,c,d)},a.prototype.localResponseNormalization=function(a,b,c,d){return void 0===a&&(a=5),void 0===b&&(b=1),void 0===c&&(c=1),void 0===d&&(d=.5),aD.localResponseNormalization(this,a,b,c,d)},a.prototype.pool=function(a,b,c,d,e){return this.throwIfDisposed(),aD.pool(this,a,b,c,d,e)},a.prototype.variable=function(a,b,c){return void 0===a&&(a=!0),this.throwIfDisposed(),aC().makeVariable(this,a,b,c)},a.prototype.unsortedSegmentSum=function(a,b){return this.throwIfDisposed(),aD.unsortedSegmentSum(this,a,b)},a.prototype.batchToSpaceND=function(a,b){return this.throwIfDisposed(),aD.batchToSpaceND(this,a,b)},a.prototype.spaceToBatchND=function(a,b){return this.throwIfDisposed(),aD.spaceToBatchND(this,a,b)},a.prototype.topk=function(a,b){return void 0===a&&(a=1),void 0===b&&(b=!0),this.throwIfDisposed(),aD.topk(this,a,b)},a.prototype.stridedSlice=function(a,b,c,d,e,f,g,h){return void 0===d&&(d=0),void 0===e&&(e=0),void 0===f&&(f=0),void 0===g&&(g=0),void 0===h&&(h=0),this.throwIfDisposed(),aD.stridedSlice(this,a,b,c,d,e,f,g,h)},a.prototype.depthToSpace=function(a,b){return this.throwIfDisposed(),aD.depthToSpace(this,a,b)},a.prototype.fft=function(){return this.throwIfDisposed(),aD.spectral.fft(this)},a.prototype.ifft=function(){return this.throwIfDisposed(),aD.spectral.ifft(this)},a.prototype.rfft=function(){return this.throwIfDisposed(),aD.spectral.rfft(this)},a.prototype.irfft=function(){return this.throwIfDisposed(),aD.spectral.irfft(this)},a}();Object.defineProperty(aF,Symbol.hasInstance,{value:function(a){return!!a&&null!=a.dataId&&null!=a.shape&&null!=a.dtype}});var aG,aH,aI,aJ,aK,aL=function(a){function b(b,c,d,e){var f=a.call(this,b.shape,b.dtype,b.dataId,e)||this;return f.trainable=c,f.name=d,f}return r(b,a),b.prototype.assign=function(a){if(a.dtype!==this.dtype)throw Error("dtype of the new value ("+a.dtype+") and previous value ("+this.dtype+") must match");if(!P(a.shape,this.shape))throw Error("shape of the new value ("+a.shape+") and previous value ("+this.shape+") must match");aC().disposeTensor(this),this.dataId=a.dataId,aC().incRef(this,null)},b.prototype.dispose=function(){aC().disposeVariable(this),this.isDisposedInternal=!0},b}(aF);Object.defineProperty(aL,Symbol.hasInstance,{value:function(a){return a instanceof aF&&null!=a.assign&&a.assign instanceof Function}}),(aS=aG||(aG={})).R0="R0",aS.R1="R1",aS.R2="R2",aS.R3="R3",aS.R4="R4",aS.R5="R5",aS.R6="R6",(aT=aH||(aH={})).float32="float32",aT.int32="int32",aT.bool="int32",aT.complex64="complex64",(aU=aI||(aI={})).float32="float32",aU.int32="int32",aU.bool="bool",aU.complex64="complex64",(aV=aJ||(aJ={})).float32="float32",aV.int32="float32",aV.bool="float32",aV.complex64="complex64",(aW=aK||(aK={})).float32="complex64",aW.int32="complex64",aW.bool="complex64",aW.complex64="complex64";var aM={float32:aJ,int32:aH,bool:aI,complex64:aK};function aN(a,b){if("string"===a||"string"===b){if("string"===a&&"string"===b)return"string";throw Error("Can not upcast "+a+" with "+b)}return aM[a][b]}function aO(a){return aN(a,"int32")}function aP(a,b){if(a.dtype===b.dtype)return[a,b];var c=aN(a.dtype,b.dtype);return[a.cast(c),b.cast(c)]}function aQ(a,b){K(a.dtype===b.dtype,function(){return"The dtypes of the first("+a.dtype+") and second("+b.dtype+") input must match"})}function aR(a){var b=[];return function a(b,c,d){if(null!=b){if(b instanceof aF)return void c.push(b);if(Array.isArray(b)||"object"==typeof b)for(var e in b){var f=b[e];d.has(f)||(d.add(f),a(f,c,d))}}}(a,b,new Set),b}var aS,aT,aU,aV,aW,aX,aY=Object.freeze({makeTypesMatch:aP,assertTypesMatch:aQ,isTensorInList:function(a,b){return b.some(function(b){return b.id===a.id})},getTensorsInContainer:aR}),aZ=function(){function a(){this.registeredVariables={},this.nextTapeNodeId=0,this.numBytes=0,this.numTensors=0,this.numStringTensors=0,this.numDataBuffers=0,this.gradientDepth=0,this.kernelDepth=0,this.scopeStack=[],this.numDataMovesStack=[],this.nextScopeId=0,this.tensorInfo=new WeakMap,this.profiling=!1,this.activeProfile={newBytes:0,newTensors:0,peakBytes:0,kernels:[],result:null}}return a.prototype.dispose=function(){for(var a in this.registeredVariables)this.registeredVariables[a].dispose()},a}(),a$=function(){function a(a){this.ENV=a,this.registry={},this.registryFactory={},this.pendingBackendInitId=0,this.state=new aZ}return a.prototype.ready=function(){return s(this,void 0,void 0,function(){var a,b,c;return t(this,function(d){switch(d.label){case 0:if(null!=this.pendingBackendInit)return[2,this.pendingBackendInit.then(function(){})];if(null!=this.backendInstance)return[2];a=this.getSortedBackends(),b=0,d.label=1;case 1:return b<a.length?(c=a[b],[4,this.initializeBackend(c).success]):[3,5];case 2:return d.sent()?[4,this.setBackend(c)]:[3,4];case 3:return d.sent(),[2];case 4:return b++,[3,1];case 5:throw Error("Could not initialize any backends, all backend initializations failed.")}})})},Object.defineProperty(a.prototype,"backend",{get:function(){if(null!=this.pendingBackendInit)throw Error("Backend '"+this.backendName+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");if(null==this.backendInstance){var a=this.initializeBackendsAndReturnBest(),b=a.name;if(a.asyncInit)throw Error("The highest priority backend '"+b+"' has not yet been initialized. Make sure to await tf.ready() or await tf.setBackend() before calling other methods");this.setBackend(b)}return this.backendInstance},enumerable:!0,configurable:!0}),a.prototype.backendNames=function(){return Object.keys(this.registryFactory)},a.prototype.findBackend=function(a){return a in this.registry||a in this.registryFactory&&!this.initializeBackend(a).asyncInit?this.registry[a]:null},a.prototype.findBackendFactory=function(a){return a in this.registryFactory?this.registryFactory[a].factory:null},a.prototype.registerBackend=function(a,b,c){return void 0===c&&(c=1),a in this.registryFactory?(console.warn(a+" backend was already registered. Reusing existing backend factory."),!1):(this.registryFactory[a]={factory:b,priority:c},!0)},a.prototype.setBackend=function(a){return s(this,void 0,void 0,function(){var b,c,d;return t(this,function(e){switch(e.label){case 0:if(null==this.registryFactory[a])throw Error("Backend name '"+a+"' not found in registry");return this.backendName=a,null!=this.registry[a]?[3,4]:(this.backendInstance=null,c=(b=this.initializeBackend(a)).success,b.asyncInit?[4,c]:[3,2]);case 1:return d=e.sent(),[3,3];case 2:d=c,e.label=3;case 3:if(!d)return[2,!1];e.label=4;case 4:return this.backendInstance=this.registry[a],this.setupRegisteredKernels(),this.profiler=new aw(this.backendInstance),[2,!0]}})})},a.prototype.setupRegisteredKernels=function(){var a=this;B(this.backendName).forEach(function(b){null!=b.setupFunc&&b.setupFunc(a.backendInstance)})},a.prototype.disposeRegisteredKernels=function(a){var b=this;B(a).forEach(function(c){null!=c.disposeFunc&&c.disposeFunc(b.registry[a])})},a.prototype.initializeBackend=function(a){var b=this,c=this.registryFactory[a];if(null==c)throw Error("Cannot initialize backend "+a+", no registration found.");try{var d=c.factory();if(Promise.resolve(d)===d){var e=++this.pendingBackendInitId,f=d.then(function(c){return!(e<b.pendingBackendInitId)&&(b.registry[a]=c,b.pendingBackendInit=null,!0)}).catch(function(c){return!(e<b.pendingBackendInitId)&&(b.pendingBackendInit=null,console.warn("Initialization of backend "+a+" failed"),console.warn(c.stack||c.message),!1)});return this.pendingBackendInit=f,{success:f,asyncInit:!0}}return this.registry[a]=d,{success:!0,asyncInit:!1}}catch(b){return console.warn("Initialization of backend "+a+" failed"),console.warn(b.stack||b.message),{success:!1,asyncInit:!1}}},a.prototype.removeBackend=function(a){if(!(a in this.registryFactory))throw Error(a+" backend not found in registry");this.backendName===a&&null!=this.pendingBackendInit&&this.pendingBackendInitId++,a in this.registry&&(this.disposeRegisteredKernels(a),this.registry[a].dispose(),delete this.registry[a]),delete this.registryFactory[a],this.backendName===a&&(this.pendingBackendInit=null,this.backendName=null,this.backendInstance=null)},a.prototype.getSortedBackends=function(){var a=this;if(0===Object.keys(this.registryFactory).length)throw Error("No backend found in registry.");return Object.keys(this.registryFactory).sort(function(b,c){return a.registryFactory[c].priority-a.registryFactory[b].priority})},a.prototype.initializeBackendsAndReturnBest=function(){for(var a=this.getSortedBackends(),b=0;b<a.length;b++){var c=a[b],d=this.initializeBackend(c),e=d.success,f=d.asyncInit;if(f||e)return{name:c,asyncInit:f}}throw Error("Could not initialize any backends, all backend initializations failed.")},a.prototype.moveData=function(a,b){var c=this.state.tensorInfo.get(b),d=c.backend,e=this.readSync(b);d.disposeData(b),c.backend=a,a.move(b,e,c.shape,c.dtype),this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack[this.state.numDataMovesStack.length-1]++},a.prototype.tidy=function(a,b){var c,d=this,e=null;if(null==b){if("function"!=typeof a)throw Error("Please provide a function to tidy()");b=a}else{if("string"!=typeof a&&!(a instanceof String))throw Error("When calling with two arguments, the first argument to tidy() must be a string");if("function"!=typeof b)throw Error("When calling with two arguments, the 2nd argument to tidy() must be a function");e=a}return this.scopedRun(function(){return d.startScope(e)},function(){return d.endScope(c)},function(){return(c=b())instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),c})},a.prototype.scopedRun=function(a,b,c){a();try{var d=c();return b(),d}catch(a){throw b(),a}},a.prototype.nextTensorId=function(){return a.nextTensorId++},a.prototype.nextVariableId=function(){return a.nextVariableId++},a.prototype.clone=function(a){var b=this.makeTensorFromDataId(a.dataId,a.shape,a.dtype);return this.addTapeNode(this.state.activeScope.name,{x:a},[b],function(a){return{x:function(){return a.toFloat()}}},[]),b},a.prototype.runKernel=function(a,b,c,d,e){return this.runKernelFunc(null,b,null,a,c,d,e)},a.prototype.shouldCheckForMemLeaks=function(){return this.ENV.getBool("IS_TEST")},a.prototype.checkKernelForMemLeak=function(a,b,c){var d=this.backend.numDataIds(),e=0;c.forEach(function(a){e+="complex64"===a.dtype?3:1});var f=this.state.numDataMovesStack[this.state.numDataMovesStack.length-1],g=d-b-e-f;if(g>0)throw Error("Backend '"+this.backendName+"' has an internal memory leak ("+g+" data ids) after running '"+a+"'")},a.prototype.runKernelFunc=function(a,b,c,d,e,f,g){var h,i=this;void 0===f&&(f=[]),void 0===g&&(g=[]);var j=[],k=this.isTapeOn();null==d&&(d=null!=this.state.activeScope?this.state.activeScope.name:"");var l,m=function(a){k&&(j=a.map(function(a){return i.keep(i.clone(a))}))},n=this.state.numBytes,o=this.state.numTensors;this.shouldCheckForMemLeaks()&&this.state.numDataMovesStack.push(0);var p,q=z(d,this.backendName);return l=null!=q?function(){var a=i.backend.numDataIds(),c=Array.isArray(p=q.kernelFunc({inputs:b,attrs:e,backend:i.backend}))?p:[p];i.shouldCheckForMemLeaks()&&i.checkKernelForMemLeak(d,a,c);var h=c.map(function(a){var b=a.dataId,c=a.shape,d=a.dtype;return i.makeTensorFromDataId(b,c,d)}),j=h.filter(function(a,b){return g[b]});return m((f||[]).slice().concat(j)),h}:function(){var b=i.backend.numDataIds(),c=Array.isArray(p=i.tidy(function(){return a(i.backend,m)}))?p:[p];return i.shouldCheckForMemLeaks()&&i.checkKernelForMemLeak(d,b,c),c},this.scopedRun(function(){return i.state.kernelDepth++},function(){return i.state.kernelDepth--},function(){h=i.ENV.getBool("DEBUG")?i.profiler.profileKernel(d,b,function(){return l()}):l()}),k&&this.addTapeNode(d,b,h,c,j),this.state.profiling&&this.state.activeProfile.kernels.push({name:d,bytesAdded:this.state.numBytes-n,totalBytesSnapshot:this.state.numBytes,tensorsAdded:this.state.numTensors-o,totalTensorsSnapshot:this.state.numTensors,inputShapes:Object.keys(b).map(function(a){return b[a].shape}),outputShapes:h.map(function(a){return a.shape})}),Array.isArray(p)?h:h[0]},a.prototype.makeTensor=function(a,b,c,d){if(null==a)throw Error("Values passed to engine.makeTensor() are null");c=c||"float32",d=d||this.backend;var e=a;"string"===c&&ae(a[0])&&(e=a.map(function(a){return ar(a)}));var f=d.write(e,b,c),g=new aF(b,c,f,this.nextTensorId());if(this.incRef(g,d),"string"===c){var h=this.state.tensorInfo.get(f),i=ad(e);this.state.numBytes+=i-h.bytes,h.bytes=i}return g},a.prototype.makeTensorFromDataId=function(a,b,c,d){var e=new aF(b,c=c||"float32",a,this.nextTensorId());return this.incRef(e,d),e},a.prototype.makeVariable=function(a,b,c,d){void 0===b&&(b=!0),c=c||this.nextVariableId().toString(),null!=d&&d!==a.dtype&&(a=a.asType(d));var e=new aL(a,b,c,this.nextTensorId());if(null!=this.state.registeredVariables[e.name])throw Error("Variable with name "+e.name+" was already registered");return this.state.registeredVariables[e.name]=e,this.incRef(e,this.backend),e},a.prototype.incRef=function(a,b){var c=this.state.tensorInfo.has(a.dataId)?this.state.tensorInfo.get(a.dataId).refCount:0;if(this.state.numTensors++,"string"===a.dtype&&this.state.numStringTensors++,0===c){this.state.numDataBuffers++;var d=0;"complex64"!==a.dtype&&"string"!==a.dtype&&(d=a.size*ac(a.dtype)),this.state.tensorInfo.set(a.dataId,{backend:b||this.backend,dtype:a.dtype,shape:a.shape,bytes:d,refCount:0}),this.state.numBytes+=d}this.state.tensorInfo.get(a.dataId).refCount++,a instanceof aL||this.track(a)},a.prototype.disposeTensor=function(a){if(this.state.tensorInfo.has(a.dataId)){this.state.numTensors--,"string"===a.dtype&&this.state.numStringTensors--;var b=this.state.tensorInfo.get(a.dataId);b.refCount<=1?("complex64"!==a.dtype&&(this.state.numBytes-=b.bytes),this.state.numDataBuffers--,b.backend.disposeData(a.dataId),this.state.tensorInfo.delete(a.dataId)):this.state.tensorInfo.get(a.dataId).refCount--}},a.prototype.disposeVariables=function(){for(var a in this.state.registeredVariables){var b=this.state.registeredVariables[a];this.disposeVariable(b)}},a.prototype.disposeVariable=function(a){this.disposeTensor(a),null!=this.state.registeredVariables[a.name]&&delete this.state.registeredVariables[a.name]},a.prototype.memory=function(){var a=this.backend.memory();return a.numTensors=this.state.numTensors,a.numDataBuffers=this.state.numDataBuffers,a.numBytes=this.state.numBytes,this.state.numStringTensors>0&&(a.unreliable=!0,null==a.reasons&&(a.reasons=[]),a.reasons.push("Memory usage by string tensors is approximate (2 bytes per character)")),a},a.prototype.profile=function(a){return s(this,void 0,void 0,function(){var b,c;return t(this,function(d){return this.state.profiling=!0,b=this.state.numBytes,c=this.state.numTensors,this.state.activeProfile.kernels=[],this.state.activeProfile.result=a(),this.state.profiling=!1,this.state.activeProfile.peakBytes=Math.max.apply(Math,this.state.activeProfile.kernels.map(function(a){return a.totalBytesSnapshot})),this.state.activeProfile.newBytes=this.state.numBytes-b,this.state.activeProfile.newTensors=this.state.numTensors-c,[2,this.state.activeProfile]})})},a.prototype.isTapeOn=function(){return this.state.gradientDepth>0&&0===this.state.kernelDepth},a.prototype.addTapeNode=function(a,b,c,d,e){var f=this,g={id:this.state.nextTapeNodeId++,kernelName:a,inputs:b,outputs:c,saved:e},h=A(a);null!=h&&(d=h.gradFunc),null!=d&&(g.gradient=function(a){return a=a.map(function(a,b){if(null==a){var d=c[b],e=ao(d.size,d.dtype);return f.makeTensor(e,d.shape,d.dtype)}return a}),d(a.length>1?a:a[0],e)}),this.state.activeTape.push(g)},a.prototype.keep=function(a){return a.kept=!0,a},a.prototype.startTape=function(){0===this.state.gradientDepth&&(this.state.activeTape=[]),this.state.gradientDepth++},a.prototype.endTape=function(){this.state.gradientDepth--},a.prototype.startScope=function(a){var b={track:[],name:"unnamed scope",id:this.state.nextScopeId++};a&&(b.name=a),this.state.scopeStack.push(b),this.state.activeScope=b},a.prototype.endScope=function(a){for(var b=this,c=aR(a),d=new Set(c.map(function(a){return a.id})),e=0;e<this.state.activeScope.track.length;e++){var f=this.state.activeScope.track[e];f.kept||d.has(f.id)||f.dispose()}var g=this.state.scopeStack.pop();this.state.activeScope=0===this.state.scopeStack.length?null:this.state.scopeStack[this.state.scopeStack.length-1],c.forEach(function(a){a.kept||a.scopeId!==g.id||b.track(a)})},a.prototype.gradients=function(a,b,c,d){var e=this;if(void 0===d&&(d=!1),K(b.length>0,function(){return"gradients() received an empty list of xs."}),null!=c&&"float32"!==c.dtype)throw Error("dy must have 'float32' dtype, but has '"+c.dtype+"'");var f=this.scopedRun(function(){return e.startTape()},function(){return e.endTape()},function(){return e.tidy("forward",a)});K(f instanceof aF,function(){return"The result y returned by f() must be a tensor."});var g=function(a,b,c){for(var d,e={},f={},g=0;g<b.length;g++)e[b[g].id]=!0;for(g=0;g<a.length;g++){var h=(d=a[g]).inputs;for(var i in h){for(var j=h[i],k=!1,l=0;l<b.length;l++)if(e[j.id]){d.outputs.forEach(function(a){return e[a.id]=!0}),k=!0,f[d.id]=!0;break}if(k)break}}var m={};m[c.id]=!0;var n={};for(g=a.length-1;g>=0;g--)for(h=(d=a[g]).inputs,l=0;l<d.outputs.length;l++)if(m[d.outputs[l].id]){for(var i in h)m[h[i].id]=!0,n[d.id]=!0;break}var o=[];for(g=0;g<a.length;g++)if(f[(d=a[g]).id]&&n[d.id]){var p={};for(var i in d.inputs){var q=d.inputs[i];e[q.id]&&(p[i]=q)}var r=Object.assign({},d);r.inputs=p,r.outputs=d.outputs,o.push(r)}return o}(this.state.activeTape,b,f);if(!d&&0===g.length&&b.length>0)throw Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that the f you passed encloses all operations that lead from x to y.");return this.tidy("backward",function(){var a,d,h={};h[f.id]=null==c?(d=an(O(a=f.shape),"float32"),a_.makeTensor(d,a,"float32")):c,function(a,b,c){for(var d=b.length-1;d>=0;d--)!function(d){var e=b[d],f=[];if(e.outputs.forEach(function(b){var c=a[b.id];null!=c?f.push(c):f.push(null)}),null==e.gradient)throw Error("Cannot compute gradient: gradient function not found for "+e.kernelName+".");var g=e.gradient(f),h=function(b){if(!(b in g))throw Error("Cannot backprop through input "+b+". Available gradients found: "+Object.keys(g)+".");var d=c(function(){return g[b]()});if("float32"!==d.dtype)throw Error("Error in gradient for op "+e.kernelName+". The gradient of input "+b+" must have 'float32' dtype, but has '"+d.dtype+"'");var f=e.inputs[b];if(!P(d.shape,f.shape))throw Error("Error in gradient for op "+e.kernelName+". The gradient of input '"+b+"' has shape '"+d.shape+"', which does not match the shape of the input '"+f.shape+"'");if(null==a[f.id])a[f.id]=d;else{var h=a[f.id];a[f.id]=h.add(d),h.dispose()}};for(var i in e.inputs)h(i)}(d)}(h,g,function(a){return e.tidy(a)});var i=b.map(function(a){return h[a.id]});return 0===e.state.gradientDepth&&(e.state.activeTape.forEach(function(a){for(var b=0,c=a.saved;b<c.length;b++)c[b].dispose()}),e.state.activeTape=null),{value:f,grads:i}})},a.prototype.customGrad=function(a){var b=this;return K(ai(a),function(){return"The f passed in customGrad(f) must be a function."}),function(){for(var c,d=[],e=0;e<arguments.length;e++)d[e]=arguments[e];K(d.every(function(a){return a instanceof aF}),function(){return"The args passed in customGrad(f)(x1, x2,...) must all be tensors"});var f={};return d.forEach(function(a,b){f[b]=a}),b.runKernelFunc(function(b,e){return K((c=a.apply(void 0,d.concat([e]))).value instanceof aF,function(){return"The function f passed in customGrad(f) must return an object where `obj.value` is a tensor"}),K(ai(c.gradFunc),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function."}),c.value},f,function(a,b){var e=c.gradFunc(a,b),f=Array.isArray(e)?e:[e];K(f.length===d.length,function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns the same number of tensors as inputs passed to f(...)."}),K(f.every(function(a){return a instanceof aF}),function(){return"The function f passed in customGrad(f) must return an object where `obj.gradFunc` is a function that returns a list of only tensors."});var g={};return f.forEach(function(a,b){g[b]=function(){return a}}),g})}},a.prototype.readSync=function(a){return this.state.tensorInfo.get(a).backend.readSync(a)},a.prototype.read=function(a){return this.state.tensorInfo.get(a).backend.read(a)},a.prototype.time=function(a){return s(this,void 0,void 0,function(){var b,c;return t(this,function(d){switch(d.label){case 0:return b=ap(),[4,this.backend.time(a)];case 1:return(c=d.sent()).wallMs=ap()-b,[2,c]}})})},a.prototype.track=function(a){return null!=this.state.activeScope&&(a.scopeId=this.state.activeScope.id,this.state.activeScope.track.push(a)),a},Object.defineProperty(a.prototype,"registeredVariables",{get:function(){return this.state.registeredVariables},enumerable:!0,configurable:!0}),a.prototype.reset=function(){for(var a in this.pendingBackendInitId++,this.state.dispose(),this.ENV.reset(),this.state=new aZ,this.registry)this.disposeRegisteredKernels(a),this.registry[a].dispose(),delete this.registry[a];this.backendName=null,this.backendInstance=null,this.pendingBackendInit=null},a.nextTensorId=0,a.nextVariableId=0,a}(),a_=function(){var b=function(){if(null==aX){var b=void 0;aX=b=a.g}return aX}();if(null==b._tfengine){var c=new u(b);b._tfengine=new a$(c)}return w=b._tfengine.ENV,aC=function(){return b._tfengine},b._tfengine}();function a0(){return"undefined"!=typeof WorkerGlobalScope}var a1=w;a1.registerFlag("DEBUG",function(){return!1},function(a){a&&console.warn("Debugging mode is ON. The output of every math call will be downloaded to CPU and checked for NaNs. This significantly impacts performance.")}),a1.registerFlag("IS_BROWSER",function(){return a0()}),a1.registerFlag("IS_NODE",function(){return"undefined"!=typeof process&&void 0!==process.versions&&void 0!==process.versions.node}),a1.registerFlag("IS_CHROME",function(){return"undefined"!=typeof navigator&&null!=navigator&&null!=navigator.userAgent&&/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}),a1.registerFlag("PROD",function(){return!1}),a1.registerFlag("TENSORLIKE_CHECK_SHAPE_CONSISTENCY",function(){return a1.getBool("DEBUG")}),a1.registerFlag("DEPRECATION_WARNINGS_ENABLED",function(){return!0}),a1.registerFlag("IS_TEST",function(){return!1});var a2,a3,a4,a5={},a6={alpha:!1,antialias:!1,premultipliedAlpha:!1,preserveDrawingBuffer:!1,depth:!1,stencil:!1,failIfMajorPerformanceCaveat:!0};function a7(a,b){a5[a]=b}function a8(a){a in a5||(a5[a]=function(a){if(1!==a&&2!==a)throw Error("Cannot get WebGL rendering context, WebGL is disabled.");var b=function(a){if("undefined"!=typeof OffscreenCanvas&&2===a)return new OffscreenCanvas(300,150);if("undefined"!=typeof document)return document.createElement("canvas");throw Error("Cannot create a canvas in this context")}(a);return(b.addEventListener("webglcontextlost",function(b){b.preventDefault(),delete a5[a]},!1),1===a)?b.getContext("webgl",a6)||b.getContext("experimental-webgl",a6):b.getContext("webgl2",a6)}(a));var b=a5[a];return b.isContextLost()?(delete a5[a],a8(a)):(b.disable(b.DEPTH_TEST),b.disable(b.STENCIL_TEST),b.disable(b.BLEND),b.disable(b.DITHER),b.disable(b.POLYGON_OFFSET_FILL),b.disable(b.SAMPLE_COVERAGE),b.enable(b.SCISSOR_TEST),b.enable(b.CULL_FACE),b.cullFace(b.BACK),a5[a])}function a9(a){return S(Math.ceil(O(a)/4))}function ba(a,b){return[Math.max(1,Math.ceil(b/2)),Math.max(1,Math.ceil(a/2))]}function bb(a,b){var c,d,e,f,g,h,i,j,k;return 2===w.getNumber("WEBGL_VERSION")?(c=a.R32F,d=a.R16F,e=a.RGBA16F,f=a.RGBA32F,g=a.RED,h=4,i=1,j=a.HALF_FLOAT):(c=a.RGBA,d=a.RGBA,e=a.RGBA,f=a.RGBA,g=a.RGBA,h=4,i=4,j=null!=b?b.HALF_FLOAT_OES:null),k=a.FLOAT,{internalFormatFloat:c,internalFormatHalfFloat:d,internalFormatPackedHalfFloat:e,internalFormatPackedFloat:f,textureFormatFloat:g,downloadTextureFormat:a.RGBA,downloadUnpackNumChannels:h,defaultNumChannels:i,textureTypeHalfFloat:j,textureTypeFloat:k}}function bc(a,b,c){var d=c();return b&&function(a){var b=a.getError();if(b!==a.NO_ERROR)throw Error("WebGL Error: "+be(a,b))}(a),d}function bd(a){return!!(w.getBool("WEBGL_RENDER_FLOAT32_ENABLED")||0===a||596e-10<Math.abs(a)&&65504>Math.abs(a))}function be(a,b){switch(b){case a.NO_ERROR:return"NO_ERROR";case a.INVALID_ENUM:return"INVALID_ENUM";case a.INVALID_VALUE:return"INVALID_VALUE";case a.INVALID_OPERATION:return"INVALID_OPERATION";case a.INVALID_FRAMEBUFFER_OPERATION:return"INVALID_FRAMEBUFFER_OPERATION";case a.OUT_OF_MEMORY:return"OUT_OF_MEMORY";case a.CONTEXT_LOST_WEBGL:return"CONTEXT_LOST_WEBGL";default:return"Unknown error code "+b}}function bf(a,b,c){return bF(a,b,function(){return a.getExtension(c)},'Extension "'+c+'" not supported on this browser.')}function bg(a,b,c){var d=bF(a,b,function(){return a.createShader(a.VERTEX_SHADER)},"Unable to create vertex WebGLShader.");if(bc(a,b,function(){return a.shaderSource(d,c)}),bc(a,b,function(){return a.compileShader(d)}),!1===a.getShaderParameter(d,a.COMPILE_STATUS))throw console.log(a.getShaderInfoLog(d)),Error("Failed to compile vertex shader.");return d}function bh(a,b,c){var d=bF(a,b,function(){return a.createShader(a.FRAGMENT_SHADER)},"Unable to create fragment WebGLShader.");if(bc(a,b,function(){return a.shaderSource(d,c)}),bc(a,b,function(){return a.compileShader(d)}),!1===a.getShaderParameter(d,a.COMPILE_STATUS))throw function(a,b){var c=bn.exec(b);if(null==c)return console.log("Couldn't parse line number in error: "+b),console.log(a);for(var d=+c[1],e=a.split("\n"),f=e.length.toString().length+2,g=e.map(function(a,b){return T((b+1).toString(),f)+a}),h=0,i=0;i<g.length;i++)h=Math.max(g[i].length,h);var j=g.slice(0,d-1),k=g.slice(d-1,d),l=g.slice(d);console.log(j.join("\n")),console.log(b.split("\n")[0]),console.log("%c "+T(k[0],h),"border:1px solid red; background-color:#e3d2d2; color:#a61717"),console.log(l.join("\n"))}(c,a.getShaderInfoLog(d)),Error("Failed to compile fragment shader.");return d}(bi=a2||(a2={}))[bi.DENSE=0]="DENSE",bi[bi.SHARED_BATCH=1]="SHARED_BATCH",(bj=a3||(a3={}))[bj.RENDER=0]="RENDER",bj[bj.UPLOAD=1]="UPLOAD",bj[bj.PIXELS=2]="PIXELS",bj[bj.DOWNLOAD=3]="DOWNLOAD",(bk=a4||(a4={}))[bk.UNPACKED_FLOAT16=0]="UNPACKED_FLOAT16",bk[bk.UNPACKED_FLOAT32=1]="UNPACKED_FLOAT32",bk[bk.PACKED_4X1_UNSIGNED_BYTE=2]="PACKED_4X1_UNSIGNED_BYTE",bk[bk.PACKED_2X2_FLOAT32=3]="PACKED_2X2_FLOAT32",bk[bk.PACKED_2X2_FLOAT16=4]="PACKED_2X2_FLOAT16";var bi,bj,bk,bl,bm,bn=/ERROR: [0-9]+:([0-9]+):/g;function bo(a,b){return bF(a,b,function(){return a.createProgram()},"Unable to create WebGLProgram.")}function bp(a,b,c){if(bc(a,b,function(){return a.linkProgram(c)}),!1===a.getProgramParameter(c,a.LINK_STATUS))throw console.log(a.getProgramInfoLog(c)),Error("Failed to link vertex and fragment shaders.")}function bq(a,b,c){if(bc(a,b,function(){return a.validateProgram(c)}),!1===a.getProgramParameter(c,a.VALIDATE_STATUS))throw console.log(a.getProgramInfoLog(c)),Error("Shader program validation failed.")}function br(a,b,c){var d=bF(a,b,function(){return a.createBuffer()},"Unable to create WebGLBuffer");return bc(a,b,function(){return a.bindBuffer(a.ARRAY_BUFFER,d)}),bc(a,b,function(){return a.bufferData(a.ARRAY_BUFFER,c,a.STATIC_DRAW)}),d}function bs(a,b,c){var d=bF(a,b,function(){return a.createBuffer()},"Unable to create WebGLBuffer");return bc(a,b,function(){return a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,d)}),bc(a,b,function(){return a.bufferData(a.ELEMENT_ARRAY_BUFFER,c,a.STATIC_DRAW)}),d}function bt(a,b){return bF(a,b,function(){return a.createTexture()},"Unable to create WebGLTexture.")}function bu(a,b){var c=w.getNumber("WEBGL_MAX_TEXTURE_SIZE");if(a<=0||b<=0){var d="["+a+"x"+b+"]";throw Error("Requested texture size "+d+" is invalid.")}if(a>c||b>c)throw Error("Requested texture size "+(d="["+a+"x"+b+"]")+" greater than WebGL maximum on this browser / GPU "+("["+c+"x")+c+"].")}function bv(a,b){return bF(a,b,function(){return a.createFramebuffer()},"Unable to create WebGLFramebuffer.")}function bw(a,b,c,d,e,f,g,h){var i=a.getAttribLocation(c,d);return -1!==i&&(bc(a,b,function(){return a.bindBuffer(a.ARRAY_BUFFER,e)}),bc(a,b,function(){return a.vertexAttribPointer(i,f,a.FLOAT,!1,g,h)}),bc(a,b,function(){return a.enableVertexAttribArray(i)}),!0)}function bx(a,b,c,d){bG(a,d),bc(a,b,function(){return a.activeTexture(a.TEXTURE0+d)}),bc(a,b,function(){return a.bindTexture(a.TEXTURE_2D,c)})}function by(a,b,c,d){return bF(a,b,function(){return a.getUniformLocation(c,d)},'uniform "'+d+'" not present in program.')}function bz(a,b,c){return a.getUniformLocation(b,c)}function bA(a,b,c,d,e,f){bc(a,b,function(){return bx(a,b,d,f)}),bc(a,b,function(){return a.uniform1i(e,f)})}function bB(a,b,c,d){bc(a,b,function(){return a.bindFramebuffer(a.FRAMEBUFFER,d)}),bc(a,b,function(){return a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0)})}function bC(a,b,c){bc(a,b,function(){return a.bindFramebuffer(a.FRAMEBUFFER,c)}),bc(a,b,function(){return a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,null,0)})}function bD(a){var b=a.checkFramebufferStatus(a.FRAMEBUFFER);if(b!==a.FRAMEBUFFER_COMPLETE)throw Error("Error binding framebuffer: "+bE(a,b))}function bE(a,b){switch(b){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:return"FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:return"FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case a.FRAMEBUFFER_UNSUPPORTED:return"FRAMEBUFFER_UNSUPPORTED";default:return"unknown error "+b}}function bF(a,b,c,d){var e=bc(a,b,function(){return c()});if(null==e)throw Error(d);return e}function bG(a,b){var c=a.MAX_COMBINED_TEXTURE_IMAGE_UNITS-1,d=b+a.TEXTURE0;if(d<a.TEXTURE0||d>c)throw Error("textureUnit must be in [gl.TEXTURE0, gl.TEXTURE"+c+"].")}function bH(a,b){return void 0===b&&(b=2),O(a.slice(0,a.length-b))}function bI(a){if(0===a.length)throw Error("Cannot get rows and columns of an empty shape array.");return[a.length>1?a[a.length-2]:1,a[a.length-1]]}function bJ(a){var b=[1,1,1];return 0===a.length||1===a.length&&1===a[0]||(b=[bH(a)].concat(bI(a))),b}function bK(a,b){void 0===b&&(b=!1);var c,d=w.getNumber("WEBGL_MAX_TEXTURE_SIZE");b&&(d*=2,1===(a=a.map(function(b,c){return c>=a.length-2?I(a[c]):a[c]})).length&&(a=[2,a[0]])),2!==a.length&&(a=X(a).newShape);var e=O(a);if(a.length<=1&&e<=d)return[1,e];if(2===a.length&&a[0]<=d&&a[1]<=d)return a;if(3===a.length&&a[0]*a[1]<=d&&a[2]<=d)return[a[0]*a[1],a[2]];if(3===a.length&&a[0]<=d&&a[1]*a[2]<=d)return[a[0],a[1]*a[2]];if(4===a.length&&a[0]*a[1]*a[2]<=d&&a[3]<=d)return[a[0]*a[1]*a[2],a[3]];if(4===a.length&&a[0]<=d&&a[1]*a[2]*a[3]<=d)return[a[0],a[1]*a[2]*a[3]];if(b){var f=bH(a),g=2,h=2;return a.length&&(g=(c=bI(a))[0],h=c[1]),S(e=g/2*f*(h/2)).map(function(a){return 2*a})}return S(e)}function bL(a,b){if(P(a=a.slice(-2),b=b.slice(-2))||!a.length||!b.length||0===a[0]||0===a[1]||0===b[0]||0===b[1])return!0;if(a.length!==b.length){var c=a.slice(-1)[0],d=b.slice(-1)[0];if(c===d||c%2==0&&d%2==0&&(1===a[0]||1===b[0]))return!0}return a[1]===b[1]&&a[0]%2==0&&b[0]%2==0}function bM(a){if(null==bl){var b=a8(a);bl=b.getParameter(b.MAX_TEXTURE_SIZE)}return bl}function bN(a){if(null==bm){var b=a8(a);bm=b.getParameter(b.MAX_TEXTURE_IMAGE_UNITS)}return Math.min(16,bm)}function bO(a){if(0===a)return 0;var b=a8(a);return bP(b,"EXT_disjoint_timer_query_webgl2")&&2===a?2:+!!bP(b,"EXT_disjoint_timer_query")}function bP(a,b){return null!=a.getExtension(b)}function bQ(a){try{if(null!=a8(a))return!0}catch(a){}return!1}function bR(a){if(0===a)return!1;var b=a8(a);if(1===a){if(!bP(b,"OES_texture_float"))return!1}else if(!bP(b,"EXT_color_buffer_float"))return!1;return bT(b)}function bS(a){if(0===a)return!1;var b=a8(a);if(1!==a){if(bP(b,"EXT_color_buffer_float"))return bT(b);if(bP(b,"EXT_color_buffer_half_float")){var c,d,e,f,g=b.getExtension("EXT_color_buffer_half_float");return c=bb(b,g),d=b.createTexture(),b.bindTexture(b.TEXTURE_2D,d),b.texImage2D(b.TEXTURE_2D,0,c.internalFormatHalfFloat,1,1,0,c.textureFormatFloat,c.textureTypeHalfFloat,null),e=b.createFramebuffer(),b.bindFramebuffer(b.FRAMEBUFFER,e),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,d,0),f=b.checkFramebufferStatus(b.FRAMEBUFFER)===b.FRAMEBUFFER_COMPLETE,b.bindTexture(b.TEXTURE_2D,null),b.bindFramebuffer(b.FRAMEBUFFER,null),b.deleteTexture(d),b.deleteFramebuffer(e),f}return!1}return!!bP(b,"OES_texture_float")&&!!bP(b,"WEBGL_color_buffer_float")&&bT(b)}function bT(a){var b=bb(a),c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c),a.texImage2D(a.TEXTURE_2D,0,b.internalFormatFloat,1,1,0,b.textureFormatFloat,b.textureTypeFloat,null);var d=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,d),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,c,0);var e=a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE;return a.bindTexture(a.TEXTURE_2D,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.deleteTexture(c),a.deleteFramebuffer(d),e}function bU(a){return 2===a&&null!=a8(a).fenceSync}var bV=Object.freeze({callAndCheck:bc,canBeRepresented:bd,getWebGLErrorMessage:be,getExtensionOrThrow:bf,createVertexShader:bg,createFragmentShader:bh,createProgram:bo,linkProgram:bp,validateProgram:bq,createStaticVertexBuffer:br,createStaticIndexBuffer:bs,getNumChannels:function(){return 2===w.getNumber("WEBGL_VERSION")?1:4},createTexture:bt,validateTextureSize:bu,createFramebuffer:bv,bindVertexBufferToProgramAttribute:bw,bindTextureUnit:bx,unbindTextureUnit:function(a,b,c){bG(a,c),bc(a,b,function(){return a.activeTexture(a.TEXTURE0+c)}),bc(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)})},getProgramUniformLocationOrThrow:by,getProgramUniformLocation:bz,bindTextureToProgramUniformSampler:bA,bindCanvasToFramebuffer:function(a,b){bc(a,b,function(){return a.bindFramebuffer(a.FRAMEBUFFER,null)}),bc(a,b,function(){return a.viewport(0,0,a.canvas.width,a.canvas.height)}),bc(a,b,function(){return a.scissor(0,0,a.canvas.width,a.canvas.height)})},bindColorTextureToFramebuffer:bB,unbindColorTextureFromFramebuffer:bC,validateFramebuffer:bD,getFramebufferErrorMessage:bE,getBatchDim:bH,getRowsCols:bI,getShapeAs3D:bJ,getTextureShapeFromLogicalShape:bK,isReshapeFree:bL,getWebGLMaxTextureSize:bM,resetMaxTextureSize:function(){bl=null},resetMaxTexturesInShader:function(){bm=null},getMaxTexturesInShader:bN,getWebGLDisjointQueryTimerVersion:bO,hasExtension:bP,isWebGLVersionEnabled:bQ,isCapableOfRenderingToFloatTexture:bR,isDownloadFloatTextureEnabled:bS,isWebGLFenceEnabled:bU}),bW=w;function bX(){w.set("PROD",!0)}function bY(){w.set("DEBUG",!0)}function bZ(){w.set("DEPRECATION_WARNINGS_ENABLED",!1),console.warn("TensorFlow.js deprecation warnings have been disabled.")}function b$(a){w.getBool("DEPRECATION_WARNINGS_ENABLED")&&console.warn(a+" You can disable deprecation warnings with tf.disableDeprecationWarnings().")}function b_(){a_.disposeVariables()}function b0(){return a_}function b1(){return a_.memory()}function b2(a){return a_.profile(a)}function b3(a,b){return a_.tidy(a,b)}function b4(a){aR(a).forEach(function(a){return a.dispose()})}function b5(a){return a_.keep(a)}function b6(a){return a_.time(a)}function b7(a){return a_.setBackend(a)}function b8(){return a_.ready()}function b9(){return a_.backendName}function ca(a){a_.removeBackend(a)}function cb(a){return a_.findBackend(a)}function cc(a){return a_.findBackendFactory(a)}function cd(a,b,c){return void 0===c&&(c=1),a_.registerBackend(a,b,c)}function ce(){return a_.backend}function cf(a,b){w.setPlatform(a,b)}function cg(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];w.getBool("IS_TEST")||console.warn.apply(console,a)}function ch(a,b){var c=a;if(ab(a))return"string"===b?[]:[a.length];if(!Array.isArray(a))return[];for(var d=[];Array.isArray(c)||ab(c)&&"string"!==b;)d.push(c.length),c=c[0];return Array.isArray(a)&&w.getBool("TENSORLIKE_CHECK_SHAPE_CONSISTENCY")&&function a(b,c,d){if(d=d||[],!Array.isArray(b)&&!ab(b))return void K(0===c.length,function(){return"Element arr["+d.join("][")+"] is a primitive, but should be an array/TypedArray of "+c[0]+" elements"});K(c.length>0,function(){return"Element arr["+d.join("][")+"] should be a primitive, but is an array of "+b.length+" elements"}),K(b.length===c[0],function(){return"Element arr["+d.join("][")+"] should have "+c[0]+" elements, but has "+b.length+" elements"});for(var e=c.slice(1),f=0;f<b.length;++f)a(b[f],e,d.concat(f))}(a,d,[]),d}function ci(a,b,c,d){if(null!=a&&("numeric"!==a&&a!==b||"numeric"===a&&"string"===b))throw Error("Argument '"+c+"' passed to '"+d+"' must be "+a+" tensor, but got "+b+" tensor")}function cj(a,b,c,d){if(void 0===d&&(d="numeric"),a instanceof aF)return ci(d,a.dtype,b,c),a;var e=ah(a);if("string"!==e&&["bool","int32","float32"].indexOf(d)>=0&&(e=d),ci(d,e,b,c),null==a||!ab(a)&&!Array.isArray(a)&&"number"!=typeof a&&"boolean"!=typeof a&&"string"!=typeof a)throw Error("Argument '"+b+"' passed to '"+c+"' must be a Tensor or TensorLike, but got '"+(null==a?"null":a.constructor.name)+"'");var f=ch(a,e);ab(a)||Array.isArray(a)||(a=[a]);var g="string"!==e?al(a,e,w.getBool("DEBUG")):N(a,[],!0);return a_.makeTensor(g,f,e)}function ck(a,b,c,d){if(void 0===d&&(d="numeric"),!Array.isArray(a))throw Error("Argument "+b+" passed to "+c+" must be a `Tensor[]` or `TensorLike[]`");return a.map(function(a,d){return cj(a,b+"["+d+"]",c)},d)}function cl(a,b){for(var c=0;c<a.length;++c)if(a[a.length-c-1]!==b-1-c)return!1;return!0}function cm(a,b,c){for(var d=a.length+b.length,e=[],f=0,g=0,h=0;h<d;h++)-1===c.indexOf(h)?e.push(a[f++]):e.push(b[g++]);return e}function cn(a,b){for(var c=[],d=a.length,e=0;e<d;e++)-1===b.indexOf(e)&&c.push(a[e]);return[c,b.map(function(b){return a[b]})]}function co(a,b){return cm(a,b.map(function(a){return 1}),b)}function cp(a,b,c){K(cl(b,c),function(){return a+" supports only inner-most axes for now. Got axes "+b+" and rank-"+c+" input."})}function cq(a,b){if(cl(a,b))return null;for(var c=[],d=0;d<b;++d)-1===a.indexOf(d)&&c.push(d);return a.forEach(function(a){return c.push(a)}),c}function cr(a){return a.map(function(a,b){return[b,a]}).sort(function(a,b){return a[1]-b[1]}).map(function(a){return a[0]})}function cs(a,b){for(var c=[],d=b-a;d<b;++d)c.push(d);return c}function ct(a,b){var c=a[0].length;a.forEach(function(a,b){K(a.length===c,function(){return"Error in concat"+c+"D: rank of tensors["+b+"] must be the same as the rank of the rest ("+c+")"})}),K(b>=0&&b<c,function(){return"Error in concat"+c+"D: axis must be between 0 and "+(c-1)+"."});var d=a[0];a.forEach(function(a,e){for(var f=0;f<c;f++)K(f===b||a[f]===d[f],function(){return"Error in concat"+c+"D: Shape of tensors["+e+"] ("+a+") does not match the shape of the rest ("+d+") along the non-concatenated axis "+e+"."})})}function cu(a,b){for(var c=a[0].slice(),d=1;d<a.length;d++)c[b]+=a[d][b];return c}function cv(a){var b=Object.keys(a);if(1!==b.length)throw Error("Please provide an object with a single key (operation name) mapping to a function. Got an object with "+b.length+" keys.");var c=b[0],d=a[c];c.endsWith("_")&&(c=c.substring(0,c.length-1));var e=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a_.startScope(c);try{var e=d.apply(void 0,a);return e instanceof Promise&&console.error("Cannot return a Promise inside of tidy."),a_.endScope(e),e}catch(a){throw a_.endScope(null),a}};return Object.defineProperty(e,"name",{value:c,configurable:!0}),e}bW.registerFlag("HAS_WEBGL",function(){return bW.getNumber("WEBGL_VERSION")>0}),bW.registerFlag("WEBGL_VERSION",function(){return bQ(2)?2:+!!bQ(1)}),bW.registerFlag("WEBGL_BUFFER_SUPPORTED",function(){return 2===bW.get("WEBGL_VERSION")}),bW.registerFlag("WEBGL_CPU_FORWARD",function(){return!0}),bW.registerFlag("WEBGL_FORCE_F16_TEXTURES",function(){return!1}),bW.registerFlag("WEBGL_PACK",function(){return bW.getBool("HAS_WEBGL")}),bW.registerFlag("WEBGL_PACK_NORMALIZATION",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_PACK_CLIP",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_PACK_DEPTHWISECONV",function(){return!1}),bW.registerFlag("WEBGL_PACK_BINARY_OPERATIONS",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_PACK_UNARY_OPERATIONS",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_PACK_ARRAY_OPERATIONS",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_PACK_IMAGE_OPERATIONS",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_PACK_REDUCE",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_LAZILY_UNPACK",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_CONV_IM2COL",function(){return bW.getBool("WEBGL_PACK")}),bW.registerFlag("WEBGL_MAX_TEXTURE_SIZE",function(){return bM(bW.getNumber("WEBGL_VERSION"))}),bW.registerFlag("WEBGL_MAX_TEXTURES_IN_SHADER",function(){return bN(bW.getNumber("WEBGL_VERSION"))}),bW.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION",function(){var a=bW.getNumber("WEBGL_VERSION");return 0===a?0:bO(a)}),bW.registerFlag("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE",function(){var a;return bW.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0&&(a=navigator.userAgent||navigator.vendor||window.opera,!(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))))}),bW.registerFlag("WEBGL_RENDER_FLOAT32_CAPABLE",function(){return bR(bW.getNumber("WEBGL_VERSION"))}),bW.registerFlag("WEBGL_RENDER_FLOAT32_ENABLED",function(){return!bW.getBool("WEBGL_FORCE_F16_TEXTURES")&&bW.getBool("WEBGL_RENDER_FLOAT32_CAPABLE")}),bW.registerFlag("WEBGL_DOWNLOAD_FLOAT_ENABLED",function(){return bS(bW.getNumber("WEBGL_VERSION"))}),bW.registerFlag("WEBGL_FENCE_API_ENABLED",function(){return bU(bW.getNumber("WEBGL_VERSION"))}),bW.registerFlag("WEBGL_SIZE_UPLOAD_UNIFORM",function(){return 4*!!bW.getBool("WEBGL_RENDER_FLOAT32_ENABLED")}),aE=b$;var cw=cv({complex_:function(a,b){var c=cj(a,"real","complex"),d=cj(b,"imag","complex");return L(c.shape,d.shape,"real and imag shapes, "+c.shape+" and "+d.shape+", must match in call to tf.complex()."),a_.runKernelFunc(function(a){return a.complex(c,d)},{$real:c,$imag:d})}}),cx=cv({real_:function(a){var b=cj(a,"input","real");return a_.runKernelFunc(function(a){return a.real(b)},{$input:b})}}),cy=cv({imag_:function(a){var b=cj(a,"input","imag");return a_.runKernelFunc(function(a){return a.imag(b)},{$input:b})}});function cz(a,b,c){return cA(a,b,ch(a,c),c)}function cA(a,b,c,d){if(null==d&&(d=ah(a)),"complex64"===d)throw Error("Cannot construct a complex64 tensor directly. Please use tf.complex(real, imag).");if(!ab(a)&&!Array.isArray(a)&&"number"!=typeof a&&"boolean"!=typeof a&&"string"!=typeof a)throw Error("values passed to tensor(values) must be a number/boolean/string or an array of numbers/booleans/strings, or a TypedArray");if(null!=b){aq(b);var e=O(b),f=O(c);K(e===f,function(){return"Based on the provided shape, ["+b+"], the tensor should have "+e+" values but has "+f});for(var g=0;g<c.length;++g){var h=c[g],i=g!==c.length-1||h!==O(b.slice(g));K(c[g]===b[g]||!i,function(){return"Error creating a new Tensor. Inferred shape ("+c+") does not match the provided shape ("+b+"). "})}}return ab(a)||Array.isArray(a)||(a=[a]),b=b||c,a="string"!==d?al(a,d,w.getBool("DEBUG")):N(a,[],!0),a_.makeTensor(a,b,d)}function cB(a,b){if((ab(a)&&"string"!==b||Array.isArray(a))&&"complex64"!==b)throw Error("Error creating a new Scalar: value must be a primitive (number|boolean|string)");if("string"===b&&ab(a)&&!(a instanceof Uint8Array))throw Error("When making a scalar from encoded string, the value must be `Uint8Array`.");return cA(a,[],[],b)}function cC(a,b){M(a);var c=ch(a,b);if(1!==c.length)throw Error("tensor1d() requires values to be a flat/TypedArray");return cA(a,null,c,b)}function cD(a,b,c){if(M(a),null!=b&&2!==b.length)throw Error("tensor2d() requires shape to have two numbers");var d=ch(a,c);if(2!==d.length&&1!==d.length)throw Error("tensor2d() requires values to be number[][] or flat/TypedArray");if(1===d.length&&null==b)throw Error("tensor2d() requires shape to be provided when `values` are a flat/TypedArray");return cA(a,b,d,c)}function cE(a,b,c){if(M(a),null!=b&&3!==b.length)throw Error("tensor3d() requires shape to have three numbers");var d=ch(a,c);if(3!==d.length&&1!==d.length)throw Error("tensor3d() requires values to be number[][][] or flat/TypedArray");if(1===d.length&&null==b)throw Error("tensor3d() requires shape to be provided when `values` are a flat array");return cA(a,b,d,c)}function cF(a,b,c){if(M(a),null!=b&&4!==b.length)throw Error("tensor4d() requires shape to have four numbers");var d=ch(a,c);if(4!==d.length&&1!==d.length)throw Error("tensor4d() requires values to be number[][][][] or flat/TypedArray");if(1===d.length&&null==b)throw Error("tensor4d() requires shape to be provided when `values` are a flat array");return cA(a,b,d,c)}function cG(a,b,c){if(M(a),null!=b&&5!==b.length)throw Error("tensor5d() requires shape to have five numbers");var d=ch(a,c);if(5!==d.length&&1!==d.length)throw Error("tensor5d() requires values to be number[][][][][] or flat/TypedArray");if(1===d.length&&null==b)throw Error("tensor5d() requires shape to be provided when `values` are a flat array");return cA(a,b,d,c)}function cH(a,b,c){if(M(a),null!=b&&6!==b.length)throw Error("tensor6d() requires shape to have six numbers");var d=ch(a,c);if(6!==d.length&&1!==d.length)throw Error("tensor6d() requires values to be number[][][][][][] or flat/TypedArray");if(1===d.length&&null==b)throw Error("tensor6d() requires shape to be provided when `values` are a flat array");return cA(a,b=b||d,d,c)}function cI(a,b,c,d){return void 0===b&&(b=!0),a_.makeVariable(a,b,c,d)}function cJ(a,b){if(void 0===b&&(b="float32"),"complex64"===b)return cw(cJ(a,"float32"),cK(a,"float32"));var c=an(O(a),b);return a_.makeTensor(c,a,b)}function cK(a,b){if(void 0===b&&(b="float32"),"complex64"===b)return cw(cK(a,"float32"),cK(a,"float32"));var c=ao(O(a),b);return a_.makeTensor(c,a,b)}function cL(a,b,c){return a_.runKernelFunc(function(d){return d.fill(a,b,c)},{})}function cM(a,b,c){if(c<=0)throw Error("The number of values should be positive.");return a_.runKernelFunc(function(d){return d.linspace(a,b,c)},{})}function cN(a,b,c,d){if(void 0===c&&(c=1),void 0===d&&(d="float32"),0===c)throw Error("Cannot have a step of zero");if(a===b||a<b&&c<0||b<a&&c>1)return cK([0],d);var e=ao(Math.abs(Math.ceil((b-a)/c)),d);b<a&&1===c&&(c=-1),e[0]=a;for(var f=1;f<e.length;f++)e[f]=e[f-1]+c;return cC(e,d)}var cO=cv({onesLike_:function(a){var b=cj(a,"x","onesLike");return"complex64"===b.dtype?cw(cO(cx(b)),cP(cy(b))):a_.runKernelFunc(function(a){return a.onesLike(b)},{$x:b},function(a,b){return{$x:function(){return cP(a)}}})}}),cP=cv({zerosLike_:function(a){var b=cj(a,"x","zerosLike");return a_.runKernelFunc(function(a){return a.zerosLike(b)},{$x:b},function(a,b){return{$x:function(){return cP(a)}}})}}),cQ=cv({concat_:function(a,b){void 0===b&&(b=0),K(a.length>=1,function(){return"Pass at least one tensor to concat"});var c=ck(a,"tensors","concat");"complex64"===c[0].dtype&&c.forEach(function(a){if("complex64"!==a.dtype)throw Error("Cannot concatenate complex64 tensors with a tensor\n          with dtype "+a.dtype+". ")}),b=W(b,c[0].shape)[0];var d=cu(c.map(function(a){return a.shape}),b);if(0===O(d))return cz([],d);if(1===(c=c.filter(function(a){return a.size>0})).length)return c[0];var e=c.map(function(a){return a.shape});ct(e,b);var f=c,g={axis:b};return a_.runKernelFunc(function(a){return a.concat(c,b)},f,function(a){return cV(a,e.map(function(a){return a[b]}),b).map(function(a){return function(){return a}})},"Concat",g)}}),cR=cv({concat1d_:function(a){return cQ(a,0)}}),cS=cv({concat2d_:function(a,b){return cQ(a,b)}}),cT=cv({concat3d_:function(a,b){return cQ(a,b)}}),cU=cv({concat4d_:function(a,b){return cQ(a,b)}}),cV=cv({split_:function(a,b,c){void 0===c&&(c=0);var d,e=cj(a,"x","split");return c=W(c,e.shape)[0],"number"==typeof b?(K(e.shape[c]%b==0,function(){return"Number of splits must evenly divide the axis."}),d=Array(b).fill(e.shape[c]/b)):(K(e.shape[c]===b.reduce(function(a,b){return a+b}),function(){return"The sum of sizes must match the size of the axis dimension."}),d=b),a_.runKernelFunc(function(a){return a.split(e,d,c)},{$x:e},function(a){return{$x:function(){return cQ(a,c)}}})}});function cW(a,b){return a(b={exports:{}},b.exports),b.exports}"undefined"!=typeof globalThis||a.g;var cX=cW(function(a){!function(a,b,c){function d(a){var b,c=this,d=(b=0xefc8249d,function(a){a=a.toString();for(var c=0;c<a.length;c++){var d=.02519603282416938*(b+=a.charCodeAt(c));d-=b=d>>>0,b=(d*=b)>>>0,b+=0x100000000*(d-=b)}return 23283064365386963e-26*(b>>>0)});c.next=function(){var a=2091639*c.s0+23283064365386963e-26*c.c;return c.s0=c.s1,c.s1=c.s2,c.s2=a-(c.c=0|a)},c.c=1,c.s0=d(" "),c.s1=d(" "),c.s2=d(" "),c.s0-=d(a),c.s0<0&&(c.s0+=1),c.s1-=d(a),c.s1<0&&(c.s1+=1),c.s2-=d(a),c.s2<0&&(c.s2+=1),d=null}function e(a,b){return b.c=a.c,b.s0=a.s0,b.s1=a.s1,b.s2=a.s2,b}function f(a,b){var c=new d(a),f=b&&b.state,g=c.next;return g.int32=function(){return 0x100000000*c.next()|0},g.double=function(){return g()+11102230246251565e-32*(2097152*g()|0)},g.quick=g,f&&("object"==typeof f&&e(f,c),g.state=function(){return e(c,{})}),g}b&&b.exports?b.exports=f:this.alea=f}(0,a,0)}),cY=cW(function(a){!function(a,b,c){function d(a){var b=this,c="";b.x=0,b.y=0,b.z=0,b.w=0,b.next=function(){var a=b.x^b.x<<11;return b.x=b.y,b.y=b.z,b.z=b.w,b.w^=b.w>>>19^a^a>>>8},a===(0|a)?b.x=a:c+=a;for(var d=0;d<c.length+64;d++)b.x^=c.charCodeAt(d),b.next()}function e(a,b){return b.x=a.x,b.y=a.y,b.z=a.z,b.w=a.w,b}function f(a,b){var c=new d(a),f=b&&b.state,g=function(){return(c.next()>>>0)/0x100000000};return g.double=function(){do var a=((c.next()>>>11)+(c.next()>>>0)/0x100000000)/2097152;while(0===a)return a},g.int32=c.next,g.quick=g,f&&("object"==typeof f&&e(f,c),g.state=function(){return e(c,{})}),g}b&&b.exports?b.exports=f:this.xor128=f}(0,a,0)}),cZ=cW(function(a){!function(a,b,c){function d(a){var b=this,c="";b.next=function(){var a=b.x^b.x>>>2;return b.x=b.y,b.y=b.z,b.z=b.w,b.w=b.v,(b.d=b.d+362437|0)+(b.v=b.v^b.v<<4^a^a<<1)|0},b.x=0,b.y=0,b.z=0,b.w=0,b.v=0,a===(0|a)?b.x=a:c+=a;for(var d=0;d<c.length+64;d++)b.x^=c.charCodeAt(d),d==c.length&&(b.d=b.x<<10^b.x>>>4),b.next()}function e(a,b){return b.x=a.x,b.y=a.y,b.z=a.z,b.w=a.w,b.v=a.v,b.d=a.d,b}function f(a,b){var c=new d(a),f=b&&b.state,g=function(){return(c.next()>>>0)/0x100000000};return g.double=function(){do var a=((c.next()>>>11)+(c.next()>>>0)/0x100000000)/2097152;while(0===a)return a},g.int32=c.next,g.quick=g,f&&("object"==typeof f&&e(f,c),g.state=function(){return e(c,{})}),g}b&&b.exports?b.exports=f:this.xorwow=f}(0,a,0)}),c$=cW(function(a){!function(a,b,c){function d(a){var b=this;b.next=function(){var a,c,d=b.x,e=b.i;return a=d[e],c=(a^=a>>>7)^a<<24^((a=d[e+1&7])^a>>>10)^((a=d[e+3&7])^a>>>3)^((a=d[e+4&7])^a<<7),a=d[e+7&7],c^=(a^=a<<13)^a<<9,d[e]=c,b.i=e+1&7,c},function(a,b){var c,d=[];if(b===(0|b))d[0]=b;else for(b=""+b,c=0;c<b.length;++c)d[7&c]=d[7&c]<<15^b.charCodeAt(c)+d[c+1&7]<<13;for(;d.length<8;)d.push(0);for(c=0;c<8&&0===d[c];++c);for(8==c?d[7]=-1:d[c],a.x=d,a.i=0,c=256;c>0;--c)a.next()}(b,a)}function e(a,b){return b.x=a.x.slice(),b.i=a.i,b}function f(a,b){null==a&&(a=+new Date);var c=new d(a),f=b&&b.state,g=function(){return(c.next()>>>0)/0x100000000};return g.double=function(){do var a=((c.next()>>>11)+(c.next()>>>0)/0x100000000)/2097152;while(0===a)return a},g.int32=c.next,g.quick=g,f&&(f.x&&e(f,c),g.state=function(){return e(c,{})}),g}b&&b.exports?b.exports=f:this.xorshift7=f}(0,a,0)}),c_=cW(function(a){!function(a,b,c){function d(a){var b=this;b.next=function(){var a,c,d=b.w,e=b.X,f=b.i;return b.w=d=d+0x61c88647|0,c=e[f+34&127],a=e[f=f+1&127],c^=c<<13,a^=a<<17,c^=c>>>15,a^=a>>>12,c=e[f]=c^a,b.i=f,c+(d^d>>>16)|0},function(a,b){var c,d,e,f,g,h=[],i=128;for(b===(0|b)?(d=b,b=null):(b+="\0",d=0,i=Math.max(i,b.length)),e=0,f=-32;f<i;++f)b&&(d^=b.charCodeAt((f+32)%b.length)),0===f&&(g=d),d^=d<<10,d^=d>>>15,d^=d<<4,d^=d>>>13,f>=0&&(g=g+0x61c88647|0,e=0==(c=h[127&f]^=d+g)?e+1:0);for(e>=128&&(h[127&(b&&b.length||0)]=-1),e=127,f=512;f>0;--f)d=h[e+34&127],c=h[e=e+1&127],d^=d<<13,c^=c<<17,d^=d>>>15,c^=c>>>12,h[e]=d^c;a.w=g,a.X=h,a.i=e}(b,a)}function e(a,b){return b.i=a.i,b.w=a.w,b.X=a.X.slice(),b}function f(a,b){null==a&&(a=+new Date);var c=new d(a),f=b&&b.state,g=function(){return(c.next()>>>0)/0x100000000};return g.double=function(){do var a=((c.next()>>>11)+(c.next()>>>0)/0x100000000)/2097152;while(0===a)return a},g.int32=c.next,g.quick=g,f&&(f.X&&e(f,c),g.state=function(){return e(c,{})}),g}b&&b.exports?b.exports=f:this.xor4096=f}(0,a,0)}),c0=cW(function(a){!function(a,b,c){function d(a){var b=this,c="";b.next=function(){var a=b.b,c=b.c,d=b.d,e=b.a;return a=a<<25^a>>>7^c,c=c-d|0,d=d<<24^d>>>8^e,e=e-a|0,b.b=a=a<<20^a>>>12^c,b.c=c=c-d|0,b.d=d<<16^c>>>16^e,b.a=e-a|0},b.a=0,b.b=0,b.c=-0x61c88647,b.d=0x517cc1b7,a===Math.floor(a)?(b.a=a/0x100000000|0,b.b=0|a):c+=a;for(var d=0;d<c.length+20;d++)b.b^=c.charCodeAt(d),b.next()}function e(a,b){return b.a=a.a,b.b=a.b,b.c=a.c,b.d=a.d,b}function f(a,b){var c=new d(a),f=b&&b.state,g=function(){return(c.next()>>>0)/0x100000000};return g.double=function(){do var a=((c.next()>>>11)+(c.next()>>>0)/0x100000000)/2097152;while(0===a)return a},g.int32=c.next,g.quick=g,f&&("object"==typeof f&&e(f,c),g.state=function(){return e(c,{})}),g}b&&b.exports?b.exports=f:this.tychei=f}(0,a,0)}),c1=cW(function(b){!function(c,d){var e,f=this,g="random",h=d.pow(256,6),i=d.pow(2,52),j=2*i;function k(a,b,k){var p=[],q=n(function a(b,c){var d,e=[],f=typeof b;if(c&&"object"==f)for(d in b)try{e.push(a(b[d],c-1))}catch(a){}return e.length?e:"string"==f?b:b+"\0"}((b=1==b?{entropy:!0}:b||{}).entropy?[a,o(c)]:null==a?function(){try{var a;return e&&(a=e.randomBytes)?a=a(256):(a=new Uint8Array(256),(f.crypto||f.msCrypto).getRandomValues(a)),o(a)}catch(a){var b=f.navigator,d=b&&b.plugins;return[+new Date,f,d,f.screen,o(c)]}}():a,3),p),r=new l(p),s=function(){for(var a=r.g(6),b=h,c=0;a<i;)a=(a+c)*256,b*=256,c=r.g(1);for(;a>=j;)a/=2,b/=2,c>>>=1;return(a+c)/b};return s.int32=function(){return 0|r.g(4)},s.quick=function(){return r.g(4)/0x100000000},s.double=s,n(o(r.S),c),(b.pass||k||function(a,b,c,e){return e&&(e.S&&m(e,r),a.state=function(){return m(r,{})}),c?(d[g]=a,b):a})(s,q,"global"in b?b.global:this==d,b.state)}function l(a){var b,c=a.length,d=this,e=0,f=d.i=d.j=0,g=d.S=[];for(c||(a=[c++]);e<256;)g[e]=e++;for(e=0;e<256;e++)g[e]=g[f=255&f+a[e%c]+(b=g[e])],g[f]=b;(d.g=function(a){for(var b,c=0,e=d.i,f=d.j,g=d.S;a--;)b=g[e=255&e+1],c=256*c+g[255&(g[e]=g[f=255&f+b])+(g[f]=b)];return d.i=e,d.j=f,c})(256)}function m(a,b){return b.i=a.i,b.j=a.j,b.S=a.S.slice(),b}function n(a,b){for(var c,d=a+"",e=0;e<d.length;)b[255&e]=255&(c^=19*b[255&e])+d.charCodeAt(e++);return o(b)}function o(a){return String.fromCharCode.apply(0,a)}if(d["seed"+g]=k,n(d.random(),c),b.exports){b.exports=k;try{e=a.r(54799)}catch(a){}}}([],Math)});c1.alea=cX,c1.xor128=cY,c1.xorwow=cZ,c1.xorshift7=c$,c1.xor4096=c_,c1.tychei=c0;var c2=c1.alea,c3=function(){function a(a,b,c,d,e){this.mean=a,this.stdDev=b,this.dtype=c,this.nextVal=NaN,this.truncated=d,this.truncated&&(this.upper=this.mean+2*this.stdDev,this.lower=this.mean-2*this.stdDev);var f=e||Math.random();this.random=c2(f.toString())}return a.prototype.nextValue=function(){if(!isNaN(this.nextVal)){var a=this.nextVal;return this.nextVal=NaN,a}for(var b,c,d=!1;!d;){var e=void 0,f=void 0,g=void 0;do g=(e=2*this.random()-1)*e+(f=2*this.random()-1)*f;while(g>=1||0===g)var h=Math.sqrt(-2*Math.log(g)/g);b=this.mean+this.stdDev*e*h,c=this.mean+this.stdDev*f*h,this.truncated&&!this.isValidTruncated(b)||(d=!0)}return this.truncated&&!this.isValidTruncated(c)||(this.nextVal=this.convertValue(c)),this.convertValue(b)},a.prototype.convertValue=function(a){return null==this.dtype||"float32"===this.dtype?a:Math.round(a)},a.prototype.isValidTruncated=function(a){return a<=this.upper&&a>=this.lower},a}(),c4=function(){function a(a,b,c,d){this.alpha=a,this.beta=1/b,this.dtype=c;var e=d||Math.random();this.randu=c2(e.toString()),this.randn=new c3(0,1,c,!1,this.randu()),this.d=a<1?a+2/3:a-1/3,this.c=1/Math.sqrt(9*this.d)}return a.prototype.nextValue=function(){for(var a,b,c,d,e,f;;){do d=this.randn.nextValue(),f=1+this.c*d;while(f<=0)if(f*=f*f,b=1-.331*(a=d*d)*a,c=.5*a+this.d*(1-f+Math.log(f)),(e=this.randu())<b||Math.log(e)<c)break}return f=1/this.beta*this.d*f,this.alpha<1&&(f*=Math.pow(this.randu(),1/this.alpha)),this.convertValue(f)},a.prototype.convertValue=function(a){return"float32"===this.dtype?a:Math.round(a)},a}(),c5=function(){function a(a,b,c,d){var e=this;if(void 0===a&&(a=0),void 0===b&&(b=1),this.canReturnFloat=function(){return null==e.dtype||"float32"===e.dtype},this.min=a,this.range=b-a,this.dtype=c,null==d&&(d=Math.random()),"number"==typeof d&&(d=d.toString()),!this.canReturnFloat()&&this.range<=1)throw Error("The difference between "+a+" - "+b+" <= 1 and dtype is not float");this.random=c2(d)}return a.prototype.convertValue=function(a){return this.canReturnFloat()?a:Math.round(a)},a.prototype.nextValue=function(){return this.convertValue(this.min+this.range*this.random())},a}();function c6(a,b,c){return void 0===b&&(b="float32"),b=b||"float32",aq(a),new aB(a,b,c)}function c7(a,b){void 0===b&&(b=!1),console.log(a.toString(b))}var c8=cv({batchToSpaceND_:function(a,b,c){var d=cj(a,"x","batchToSpaceND"),e=b.reduce(function(a,b){return a*b});return K(d.rank>=1+b.length,function(){return"input rank is "+d.rank+" but should be > than blockShape.length "+b.length}),K(c.length===b.length,function(){return"crops.length is "+c.length+" but should be equal to blockShape.length  "+b.length}),K(d.shape[0]%e==0,function(){return"input tensor batch is "+d.shape[0]+" but is not divisible by the product of the elements of blockShape "+b.join(" * ")+" === "+e}),a_.runKernelFunc(function(a){return a.batchToSpaceND(d,b,c)},{$x:d},function(a){return{$x:function(){return a.spaceToBatchND(b,c)}}})}}),c9=cv({broadcastTo_:function(a,b){var c=cj(a,"broadcastTo","x"),d=c.shape;if(b.some(function(a){return!(a>0)||a%1!=0}))throw Error("broadcastTo(): Invalid broadcast shape ["+b+"].");if(b.length<c.rank)throw Error("broadcastTo(): shape.length="+b.length+" < input.rank="+c.rank+".");if(b.length>c.rank){for(var e=c.shape.slice();e.length<b.length;)e.unshift(1);c=c.reshape(e)}for(var f=Array.from(b),g=b.length-1;g>=0;g--)if(c.shape[g]===b[g])f[g]=1;else if(1!==c.shape[g])throw Error("broadcastTo(): ["+d+"] cannot be broadcast to ["+b+"].");var h=f.map(function(a,b){return a>1?b:-1}).filter(function(a){return a>=0});return 0===h.length?c.clone():a_.runKernelFunc(function(a){return a.tile(c,f)},{input:c},function(a){return{input:function(){return a.sum(h,!0)}}})}}),da=cv({cast_:function(a,b){var c=cj(a,"x","cast");if(!_(b))throw Error("Failed to cast to unknown dtype "+b);if("string"===b&&"string"!==c.dtype||"string"!==b&&"string"===c.dtype)throw Error("Only strings can be casted to strings");return a_.runKernelFunc(function(a){return a.cast(c,b)},{x:c},function(a){return{x:function(){return a.clone()}}},"Cast",{dtype:b})}}),db=cv({clone_:function(a){var b=cj(a,"x","clone",null);return a_.runKernelFunc(function(){return a_.makeTensorFromDataId(b.dataId,b.shape,b.dtype)},{$x:b},function(a){return{$x:function(){return a.toFloat()}}})}}),dc=cv({cumsum_:function(a,b,c,d){void 0===b&&(b=0),void 0===c&&(c=!1),void 0===d&&(d=!1);var e=cj(a,"x","cumsum"),f=cq([b|=0],e.rank),g=e;null!=f&&(g=e.transpose(f));var h=cs(1,e.rank)[0],i=a_.runKernelFunc(function(a){return a.cumsum(g,h,c,d)},{permutedX:g},function(a){return{permutedX:function(){return a.cumsum(b,c,!d)}}});return null!=f&&(i=i.transpose(f)),i}}),dd=cv({depthToSpace_:function(a,b,c){void 0===c&&(c="NHWC");var d=cj(a,"x","depthToSpace"),e="NHWC"===c?d.shape[1]:d.shape[2],f="NHWC"===c?d.shape[2]:d.shape[3],g="NHWC"===c?d.shape[3]:d.shape[1];return K(e*b>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+e+" and "+b+"  for depthToSpace with input shape\n      "+d.shape}),K(f*b>=0,function(){return"Negative dimension size caused by overflow when multiplying\n      "+f+" and "+b+" for depthToSpace with input shape\n          "+d.shape}),K(g%(b*b)==0,function(){return"Dimension size must be evenly divisible by "+b*b+" but is "+g+" for depthToSpace with input shape "+d.shape}),a_.runKernelFunc(function(a){return a.depthToSpace(d,b,c)},{$x:d})}}),de=cv({expandDims_:function(a,b){void 0===b&&(b=0);var c=cj(a,"x","expandDims",null);K(b<=c.rank,function(){return"Axis must be <= rank of the tensor"});var d=c.shape.slice();return b<0&&(K(-(c.rank+1)<=b,function(){return"Axis must be in the interval ["+-(c.rank+1)+", "+c.rank+"]"}),b=c.rank+b+1),d.splice(b,0,1),ds(c,d)}}),df=cv({eye_:function(a,b,c,d){void 0===d&&(d="float32"),null==b&&(b=a);for(var e=c6([a,b],d),f=a<=b?a:b,g=0;g<f;++g)e.set(1,g,g);var h=e.toTensor().as2D(a,b);if(null==c)return h;if(1===c.length)return dw(de(h,0),[c[0],1,1]);if(2===c.length)return dw(de(de(h,0),0),[c[0],c[1],1,1]);if(3===c.length)return dw(de(de(de(h,0),0),0),[c[0],c[1],c[2],1,1]);throw Error("eye() currently supports only 1D and 2D batchShapes, but received "+c.length+"D.")}}),dg=cv({multinomial_:function(a,b,c,d){void 0===d&&(d=!1);var e=cj(a,"logits","multinomial"),f=e.size,g=e.rank;if(f<2)throw Error("Error in multinomial: you need at least 2 outcomes, but got "+f+".");if(g>2)throw Error("Rank of probabilities must be 1 or 2, but is "+g);c=c||Math.random();var h=1===g?e.as2D(1,-1):e,i=a_.runKernelFunc(function(a){return a.multinomial(h,d,b,c)},{logits2D:h});return 1===g?i.as1D():i}}),dh=cv({oneHot_:function(a,b,c,d){if(void 0===c&&(c=1),void 0===d&&(d=0),b<2)throw Error("Error in oneHot: depth must be >=2, but it is "+b);var e=cj(a,"indices","oneHot","int32"),f=e.shape.concat([b]);return e=e.flatten(),a_.runKernelFunc(function(a){return a.oneHot(e,b,c,d)},{$indices:e},function(a){return{$indices:function(){return cK(e.shape,"float32")}}}).reshape(f)}}),di=cv({pad_:function(a,b,c){void 0===c&&(c=0);var d=cj(a,"x","pad");if(0===d.rank)throw Error("pad(scalar) is not defined. Pass non-scalar to pad");var e={paddings:b,constantValue:c};return a_.runKernelFunc(function(a){return a.pad(d,b,c)},{x:d},function(a){var c=b.map(function(a){return a[0]});return{x:function(){return a.slice(c,d.shape)}}},"PadV2",e)}}),dj=cv({pad1d_:function(a,b,c){return void 0===c&&(c=0),K(2===b.length,function(){return"Invalid number of paddings. Must be length of 2."}),di(a,[b],c)}}),dk=cv({pad2d_:function(a,b,c){return void 0===c&&(c=0),K(2===b.length&&2===b[0].length&&2===b[1].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),di(a,b,c)}}),dl=cv({pad3d_:function(a,b,c){return void 0===c&&(c=0),K(3===b.length&&2===b[0].length&&2===b[1].length&&2===b[2].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),di(a,b,c)}}),dm=cv({pad4d_:function(a,b,c){return void 0===c&&(c=0),K(4===b.length&&2===b[0].length&&2===b[1].length&&2===b[2].length&&2===b[3].length,function(){return"Invalid number of paddings. Must be length of 2 each."}),di(a,b,c)}}),dn=cv({rand_:function(a,b,c){var d=O(a),e=null;if(null==c||"float32"===c)e=new Float32Array(d);else if("int32"===c)e=new Int32Array(d);else{if("bool"!==c)throw Error("Unknown data type "+c);e=new Uint8Array(d)}for(var f=0;f<d;f++)e[f]=b();return a_.makeTensor(e,a,c)}}),dp=cv({randomNormal_:function(a,b,c,d,e){if(void 0===b&&(b=0),void 0===c&&(c=1),null!=d&&"bool"===d)throw Error("Unsupported data type "+d);for(var f=new c3(b,c,d,!1,e),g=c6(a,d),h=0;h<g.values.length;h++)g.values[h]=f.nextValue();return g.toTensor()}}),dq=cv({randomGamma_:function(a,b,c,d,e){if(void 0===c&&(c=1),void 0===d&&(d="float32"),null==c&&(c=1),null==d&&(d="float32"),"float32"!==d&&"int32"!==d)throw Error("Unsupported data type "+d);for(var f=new c4(b,c,d,e),g=c6(a,d),h=0;h<g.values.length;h++)g.values[h]=f.nextValue();return g.toTensor()}}),dr=cv({randomUniform_:function(a,b,c,d,e){void 0===b&&(b=0),void 0===c&&(c=1),void 0===d&&(d="float32");for(var f=c6(a,d),g=new c5(b,c,null,e),h=0;h<f.values.length;h++)f.values[h]=g.nextValue();return f.toTensor()}}),ds=cv({reshape_:function(a,b){var c=cj(a,"x","reshape",null);b=V(b,c.size),K(c.size===O(b),function(){return"new shape and old shape must have the same number of elements."});var d={shape:b};return a_.runKernelFunc(function(a){return a.reshape(c,b)},{x:c},function(a){return{x:function(){return a.reshape(c.shape)}}},"Reshape",d)}}),dt=cv({spaceToBatchND_:function(a,b,c){var d=cj(a,"x","spaceToBatchND");return K(d.rank>=1+b.length,function(){return"input rank "+d.rank+" should be > than [blockShape] "+b.length}),K(c.length===b.length,function(){return"paddings.shape[0] "+c.length+" must be equal to [blockShape] "+b.length}),K(d.shape.reduce(function(a,d,e){return e>0&&e<=b.length?a&&(d+c[e-1][0]+c[e-1][1])%b[e-1]==0:a},!0),function(){return"input spatial dimensions "+d.shape.slice(1)+" with paddings "+c.toString()+" must be divisible by blockShapes "+b.toString()}),a_.runKernelFunc(function(a){return a.spaceToBatchND(d,b,c)},{$x:d},function(a){return{$x:function(){return a.batchToSpaceND(b,c)}}})}}),du=cv({squeeze_:function(a,b){var c=cj(a,"x","squeeze");return ds(c,X(c.shape,b).newShape)}}),dv=cv({stack_:function(a,b){void 0===b&&(b=0);var c=ck(a,"tensors","stack");if(K(c.length>=1,function(){return"Pass at least one tensor to tf.stack"}),1===c.length)return c[0].expandDims(b);var d=c[0].rank,e=c[0].shape,f=c[0].dtype;return K(b<=d,function(){return"Axis must be <= rank of the tensor"}),c.forEach(function(a){L(e,a.shape,"All tensors passed to stack must have matching shapes")}),c.forEach(function(a){K(f===a.dtype,function(){return"All tensors passed to stack must have matching dtypes"})}),cQ(c.map(function(a){return a.expandDims(b)}),b)}}),dw=cv({tile_:function(a,b){var c=cj(a,"x","tile",null);K(c.rank===b.length,function(){return"Error in transpose: rank of input "+c.rank+" must match length of reps "+b+"."});var d=[c];return a_.runKernelFunc(function(a,d){var e=a.tile(c,b);return d([c]),e},{x:c},function(a,c){var d=c[0];return{x:function(){var c=cP(d);if(1===d.rank)for(var e=0;e<b[0];++e)c=c.add(a.slice([e*d.shape[0]],[d.shape[0]]));else if(2===d.rank)for(e=0;e<b[0];++e)for(var f=0;f<b[1];++f)c=c.add(a.slice([e*d.shape[0],f*d.shape[1]],[d.shape[0],d.shape[1]]));else if(3===d.rank)for(e=0;e<b[0];++e)for(f=0;f<b[1];++f)for(var g=0;g<b[2];++g)c=c.add(a.slice([e*d.shape[0],f*d.shape[1],g*d.shape[2]],[d.shape[0],d.shape[1],d.shape[2]]));else{if(4!==d.rank)throw Error("Gradient for tile operation is not implemented for rank-"+d.rank+" tensors yet.");for(e=0;e<b[0];++e)for(f=0;f<b[1];++f)for(g=0;g<b[2];++g)for(var h=0;h<b[3];++h)c=c.add(a.slice([e*d.shape[0],f*d.shape[1],g*d.shape[2],h*d.shape[3]],[d.shape[0],d.shape[1],d.shape[2],d.shape[3]]))}return c}}},"Tile",{reps:b},d)}}),dx=cv({truncatedNormal_:function(a,b,c,d,e){if(void 0===b&&(b=0),void 0===c&&(c=1),null!=d&&"bool"===d)throw Error("Unsupported data type "+d);for(var f=new c3(b,c,d,!0,e),g=c6(a,d),h=0;h<g.values.length;h++)g.values[h]=f.nextValue();return g.toTensor()}}),dy=cv({unstack_:function(a,b){void 0===b&&(b=0),b=b||0;var c=cj(a,"x","unstack");K(b>=-c.shape.length&&b<c.shape.length,function(){return"Axis = "+b+" is not in [-"+c.shape.length+", "+c.shape.length+")"}),b<0&&(b+=c.shape.length);var d={axis:b};return a_.runKernelFunc(function(a){return a.unstack(c,b)},{x:c},function(a){return{x:function(){return dv(a,b)}}},"Unpack",d)}}),dz=function(a,b){return s(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k;return t(this,function(l){switch(l.label){case 0:return c=cj(a,"x","setdiff1d"),d=cj(b,"y","setdiff1d"),K(c.dtype===d.dtype,function(){return"x and y should have the same dtype, but got x ("+c.dtype+") and y ("+d.dtype+")."}),K(1===c.rank,function(){return"x should be 1D tensor, but got x ("+c.shape+")."}),K(1===d.rank,function(){return"y should be 1D tensor, but got y ("+d.shape+")."}),[4,c.data()];case 1:return e=l.sent(),[4,d.data()];case 2:for(f=new Set(l.sent()),g=0,j=0;j<e.length;j++)f.has(e[j])||g++;for(h=new aB([g],c.dtype),i=new aB([g],"int32"),j=0,k=0;j<e.length;j++)f.has(e[j])||(h.values[k]=e[j],i.values[k]=j,k++);return[2,[h.toTensor(),i.toTensor()]]}})})};function dA(a,b,c,d){void 0===d&&(d=!0);var e=[];if(d)(e=e.concat(b.slice(0))).push(a[0]/c),e=e.concat(a.slice(1));else{e=e.concat(a[0]);for(var f=b.length,g=0;g<f;++g)e=e.concat([a[g+1]/b[g],b[g]]);e=e.concat(a.slice(f+1))}return e}function dB(a,b,c){void 0===c&&(c=!0);var d=[];if(c){d.push(b);for(var e=b+1;e<a;++e)e<=2*b?(d.push(e),d.push(e-(b+1))):d.push(e)}else{var f=[],g=[];for(e=1;e<a;++e)e>=2*b+1||e%2==1?g.push(e):f.push(e);d.push.apply(d,f),d.push(0),d.push.apply(d,g)}return d}function dC(a,b,c,d){void 0===d&&(d=!0);var e=[];d?e.push(a[0]/c):e.push(a[0]*c);for(var f=1;f<a.length;++f)f<=b.length?d?e.push(b[f-1]*a[f]):e.push(a[f]/b[f-1]):e.push(a[f]);return e}function dD(a,b){for(var c=[0],d=0;d<b;++d)c.push(a[d][0]);return c}function dE(a,b,c){for(var d=a.slice(0,1),e=0;e<c;++e)d.push(a[e+1]-b[e][0]-b[e][1]);return d}function dF(a,b){if(a.rank<1)throw Error("tf.gatherND() expects the input to be rank 1 or higher, but the rank was "+a.rank+".");if(b.rank<1)throw Error("tf.gatherND() expects the indices to be rank 1 or higher, but the rank was "+b.rank+".");if("int32"!==b.dtype)throw Error("tf.gatherND() expects the indices to be int32 type, but the dtype was "+b.dtype+".");if(b.shape[b.rank-1]>a.rank)throw Error("index innermost dimension length must be <= tensor rank; saw: "+b.shape[b.rank-1]+" vs. "+a.rank);if(0===a.size)throw Error("Requested more than 0 entries, but input is empty. Input shape: "+a.shape+".");for(var c=b.shape,d=c[c.length-1],e=1,f=0;f<c.length-1;++f)e*=c[f];var g=a.shape,h=c.slice();h.pop();var i=1;for(f=d;f<a.rank;++f)i*=g[f],h.push(g[f]);var j=ak(a.shape).map(function(a){return a/i}).concat([1]).slice(0,d);return[h,e,i,j]}var dG=Object.freeze({prepareAndValidate:dF});function dH(a){return a<=30?a:aj(a,Math.floor(Math.sqrt(a)))}function dI(a,b,c){var d=b.rank>1?b.shape[b.rank-1]:1,e=b.rank>1?b.rank-1:1,f="Must have updates.shape = indices.shape[:batchDim] + shape[sliceDim:], got updates.shape: "+c.shape+", indices.shape: "+b.shape+", shape: "+a+", sliceDim: "+d+", and batchDim: "+e+".";if(c.rank<e)throw Error(f+" update.rank < "+e+". ");if(a.length<d+(c.rank-e))throw Error(f+" Output shape length < "+(d+(c.rank-e)));if(c.rank!==e+a.length-d)throw Error(f+" update.rank != "+(e+a.length-d));for(var g=0;g<e;++g)if(c.shape[g]!==b.shape[g])throw Error(f+" updates.shape["+g+"] ("+c.shape[g]+") != indices.shape["+g+"] ("+b.shape[g]+").");for(g=0;g<c.rank-e;++g)if(c.shape[g+e]!==a[g+d])throw Error(f+" updates.shape["+(g+e)+"] ("+c.shape[g+e]+") != shape["+(g+e)+"] ("+a[g+e]+")")}function dJ(a,b,c){if(b.rank<1)throw Error("tf.scatterND() expects the indices to be rank 1 or higher, but the rank was "+b.rank+".");if(a.rank<1)throw Error("tf.scatterND() expects the updates to be rank 1 or higher, but the rank was "+a.rank+".");if("int32"!==b.dtype)throw Error("The dtype of 'indices' should be int32, but got dtype: "+b.dtype);if(c.length<1)throw Error("Output rank must be greater or equal to 1, but got shape: "+c);if(0===c.length){if(0===b.size)throw Error("Indices specified for empty output. indices shape: "+b.shape);if(0===a.size)throw Error("Updates specified for empty output. updates shape: "+a.shape)}dI(c,b,a)}function dK(a,b,c){for(var d=b.shape.length,e=d>1?b.shape[d-1]:1,f=c.length,g=1,h=e;h<f;++h)g*=c[h];var i=e<1?1:e;return{sliceRank:e,numUpdates:O(b.shape)/i,sliceSize:g,strides:ak(c.slice(0,e)).concat([1]),outputSize:O(c)}}var dL=Object.freeze({validateUpdateShape:dI,validateInput:dJ,calculateShapes:dK});function dM(a,b,c){K(a.rank===b.length,function(){return"Error in slice"+a.rank+"D: Length of begin "+b+" must match the rank of the array ("+a.rank+")."}),K(a.rank===c.length,function(){return"Error in slice"+a.rank+"D: Length of size "+c+" must match the rank of the array ("+a.rank+")."});for(var d=function(d){K(b[d]+c[d]<=a.shape[d],function(){return"Error in slice"+a.rank+"D: begin["+d+"] + size["+d+"] ("+(b[d]+c[d])+") would overflow input.shape["+d+"] ("+a.shape[d]+")"})},e=0;e<a.rank;++e)d(e)}function dN(a){for(var b=[],c=0;a>0;)1&a&&b.push(c),a/=2,c++;return b}function dO(a,b,c){for(var d=[],e=0;e<a.length;e++)d[e]=Math.ceil((b[e]-a[e])/c[e]);return d}function dP(a,b,c,d,e){var f=b[e],g=c[e]||1;(a&1<<e||null==f)&&(f=g>0?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);var h=d[e];return f<0&&(f+=h),f=H(0,f,h-1)}function dQ(a,b,c,d,e){var f=b[e],g=c[e]||1;(a&1<<e||null==f)&&(f=g>0?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER);var h=d[e];return f<0&&(f+=h),f=g>0?H(0,f,h):H(-1,f,h-1)}function dR(a,b,c){for(var d=c.length,e=0;e<c.length;e++)if(c[e]>1){d=e;break}for(e=d+1;e<c.length;e++)if(b[e]>0||c[e]!==a[e])return!1;return!0}function dS(a,b){for(var c=a.length>0?a[a.length-1]:1,d=0;d<a.length-1;d++)c+=a[d]*b[d];return c}var dT=Object.freeze({assertParamsValid:dM,maskToAxes:dN,computeOutShape:dO,startForAxis:dP,stopForAxis:dQ,isSliceContinous:dR,computeFlatOffset:dS});function dU(a){return K(ai(a),function(){return"The f passed in grad(f) must be a function"}),function(b,c){var d=cj(b,"x","tf.grad",null),e=null!=c?cj(c,"dy","tf.grad"):null;return a_.tidy(function(){var b=a_.gradients(function(){return a(d)},[d],e),c=b.value,f=b.grads;return null!=e&&L(c.shape,e.shape,"The shape of dy passed in grad(f)(x, dy) must match the shape returned by f(x)"),d$(f),f[0]})}}function dV(a){return K(ai(a),function(){return"The f passed in grads(f) must be a function"}),function(b,c){K(Array.isArray(b),function(){return"The args passed in grads(f)(args) must be an array of `Tensor`s or `TensorLike`s"});var d=ck(b,"args","tf.grads",null),e=null!=c?cj(c,"dy","tf.grads"):null;return a_.tidy(function(){var b=a_.gradients(function(){return a.apply(void 0,d)},d,e),c=b.value,f=b.grads;return null!=e&&L(c.shape,e.shape,"The shape of dy passed in grads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),d$(f),f})}}function dW(a){return K(ai(a),function(){return"The f passed in valueAndGrad(f) must be a function"}),function(b,c){K(b instanceof aF,function(){return"The x passed in valueAndGrad(f)(x) must be a tensor"}),K(null==c||c instanceof aF,function(){return"The dy passed in valueAndGrad(f)(x, dy) must be a tensor"});var d=a_.gradients(function(){return a(b)},[b],c),e=d.grads,f=d.value;return d$(e),{grad:e[0],value:f}}}function dX(a){return K(ai(a),function(){return"The f passed in valueAndGrads(f) must be a function"}),function(b,c){K(Array.isArray(b)&&b.every(function(a){return a instanceof aF}),function(){return"The args passed in valueAndGrads(f)(args) must be array of tensors"}),K(null==c||c instanceof aF,function(){return"The dy passed in valueAndGrads(f)(args, dy) must be a tensor"});var d=a_.gradients(function(){return a.apply(void 0,b)},b,c);return null!=c&&L(d.value.shape,c.shape,"The shape of dy passed in valueAndGrads(f)([x1,...], dy) must match the shape returned by f([x1,...])"),d$(d.grads),d}}function dY(a,b){K(ai(a),function(){return"The f passed in variableGrads(f) must be a function"}),K(null==b||Array.isArray(b)&&b.every(function(a){return a instanceof aL}),function(){return"The varList passed in variableGrads(f, varList) must be an array of variables"});var c=null!=b;if(!c)for(var d in b=[],a_.registeredVariables)b.push(a_.registeredVariables[d]);var e=c?b.filter(function(a){return!a.trainable}):null,f=b.length;K((b=b.filter(function(a){return a.trainable})).length>0,function(){return"variableGrads() expects at least one of the input variables to be trainable, but none of the "+f+" variables is trainable."});var g=a_.gradients(a,b,null,!0),h=g.value,i=g.grads;K(i.some(function(a){return null!=a}),function(){return"Cannot find a connection between any variable and the result of the loss function y=f(x). Please make sure the operations that use variables are inside the function f passed to minimize()."}),K(0===h.rank,function(){return"The f passed in variableGrads(f) must return a scalar, but it returned a rank-"+h.rank+" tensor"});var j={};return b.forEach(function(a,b){null!=i[b]&&(j[a.name]=i[b])}),null!=e&&e.forEach(function(a){return j[a.name]=null}),{value:h,grads:j}}function dZ(a){return a_.customGrad(a)}function d$(a){if(a.filter(function(a){return null==a}).length>0)throw Error("Cannot compute gradient of y=f(x) with respect to x. Make sure that\n    the f you passed encloses all operations that lead from x to y.")}var d_=cv({softmax_:function(a,b){void 0===b&&(b=-1);var c=cj(a,"logits","softmax","float32");if(-1===b&&(b=c.rank-1),b!==c.rank-1)throw Error("Softmax along a non-last dimension is not yet supported. Logits was rank "+c.rank+" and dim was "+b);return a_.runKernelFunc(function(a,d){var e=a.softmax(c,b);return d([e]),e},{logits:c},function(a,c){var d=c[0],e=a.mul(d);return{logits:function(){return e.sub(e.sum([b],!0).mul(d))}}},"Softmax",{dim:b},[],[!0])}}),d0=cv({logSoftmax_:function(a,b){void 0===b&&(b=-1);var c=cj(a,"logits","logSoftmax");if(-1===b&&(b=c.rank-1),b!==c.rank-1)throw Error("Log Softmax along a non-last dimension is not yet supported. Logits was rank "+c.rank+" and axis was "+b);return dZ(function(a,c){var d=a.max(b,!0),e=a.sub(d),f=e.toFloat().sub(e.exp().sum(b,!0).log());return c([f]),{value:f,gradFunc:function(a,c){var d=c[0].exp();return a.sub(a.sum(b,!0).mul(d))}}})(c)}}),d1=function(){function a(a,b){this.backend=a,this.dataMover=b,this.data=new WeakMap,this.dataIdsCount=0}return a.prototype.get=function(a){return this.data.has(a)||this.dataMover.moveData(this.backend,a),this.data.get(a)},a.prototype.set=function(a,b){this.dataIdsCount++,this.data.set(a,b)},a.prototype.has=function(a){return this.data.has(a)},a.prototype.delete=function(a){return this.dataIdsCount--,this.data.delete(a)},a.prototype.numDataIds=function(){return this.dataIdsCount},a}(),d2=function(){function a(){}return a.prototype.time=function(a){return d3("time")},a.prototype.read=function(a){return d3("read")},a.prototype.readSync=function(a){return d3("readSync")},a.prototype.numDataIds=function(){return d3("numDataIds")},a.prototype.disposeData=function(a){return d3("disposeData")},a.prototype.write=function(a,b,c){return d3("write")},a.prototype.move=function(a,b,c,d){return d3("move")},a.prototype.memory=function(){return d3("memory")},a.prototype.floatPrecision=function(){return d3("floatPrecision")},a.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},a.prototype.batchMatMul=function(a,b,c,d){return d3("batchMatMul")},a.prototype.fusedBatchMatMul=function(a){return a.a,a.b,a.transposeA,a.transposeB,a.bias,a.activation,a.preluActivationWeights,d3("fusedBatchMatMul")},a.prototype.slice=function(a,b,c){return d3("slice")},a.prototype.stridedSlice=function(a,b,c,d){return d3("stridedSlice")},a.prototype.unstack=function(a,b){return d3("unstack")},a.prototype.reverse=function(a,b){return d3("reverse")},a.prototype.concat=function(a,b){return d3("concat")},a.prototype.neg=function(a){return d3("neg")},a.prototype.add=function(a,b){return d3("add")},a.prototype.addN=function(a){return d3("addN")},a.prototype.subtract=function(a,b){return d3("subtract")},a.prototype.multiply=function(a,b){return d3("multiply")},a.prototype.realDivide=function(a,b){return d3("realDivide")},a.prototype.floorDiv=function(a,b){return d3("floorDiv")},a.prototype.sum=function(a,b){return d3("sum")},a.prototype.prod=function(a,b){return d3("prod")},a.prototype.unsortedSegmentSum=function(a,b,c){return d3("unsortedSegmentSum")},a.prototype.argMin=function(a,b){return d3("argMin")},a.prototype.argMax=function(a,b){return d3("argMax")},a.prototype.equal=function(a,b){return d3("equal")},a.prototype.notEqual=function(a,b){return d3("notEqual")},a.prototype.less=function(a,b){return d3("less")},a.prototype.lessEqual=function(a,b){return d3("lessEqual")},a.prototype.greater=function(a,b){return d3("greater")},a.prototype.greaterEqual=function(a,b){return d3("greaterEqual")},a.prototype.logicalNot=function(a){return d3("logicalNot")},a.prototype.logicalAnd=function(a,b){return d3("logicalAnd")},a.prototype.logicalOr=function(a,b){return d3("logicalOr")},a.prototype.where=function(a){return d3("where")},a.prototype.select=function(a,b,c){return d3("select")},a.prototype.topk=function(a,b,c){return d3("topk")},a.prototype.min=function(a,b){return d3("min")},a.prototype.minimum=function(a,b){return d3("minimum")},a.prototype.mod=function(a,b){return d3("mod")},a.prototype.max=function(a,b){return d3("max")},a.prototype.maximum=function(a,b){return d3("maximum")},a.prototype.all=function(a,b){return d3("all")},a.prototype.any=function(a,b){return d3("any")},a.prototype.squaredDifference=function(a,b){return d3("squaredDifference")},a.prototype.ceil=function(a){return d3("ceil")},a.prototype.floor=function(a){return d3("floor")},a.prototype.round=function(a){return d3("round")},a.prototype.sign=function(a){return d3("sign")},a.prototype.isNaN=function(a){return d3("isNaN")},a.prototype.isInf=function(a){return d3("isInf")},a.prototype.isFinite=function(a){return d3("isFinite")},a.prototype.pow=function(a,b){return d3("pow")},a.prototype.exp=function(a){return d3("exp")},a.prototype.expm1=function(a){return d3("expm1")},a.prototype.softmax=function(a,b){return d3("softmax")},a.prototype.log=function(a){return d3("log")},a.prototype.log1p=function(a){return d3("log1p")},a.prototype.sqrt=function(a){return d3("sqrt")},a.prototype.rsqrt=function(a){return d3("rsqrt")},a.prototype.square=function(a){return d3("square")},a.prototype.reciprocal=function(a){return d3("reciprocal")},a.prototype.relu=function(a){return d3("relu")},a.prototype.relu6=function(a){return d3("relu6")},a.prototype.prelu=function(a,b){return d3("prelu")},a.prototype.elu=function(a){return d3("elu")},a.prototype.eluDer=function(a,b){return d3("eluDer")},a.prototype.selu=function(a){return d3("selu")},a.prototype.int=function(a){return d3("int")},a.prototype.clip=function(a,b,c){return d3("clip")},a.prototype.abs=function(a){return d3("abs")},a.prototype.complexAbs=function(a){return d3("complexAbs")},a.prototype.sigmoid=function(a){return d3("sigmoid")},a.prototype.softplus=function(a){return d3("softplus")},a.prototype.sin=function(a){return d3("sin")},a.prototype.cos=function(a){return d3("cos")},a.prototype.tan=function(a){return d3("tan")},a.prototype.asin=function(a){return d3("asin")},a.prototype.acos=function(a){return d3("acos")},a.prototype.atan=function(a){return d3("atan")},a.prototype.atan2=function(a,b){return d3("atan2")},a.prototype.sinh=function(a){return d3("sinh")},a.prototype.cosh=function(a){return d3("cosh")},a.prototype.tanh=function(a){return d3("tanh")},a.prototype.asinh=function(a){return d3("asinh")},a.prototype.acosh=function(a){return d3("acosh")},a.prototype.atanh=function(a){return d3("atanh")},a.prototype.erf=function(a){return d3("erf")},a.prototype.step=function(a,b){return d3("step")},a.prototype.fusedConv2d=function(a){return a.input,a.filter,a.convInfo,a.bias,a.activation,a.preluActivationWeights,d3("fusedConv2d")},a.prototype.conv2d=function(a,b,c){return d3("conv2d")},a.prototype.conv2dDerInput=function(a,b,c){return d3("conv2dDerInput")},a.prototype.conv2dDerFilter=function(a,b,c){return d3("conv2dDerFilter")},a.prototype.fusedDepthwiseConv2D=function(a){return a.input,a.filter,a.convInfo,a.bias,a.activation,a.preluActivationWeights,d3("fusedDepthwiseConv2D")},a.prototype.depthwiseConv2D=function(a,b,c){return d3("depthwiseConv2D")},a.prototype.depthwiseConv2DDerInput=function(a,b,c){return d3("depthwiseConv2DDerInput")},a.prototype.depthwiseConv2DDerFilter=function(a,b,c){return d3("depthwiseConv2DDerFilter")},a.prototype.conv3d=function(a,b,c){return d3("conv3d")},a.prototype.conv3dDerInput=function(a,b,c){return d3("conv3dDerInput")},a.prototype.conv3dDerFilter=function(a,b,c){return d3("conv3dDerFilter")},a.prototype.maxPool=function(a,b){return d3("maxPool")},a.prototype.maxPoolBackprop=function(a,b,c,d){return d3("maxPoolBackprop")},a.prototype.avgPool=function(a,b){return d3("avgPool")},a.prototype.avgPoolBackprop=function(a,b,c){return d3("avgPoolBackprop")},a.prototype.avgPool3d=function(a,b){return d3("avgPool3d")},a.prototype.avgPool3dBackprop=function(a,b,c){return d3("avgPool3dBackprop")},a.prototype.maxPool3d=function(a,b){return d3("maxPool3d")},a.prototype.maxPool3dBackprop=function(a,b,c,d){return d3("maxPool3dBackprop")},a.prototype.reshape=function(a,b){return d3("reshape")},a.prototype.cast=function(a,b){return d3("cast")},a.prototype.tile=function(a,b){return d3("tile")},a.prototype.pad=function(a,b,c){return d3("pad")},a.prototype.transpose=function(a,b){return d3("transpose")},a.prototype.gather=function(a,b,c){return d3("gather")},a.prototype.gatherND=function(a,b){return d3("gatherND")},a.prototype.scatterND=function(a,b,c){return d3("scatterND")},a.prototype.batchToSpaceND=function(a,b,c){return d3("batchToSpaceND")},a.prototype.spaceToBatchND=function(a,b,c){return d3("spaceToBatchND")},a.prototype.resizeBilinear=function(a,b,c,d){return d3("resizeBilinear")},a.prototype.resizeBilinearBackprop=function(a,b,c){return d3("resizeBilinearBackprop")},a.prototype.resizeNearestNeighbor=function(a,b,c,d){return d3("resizeNearestNeighbor")},a.prototype.resizeNearestNeighborBackprop=function(a,b,c){return d3("resizeNearestNeighborBackprop")},a.prototype.batchNormalization=function(a,b,c,d,e,f){return d3("batchNormalization")},a.prototype.localResponseNormalization4D=function(a,b,c,d,e){return d3("localResponseNormalization4D")},a.prototype.LRNGrad=function(a,b,c,d,e,f,g){return d3("LRNGrad")},a.prototype.multinomial=function(a,b,c,d){return d3("multinomial")},a.prototype.oneHot=function(a,b,c,d){return d3("oneHot")},a.prototype.cumsum=function(a,b,c,d){return d3("cumsum")},a.prototype.nonMaxSuppression=function(a,b,c,d,e){return d3("nonMaxSuppression")},a.prototype.fft=function(a){return d3("fft")},a.prototype.ifft=function(a){return d3("ifft")},a.prototype.complex=function(a,b){return d3("complex")},a.prototype.real=function(a){return d3("real")},a.prototype.imag=function(a){return d3("imag")},a.prototype.cropAndResize=function(a,b,c,d,e,f){return d3("cropAndResize")},a.prototype.depthToSpace=function(a,b,c){return d3("depthToSpace")},a.prototype.split=function(a,b,c){return d3("split")},a.prototype.sparseToDense=function(a,b,c,d){return d3("sparseToDense")},a.prototype.diag=function(a){return d3("diag")},a.prototype.fill=function(a,b,c){return d3("fill")},a.prototype.onesLike=function(a){return d3("onesLike")},a.prototype.zerosLike=function(a){return d3("zerosLike")},a.prototype.linspace=function(a,b,c){return d3("linspace")},a.prototype.dispose=function(){return d3("dispose")},a}();function d3(a){throw Error("'"+a+"' not yet implemented or not found in the registry. Did you forget to import the kernel?")}function d4(a,b){for(var c=a.length,d=[],e=0;e<c;e++){var f=c-1-e,g=a[f]||1;(b[b.length-1-e]||1)>1&&1===g&&d.unshift(f)}return d}function d5(a,b){for(var c=[],d=0;d<b.length;d++){var e=a[a.length-d-1],f=b.length-d-1,g=b[f];(null==e||1===e&&g>1)&&c.unshift(f)}return c}function d6(a,b){for(var c=[],d=Math.max(a.length,b.length),e=0;e<d;e++){var f=a[a.length-e-1];null==f&&(f=1);var g=b[b.length-e-1];if(null==g&&(g=1),1===f)c.unshift(g);else if(1===g)c.unshift(f);else{if(f!==g)throw Error("Operands could not be broadcast together with shapes "+a+" and "+b+".");c.unshift(f)}}return c}function d7(a,b,c,d,e,f,g){void 0===g&&(g="channelsLast");var h,i=ec(b),j=i[0],k=i[1];if("channelsLast"===g)h=[j,k,a[3],a[3]];else{if("channelsFirst"!==g)throw Error("Unknown dataFormat "+g);h=[j,k,a[1],a[1]]}return d9(a,h,c,d,e,f,!1,g)}function d8(a,b,c,d,e,f,g){void 0===g&&(g="NDHWC");var h,i,j=ed(b),k=j[0],l=j[1],m=j[2];if("NDHWC"===g)i="channelsLast",h=[k,l,m,a[4],a[4]];else{if("NCDHW"!==g)throw Error("Unknown dataFormat "+g);i="channelsFirst",h=[k,l,m,a[1],a[1]]}return ea(a,h,c,d,e,!1,i,f)}function d9(a,b,c,d,e,f,g,h){void 0===g&&(g=!1),void 0===h&&(h="channelsLast");var i=-1,j=-1,k=-1,l=-1;if("channelsLast"===h)i=a[0],j=a[1],k=a[2],l=a[3];else{if("channelsFirst"!==h)throw Error("Unknown dataFormat "+h);i=a[0],l=a[1],j=a[2],k=a[3]}var m,n=b[0],o=b[1],p=b[3],q=ec(c),r=q[0],s=q[1],t=ec(d),u=t[0],v=t[1],w=ee(n,u),x=ee(o,v),y=function(a,b,c,d,e,f,g,h){var i,j,k;if("number"==typeof a){i={top:a,bottom:a,left:a,right:a,type:0===a?"VALID":"NUMBER"};var l,m,n,o,p,q,r=(l=[b,c],null==(m=a)&&(m=eb(l,f,d)),n=l[0],o=l[1],K(Q(p=ef((n-f+2*m)/d+1,h)),function(){return"The output # of rows ("+p+") must be an integer. Change the stride and/or zero pad parameters"}),K(Q(q=ef((o-f+2*m)/d+1,h)),function(){return"The output # of columns ("+q+") must be an integer. Change the stride and/or zero pad parameters"}),[p,q]);j=r[0],k=r[1]}else if("same"===a){j=Math.ceil(b/d),k=Math.ceil(c/e);var s=Math.max(0,(j-1)*d+f-b),t=Math.max(0,(k-1)*e+g-c),u=Math.floor(s/2),v=Math.floor(t/2);i={top:u,bottom:s-u,left:v,right:t-v,type:"SAME"}}else{if("valid"!==a)throw Error("Unknown padding parameter: "+a);i={top:0,bottom:0,left:0,right:0,type:"VALID"},j=Math.ceil((b-f+1)/d),k=Math.ceil((c-g+1)/e)}return{padInfo:i,outHeight:j,outWidth:k}}(e,j,k,r,s,w,x,f),z=y.padInfo,A=y.outHeight,B=y.outWidth,C=g?p*l:p;return"channelsFirst"===h?m=[i,C,A,B]:"channelsLast"===h&&(m=[i,A,B,C]),{batchSize:i,dataFormat:h,inHeight:j,inWidth:k,inChannels:l,outHeight:A,outWidth:B,outChannels:C,padInfo:z,strideHeight:r,strideWidth:s,filterHeight:n,filterWidth:o,effectiveFilterHeight:w,effectiveFilterWidth:x,dilationHeight:u,dilationWidth:v,inShape:a,outShape:m,filterShape:b}}function ea(a,b,c,d,e,f,g,h){void 0===f&&(f=!1),void 0===g&&(g="channelsLast");var i=-1,j=-1,k=-1,l=-1,m=-1;if("channelsLast"===g)i=a[0],j=a[1],k=a[2],l=a[3],m=a[4];else{if("channelsFirst"!==g)throw Error("Unknown dataFormat "+g);i=a[0],m=a[1],j=a[2],k=a[3],l=a[4]}var n,o=b[0],p=b[1],q=b[2],r=b[4],s=ed(c),t=s[0],u=s[1],v=s[2],w=ed(d),x=w[0],y=w[1],z=w[2],A=ee(o,x),B=ee(p,y),C=ee(q,z),D=function(a,b,c,d,e,f,g,h,i,j,k){var l,m,n,o;if("number"==typeof a){l={top:a,bottom:a,left:a,right:a,front:a,back:a,type:0===a?"VALID":"NUMBER"};var p,q,r,s,t,u,v,w,x=(p=[b,c,d,1],null==(q=a)&&(q=eb(p,h,e)),r=p[0],s=p[1],t=p[2],K(Q(u=ef((r-h+2*q)/e+1,k)),function(){return"The output # of depths ("+u+") must be an integer. Change the stride and/or zero pad parameters"}),K(Q(v=ef((s-h+2*q)/e+1,k)),function(){return"The output # of rows ("+v+") must be an integer. Change the stride and/or zero pad parameters"}),K(Q(w=ef((t-h+2*q)/e+1,k)),function(){return"The output # of columns ("+w+") must be an integer. Change the stride and/or zero pad parameters"}),[u,v,w,1]);m=x[0],n=x[1],o=x[2]}else if("same"===a){m=Math.ceil(b/e),n=Math.ceil(c/f),o=Math.ceil(d/g);var y=(m-1)*e+h-b,z=(n-1)*f+i-c,A=(o-1)*g+j-d,B=Math.floor(y/2),C=Math.floor(z/2),D=Math.floor(A/2);l={top:C,bottom:z-C,left:D,right:A-D,front:B,back:y-B,type:"SAME"}}else{if("valid"!==a)throw Error("Unknown padding parameter: "+a);l={top:0,bottom:0,left:0,right:0,front:0,back:0,type:"VALID"},m=Math.ceil((b-h+1)/e),n=Math.ceil((c-i+1)/f),o=Math.ceil((d-j+1)/g)}return{padInfo:l,outDepth:m,outHeight:n,outWidth:o}}(e,j,k,l,t,u,v,A,B,C,h),E=D.padInfo,F=D.outDepth,G=D.outHeight,H=D.outWidth,I=f?r*m:r;return"channelsFirst"===g?n=[i,I,F,G,H]:"channelsLast"===g&&(n=[i,F,G,H,I]),{batchSize:i,dataFormat:g,inDepth:j,inHeight:k,inWidth:l,inChannels:m,outDepth:F,outHeight:G,outWidth:H,outChannels:I,padInfo:E,strideDepth:t,strideHeight:u,strideWidth:v,filterDepth:o,filterHeight:p,filterWidth:q,effectiveFilterDepth:A,effectiveFilterHeight:B,effectiveFilterWidth:C,dilationDepth:x,dilationHeight:y,dilationWidth:z,inShape:a,outShape:n,filterShape:b}}function eb(a,b,c,d){void 0===d&&(d=1);var e=ee(b,d);return Math.floor((a[0]*(c-1)-c+e)/2)}function ec(a){return"number"==typeof a?[a,a,a]:2===a.length?[a[0],a[1],1]:a}function ed(a){return"number"==typeof a?[a,a,a]:a}function ee(a,b){return b<=1?a:a+(a-1)*(b-1)}function ef(a,b){if(!b)return a;switch(b){case"round":return Math.round(a);case"ceil":return Math.ceil(a);case"floor":return Math.floor(a);default:throw Error("Unknown roundingMode "+b)}}function eg(a){var b=ec(a),c=b[0],d=b[1],e=b[2];return 1===c&&1===d&&1===e}function eh(a,b){return eg(a)||eg(b)}function ei(a){if("NHWC"===a)return"channelsLast";if("NCHW"===a)return"channelsFirst";throw Error("Unknown dataFormat "+a)}function ej(a,b,c){if("complex64"===b){if("complex64"===a.dtype)return a.clone();var d=cK(a.shape),e=a.toFloat(),f=c.complex(e,d);return d.dispose(),e.dispose(),f}if(!aa(a.dtype,b))return a_.makeTensorFromDataId(a.dataId,a.shape,b);if("complex64"===a.dtype){var g=c.real(a);return f=g.cast(b),g.dispose(),f}if("int32"===b)return c.int(a);if("bool"===b){var h=cB(0,a.dtype);return f=c.notEqual(a,h),h.dispose(),f}throw Error("Error in Cast: failed to cast "+a.dtype+" to "+b)}function ek(a,b){return a_.makeTensorFromDataId(a.dataId,b,a.dtype)}function el(a,b,c){var d=(b-a)/(c-1),e=ao(c,"float32");e[0]=a;for(var f=1;f<e.length;f++)e[f]=e[f-1]+d;return cC(e,"float32")}var em=Object.freeze({castTensor:ej,reshapeTensor:ek,linspaceImpl:el,upcastType:aN,axesAreInnerMostDims:cl,combineLocations:cm,computeOutAndReduceShapes:cn,expandShapeToKeepDim:co,assertAxesAreInnerMostDims:cp,getAxesPermutation:cq,getUndoAxesPermutation:cr,getInnerMostAxes:cs,getBroadcastDims:d4,getReductionAxes:d5,assertAndGetBroadcastShape:d6,assertParamsConsistent:ct,computeOutShape:cu,computePool2DInfo:d7,computePool3DInfo:d8,computeConv2DInfo:d9,computeConv3DInfo:ea,computeDefaultPad:eb,tupleValuesAreOne:eg,eitherStridesOrDilationsAreOne:eh,convertConv2DDataFormat:ei,PARALLELIZE_THRESHOLD:30,computeOptimalWindowSize:dH});function en(a,b){if(a.length!==b.length)throw Error("Cannot merge real and imag arrays of different lengths. real:"+a.length+", imag: "+b.length+".");for(var c=new Float32Array(2*a.length),d=0;d<c.length;d+=2)c[d]=a[d/2],c[d+1]=b[d/2];return c}function eo(a,b){return{real:a[2*b],imag:a[2*b+1]}}function ep(a,b){return a>b?1:a<b?-1:0}function eq(a,b,c,d,e){return es(a,b,c,d,e,0).selectedIndices}function er(a,b,c,d,e,f){var g=es(a,b,c,d,e,f,!0);return g.numValidOutputs.dispose(),{selectedIndices:g.selectedIndices,selectedScores:g.selectedScores}}function es(a,b,c,d,e,f,g,h){void 0===g&&(g=!1),void 0===h&&(h=!1);for(var i=Array.from(b).map(function(a,b){return{score:a,boxIndex:b,suppressBeginIndex:0}}).filter(function(a){return a.score>e}).sort(et),j=f>0?-.5/f:0,k=[],l=[];k.length<c&&i.length>0;){var m=i.pop(),n=m.score,o=m.boxIndex,p=m.suppressBeginIndex;if(n<e)break;for(var q=!1,r=k.length-1;r>=p;--r){var s=function(a,b,c){var d=a.subarray(4*b,4*b+4),e=a.subarray(4*c,4*c+4),f=Math.min(d[0],d[2]),g=Math.min(d[1],d[3]),h=Math.max(d[0],d[2]),i=Math.max(d[1],d[3]),j=Math.min(e[0],e[2]),k=Math.min(e[1],e[3]),l=Math.max(e[0],e[2]),m=Math.max(e[1],e[3]),n=(h-f)*(i-g),o=(l-j)*(m-k);if(n<=0||o<=0)return 0;var p=Math.max(Math.min(h,l)-Math.max(f,j),0)*Math.max(Math.min(i,m)-Math.max(g,k),0);return p/(n+o-p)}(a,o,k[r]);if(s>=d){q=!0;break}if(m.score=m.score*function(a,b,c){var d=Math.exp(b*c*c);return c<=a?d:0}(d,j,s),m.score<=e)break}m.suppressBeginIndex=k.length,q||(m.score===n?(k.push(o),l.push(m.score)):m.score>e&&function(a,b,c){var d=function(a,b,c){for(var d=0,e=a.length,f=0,g=!1;d<e;){var h=c(b,a[f=d+(e-d>>>1)]);h>0?d=f+1:(e=f,g=!h)}return g?d:-d-1}(a,b,c||ep);a.splice(d<0?-(d+1):d,0,b)}(i,m,et))}var t=k.length;return h&&(k.fill(0,t),l.fill(0,t)),{selectedIndices:cC(k,"int32"),selectedScores:cC(l,"float32"),numValidOutputs:cB(t,"int32")}}function et(a,b){return a.score-b.score||a.score===b.score&&b.boxIndex-a.boxIndex}function eu(a,b,c){var d=Array(a.rank).fill(0),e=a.shape.slice();return b.map(function(b){e[c]=b;var f=a.slice(d,e);return d[c]+=b,f})}function ev(a,b){for(var c=Array(a.rank),d=0;d<c.length;d++)c[d]=a.shape[d]*b[d];var e=c6(c,a.dtype);for(d=0;d<e.values.length;++d){for(var f=e.indexToLoc(d),g=Array(a.rank),h=0;h<g.length;h++)g[h]=f[h]%a.shape[h];var i=a.locToIndex(g);e.values[d]=a.values[i]}return e.toTensor()}function ew(a,b,c,d,e){for(var f=b[b.length-1],g=[a.length/f,f],h=g[0],i=g[1],j=Y(c,h*d),k=Y("int32",h*d),l=0;l<h;l++){for(var m=l*i,n=a.subarray(m,m+i),o=[],p=0;p<n.length;p++)o.push({value:n[p],index:p});o.sort(function(a,b){return b.value-a.value});var q=l*d,r=j.subarray(q,q+d),s=k.subarray(q,q+d);for(p=0;p<d;p++)r[p]=o[p].value,s[p]=o[p].index}var t=b.slice();return t[t.length-1]=d,[cz(j,t,c),cz(k,t,"int32")]}function ex(a,b){for(var c=[],d=0;d<b.length;d++)b[d]&&c.push(d);var e=c6(a,"int32"),f=c6([c.length,a.length],"int32");for(d=0;d<c.length;d++){var g=e.indexToLoc(c[d]),h=d*a.length;f.values.set(g,h)}return f.toTensor()}var ey=function(a,b){this.outputShape=[],this.outputShape=a,this.variableNames=b.map(function(a,b){return"T"+b});var c=[];this.variableNames.forEach(function(a){c.push("float v"+a+" = get"+a+"AtOutCoords();")});var d=this.variableNames.map(function(a){return"v"+a}).join(" + ");this.userCode="\n      void main() {\n        "+c.join("\n        ")+"\n\n        float result = "+d+";\n        setOutput(result);\n      }\n    "},ez=function(a,b){this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.variableNames=b.map(function(a,b){return"T"+b});var c=[];this.variableNames.forEach(function(a){c.push("vec4 v"+a+" = get"+a+"AtOutCoords();")});var d=this.variableNames.map(function(a){return"v"+a}).join(" + ");this.userCode="\n      void main() {\n        "+c.join("\n        ")+"\n\n        vec4 result = "+d+";\n        setOutput(result);\n      }\n    "},eA=function(a,b,c){this.variableNames=["A"];var d=a.windowSize,e=a.batchSize,f=Math.ceil(a.inSize/d);c||this.variableNames.push("bestIndicesA"),this.outputShape=[e,f],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+d+";\n\n        int bestIndex = inOffset;\n        float bestValue = getA(batch, bestIndex);\n\n        for (int i = 0; i < "+d+"; i++) {\n          int inIdx = "+(c?"inOffset + i;":"round(getBestIndicesA(batch, inOffset + i));")+";\n          float candidate = getA(batch, inIdx);\n          if (candidate "+("max"===b?">":"<")+" bestValue) {\n            bestValue = candidate;\n            bestIndex = inIdx;\n          }\n        }\n        setOutput(float(bestIndex));\n      }\n    "};function eB(a,b){return["x","y","z","w","u","v"].slice(0,b).map(function(b){return a+"."+b})}function eC(a,b){return 1===b?[a]:eB(a,b)}function eD(){var a,b,c,d,e,f,g,h,i,j;return 2===w.getNumber("WEBGL_VERSION")?(a="#version 300 es",b="in",c="out",d="in",e="texture",f="outputColor",g="out vec4 outputColor;",h="\n      bool isnan_custom(float val) {\n        return (val > 0.0 || val < 0.0) ? false : val != 0.0;\n      }\n\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan_custom(val.x),\n          isnan_custom(val.y), isnan_custom(val.z), isnan_custom(val.w));\n      }\n\n      #define isnan(value) isnan_custom(value)\n    ",i="",j="\n      #define round(value) newRound(value)\n      int newRound(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 newRound(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "):(a="",b="attribute",c="varying",d="varying",e="texture2D",f="gl_FragColor",g="",h="\n      #define isnan(value) isnan_custom(value)\n      bool isnan_custom(float val) {\n        return (val > 0. || val < 1. || val == 0.) ? false : true;\n      }\n      bvec4 isnan_custom(vec4 val) {\n        return bvec4(isnan(val.x), isnan(val.y), isnan(val.z), isnan(val.w));\n      }\n    ",i="\n      uniform float INFINITY;\n\n      bool isinf(float val) {\n        return abs(val) == INFINITY;\n      }\n      bvec4 isinf(vec4 val) {\n        return equal(abs(val), vec4(INFINITY));\n      }\n    ",j="\n      int round(float value) {\n        return int(floor(value + 0.5));\n      }\n\n      ivec4 round(vec4 value) {\n        return ivec4(floor(value + vec4(0.5)));\n      }\n    "),{version:a,attribute:b,varyingVs:c,varyingFs:d,texture2D:e,output:f,defineOutput:g,defineSpecialNaN:h,defineSpecialInf:i,defineRound:j}}function eE(a,b,c){void 0===c&&(c="index");var d=ak(b);return d.map(function(b,e){return"int "+a[e]+" = "+c+" / "+b+"; "+(e===d.length-1?"int "+a[e+1]+" = "+c+" - "+a[e]+" * "+b:"index -= "+a[e]+" * "+b)+";"}).join("")}function eF(a){var b=ak(a).map(function(a){return a.toString()});return"\n  int getFlatIndex(ivec3 coords) {\n    return coords.x * "+b[0]+" + coords.y * "+b[1]+" + coords.z;\n  }\n"}var eG="\n  const float FLOAT_MAX = 1.70141184e38;\n  const float FLOAT_MIN = 1.17549435e-38;\n\n  lowp vec4 encode_float(highp float v) {\n    if (isnan(v)) {\n      return vec4(255, 255, 255, 255);\n    }\n\n    highp float av = abs(v);\n\n    if(av < FLOAT_MIN) {\n      return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > FLOAT_MAX) {\n      return vec4(0.0, 0.0, 128.0, 127.0) / 255.0;\n    } else if(v < -FLOAT_MAX) {\n      return vec4(0.0, 0.0,  128.0, 255.0) / 255.0;\n    }\n\n    highp vec4 c = vec4(0,0,0,0);\n\n    highp float e = floor(log2(av));\n    highp float m = exp2(fract(log2(av))) - 1.0;\n\n    c[2] = floor(128.0 * m);\n    m -= c[2] / 128.0;\n    c[1] = floor(32768.0 * m);\n    m -= c[1] / 32768.0;\n    c[0] = floor(8388608.0 * m);\n\n    highp float ebias = e + 127.0;\n    c[3] = floor(ebias / 2.0);\n    ebias -= c[3] * 2.0;\n    c[2] += floor(ebias) * 128.0;\n\n    c[3] += 128.0 * step(0.0, -v);\n\n    return c / 255.0;\n  }\n";function eH(a){return"offset"+a}function eI(a){var b=a.name,c=O(a.shapeInfo.logicalShape);return c<2?"return "+b+";":"\n    for (int i = 0; i < "+c+"; i++) {\n      if (i == index) {\n        return "+b+"[i];\n      }\n    }\n  "}function eJ(a){if(a<=1)return"int";if(2===a)return"ivec2";if(3===a)return"ivec3";if(4===a)return"ivec4";if(5===a)return"ivec5";if(6===a)return"ivec6";throw Error("GPU for rank "+a+" is not yet supported")}function eK(a,b){var c=JSON.parse(JSON.stringify(a));return c.shapeInfo.logicalShape=b,c}function eL(a,b){return b.map(function(b){return a[b]}).join(", ")}var eM=function(a,b,c,d){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,K(a.length>2,function(){return"Packed arg"+(c.charAt(0).toUpperCase()+c.slice(1))+" supports only inputs with rank above 2."});var e=Math.ceil(a[a.length-1]/b);this.outputShape=a.slice(0,-1),e>1&&this.outputShape.push(e),d||this.variableNames.push("bestIndicesA");var f,g,h=this.outputShape,i=h.length,j=eJ(i),k=eC("coords",i);if(1===e){var l=eJ(g=i+1);f="\n        "+l+" sourceLocR = "+l+"("+k.join()+", 0);\n        ++"+k[i-1]+";\n        "+l+" sourceLocG = "+l+"("+k.join()+", 0);\n        ++"+k[i-2]+";\n        "+l+" sourceLocA = "+l+"("+k.join()+", 0);\n        --"+k[i-1]+";\n        "+l+" sourceLocB = "+l+"("+k.join()+", 0);\n        --"+k[i-2]+";"}else g=i,f="\n        "+j+" sourceLocR = coords;\n        ++"+k[i-1]+";\n        "+j+" sourceLocG = coords;\n        ++"+k[i-2]+";\n        "+j+" sourceLocA = coords;\n        --"+k[i-1]+";\n        "+j+" sourceLocB = coords;\n        --"+k[i-2]+";";var m=["x","y","z","w","u","v"].slice(0,g),n="."+m[g-1],o=m.map(function(a){return"int "+a}),p=eC("sourceLocR",g-1).concat("inIdx.r"),q=eC("sourceLocG",g-1).concat("inIdx.g"),r=eC("sourceLocB",g-1).concat("inIdx.b"),s=eC("sourceLocA",g-1).concat("inIdx.a"),t="max"===c?"greaterThan":"lessThan",u=d?"":"\n          inIdx = round(vec4(getBestIndicesAChannel("+p.join()+"),\n                             getBestIndicesAChannel("+q.join()+"),\n                             getBestIndicesAChannel("+r.join()+"),\n                             getBestIndicesAChannel("+s.join()+")));",v="vec4(\n            getAChannel("+p.join()+"),\n            hasNextCol ? getAChannel("+q.join()+") : 0.,\n            hasNextRow ? getAChannel("+r.join()+") : 0.,\n            hasNextRow && hasNextCol ? getAChannel("+s.join()+") : 0.)",w=d?"":"\n      float getBestIndicesAChannel("+o.join()+") {\n        return getChannel(getBestIndicesA("+m.join()+"),\n                                          vec2("+m.slice(-2).join()+"));\n      }";this.userCode="\n      float getAChannel("+o.join()+") {\n        return getChannel(getA("+m.join()+"),\n                               vec2("+m.slice(-2).join()+"));\n      }\n      "+w+"\n      void main() {\n        "+j+" coords = getOutputCoords();\n        bool hasNextCol = "+k[i-1]+" < "+(h[i-1]-1)+";\n        bool hasNextRow = "+k[i-2]+" < "+(h[i-2]-1)+";\n        "+f+"\n        ivec4 srcIdx = ivec4(sourceLocR"+n+", sourceLocG"+n+",\n          sourceLocB"+n+", sourceLocA"+n+") * "+b+";\n        ivec4 inIdx = srcIdx;\n        vec4 bestIndex = vec4(inIdx);\n        vec4 bestValue = "+v+";\n\n        for (int i = 0; i < "+b+"; i++) {\n          inIdx = srcIdx;\n          "+u+"\n          vec4 candidate = "+v+";\n          bvec4 nan = isnan(candidate);\n          bvec4 replace = bvec4(\n            vec4("+t+"(candidate, bestValue)) * (vec4(1.0) - vec4(nan)));\n\n          bestValue = vec4(replace.x  ? candidate.x : bestValue.x,\n                           replace.y  ? candidate.y : bestValue.y,\n                           replace.z  ? candidate.z : bestValue.z,\n                           replace.w  ? candidate.w : bestValue.w);\n          bestIndex = mix(bestIndex, vec4(inIdx), vec4(replace));\n          srcIdx++;\n        }\n        setOutput(bestIndex);\n      }\n    "},eN=function(a){this.variableNames=["dy"],this.outputShape=a.inShape;var b=a.filterHeight,c=a.filterWidth,d=a.strideHeight,e=a.strideWidth,f=a.dilationHeight,g=a.dilationWidth,h=a.effectiveFilterHeight,i=a.effectiveFilterWidth,j=h-1-a.padInfo.top,k=i-1-a.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+j+", "+k+");\n      const float avgMultiplier = float("+1/(b*c)+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+h+";\n            wR += "+f+") {\n          float dyR = float(dyRCorner + wR) / "+d+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+i+";\n            wC+= "+g+") {\n            float dyC = float(dyCCorner + wC) / "+e+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n\n            dotProd += dyValue * avgMultiplier;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},eO=function(a){this.variableNames=["dy"],this.outputShape=a.inShape;var b=a.filterDepth,c=a.filterHeight,d=a.filterWidth,e=a.strideDepth,f=a.strideHeight,g=a.strideWidth,h=a.dilationDepth,i=a.dilationHeight,j=a.dilationWidth,k=a.effectiveFilterDepth,l=a.effectiveFilterHeight,m=a.effectiveFilterWidth,n=k-1-a.padInfo.front,o=l-1-a.padInfo.top,p=m-1-a.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+n+", "+o+", "+p+");\n      const float avgMultiplier = float("+1/(b*c*d)+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, d) with pos mask(:, :, :, ch) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+k+";\n            wD += "+h+") {\n          float dyD = float(dyDCorner + wD) / "+e+".0;\n\n          if (dyD < 0.0 || dyD >= "+a.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+l+";\n              wR += "+i+") {\n            float dyR = float(dyRCorner + wR) / "+f+".0;\n\n            if (dyR < 0.0 || dyR >= "+a.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+m+";\n                wC += "+j+") {\n              float dyC = float(dyCCorner + wC) / "+g+".0;\n\n              if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n\n              dotProd += dyValue * avgMultiplier;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},eP=function(a,b,c,d,e,f){this.outputShape=[],this.variableNames=["x","mean","variance"],d6(a,b),d6(a,c);var g="0.0";null!=d&&(d6(a,d),this.variableNames.push("offset"),g="getOffsetAtOutCoords()");var h="1.0";null!=e&&(d6(a,e),this.variableNames.push("scale"),h="getScaleAtOutCoords()"),this.outputShape=a,this.userCode="\n      void main() {\n        float x = getXAtOutCoords();\n        float mean = getMeanAtOutCoords();\n        float variance = getVarianceAtOutCoords();\n        float offset = "+g+";\n        float scale = "+h+";\n        float inv = scale * inversesqrt(variance + float("+f+"));\n        setOutput(dot(vec3(x, -mean, offset), vec3(inv, inv, 1)));\n      }\n    "},eQ=function(a,b,c,d,e,f){this.packedInputs=!0,this.packedOutput=!0,this.variableNames=["x","mean","variance"],d6(a,b),d6(a,c);var g="vec4(0.0)";null!=d&&(d6(a,d),this.variableNames.push("offset"),g="getOffsetAtOutCoords()");var h="vec4(1.0)";null!=e&&(d6(a,e),this.variableNames.push("scale"),h="getScaleAtOutCoords()"),this.outputShape=a,this.userCode="\n      void main() {\n        vec4 offset = "+g+";\n        vec4 scale = "+h+";\n\n        vec4 x = getXAtOutCoords();\n        vec4 mean = getMeanAtOutCoords();\n        vec4 variance = getVarianceAtOutCoords();\n\n        vec4 inv = scale * inversesqrt(variance + vec4("+f+"));\n\n        setOutput((x - mean) * inv + offset);\n      }\n    "},eR=function(a,b,c){this.variableNames=["AReal","AImag","BReal","BImag"],this.outputShape=d6(b,c),this.userCode="\n      float binaryOpComplex(\n          float areal, float aimag, float breal, float bimag) {\n        "+a+"\n      }\n\n      void main() {\n        float areal = getARealAtOutCoords();\n        float aimag = getAImagAtOutCoords();\n        float breal = getBRealAtOutCoords();\n        float bimag = getBImagAtOutCoords();\n        setOutput(binaryOpComplex(areal, aimag, breal, bimag));\n      }\n    "},eS="return a + b;",eT="return a - b;",eU="return a * b;",eV="return (a < 0.) ? b * a : a;",eW=function(a,b,c){this.variableNames=["A","B"],this.outputShape=d6(b,c),this.userCode="\n      float binaryOperation(float a, float b) {\n        "+a+"\n      }\n\n      void main() {\n        float a = getAAtOutCoords();\n        float b = getBAtOutCoords();\n        setOutput(binaryOperation(a, b));\n      }\n    "},eX="\n  vec4 aLessThanZero = vec4(lessThan(a, vec4(0.)));\n  return (aLessThanZero * (b * a)) + ((vec4(1.0) - aLessThanZero) * a);\n",eY=function(a,b,c,d){void 0===d&&(d=!1),this.variableNames=["A","B"],this.supportsBroadcasting=!0,this.packedInputs=!0,this.packedOutput=!0,this.outputShape=d6(b,c);var e=this.outputShape.length,f="";if(d)if(0===e||1===O(this.outputShape))f="\n          result.y = 0.;\n          result.z = 0.;\n          result.w = 0.;\n        ";else if(f="\n          "+eJ(e)+" coords = getOutputCoords();\n        ",1===e)f+="\n            result.y = (coords + 1) >= "+this.outputShape[0]+" ? 0. : result.y;\n            result.z = 0.;\n            result.w = 0.;\n          ";else{var g=eC("coords",e);f+="\n            bool nextRowOutOfBounds =\n              ("+g[e-2]+" + 1) >= "+this.outputShape[e-2]+";\n            bool nextColOutOfBounds =\n              ("+g[e-1]+" + 1) >= "+this.outputShape[e-1]+";\n            result.y = nextColOutOfBounds ? 0. : result.y;\n            result.z = nextRowOutOfBounds ? 0. : result.z;\n            result.w = nextColOutOfBounds || nextRowOutOfBounds ? 0. : result.w;\n          "}this.userCode="\n      vec4 binaryOperation(vec4 a, vec4 b) {\n        "+a+"\n      }\n\n      void main() {\n        vec4 a = getAAtOutCoords();\n        vec4 b = getBAtOutCoords();\n\n        vec4 result = binaryOperation(a, b);\n        "+f+"\n\n        setOutput(result);\n      }\n    "},eZ=function(){function a(a){this.variableNames=["A"],this.outputShape=a,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        float value = getAAtOutCoords();\n        if (isnan(value)) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, minVal, maxVal));\n      }\n    "}return a.prototype.getCustomSetupFunc=function(a,b){var c=this;return function(d,e){null==c.minLoc&&(c.minLoc=d.getUniformLocationNoThrow(e,"minVal"),c.maxLoc=d.getUniformLocationNoThrow(e,"maxVal")),d.gl.uniform1f(c.minLoc,a),d.gl.uniform1f(c.maxLoc,b)}},a}(),e$=function(){function a(a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.userCode="\n      uniform float minVal;\n      uniform float maxVal;\n\n      void main() {\n        vec4 value = getAAtOutCoords();\n\n        if (any(isnan(value))) {\n          setOutput(value);\n          return;\n        }\n\n        setOutput(clamp(value, vec4(minVal), vec4(maxVal)));\n      }\n    "}return a.prototype.getCustomSetupFunc=function(a,b){var c=this;return function(d,e){null==c.minLoc&&(c.minLoc=d.getUniformLocationNoThrow(e,"minVal"),c.maxLoc=d.getUniformLocationNoThrow(e,"maxVal")),d.gl.uniform1f(c.minLoc,a),d.gl.uniform1f(c.maxLoc,b)}},a}(),e_=function(a){this.variableNames=["real","imag"],this.outputShape=a,this.userCode="\n      void main() {\n        float re = abs(getRealAtOutCoords());\n        float im = abs(getImagAtOutCoords());\n        float mx = max(re, im);\n\n        // sadly the length function in glsl is not underflow-safe\n        // (at least not on Intel GPUs). So the safe solution is\n        // to ensure underflow-safety in all cases.\n        setOutput(\n          mx == 0.0 ? 0.0 : mx * length(vec2(1, min(re, im)/mx))\n        );\n      }\n    "},e0=function(a){this.outputShape=[],this.outputShape=cu(a,1),this.variableNames=a.map(function(a,b){return"T"+b});var b=Array(a.length-1);b[0]=a[0][1];for(var c=1;c<b.length;c++)b[c]=b[c-1]+a[c][1];var d=["if (yC < "+b[0]+") setOutput(getT0(yR, yC));"];for(c=1;c<b.length;c++){var e=b[c-1];d.push("else if (yC < "+b[c]+") setOutput(getT"+c+"(yR, yC-"+e+"));")}var f=b.length,g=b[b.length-1];d.push("else setOutput(getT"+f+"(yR, yC-"+g+"));"),this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int yR = coords.x;\n        int yC = coords.y;\n\n        "+d.join("\n        ")+"\n      }\n    "},e1=function(a,b){this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[],this.outputShape=cu(a,b);var c=this.outputShape,d=c.length,e=eJ(d),f=eC("coords",d),g=["x","y","z","w","u","v"].slice(0,d);this.variableNames=a.map(function(a,b){return"T"+b});var h=Array(a.length-1);h[0]=a[0][b];for(var i=1;i<h.length;i++)h[i]=h[i-1]+a[i][b];var j=g[b],k=g.slice(-2),l=g.join(),m="if ("+j+" < "+h[0]+") {\n        return getChannel(\n            getT0("+l+"), vec2("+k.join()+"));\n        }";for(i=1;i<h.length;i++){var n=h[i-1];m+="\n        if ("+j+" < "+h[i]+"  && "+j+" >= "+h[i-1]+") {\n          return getChannel(\n            getT"+i+"("+e2(g,j,n)+"),\n            vec2("+e2(k,j,n)+"));\n        }"}var o=h.length,p=h[h.length-1];m+="\n        return getChannel(\n          getT"+o+"("+e2(g,j,p)+"),\n          vec2("+e2(k,j,p)+"));",this.userCode="\n      float getValue("+g.map(function(a){return"int "+a})+") {\n        "+m+"\n      }\n\n      void main() {\n        "+e+" coords = getOutputCoords();\n        vec4 result = vec4(getValue("+f+"), 0., 0., 0.);\n\n        "+f[d-1]+" = "+f[d-1]+" + 1;\n        if ("+f[d-1]+" < "+c[d-1]+") {\n          result.g = getValue("+f+");\n        }\n\n        "+f[d-2]+" = "+f[d-2]+" + 1;\n        if ("+f[d-2]+" < "+c[d-2]+") {\n          result.a = getValue("+f+");\n        }\n\n        "+f[d-1]+" = "+f[d-1]+" - 1;\n        if ("+f[d-2]+" < "+c[d-2]+" &&\n            "+f[d-1]+" < "+c[d-1]+") {\n          result.b = getValue("+f+");\n        }\n        setOutput(result);\n      }\n    "};function e2(a,b,c){var d=a.indexOf(b);return a.map(function(a,b){return b===d?a+" - "+c:a}).join()}var e3=function(a){this.variableNames=["x","dy"],this.outputShape=a.filterShape;var b=a.strideHeight,c=a.strideWidth,d=a.padInfo.top,e=a.padInfo.left,f="channelsLast"===a.dataFormat;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int d2 = coords.w;\n\n        // Convolve x(?, ?, d1) with dy(:, :, d2) to get dw(wR, wC, d1, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+a.batchSize+"; b++) {\n          for (int yR = 0; yR < "+a.outHeight+"; yR++) {\n            int xR = wR + yR * "+b+" - "+d+";\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+a.outWidth+"; yC++) {\n              int xC = wC + yC * "+c+" - "+e+";\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              if ("+f+") {\n                float dyValue = getDy(b, yR, yC, d2);\n                float xValue = getX(b, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              } else {\n                float dyValue = getDy(b, d2, yR, yC);\n                float xValue = getX(b, d1, xR, xC);\n                dotProd += (xValue * dyValue);\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},e4=function(a){this.variableNames=["dy","W"],this.outputShape=a.inShape;var b=a.filterHeight,c=a.filterWidth,d=a.strideHeight,e=a.strideWidth,f="channelsLast"===a.dataFormat,g=b-1-a.padInfo.top,h=c-1-a.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+g+", "+h+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords["+(f?3:1)+"];\n\n        ivec2 dyCorner = ivec2(coords["+(f?1:2)+"], coords["+(f?2:3)+"]) - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        // Convolve dy(?, ?, d2) with w(:, :, d1, d2) to compute dx(xR, xC, d1).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+b+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+d+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+b+" - 1 - wR;\n\n          for (int wC = 0; wC < "+c+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+e+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+c+" - 1 - wC;\n\n            for (int d2 = 0; d2 < "+a.outChannels+"; d2++) {\n\n              if ("+f+") {\n                float xValue = getDy(batch, idyR, idyC, d2);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              } else {\n                float xValue = getDy(batch, d2, idyR, idyC);\n                float wValue = getW(wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},e5=function(a){this.variableNames=["x","dy"],this.outputShape=a.filterShape;var b=a.strideDepth,c=a.strideHeight,d=a.strideWidth,e=a.padInfo.front,f=a.padInfo.top,g=a.padInfo.left;this.userCode="\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int wF = coords.x;\n        int wR = coords.y;\n        int wC = coords.z;\n        int d1 = coords.w;\n        int d2 = coords.u;\n\n        float dotProd = 0.0;\n\n        for (int b = 0; b < "+a.batchSize+"; b++) {\n          for (int yF = 0; yF < "+a.outDepth+"; yF++) {\n            int xF = wF + yF * "+b+" - "+e+";\n\n            if (xF < 0 || xF >= "+a.inDepth+") {\n              continue;\n            }\n\n            for (int yR = 0; yR < "+a.outHeight+"; yR++) {\n              int xR = wR + yR * "+c+" - "+f+";\n\n              if (xR < 0 || xR >= "+a.inHeight+") {\n                continue;\n              }\n\n              for (int yC = 0; yC < "+a.outWidth+"; yC++) {\n                int xC = wC + yC * "+d+" - "+g+";\n\n                if (xC < 0 || xC >= "+a.inWidth+") {\n                  continue;\n                }\n\n                float dyValue = getDy(b, yF, yR, yC, d2);\n                float xValue = getX(b, xF, xR, xC, d1);\n                dotProd += (xValue * dyValue);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},e6=function(a){this.variableNames=["dy","W"],this.outputShape=a.inShape;var b=a.filterDepth,c=a.filterHeight,d=a.filterWidth,e=a.strideDepth,f=a.strideHeight,g=a.strideWidth,h=b-1-a.padInfo.front,i=c-1-a.padInfo.top,j=d-1-a.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+h+", "+i+", "+j+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d1 = coords.u;\n\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyFCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+b+"; wF++) {\n          float dyF = float(dyFCorner + wF) / "+e+".0;\n\n          if (dyF < 0.0 || dyF >= "+a.outDepth+".0 || fract(dyF) > 0.0) {\n            continue;\n          }\n          int idyF = int(dyF);\n\n          int wFPerm = "+b+" - 1 - wF;\n\n          for (int wR = 0; wR < "+c+"; wR++) {\n            float dyR = float(dyRCorner + wR) / "+f+".0;\n\n            if (dyR < 0.0 || dyR >= "+a.outHeight+".0 ||\n              fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            int wRPerm = "+c+" - 1 - wR;\n\n            for (int wC = 0; wC < "+d+"; wC++) {\n              float dyC = float(dyCCorner + wC) / "+g+".0;\n\n              if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              int wCPerm = "+d+" - 1 - wC;\n\n              for (int d2 = 0; d2 < "+a.outChannels+"; d2++) {\n                float xValue = getDy(batch, idyF, idyR, idyC, d2);\n                float wValue = getW(wFPerm, wRPerm, wCPerm, d1, d2);\n                dotProd += xValue * wValue;\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},e7=function(a){this.variableNames=["x","dy"],this.outputShape=a.filterShape;var b=a.strideHeight,c=a.strideWidth,d=a.padInfo.top,e=a.padInfo.left,f=a.outChannels/a.inChannels;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int wR = coords.x;\n        int wC = coords.y;\n        int d1 = coords.z;\n        int dm = coords.w;\n        int d2 = d1 * "+f+" + dm;\n\n        float dotProd = 0.0;\n\n        // TO DO: Vec4 over the batch size\n        for (int b = 0; b < "+a.batchSize+"; b++) {\n          for (int yR = 0; yR < "+a.outHeight+"; yR++) {\n            int xR = wR + yR * "+b+" - "+d+";\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int yC = 0; yC < "+a.outWidth+"; yC++) {\n              int xC = wC + yC * "+c+" - "+e+";\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              float dyValue = getDy(b, yR, yC, d2);\n              float xValue = getX(b, xR, xC, d1);\n              dotProd += (xValue * dyValue);\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},e8=function(a){this.variableNames=["dy","W"],this.outputShape=a.inShape;var b=a.filterHeight,c=a.filterWidth,d=a.strideHeight,e=a.strideWidth,f=b-1-a.padInfo.top,g=c-1-a.padInfo.left,h=a.outChannels/a.inChannels;this.userCode="\n      const ivec2 pads = ivec2("+f+", "+g+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d1 = coords[3];\n        ivec2 dyCorner = coords.yz - pads;\n        int dyRCorner = dyCorner.x;\n        int dyCCorner = dyCorner.y;\n\n        float dotProd = 0.0;\n\n        for (int wR = 0; wR < "+b+"; wR++) {\n          float dyR = float(dyRCorner + wR) / "+d+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          int wRPerm = "+b+" - 1 - wR;\n\n          for (int wC = 0; wC < "+c+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+e+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            int wCPerm = "+c+" - 1 - wC;\n\n            // TO DO: Vec4 over the channelMul\n            for (int dm = 0; dm < "+h+"; dm++) {\n              int d2 = d1 * "+h+" + dm;\n              float xValue = getDy(batch, idyR, idyC, d2);\n              float wValue = getW(wRPerm, wCPerm, d1, dm);\n              dotProd += xValue * wValue;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},e9=function(a,b,c,d){void 0===b&&(b=!1),void 0===c&&(c=null),void 0===d&&(d=!1),this.variableNames=["x","W"],this.outputShape=a.outShape;var e=a.padInfo.top,f=a.padInfo.left,g=a.strideHeight,h=a.strideWidth,i=a.dilationHeight,j=a.dilationWidth,k=a.filterHeight,l=a.filterWidth,m=4*Math.floor(a.inChannels/4),n=a.inChannels%4,o="channelsLast"===a.dataFormat,p="",q="";c&&(p=d?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+c+"\n        }":"\n          float activation(float x) {\n            "+c+"\n          }\n        ",q="result = activation(result);");var r=b?"result += getBiasAtOutCoords();":"";b&&this.variableNames.push("bias"),d&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+p+"\n\n      const ivec2 strides = ivec2("+g+", "+h+");\n      const ivec2 pads = ivec2("+e+", "+f+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d2 = coords["+(o?3:1)+"];\n\n        ivec2 xRCCorner =\n            ivec2(coords["+(o?1:2)+"], coords["+(o?2:3)+"]) * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, d2) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+k+"; wR++) {\n          int xR = xRCorner + wR * "+i+";\n\n          if (xR < 0 || xR >= "+a.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+l+"; wC++) {\n            int xC = xCCorner + wC * "+j+";\n\n            if (xC < 0 || xC >= "+a.inWidth+") {\n              continue;\n            }\n\n            for (int d1 = 0; d1 < "+m+"; d1 += 4) {\n              vec4 wValues = vec4(\n                getW(wR, wC, d1, d2),\n                getW(wR, wC, d1 + 1, d2),\n                getW(wR, wC, d1 + 2, d2),\n                getW(wR, wC, d1 + 3, d2)\n              );\n\n              if ("+o+") {\n                vec4 xValues = vec4(\n                  getX(batch, xR, xC, d1),\n                  getX(batch, xR, xC, d1 + 1),\n                  getX(batch, xR, xC, d1 + 2),\n                  getX(batch, xR, xC, d1 + 3)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec4 xValues = vec4(\n                  getX(batch, d1, xR, xC),\n                  getX(batch, d1 + 1, xR, xC),\n                  getX(batch, d1 + 2, xR, xC),\n                  getX(batch, d1 + 3, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n\n            if ("+(1===n)+") {\n\n              if ("+o+") {\n                dotProd +=\n                    getX(batch, xR, xC, "+m+") *\n                    getW(wR, wC, "+m+", d2);\n              } else {\n                dotProd +=\n                    getX(batch, "+m+", xR, xC) *\n                    getW(wR, wC, "+m+", d2);\n              }\n\n            } else if ("+(2===n)+") {\n              vec2 wValues = vec2(\n                getW(wR, wC, "+m+", d2),\n                getW(wR, wC, "+m+" + 1, d2)\n              );\n\n              if ("+o+") {\n                vec2 xValues = vec2(\n                  getX(batch, xR, xC, "+m+"),\n                  getX(batch, xR, xC, "+m+" + 1)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec2 xValues = vec2(\n                  getX(batch, "+m+", xR, xC),\n                  getX(batch, "+m+" + 1, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            } else if ("+(3===n)+") {\n              vec3 wValues = vec3(\n                getW(wR, wC, "+m+", d2),\n                getW(wR, wC, "+m+" + 1, d2),\n                getW(wR, wC, "+m+" + 2, d2)\n              );\n\n              if ("+o+") {\n                vec3 xValues = vec3(\n                  getX(batch, xR, xC, "+m+"),\n                  getX(batch, xR, xC, "+m+" + 1),\n                  getX(batch, xR, xC, "+m+" + 2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else {\n                vec3 xValues = vec3(\n                  getX(batch, "+m+", xR, xC),\n                  getX(batch, "+m+" + 1, xR, xC),\n                  getX(batch, "+m+" + 2, xR, xC)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n\n            }\n          }\n        }\n\n        float result = dotProd;\n        "+r+"\n        "+q+"\n        setOutput(result);\n      }\n    "},fa=function(a){this.variableNames=["x","W"],this.outputShape=a.outShape;var b=a.padInfo.front,c=a.padInfo.top,d=a.padInfo.left,e=a.strideDepth,f=a.strideHeight,g=a.strideWidth,h=a.dilationDepth,i=a.dilationHeight,j=a.dilationWidth,k=a.filterDepth,l=a.filterHeight,m=a.filterWidth,n=4*Math.floor(a.inChannels/4),o=a.inChannels%4;this.userCode="\n      const ivec3 strides = ivec3("+e+", "+f+", "+g+");\n      const ivec3 pads = ivec3("+b+", "+c+", "+d+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int d2 = coords.u;\n\n        ivec3 xFRCCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xFCorner = xFRCCorner.x;\n        int xRCorner = xFRCCorner.y;\n        int xCCorner = xFRCCorner.z;\n\n        // Convolve x(?, ?, ?, d1) with w(:, :, :, d1, d2) to get\n        // y(yF, yR, yC, d2). ? = to be determined. : = across all\n        // values in that axis.\n        float dotProd = 0.0;\n        for (int wF = 0; wF < "+k+"; wF++) {\n          int xF = xFCorner + wF * "+h+";\n\n          if (xF < 0 || xF >= "+a.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+l+"; wR++) {\n            int xR = xRCorner + wR * "+i+";\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+m+"; wC++) {\n              int xC = xCCorner + wC * "+j+";\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              for (int d1 = 0; d1 < "+n+"; d1 += 4) {\n                vec4 xValues = vec4(\n                  getX(batch, xF, xR, xC, d1),\n                  getX(batch, xF, xR, xC, d1 + 1),\n                  getX(batch, xF, xR, xC, d1 + 2),\n                  getX(batch, xF, xR, xC, d1 + 3)\n                );\n                vec4 wValues = vec4(\n                  getW(wF, wR, wC, d1, d2),\n                  getW(wF, wR, wC, d1 + 1, d2),\n                  getW(wF, wR, wC, d1 + 2, d2),\n                  getW(wF, wR, wC, d1 + 3, d2)\n                );\n\n                dotProd += dot(xValues, wValues);\n              }\n\n              if ("+(1===o)+") {\n                dotProd +=\n                  getX(batch, xF, xR, xC, "+n+") *\n                  getW(wF, wR, wC, "+n+", d2);\n              } else if ("+(2===o)+") {\n                vec2 xValues = vec2(\n                  getX(batch, xF, xR, xC, "+n+"),\n                  getX(batch, xF, xR, xC, "+n+" + 1)\n                );\n                vec2 wValues = vec2(\n                  getW(wF, wR, wC, "+n+", d2),\n                  getW(wF, wR, wC, "+n+" + 1, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              } else if ("+(3===o)+") {\n                vec3 xValues = vec3(\n                  getX(batch, xF, xR, xC, "+n+"),\n                  getX(batch, xF, xR, xC, "+n+" + 1),\n                  getX(batch, xF, xR, xC, "+n+" + 2)\n                );\n                vec3 wValues = vec3(\n                  getW(wF, wR, wC, "+n+", d2),\n                  getW(wF, wR, wC, "+n+" + 1, d2),\n                  getW(wF, wR, wC, "+n+" + 2, d2)\n                );\n                dotProd += dot(xValues, wValues);\n              }\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},fb=function(a,b,c,d){void 0===b&&(b=!1),void 0===c&&(c=null),void 0===d&&(d=!1),this.variableNames=["x","W"],this.outputShape=a.outShape;var e=a.inHeight,f=a.inWidth,g=a.padInfo.top,h=a.padInfo.left,i=a.strideHeight,j=a.strideWidth,k=a.dilationHeight,l=a.dilationWidth,m=a.filterHeight,n=a.filterWidth,o=a.outChannels/a.inChannels,p="",q="";c&&(p=d?"float activation(float a) {\n          float b = getPreluActivationWeightsAtOutCoords();\n          "+c+"\n        }":"\n          float activation(float x) {\n            "+c+"\n          }\n        ",q="result = activation(result);");var r=b?"result += getBiasAtOutCoords();":"";b&&this.variableNames.push("bias"),d&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+p+"\n\n      const ivec2 strides = ivec2("+i+", "+j+");\n      const ivec2 pads = ivec2("+g+", "+h+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2 / "+o+";\n        int q = d2 - d1 * "+o+";\n\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // Convolve x(?, ?, d1) with w(:, :, d1, q) to get y(yR, yC, d2).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        // TO DO(dsmilkov): Flatten the two for loops and vec4 the operations.\n        for (int wR = 0; wR < "+m+"; wR++) {\n          int xR = xRCorner + wR * "+k+";\n\n          if (xR < 0 || xR >= "+e+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+n+"; wC++) {\n            int xC = xCCorner + wC * "+l+";\n\n            if (xC < 0 || xC >= "+f+") {\n              continue;\n            }\n\n            float xVal = getX(batch, xR, xC, d1);\n            float wVal = getW(wR, wC, d1, q);\n            dotProd += xVal * wVal;\n          }\n        }\n\n        float result = dotProd;\n        "+r+"\n        "+q+"\n        setOutput(result);\n      }\n    "},fc=function(a,b,c,d){void 0===b&&(b=!1),void 0===c&&(c=null),void 0===d&&(d=!1),this.variableNames=["x","W"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a.outShape;for(var e=a.inHeight,f=a.inWidth,g=a.padInfo.top,h=a.padInfo.left,i=a.strideHeight,j=a.strideWidth,k=a.dilationHeight,l=a.dilationWidth,m=a.filterHeight,n=a.filterWidth,o="int xR; int xC; int xCOffset;",p=0;p<m;p++)for(var q=0;q<n;q++)o+="\n          vec4 xTexelR"+p+"C"+2*q+" = vec4(0.);\n          vec4 wR"+p+"C"+q+" = vec4(0.);\n          vec4 xR"+p+"C"+q+" = vec4(0.);";for(p=0;p<m;p++)for(var r=0;r<n;r++){if(o+="\n          xR = xRCorner + "+p*k+";\n          xC = xCCorner + "+(q=2*r)*l+";\n        ",1===j){if(q<n&&(o+=h%2==1?"\n                xCOffset = xC + 1;\n                if(xR >= 0 && xR < "+e+" && xCOffset >= 0 && xCOffset < "+f+") {\n                  xTexelR"+p+"C"+q+" = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+f+") {\n                    xTexelR"+p+"C"+q+".zw = vec2(0.);\n                  }\n                } else {\n                  xTexelR"+p+"C"+q+" = vec4(0.);\n                }\n\n                xCOffset = xC + 1 - 2;\n                if(xR >= 0 && xR < "+e+" && xCOffset >= 0 && xCOffset < "+f+") {\n                  vec4 previous = getX(batch, xR, xCOffset, d1);\n\n                  // Need to manually clear unused channels in case\n                  // we're reading from recycled texture.\n                  if(xCOffset + 1 >= "+f+") {\n                    previous.zw = vec2(0.);\n                  }\n\n                  xR"+p+"C"+q+" = vec4(previous.zw, xTexelR"+p+"C"+q+".xy);\n                } else {\n                  xR"+p+"C"+q+" = vec4(0, 0, xTexelR"+p+"C"+q+".xy);\n                }\n              ":"\n                if(xR >= 0 && xR < "+e+" && xC >= 0 && xC < "+f+") {\n                  xTexelR"+p+"C"+q+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+p+"C"+q+" = vec4(0.);\n                }\n\n                xR"+p+"C"+q+" = xTexelR"+p+"C"+q+";\n              ",q+1<n)){var s=h%2==0?I(l):l;l%2==0&&h%2==1||l%2!=0&&h%2!=1?(o+="\n                  xCOffset = xC + "+h%2+" + "+s+";\n\n                  if(xR >= 0 && xR < "+e+" &&\n                    xCOffset >= 0 && xCOffset < "+f+") {\n                    xTexelR"+p+"C"+(q+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n                ",l>1&&(o+="\n                    xCOffset -= 2;\n                    if(xR >= 0 && xR < "+e+" &&\n                      xCOffset >= 0 && xCOffset < "+f+") {\n                      xTexelR"+p+"C"+q+" = getX(batch, xR, xCOffset, d1);\n                    } else {\n                      xTexelR"+p+"C"+q+" = vec4(0.);\n                    }\n                  "),o+="\n                  xR"+p+"C"+(q+1)+" = vec4(\n                    xTexelR"+p+"C"+q+".zw, xTexelR"+p+"C"+(q+2)+".xy);\n                "):o+="\n                  xCOffset = xC + "+s+";\n\n                  if(xR >= 0 && xR < "+e+" &&\n                    xCOffset >= 0 && xCOffset < "+f+") {\n                    xTexelR"+p+"C"+(q+2)+" = getX(batch, xR, xCOffset, d1);\n                  }\n\n                  xR"+p+"C"+(q+1)+" = xTexelR"+p+"C"+(q+2)+";\n                "}}else q<n&&(o+="\n              if(xR >= 0 && xR < "+e+") {\n            ",h%2==1?(o+="\n                xCOffset = xC + 1 - "+j+";\n                if(xCOffset >= 0 && xCOffset < "+f+") {\n                  xTexelR"+p+"C"+q+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+p+"C"+q+" = vec4(0.);\n                }\n\n                if(xC + 1 >= 0 && xC + 1 < "+f+") {\n                  xTexelR"+p+"C"+(q+2)+" = getX(batch, xR, xC + 1, d1);\n                } else {\n                  xTexelR"+p+"C"+(q+2)+" = vec4(0.);\n                }\n\n                xR"+p+"C"+q+" = vec4(\n                  xTexelR"+p+"C"+q+".zw, xTexelR"+p+"C"+(q+2)+".zw);\n              ",q+1<n&&(o+="\n                  vec4 final = vec4(0.);\n                  xCOffset = xC + 1 + "+j+";\n                  if(xCOffset >= 0 && xCOffset < "+f+") {\n                    final = getX(batch, xR, xCOffset, d1);\n                  }\n                  xR"+p+"C"+(q+1)+" = vec4(xTexelR"+p+"C"+(q+2)+".xy, final.xy);\n                ")):(o+="\n                if(xC >= 0 && xC < "+f+") {\n                  xTexelR"+p+"C"+q+" = getX(batch, xR, xC, d1);\n                } else {\n                  xTexelR"+p+"C"+q+" = vec4(0.);\n                }\n\n                xCOffset = xC + "+j+";\n                if(xCOffset >= 0 && xCOffset < "+f+") {\n                  xTexelR"+p+"C"+(q+2)+" = getX(batch, xR, xCOffset, d1);\n                } else {\n                  xTexelR"+p+"C"+(q+2)+" = vec4(0.);\n                }\n\n                xR"+p+"C"+q+" = vec4(\n                  xTexelR"+p+"C"+q+".xy, xTexelR"+p+"C"+(q+2)+".xy);\n              ",q+1<n&&(o+="\n                  xR"+p+"C"+(q+1)+" = vec4(\n                    xTexelR"+p+"C"+q+".zw, xTexelR"+p+"C"+(q+2)+".zw);\n                ")),o+="}");q<n&&(o+="\n            vec4 wTexelR"+p+"C"+q+" = getW("+p+", "+q+", d1, q);\n            wR"+p+"C"+q+" = vec4(wTexelR"+p+"C"+q+".xz, wTexelR"+p+"C"+q+".xz);\n          ",q+1<n&&(o+="\n              vec4 wTexelR"+p+"C"+(q+1)+" = getW("+p+", "+(q+1)+", d1, q);\n              wR"+p+"C"+(q+1)+" =\n                vec4(wTexelR"+p+"C"+(q+1)+".xz, wTexelR"+p+"C"+(q+1)+".xz);"))}for(p=0;p<m;p++)for(q=0;q<n;q++)o+="dotProd += xR"+p+"C"+q+" * wR"+p+"C"+q+";";var t="",u="";c&&(t=d?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+c+"\n        }":"vec4 activation(vec4 x) {\n          "+c+"\n        }",u="result = activation(result);");var v=b?"result += getBiasAtOutCoords();":"";b&&this.variableNames.push("bias"),d&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+t+"\n\n      const ivec2 strides = ivec2("+i+", "+j+");\n      const ivec2 pads = ivec2("+g+", "+h+");\n\n      void main() {\n\n        ivec4 coords = getOutputCoords();\n        int batch = coords.x;\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int d2 = coords.w;\n        int d1 = d2;\n        int q = 0;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        vec4 dotProd = vec4(0.);\n\n        "+o+"\n\n        vec4 result = dotProd;\n        "+v+"\n        "+u+"\n        setOutput(result);\n      }\n    "},fd=function(a,b,c,d,e){this.variableNames=["Image","Boxes","BoxInd"],this.outputShape=[];var f=a[0],g=a[1],h=a[2],i=a[3],j=b[0],k=c[0],l=c[1];this.outputShape=[j,k,l,i];var m=[g-1+".0",h-1+".0"],n=m[0],o=m[1],p=k>1?[""+(g-1)/(k-1),"(y2-y1) * height_ratio","y1*"+n+" + float(y)*(height_scale)"]:["0.0","0.0","0.5 * (y1+y2) * "+n],q=p[0],r=p[1],s=p[2],t=l>1?[""+(h-1)/(l-1),"(x2-x1) * width_ratio","x1*"+o+" + float(x)*(width_scale)"]:["0.0","0.0","0.5 * (x1+x2) * "+o],u=t[0],v=t[1],w=t[2];this.userCode="\n      const float height_ratio = float("+q+");\n      const float width_ratio = float("+u+");\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int y = coords[1];\n        int x = coords[2];\n        int d = coords[3];\n\n        // get box vals\n        float y1 = getBoxes(b,0);\n        float x1 = getBoxes(b,1);\n        float y2 = getBoxes(b,2);\n        float x2 = getBoxes(b,3);\n\n        // get image in batch index\n        int bInd = round(getBoxInd(b));\n        if(bInd < 0 || bInd >= "+f+") {\n          return;\n        }\n\n        float height_scale = "+r+";\n        float width_scale = "+v+";\n\n        float in_y = "+s+";\n        if( in_y < 0.0 || in_y > "+n+" ) {\n          setOutput(float("+e+"));\n          return;\n        }\n        float in_x = "+w+";\n        if( in_x < 0.0 || in_x > "+o+" ) {\n          setOutput(float("+e+"));\n          return;\n        }\n\n        vec2 sourceFracIndexCR = vec2(in_x,in_y);\n        if("+ +("bilinear"===d)+" == 1) {\n          // Compute the four integer indices.\n          ivec2 sourceFloorCR = ivec2(sourceFracIndexCR);\n          ivec2 sourceCeilCR = ivec2(ceil(sourceFracIndexCR));\n\n          float topLeft = getImage(b, sourceFloorCR.y, sourceFloorCR.x, d);\n          float bottomLeft = getImage(b, sourceCeilCR.y, sourceFloorCR.x, d);\n          float topRight = getImage(b, sourceFloorCR.y, sourceCeilCR.x, d);\n          float bottomRight = getImage(b, sourceCeilCR.y, sourceCeilCR.x, d);\n\n          vec2 fracCR = sourceFracIndexCR - vec2(sourceFloorCR);\n\n          float top = topLeft + (topRight - topLeft) * fracCR.x;\n          float bottom = bottomLeft + (bottomRight - bottomLeft) * fracCR.x;\n          float newValue = top + (bottom - top) * fracCR.y;\n          setOutput(newValue);\n        } else {\n          // Compute the coordinators of nearest neighbor point.\n          ivec2 sourceNearestCR = ivec2(floor(\n            sourceFracIndexCR + vec2(0.5,0.5)));\n          float newValue = getImage(b, sourceNearestCR.y, sourceNearestCR.x, d);\n          setOutput(newValue);\n        }\n      }\n    "},fe=function(a,b,c){this.variableNames=["x"],this.outputShape=a;var d=a.length,e=a[a.length-1];this.userCode="\n      int getIndex(int i) {\n        "+(c?"return "+e+" -i - 1;":"return i;")+"\n      }\n\n      void main() {\n        "+eJ(d)+" coords = getOutputCoords();\n        int end = "+ff(d,"coords")+";\n        float val = 0.0;\n        for (int i = "+e+" - 1; i >= 0; i -= 1) {\n          int idx = getIndex(i);\n          if (idx "+(c?"<":">")+" end) {\n            continue;\n          }\n          if (idx == end && "+b+") {\n            continue;\n          }\n          "+ff(d,"coords")+" = idx;\n          val += getX("+function(a,b){if(1===a)return""+b;if(2===a)return b+".x, "+b+".y";if(3===a)return b+".x, "+b+".y, "+b+".z";if(4===a)return b+".x, "+b+".y, "+b+".z, "+b+".w";throw Error("Cumulative sum for rank "+a+" is not yet supported")}(d,"coords")+");\n        }\n        setOutput(val);\n      }\n    "};function ff(a,b){if(1===a)return""+b;if(2===a)return b+".y";if(3===a)return b+".z";if(4===a)return b+".w";throw Error("Cumulative sum for rank "+a+" is not yet supported")}var fg=function(a){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outPackingScheme=a2.DENSE;var b=a9(a),c=eD();this.outputShape=a,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+eE(["r","c","d"],a)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+b[0]+", "+b[1]+"));\n        int index = 4 * (resTexRC.x * "+b[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getA(rc.x, rc.y, rc.z);\n        }\n\n        "+c.output+" = result;\n      }\n    "},fh=function(a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outPackingScheme=a2.DENSE;var b=a9(a),c=eD();this.outputShape=a,this.userCode="\n      ivec3 outCoordsFromFlatIndex(int index) {\n        "+eE(["r","c","d"],a)+"\n        return ivec3(r, c, d);\n      }\n\n      void main() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n          vec2("+b[0]+", "+b[1]+"));\n        int index = 4 * (resTexRC.x * "+b[1]+" + resTexRC.y);\n\n        vec4 result = vec4(0.);\n\n        for (int i=0; i<4; i++) {\n          int flatIndex = index + i;\n          ivec3 rc = outCoordsFromFlatIndex(flatIndex);\n          result[i] = getChannel(getA(rc.x, rc.y, rc.z), vec2(rc.y, rc.z));\n        }\n\n        "+c.output+" = result;\n      }\n    "},fi=function(){function a(a,b,c){this.variableNames=["x"],this.outputShape=[],this.outputShape=a,this.blockSize=b,this.dataFormat=c,this.userCode="\n    void main() {\n      ivec4 coords = getOutputCoords();\n      int b = coords[0];\n      int h = "+this.getHeightCoordString()+";\n      int w = "+this.getWidthCoordString()+";\n      int d = "+this.getDepthCoordString()+";\n\n      int in_h = h / "+b+";\n      int offset_h = imod(h, "+b+");\n      int in_w = w / "+b+";\n      int offset_w = imod(w, "+b+");\n      int offset_d = (offset_h * "+b+" + offset_w) *\n        "+this.getOutputDepthSize()+";\n      int in_d = d + offset_d;\n\n      float result = "+this.getInputSamplingString()+";\n      setOutput(result);\n    }\n  "}return a.prototype.getHeightCoordString=function(){return"NHWC"===this.dataFormat?"coords[1]":"coords[2]"},a.prototype.getWidthCoordString=function(){return"NHWC"===this.dataFormat?"coords[2]":"coords[3]"},a.prototype.getDepthCoordString=function(){return"NHWC"===this.dataFormat?"coords[3]":"coords[1]"},a.prototype.getOutputDepthSize=function(){return"NHWC"===this.dataFormat?this.outputShape[3]:this.outputShape[1]},a.prototype.getInputSamplingString=function(){return"NHWC"===this.dataFormat?"getX(b, in_h, in_w, in_d)":"getX(b, in_d, in_h, in_w)"},a}(),fj=function(a){this.variableNames=["X"],this.outputShape=[a,a],this.userCode="\n      void main() {\n          ivec2 coords = getOutputCoords();\n          float val = coords[0] == coords[1] ? getX(coords[0]) : 0.0;\n          setOutput(val);\n      }\n    "},fk=function(a){this.variableNames=["A"],this.outTexUsage=a3.DOWNLOAD;var b=eD();this.outputShape=a,this.userCode="\n      "+eG+"\n\n      void main() {\n        float x = getAAtOutCoords();\n        "+b.output+" = encode_float(x);\n      }\n    "},fl=function(a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outTexUsage=a3.DOWNLOAD;var b=eD();this.outputShape=a,this.userCode="\n      "+eG+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n        float x = getChannel(getAAtOutCoords(), vec2(coords.y, coords.z));\n        "+b.output+" = encode_float(x);\n      }\n    "},fm=function(a,b,c){void 0===c&&(c=!1),this.variableNames=["A"];var d=eD(),e=b[0],f=b[1];this.outputShape=a;var g="result";c&&(g="floor(result * 255. + 0.5)"),this.userCode="\n      "+eF(a)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        int flatIndex = getFlatIndex(coords);\n        int offset = imod(flatIndex, 4);\n\n        flatIndex = idiv(flatIndex, 4, 1.);\n        \n        int r = flatIndex / "+f+";\n        int c = imod(flatIndex, "+f+");\n        vec2 uv = (vec2(c, r) + halfCR) / vec2("+f+".0, "+e+".0);\n        vec4 values = "+d.texture2D+"(A, uv);\n\n        float result;\n\n        if(offset == 0) {\n          result = values[0];\n        } else if(offset == 1) {\n          result = values[1];\n        } else if(offset == 2) {\n          result = values[2];\n        } else {\n          result = values[3];\n        }\n\n        "+d.output+" = vec4("+g+", 0., 0., 0.);\n      }\n    "},fn=function(a,b,c){void 0===c&&(c=!1),this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var d=eD(),e=b[0],f=b[1];this.outputShape=a;var g="",h="result";c&&(h="floor(result * 255. + 0.5)");for(var i=0;i<=1;i++)for(var j=0;j<=1;j++){var k=2*i+j;g+="\n          localCoords = coords;\n          if(localCoords[2] + "+j+" < "+a[2]+") {\n            localCoords[2] += "+j+";\n            if(localCoords[1] + "+i+" < "+a[1]+") {\n              localCoords[1] += "+i+";\n\n              flatIndex = getFlatIndex(localCoords);\n              offset = imod(flatIndex, 4);\n\n              flatIndex = idiv(flatIndex, 4, 1.);\n\n              r = flatIndex / "+f+";\n              c = imod(flatIndex, "+f+");\n              uv = (vec2(c, r) + halfCR) / vec2("+f+".0, "+e+".0);\n              values = "+d.texture2D+"(A, uv);\n\n              if(offset == 0) {\n                result["+k+"] = values[0];\n              } else if(offset == 1) {\n                result["+k+"] = values[1];\n              } else if(offset == 2) {\n                result["+k+"] = values[2];\n              } else {\n                result["+k+"] = values[3];\n              }\n            }\n          }\n        "}this.userCode="\n      "+eF(a)+"\n\n      void main() {\n        ivec3 coords = getOutputCoords();\n\n        vec4 result = vec4(0.);\n        int flatIndex, r, c, offset;\n        ivec3 localCoords;\n        vec2 uv;\n        vec4 values;\n\n        "+g+"\n\n        "+d.output+" = "+h+";\n      }\n    "},fo=function(a,b,c){this.variableNames=["real","imag"];var d=b[1];this.outputShape=b;var e=c?"2.0 * "+Math.PI:"-2.0 * "+Math.PI;this.userCode="\n      const float exponentMultiplier = "+e+";\n\n      float unaryOpComplex(float real, float expR, float imag, float expI) {\n        "+a+"\n      }\n\n      float mulMatDFT(int batch, int index) {\n        float indexRatio = float(index) / float("+d+");\n        float exponentMultiplierTimesIndexRatio =\n            exponentMultiplier * indexRatio;\n\n        float result = 0.0;\n\n        for (int i = 0; i < "+d+"; i++) {\n          // x = (-2|2 * PI / N) * index * i;\n          float x = exponentMultiplierTimesIndexRatio * float(i);\n          float expR = cos(x);\n          float expI = sin(x);\n          float real = getReal(batch, i);\n          float imag = getImag(batch, i);\n\n          result +=\n              unaryOpComplex(real, expR, imag, expI) / "+(c?d+".0":"1.0")+";\n        }\n\n        return result;\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        setOutput(mulMatDFT(coords[0], coords[1]));\n      }\n    "},fp=function(){function a(a,b){this.outputShape=[],this.variableNames=["x"],this.outputShape=a,this.userCode="\n      uniform float value;\n      void main() {\n        // Input can be obtained from uniform value.\n        setOutput(value);\n      }\n    "}return a.prototype.getCustomSetupFunc=function(a){var b=this;return function(c,d){null==b.valueLoc&&(b.valueLoc=c.getUniformLocationNoThrow(d,"value")),c.gl.uniform1f(b.valueLoc,a)}},a}(),fq=function(a,b,c){this.variableNames=["A","indices"];var d=a.slice();d[c]=b,this.outputShape=d,this.rank=d.length;var e=eJ(this.rank),f=function(a,b){var c=a.length;if(c>4)throw Error("Gather for rank "+c+" is not yet supported");if(1===c)return"int(getIndices(resRC))";for(var d=["resRC.x","resRC.y","resRC.z","resRC.w"],e=[],f=0;f<a.length;f++)f===b?e.push("int(getIndices("+d[f]+"))"):e.push(""+d[f]);return e.join()}(a,c);this.userCode="\n      void main() {\n        "+e+" resRC = getOutputCoords();\n        setOutput(getA("+f+"));\n      }\n    "},fr=function(a,b,c){this.sliceDim=a,this.strides=b,this.variableNames=["x","indices"],this.outputShape=c;var d=eJ(b.length),e=eJ(c.length),f=this.sliceDim>1?"strides[j]":"strides";this.userCode="\n        "+d+" strides = "+d+"("+this.strides+");\n         void main() {\n          "+e+" coords = getOutputCoords();\n          int flattenIndex = 0;\n          for (int j = 0; j < "+this.sliceDim+"; j++) {\n            int index = round(getIndices(coords[0], j));\n            flattenIndex += index * "+f+";\n          }\n          setOutput(getX(flattenIndex, coords[1]));\n        }\n      "};function fs(a,b){var c=eD();return bg(a,b,c.version+"\n    precision highp float;\n    "+c.attribute+" vec3 clipSpacePos;\n    "+c.attribute+" vec2 uv;\n    "+c.varyingVs+" vec2 resultUV;\n\n    void main() {\n      gl_Position = vec4(clipSpacePos, 1);\n      resultUV = uv;\n    }")}function ft(a,b){return br(a,b,new Float32Array([-1,1,0,0,1,-1,-1,0,0,0,1,1,0,1,1,1,-1,0,1,0]))}function fu(a,b){return bs(a,b,new Uint16Array([0,1,2,2,1,3]))}function fv(a,b,c,d,e,f,g){bu(c,d);var h=bt(a,b),i=a.TEXTURE_2D;return bc(a,b,function(){return a.bindTexture(i,h)}),bc(a,b,function(){return a.texParameteri(i,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE)}),bc(a,b,function(){return a.texParameteri(i,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE)}),bc(a,b,function(){return a.texParameteri(i,a.TEXTURE_MIN_FILTER,a.NEAREST)}),bc(a,b,function(){return a.texParameteri(i,a.TEXTURE_MAG_FILTER,a.NEAREST)}),bc(a,b,function(){return a.texImage2D(i,0,e,c,d,0,f,g,null)}),bc(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)}),h}function fw(a,b,c,d,e){var f=[d,c];return fv(a,b,f[0],f[1],e.internalFormatFloat,e.textureFormatFloat,a.FLOAT)}function fx(a,b,c,d,e){var f=[d,c];return fv(a,b,f[0],f[1],e.internalFormatHalfFloat,e.textureFormatFloat,e.textureTypeHalfFloat)}function fy(a,b,c,d,e){var f=[d,c];return fv(a,b,f[0],f[1],a.RGBA,a.RGBA,a.UNSIGNED_BYTE)}function fz(a,b,c,d,e){var f=ba(c,d);return fv(a,b,f[0],f[1],e.internalFormatPackedFloat,a.RGBA,a.FLOAT)}function fA(a,b,c,d,e){var f=ba(c,d);return fv(a,b,f[0],f[1],e.internalFormatPackedHalfFloat,a.RGBA,e.textureTypeHalfFloat)}function fB(a,b,c,d){return bc(a,b,function(){return a.bindBuffer(a.ARRAY_BUFFER,d)}),bw(a,b,c,"clipSpacePos",d,3,20,0)&&bw(a,b,c,"uv",d,2,20,12)}function fC(a,b,c,d,e,f,g){var h,i,j;bc(a,b,function(){return a.bindTexture(a.TEXTURE_2D,c)}),f instanceof Uint8Array?(h=new Uint8Array(d*e*4),i=a.UNSIGNED_BYTE,j=a.RGBA):(h=new Float32Array(d*e*4),i=a.FLOAT,j=g.internalFormatPackedFloat),h.set(f),bc(a,b,function(){return a.texImage2D(a.TEXTURE_2D,0,j,d,e,0,a.RGBA,i,h)}),bc(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)})}function fD(a,b,c,d){bc(a,b,function(){return a.bindTexture(a.TEXTURE_2D,c)}),d.data instanceof Uint8Array?bc(a,b,function(){return a.texImage2D(a.TEXTURE_2D,0,a.RGBA,d.width,d.height,0,a.RGBA,a.UNSIGNED_BYTE,d.data)}):bc(a,b,function(){return a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,d)}),bc(a,b,function(){return a.bindTexture(a.TEXTURE_2D,null)})}function fE(a,b,c,d,e){var f=a.createBuffer();bc(a,b,function(){return a.bindBuffer(a.PIXEL_PACK_BUFFER,f)});var g=16*c*d;return bc(a,b,function(){return a.bufferData(a.PIXEL_PACK_BUFFER,g,a.STREAM_READ)}),bc(a,b,function(){return a.readPixels(0,0,d,c,a.RGBA,a.FLOAT,0)}),bc(a,b,function(){return a.bindBuffer(a.PIXEL_PACK_BUFFER,null)}),f}function fF(a,b,c){var d=new Float32Array(c);return a.bindBuffer(a.PIXEL_PACK_BUFFER,b),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,d),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),d}function fG(a,b,c,d,e){var f=[d,c],g=f[0],h=f[1],i=new Uint8Array(c*d*4);return bc(a,b,function(){return a.readPixels(0,0,g,h,e.downloadTextureFormat,a.UNSIGNED_BYTE,i)}),new Float32Array(i.buffer)}function fH(a,b,c,d,e,f,g,h){var i,j=new Float32Array((i=ba(f,g))[0]*i[1]*4);return a.bindBuffer(a.PIXEL_PACK_BUFFER,b),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,j),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),j}function fI(a,b,c,d){var e=new Float32Array(c*d*4);return bc(a,b,function(){return a.readPixels(0,0,d,c,a.RGBA,a.FLOAT,e)}),e}var fJ=Object.freeze({createVertexShader:fs,createVertexBuffer:ft,createIndexBuffer:fu,createFloat32MatrixTexture:fw,createFloat16MatrixTexture:fx,createUnsignedBytesMatrixTexture:fy,createPackedMatrixTexture:fz,createFloat16PackedMatrixTexture:fA,bindVertexProgramAttributeStreams:fB,uploadDenseMatrixToTexture:fC,uploadPixelDataToTexture:fD,createBufferFromOutputTexture:fE,downloadFloat32MatrixFromBuffer:fF,downloadByteEncodedFloatMatrixFromOutputTexture:fG,downloadPackedMatrixFromBuffer:fH,downloadMatrixFromPackedOutputTexture:fI}),fK=function(){function a(a){this.outputTexture=null,this.program=null,this.disposed=!1,this.vertexAttrsAreBound=!1,this.itemsToPoll=[];var b=w.getNumber("WEBGL_VERSION");null!=a?(this.gl=a,a7(b,a)):this.gl=a8(b);var c="WEBGL_color_buffer_float";if(1===w.getNumber("WEBGL_VERSION")){if(this.textureFloatExtension=bf(this.gl,this.debug,"OES_texture_float"),bP(this.gl,"OES_texture_half_float"))this.textureHalfFloatExtension=bf(this.gl,this.debug,"OES_texture_half_float");else if(w.get("WEBGL_FORCE_F16_TEXTURES"))throw Error("GL context does not support half float textures, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.");if(this.colorBufferFloatExtension=this.gl.getExtension(c),bP(this.gl,"EXT_color_buffer_half_float"))this.colorBufferHalfFloatExtension=bf(this.gl,this.debug,"EXT_color_buffer_half_float");else if(w.get("WEBGL_FORCE_F16_TEXTURES"))throw Error("GL context does not support color renderable half floats, yet the environment flag WEBGL_FORCE_F16_TEXTURES is set to true.")}else if(c="EXT_color_buffer_float",bP(this.gl,c))this.colorBufferFloatExtension=this.gl.getExtension(c);else{if(!bP(this.gl,"EXT_color_buffer_half_float"))throw Error("GL context does not support color renderable floats");this.colorBufferHalfFloatExtension=this.gl.getExtension("EXT_color_buffer_half_float")}this.vertexBuffer=ft(this.gl,this.debug),this.indexBuffer=fu(this.gl,this.debug),this.framebuffer=bv(this.gl,this.debug),this.textureConfig=bb(this.gl,this.textureHalfFloatExtension)}return Object.defineProperty(a.prototype,"debug",{get:function(){return w.getBool("DEBUG")},enumerable:!0,configurable:!0}),a.prototype.dispose=function(){var a=this;if(!this.disposed){null!=this.program&&console.warn("Disposing a GPGPUContext that still has a bound WebGLProgram. This is probably a resource leak, delete the program with GPGPUContext.deleteProgram before disposing."),null!=this.outputTexture&&console.warn("Disposing a GPGPUContext that still has a bound output matrix texture.  This is probably a resource leak, delete the output matrix texture with GPGPUContext.deleteMatrixTexture before disposing.");var b=this.gl;bc(b,this.debug,function(){return b.finish()}),bc(b,this.debug,function(){return b.bindFramebuffer(b.FRAMEBUFFER,null)}),bc(b,this.debug,function(){return b.deleteFramebuffer(a.framebuffer)}),bc(b,this.debug,function(){return b.bindBuffer(b.ARRAY_BUFFER,null)}),bc(b,this.debug,function(){return b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,null)}),bc(b,this.debug,function(){return b.deleteBuffer(a.indexBuffer)}),this.disposed=!0}},a.prototype.createFloat32MatrixTexture=function(a,b){return this.throwIfDisposed(),fw(this.gl,this.debug,a,b,this.textureConfig)},a.prototype.createFloat16MatrixTexture=function(a,b){return this.throwIfDisposed(),fx(this.gl,this.debug,a,b,this.textureConfig)},a.prototype.createUnsignedBytesMatrixTexture=function(a,b){return this.throwIfDisposed(),fy(this.gl,this.debug,a,b,this.textureConfig)},a.prototype.uploadPixelDataToTexture=function(a,b){this.throwIfDisposed(),fD(this.gl,this.debug,a,b)},a.prototype.uploadDenseMatrixToTexture=function(a,b,c,d){this.throwIfDisposed(),fC(this.gl,this.debug,a,b,c,d,this.textureConfig)},a.prototype.createFloat16PackedMatrixTexture=function(a,b){return this.throwIfDisposed(),fA(this.gl,this.debug,a,b,this.textureConfig)},a.prototype.createPackedMatrixTexture=function(a,b){return this.throwIfDisposed(),fz(this.gl,this.debug,a,b,this.textureConfig)},a.prototype.deleteMatrixTexture=function(a){var b=this;this.throwIfDisposed(),this.outputTexture===a&&(bC(this.gl,this.debug,this.framebuffer),this.outputTexture=null),bc(this.gl,this.debug,function(){return b.gl.deleteTexture(a)})},a.prototype.downloadByteEncodedFloatMatrixFromOutputTexture=function(a,b,c){var d=this;return this.downloadMatrixDriver(a,function(){return fG(d.gl,d.debug,b,c,d.textureConfig)})},a.prototype.downloadPackedMatrixFromBuffer=function(a,b,c,d,e,f){return fH(this.gl,a,0,0,0,e,f,this.textureConfig)},a.prototype.downloadFloat32MatrixFromBuffer=function(a,b){return fF(this.gl,a,b)},a.prototype.createBufferFromTexture=function(a,b,c){this.bindTextureToFrameBuffer(a);var d=fE(this.gl,this.debug,b,c,this.textureConfig);return this.unbindTextureToFrameBuffer(),d},a.prototype.createAndWaitForFence=function(){var a=this.createFence(this.gl);return this.pollFence(a)},a.prototype.createFence=function(a){var b,c,d=this;if(w.getBool("WEBGL_FENCE_API_ENABLED")){var e=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0);a.flush(),c=function(){var b=a.clientWaitSync(e,0,0);return b===a.ALREADY_SIGNALED||b===a.CONDITION_SATISFIED},b=e}else w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")>0?(b=this.beginQuery(),this.endQuery(),c=function(){return d.isQueryAvailable(b,w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))}):c=function(){return!0};return{query:b,isFencePassed:c}},a.prototype.downloadMatrixFromPackedTexture=function(a,b,c){var d=this;return this.downloadMatrixDriver(a,function(){return fI(d.gl,d.debug,b,c)})},a.prototype.createProgram=function(a){this.throwIfDisposed();var b=this.gl,c=bh(b,this.debug,a),d=fs(b,this.debug),e=bo(b,this.debug);return bc(b,this.debug,function(){return b.attachShader(e,d)}),bc(b,this.debug,function(){return b.attachShader(e,c)}),bp(b,this.debug,e),this.debug&&bq(b,this.debug,e),this.vertexAttrsAreBound||(this.setProgram(e),this.vertexAttrsAreBound=fB(b,this.debug,this.program,this.vertexBuffer)),e},a.prototype.deleteProgram=function(a){var b=this;this.throwIfDisposed(),a===this.program&&(this.program=null),null!=a&&bc(this.gl,this.debug,function(){return b.gl.deleteProgram(a)})},a.prototype.setProgram=function(a){var b=this;this.throwIfDisposed(),this.program=a,null!=this.program&&this.debug&&bq(this.gl,this.debug,this.program),bc(this.gl,this.debug,function(){return b.gl.useProgram(a)})},a.prototype.getUniformLocation=function(a,b,c){return void 0===c&&(c=!0),this.throwIfDisposed(),c?by(this.gl,this.debug,a,b):bz(this.gl,a,b)},a.prototype.getAttributeLocation=function(a,b){var c=this;return this.throwIfDisposed(),bc(this.gl,this.debug,function(){return c.gl.getAttribLocation(a,b)})},a.prototype.getUniformLocationNoThrow=function(a,b){return this.throwIfDisposed(),this.gl.getUniformLocation(a,b)},a.prototype.setInputMatrixTexture=function(a,b,c){this.throwIfDisposed(),this.throwIfNoProgram(),bA(this.gl,this.debug,this.program,a,b,c)},a.prototype.setOutputMatrixTexture=function(a,b,c){this.setOutputMatrixTextureDriver(a,c,b)},a.prototype.setOutputPackedMatrixTexture=function(a,b,c){this.throwIfDisposed();var d=ba(b,c),e=d[0],f=d[1];this.setOutputMatrixTextureDriver(a,e,f)},a.prototype.setOutputMatrixWriteRegion=function(a,b,c,d){this.setOutputMatrixWriteRegionDriver(c,a,d,b)},a.prototype.setOutputPackedMatrixWriteRegion=function(a,b,c,d){throw Error("setOutputPackedMatrixWriteRegion not implemented.")},a.prototype.debugValidate=function(){null!=this.program&&bq(this.gl,this.debug,this.program),bD(this.gl)},a.prototype.executeProgram=function(){this.throwIfDisposed(),this.throwIfNoProgram();var a=this.gl;this.debug&&this.debugValidate(),bc(a,this.debug,function(){return a.drawElements(a.TRIANGLES,6,a.UNSIGNED_SHORT,0)})},a.prototype.blockUntilAllProgramsCompleted=function(){var a=this;this.throwIfDisposed(),bc(this.gl,this.debug,function(){return a.gl.finish()})},a.prototype.getQueryTimerExtension=function(){return null==this.disjointQueryTimerExtension&&(this.disjointQueryTimerExtension=bf(this.gl,this.debug,2===w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")?"EXT_disjoint_timer_query_webgl2":"EXT_disjoint_timer_query")),this.disjointQueryTimerExtension},a.prototype.getQueryTimerExtensionWebGL2=function(){return this.getQueryTimerExtension()},a.prototype.getQueryTimerExtensionWebGL1=function(){return this.getQueryTimerExtension()},a.prototype.beginQuery=function(){if(2===w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var a=this.gl,b=this.getQueryTimerExtensionWebGL2(),c=a.createQuery();return a.beginQuery(b.TIME_ELAPSED_EXT,c),c}var d=this.getQueryTimerExtensionWebGL1(),e=d.createQueryEXT();return d.beginQueryEXT(d.TIME_ELAPSED_EXT,e),e},a.prototype.endQuery=function(){if(2!==w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION")){var a=this.getQueryTimerExtensionWebGL1();a.endQueryEXT(a.TIME_ELAPSED_EXT)}else{var b=this.gl,c=this.getQueryTimerExtensionWebGL2();b.endQuery(c.TIME_ELAPSED_EXT)}},a.prototype.waitForQueryAndGetTime=function(a){return s(this,void 0,void 0,function(){var b=this;return t(this,function(c){switch(c.label){case 0:return[4,U(function(){return b.disposed||b.isQueryAvailable(a,w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))})];case 1:return c.sent(),[2,this.getQueryTime(a,w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_VERSION"))]}})})},a.prototype.getQueryTime=function(a,b){if(0===b)return null;if(2===b){var c=this.gl;return c.getQueryParameter(a,c.QUERY_RESULT)/1e6}var d=this.getQueryTimerExtensionWebGL1();return d.getQueryObjectEXT(a,d.QUERY_RESULT_EXT)/1e6},a.prototype.isQueryAvailable=function(a,b){if(0===b)return!0;if(2===b){var c=this.gl,d=this.getQueryTimerExtensionWebGL2(),e=c.getQueryParameter(a,c.QUERY_RESULT_AVAILABLE);return null==this.disjoint&&(this.disjoint=this.gl.getParameter(d.GPU_DISJOINT_EXT)),e&&!this.disjoint}return e=(d=this.getQueryTimerExtensionWebGL1()).getQueryObjectEXT(a,d.QUERY_RESULT_AVAILABLE_EXT),null==this.disjoint&&(this.disjoint=this.gl.getParameter(d.GPU_DISJOINT_EXT)),e&&!this.disjoint},a.prototype.pollFence=function(a){var b=this;return new Promise(function(c){b.addItemToPoll(function(){return a.isFencePassed()},function(){return c()})})},a.prototype.pollItems=function(){for(var a=function(a){for(var b=0;b<a.length&&a[b]();++b);return b-1}(this.itemsToPoll.map(function(a){return a.isDoneFn})),b=0;b<=a;++b)(0,this.itemsToPoll[b].resolveFn)();this.itemsToPoll=this.itemsToPoll.slice(a+1)},a.prototype.addItemToPoll=function(a,b){var c=this;this.itemsToPoll.push({isDoneFn:a,resolveFn:b}),this.itemsToPoll.length>1||U(function(){return c.pollItems(),0===c.itemsToPoll.length})},a.prototype.bindTextureToFrameBuffer=function(a){this.throwIfDisposed(),bB(this.gl,this.debug,a,this.framebuffer),this.debug&&bD(this.gl)},a.prototype.unbindTextureToFrameBuffer=function(){null!=this.outputTexture?(bB(this.gl,this.debug,this.outputTexture,this.framebuffer),this.debug&&bD(this.gl)):bC(this.gl,this.debug,this.framebuffer)},a.prototype.downloadMatrixDriver=function(a,b){this.bindTextureToFrameBuffer(a);var c=b();return this.unbindTextureToFrameBuffer(),c},a.prototype.setOutputMatrixTextureDriver=function(a,b,c){this.throwIfDisposed();var d=this.gl;bB(d,this.debug,a,this.framebuffer),this.debug&&bD(d),this.outputTexture=a,bc(d,this.debug,function(){return d.viewport(0,0,b,c)}),bc(d,this.debug,function(){return d.scissor(0,0,b,c)})},a.prototype.setOutputMatrixWriteRegionDriver=function(a,b,c,d){var e=this;this.throwIfDisposed(),bc(this.gl,this.debug,function(){return e.gl.scissor(a,b,c,d)})},a.prototype.throwIfDisposed=function(){if(this.disposed)throw Error("Attempted to use disposed GPGPUContext.")},a.prototype.throwIfNoProgram=function(){if(null==this.program)throw Error("No GPU program is currently set.")},a}();function fL(a,b){if(a.length!==b.length)throw Error("Binary was compiled with "+a.length+" inputs, but was executed with "+b.length+" inputs");a.forEach(function(a,c){var d=a.logicalShape,e=b[c],f=e.shape;if(!P(d,f))throw Error("Binary was compiled with different shapes than the current args. Shapes "+d+" and "+f+" must match");if(!a.isUniform||!e.isUniform){var g=a.texShape,h=e.isUniform?null:e.texData.texShape;if(!P(g,h))throw Error("Binary was compiled with different texture shapes than the current args. Shape "+g+" and "+h+" must match")}})}var fM=function(a,b,c){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a;for(var d=c.filterWidth,e=c.inChannels,f=c.strideWidth,g=c.strideHeight,h=c.padInfo,i=c.outWidth,j=c.dilationWidth,k=c.dilationHeight,l=c.dataFormat,m=h.left,n=h.top,o=e*d,p=eD(),q="channelsLast"===l,r=+!q,s=q?1:2,t="",u=0;u<=1;u++)for(var v=0;v<=1;v++)t+="\n          blockIndex = rc.y + "+v+";\n          pos = rc.x + "+u+";\n\n          if(blockIndex < "+a[1]+" && pos < "+a[0]+") {\n            offsetY = int(blockIndex / ("+i+")) * "+g+" - "+n+";\n            d0 = offsetY + "+k+" * (pos / "+o+");\n\n            if(d0 < "+b[r]+" && d0 >= 0) {\n\n              offsetX = int(mod(float(blockIndex), "+i+".) * "+f+". - "+m+".);\n              d1 = offsetX + "+j+" * (int(mod(float(pos), "+o+".) / "+e+".));\n\n              if(d1 < "+b[s]+" && d1 >= 0) {\n\n                ch = int(mod(float(pos), "+e+".));\n\n                if ("+q+") {\n                  innerDims = vec2(d1, ch);\n                  result["+(2*u+v)+"] = getChannel(\n                    getA(d0, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                } else {\n                  innerDims = vec2(d0, d1);\n                  result["+(2*u+v)+"] = getChannel(\n                    getA(ch, int(innerDims.x),\n                    int(innerDims.y)), innerDims);\n                }\n              }\n            }\n          }\n        ";this.userCode="\n      void main() {\n        ivec2 rc = getOutputCoords();\n\n        vec4 result = vec4(0);\n\n        int blockIndex, pos, offsetY, d0, offsetX, d1, ch;\n        vec2 innerDims;\n\n        "+t+"\n\n        "+p.output+" = result;\n      }\n    "},fN=function(a,b,c,d,e){this.variableNames=["x"],this.outputShape=[];var f,g=a[3]-1;this.outputShape=a;var h="float("+c+") + float("+d+") * sum";f=.5===e?"inversesqrt("+h+")":1===e?"1.0/("+h+")":"exp(log("+h+") * float(-"+e+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n        int d = coords[3];\n        float x = getX(b, r, c, d);\n        float sum = 0.0;\n        for (int j = -"+b+"; j <= "+b+"; j++) {\n          int idx = d + j;\n          if (idx >= 0 && idx <=  "+g+") {\n            float z = getX(b, r, c, idx);\n            sum += z * z;\n          }\n        }\n        float val = x * "+f+";\n        setOutput(val);\n      }\n    "},fO=function(a,b,c,d,e){this.variableNames=["inputImage","outputImage","dy"],this.outputShape=[],this.outputShape=a,this.depth=a[3],this.depthRadius=b,this.bias=c,this.alpha=d,this.beta=e,this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int r = coords[1];\n        int c = coords[2];\n\n        float result = 0.0;\n        for (int d = 0; d < "+this.depth+"; ++d) {\n          int depthBegin = int(max(0.0, float(d - "+b+")));\n          int depthEnd = int(min(float("+this.depth+"),\n              float(d + "+b+" + 1)));\n\n          const int MIN_DEPTH_BEGIN = 0;\n          const int MAX_DEPTH_END = "+this.depth+";\n\n          float norm = 0.0;\n          for (int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k) {\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd) {\n              norm += getInputImage(b, r, c, k) * getInputImage(b, r, c, k);\n            }\n            else {\n              break;\n            }\n          }\n\n          norm = float("+d+") * norm + float("+c+");\n\n          for(int k = MIN_DEPTH_BEGIN; k < MAX_DEPTH_END; ++k){\n            if (k < depthBegin){\n              continue;\n            }\n            else if (k >= depthBegin && k < depthEnd){\n              float dyi = -2.0 * float("+d+")\n                * float("+e+")\n                * getInputImage(b ,r ,c, k) * getOutputImage(b, r, c, d)\n                / norm;\n              if (k == d) {\n                dyi += pow(norm, -1.0 * "+e+");\n              }\n              if (k == coords[3]) {\n                dyi *= getDy(b, r, c, d);\n                result += dyi;\n              }\n            }\n            else {\n              break;\n            }\n          }\n      }\n      setOutput(result);\n      }\n    "},fP=function(a,b,c,d,e){this.variableNames=["x"],this.outputShape=[],this.packedInputs=!0,this.packedOutput=!0;var f,g=a[3]-1;this.outputShape=a;var h="float("+c+") + float("+d+") * sum";f=.5===e?"inversesqrt("+h+")":1===e?"1.0/("+h+")":"exp(log("+h+") * float(-"+e+"));",this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords.x;\n        int r = coords.y;\n        int c = coords.z;\n        int d = coords.w;\n\n        bool hasNextCol = d < "+this.outputShape[3]+";\n        bool hasNextRow = c < "+this.outputShape[2]+";\n\n        vec4 sum = vec4(0.);\n        vec4 xFragAtOutputCoords = getX(b, r, c, d);\n\n        vec4 xAtOutputCoords = vec4(\n          getChannel(xFragAtOutputCoords, vec2(c, d)),\n          hasNextCol ?\n            getChannel(xFragAtOutputCoords, vec2(c, d + 1)) : 0.0,\n          hasNextRow ?\n            getChannel(xFragAtOutputCoords , vec2(c + 1, d)) : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getChannel(xFragAtOutputCoords, vec2(c + 1, d + 1)) : 0.0\n        );\n\n        int firstChannel = d - "+b+";\n        vec2 cache = vec2(0.);\n        if(firstChannel >= 0){\n          vec4 firstChannelFrag = getX(b, r, c, firstChannel);\n          cache.x = getChannel(firstChannelFrag, vec2(c, firstChannel));\n            if(hasNextRow){\n              cache.y = getChannel(firstChannelFrag, vec2(c + 1, firstChannel));\n            }\n        }\n\n        ivec2 depth = ivec2(d, d + 1);\n        for (int j = - "+b+"; j <= "+b+"; j++) {\n          ivec2 idx = depth + j;\n          bvec2 aboveLowerBound = greaterThanEqual(idx, ivec2(0));\n          bvec2 belowUpperBound = lessThanEqual(idx, ivec2("+g+"));\n\n          bool depthInRange = aboveLowerBound.x && belowUpperBound.x;\n          bool depthPlusOneInRange = aboveLowerBound.y && belowUpperBound.y;\n\n          if(depthInRange || depthPlusOneInRange){\n            vec4 z = vec4(0.);\n            vec4 xFragAtCurrentDepth;\n            z.xz = cache.xy;\n            if(depthPlusOneInRange && hasNextCol){\n              xFragAtCurrentDepth = idx.y != d ?\n                getX(b, r, c, idx.y) : xFragAtOutputCoords;\n              z.y = getChannel(xFragAtCurrentDepth, vec2(c, idx.y));\n              if(hasNextRow){\n                z.w = getChannel(xFragAtCurrentDepth, vec2(c + 1, idx.y));\n              }\n            }\n            cache.xy = z.yw;\n            sum += z * z;\n          }\n        }\n        vec4 result = xAtOutputCoords * "+f+";\n        setOutput(result);\n      }\n    "},fQ=function(a){this.variableNames=["dy","maxPos"],this.outputShape=a.inShape;var b=a.strideHeight,c=a.strideWidth,d=a.dilationHeight,e=a.effectiveFilterHeight,f=a.effectiveFilterWidth,g=e-1-a.padInfo.top,h=f-1-a.padInfo.left;this.userCode="\n      const ivec2 pads = ivec2("+g+", "+h+");\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n\n        ivec2 dyRCCorner = coords.yz - pads;\n        int dyRCorner = dyRCCorner.x;\n        int dyCCorner = dyRCCorner.y;\n\n        // Convolve dy(?, ?, d) with pos mask(:, :, d) to get dx(xR, xC, d).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n        for (int wR = 0; wR < "+e+";\n          wR += "+d+") {\n          float dyR = float(dyRCorner + wR) / "+b+".0;\n\n          if (dyR < 0.0 || dyR >= "+a.outHeight+".0 || fract(dyR) > 0.0) {\n            continue;\n          }\n          int idyR = int(dyR);\n\n          for (int wC = 0; wC < "+f+"; wC++) {\n            float dyC = float(dyCCorner + wC) / "+c+".0;\n\n            if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                fract(dyC) > 0.0) {\n              continue;\n            }\n            int idyC = int(dyC);\n\n            float dyValue = getDy(b, idyR, idyC, d);\n            int maxPosValue = "+(e*f-1)+" - int(getMaxPos(b, idyR, idyC, d));\n\n            // Get the current value, check it against the value from the\n            // position matrix.\n            int curPosValue = wR * "+f+" + wC;\n            float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n            dotProd += dyValue * mask;\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},fR=function(a){this.variableNames=["dy","maxPos"],this.outputShape=a.inShape;var b=a.strideDepth,c=a.strideHeight,d=a.strideWidth,e=a.dilationDepth,f=a.dilationHeight,g=a.dilationWidth,h=a.effectiveFilterDepth,i=a.effectiveFilterHeight,j=a.effectiveFilterWidth,k=h-1-a.padInfo.front,l=i-1-a.padInfo.top,m=j-1-a.padInfo.left;this.userCode="\n      const ivec3 pads = ivec3("+k+", "+l+", "+m+");\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 dyCorner = ivec3(coords.y, coords.z, coords.w) - pads;\n        int dyDCorner = dyCorner.x;\n        int dyRCorner = dyCorner.y;\n        int dyCCorner = dyCorner.z;\n\n        // Convolve dy(?, ?, ?, ch) with pos mask(:, :, :, d) to get\n        // dx(xD, xR, xC, ch).\n        // ? = to be determined. : = across all values in that axis.\n        float dotProd = 0.0;\n\n        for (int wD = 0; wD < "+h+";\n           wD += "+e+") {\n          float dyD = float(dyDCorner + wD) / "+b+".0;\n\n          if (dyD < 0.0 || dyD >= "+a.outDepth+".0 || fract(dyD) > 0.0) {\n            continue;\n          }\n          int idyD = int(dyD);\n\n          for (int wR = 0; wR < "+i+";\n              wR += "+f+") {\n            float dyR = float(dyRCorner + wR) / "+c+".0;\n\n            if (dyR < 0.0 || dyR >= "+a.outHeight+".0 ||\n                fract(dyR) > 0.0) {\n              continue;\n            }\n            int idyR = int(dyR);\n\n            for (int wC = 0; wC < "+j+";\n                wC += "+g+") {\n              float dyC = float(dyCCorner + wC) / "+d+".0;\n\n              if (dyC < 0.0 || dyC >= "+a.outWidth+".0 ||\n                  fract(dyC) > 0.0) {\n                continue;\n              }\n              int idyC = int(dyC);\n\n              float dyValue = getDy(batch, idyD, idyR, idyC, ch);\n              int maxPosValue = "+(h*i*j-1)+" -\n                  int(getMaxPos(batch, idyD, idyR, idyC, ch));\n\n              // Get the current value, check it against the value from the\n              // position matrix.\n              int curPosValue =\n                  wD * "+i+" * "+j+" +\n                  wR * "+j+" + wC;\n              float mask = float(maxPosValue == curPosValue ? 1.0 : 0.0);\n\n              dotProd += dyValue * mask;\n            }\n          }\n        }\n        setOutput(dotProd);\n      }\n    "},fS=function(a,b,c,d,e,f,g){void 0===c&&(c=!1),void 0===d&&(d=!1),void 0===e&&(e=!1),void 0===f&&(f=null),void 0===g&&(g=!1),this.variableNames=["matrixA","matrixB"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=b;var h=Math.ceil((c?a[1]:a[2])/2),i=c?"i * 2, rc.y":"rc.y, i * 2",j=d?"rc.z, i * 2":"i * 2, rc.z",k=c?["a.xxyy","a.zzww"]:["a.xxzz","a.yyww"],l=d?["b.xzxz","b.ywyw"]:["b.xyxy","b.zwzw"],m="",n="";f&&(m=g?"vec4 activation(vec4 a) {\n          vec4 b = getPreluActivationWeightsAtOutCoords();\n          "+f+"\n        }":"vec4 activation(vec4 x) {\n          "+f+"\n        }",n="result = activation(result);");var o=e?"result += getBiasAtOutCoords();":"";e&&this.variableNames.push("bias"),g&&this.variableNames.push("preluActivationWeights"),this.userCode="\n      "+m+"\n\n      const float sharedDimension = "+h+".0;\n\n      vec4 dot2x2ARowBCol(ivec3 rc) {\n        vec4 result = vec4(0);\n        for (int i = 0; i < "+h+"; i++) {\n          vec4 a = getMatrixA(rc.x, "+i+");\n          vec4 b = getMatrixB(rc.x, "+j+");\n\n          // These swizzled products need to be separately added.\n          // See: https://github.com/tensorflow/tfjs/issues/1735\n          result += ("+k[0]+" * "+l[0]+");\n          result += ("+k[1]+" * "+l[1]+");\n        }\n        return result;\n      }\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n        vec4 result = dot2x2ARowBCol(rc);\n\n        "+o+"\n\n        "+n+"\n\n        setOutput(result);\n      }\n    "},fT=function(){function a(a,b,c){this.variableNames=["probs"],this.outputShape=[a,c],this.userCode="\n      uniform float seed;\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n\n        float r = random(seed);\n        float cdf = 0.0;\n\n        for (int i = 0; i < "+(b-1)+"; i++) {\n          cdf += getProbs(batch, i);\n\n          if (r < cdf) {\n            setOutput(float(i));\n            return;\n          }\n        }\n\n        // If no other event happened, last event happened.\n        setOutput(float("+(b-1)+"));\n      }\n    "}return a.prototype.getCustomSetupFunc=function(a){var b=this;return function(c,d){null==b.seedLoc&&(b.seedLoc=c.getUniformLocation(d,"seed")),c.gl.uniform1f(b.seedLoc,a)}},a}(),fU=function(a,b,c,d){this.variableNames=["indices"],this.outputShape=[a,b],this.userCode="\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int index = round(getIndices(coords.x));\n        setOutput(mix(float("+d+"), float("+c+"),\n                      float(index == coords.y)));\n      }\n    "},fV=function(a){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0,this.outputShape=a;var b=a.length;if(0===b)this.userCode="\n        void main() {\n          setOutput(vec4(getA(), 0., 0., 0.));\n        }\n      ";else{var c,d,e=eC("rc",b),f=eJ(b),g=function(a,b,c){if(1===a)return"rc > "+b[0];for(var d="",e=a-2;e<a;e++)d+=c[e]+" >= "+b[e],e<a-1&&(d+="||");return d}(b,a,e),h=function(a,b,c,d){if(1===a)return"";var e=d.slice(-2);return"\n    int r = "+e[0]+";\n    int c = "+e[1]+";\n    int rp1 = r + 1;\n    int cp1 = c + 1;\n\n    bool cEdge = cp1 >= "+b+";\n    bool rEdge = rp1 >= "+c+";\n  "}(b,a[a.length-1],a[a.length-2],e),i=(d=function(a,b){for(var c=[],d=0;d<=1;d++)for(var e=0;e<=1;e++){for(var f=(0===d?"r":"rp1")+", "+(0===e?"c":"cp1"),g=2;g<a;g++)f=b[b.length-1-g]+","+f;c.push(f)}return c}(c=a.length,e),1===c?"getA(rc),\n            rc + 1 >= "+a[0]+" ? 0. : getA(rc + 1),\n            0, 0":"getA("+d[0]+"),\n          cEdge ? 0. : getA("+d[1]+"),\n          rEdge ? 0. : getA("+d[2]+"),\n          rEdge || cEdge ? 0. : getA("+d[3]+")");this.userCode="\n        void main() {\n          "+f+" rc = getOutputCoords();\n\n          if("+g+") {\n            setOutput(vec4(0));\n          } else {\n            "+h+"\n\n            setOutput(vec4("+i+"));\n          }\n        }\n      "}},fW=function(a,b,c){this.variableNames=["x"],this.outputShape=b.map(function(b,c){return b[0]+a[c]+b[1]});var d=a.length,e=eJ(d),f=b.map(function(a){return a[0]}).join(","),g=b.map(function(b,c){return b[0]+a[c]}).join(","),h=["coords[0]","coords[1]","coords[2]","coords[3]"].slice(0,d);this.userCode=1!==d?"\n      "+e+" start = "+e+"("+f+");\n      "+e+" end = "+e+"("+g+");\n\n      void main() {\n        "+e+" outC = getOutputCoords();\n        if (any(lessThan(outC, start)) || any(greaterThanEqual(outC, end))) {\n          setOutput(float("+c+"));\n        } else {\n          "+e+" coords = outC - start;\n          setOutput(getX("+h+"));\n        }\n      }\n    ":"\n        int start = "+f+";\n        int end = "+g+";\n\n        void main() {\n          int outC = getOutputCoords();\n          if (outC < start || outC >= end) {\n            setOutput(float("+c+"));\n          } else {\n            setOutput(getX(outC - start));\n          }\n        }\n      "},fX=function(a,b,c){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=b.map(function(b,c){return b[0]+a[c]+b[1]});for(var d=a.length,e=eJ(d),f=b.map(function(a){return a[0]}).join(","),g=b.map(function(b,c){return b[0]+a[c]}).join(","),h=eC("rc",d),i=eC("source",d),j=h[d-1]+" < "+this.outputShape[d-1],k=1===d?"source":"vec2("+i.slice(-2).join()+")",l=[e+" rc = outputLoc;",h[d-1]+" += 1;\n       if("+j+") {\n      ",1===d?"":"}\n       rc = outputLoc;\n       "+h[d-2]+" += 1;\n       if("+h[d-2]+" < "+this.outputShape[d-2]+") {",1===d?"":"  "+h[d-1]+" += 1;\n         if("+j+") {"],m=1===d?"rc < start || rc >= end":"any(lessThan(rc, start)) || any(greaterThanEqual(rc, end))",n="",o=0,p=1===d?2:4;o<p;o++)n+="\n        "+l[o]+"\n        if ("+m+") {\n          result["+o+"] = float("+c+");\n        } else {\n          "+e+" source = rc - start;\n          result["+o+"] = getChannel(getX("+i.join()+"), "+k+");\n        }\n      ";n+=1===d?"} ":"}}",this.userCode="\n      const "+e+" start = "+e+"("+f+");\n      const "+e+" end = "+e+"("+g+");\n\n      void main() {\n        "+e+" outputLoc = getOutputCoords();\n        vec4 result = vec4(0.);\n        "+n+"\n        setOutput(result);\n      }\n    "},fY=function(a,b,c){if(this.variableNames=["x"],"avg"===b&&c)throw Error("Cannot compute positions for average pool.");var d=a.filterWidth,e=a.strideHeight,f=a.strideWidth,g=a.dilationHeight,h=a.dilationWidth,i=a.effectiveFilterHeight,j=a.effectiveFilterWidth,k=a.padInfo.top,l=a.padInfo.left;this.outputShape=a.outShape;var m="avg"===b,n="0.0";if(m||(n="-1.0 / 1e-20"),c)this.userCode="\n        const ivec2 strides = ivec2("+e+", "+f+");\n        const ivec2 pads = ivec2("+k+", "+l+");\n\n        void main() {\n          ivec4 coords = getOutputCoords();\n          int batch = coords[0];\n          int d = coords[3];\n\n          ivec2 xRCCorner = coords.yz * strides - pads;\n          int xRCorner = xRCCorner.x;\n          int xCCorner = xRCCorner.y;\n\n          // max/min x(?, ?, d) to get y(yR, yC, d).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n          float avgValue = 0.0;\n\n          for (int wR = 0; wR < "+i+";\n              wR += "+g+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+j+";\n                wC += "+h+") {\n              int xC = xCCorner + wC;\n\n              if (xC < 0 || xC >= "+a.inWidth+") {\n                continue;\n              }\n\n              float value = getX(batch, xR, xC, d);\n\n              // If a min / max value has already been found, use it. If not,\n              // use the current value.\n              float currMinMaxValue = mix(\n                  value, minMaxValue, minMaxValueFound);\n              if (value >= currMinMaxValue) {\n                minMaxValue = value;\n                minMaxValueFound = 1.0;\n                minMaxPosition = wR * "+j+" + wC;\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var o=b+"("+b+"("+b+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===b&&(o="avgValue / count");var p=4*Math.floor(d/4),q=d%4,r="\n      if ("+m+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec2 strides = ivec2("+e+", "+f+");\n      const ivec2 pads = ivec2("+k+", "+l+");\n      const float initializationValue = "+n+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xR, int xC, int d) {\n        if (xC < 0 || xC >= "+a.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xR, xC, d);\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int batch = coords[0];\n        int d = coords[3];\n\n        ivec2 xRCCorner = coords.yz * strides - pads;\n        int xRCorner = xRCCorner.x;\n        int xCCorner = xRCCorner.y;\n\n        // max/min x(?, ?, d) to get y(yR, yC, d).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+n+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wR = 0; wR < "+i+";\n            wR += "+g+") {\n          int xR = xRCorner + wR;\n\n          if (xR < 0 || xR >= "+a.inHeight+") {\n            continue;\n          }\n\n          for (int wC = 0; wC < "+p+"; wC += 4) {\n            int xC = xCCorner + wC * "+h+";\n\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+h+", d),\n              getValue(batch, xR, xC + 2 * "+h+", d),\n              getValue(batch, xR, xC + 3 * "+h+", d)\n            );\n\n            "+r+"\n          }\n\n          int xC = xCCorner + "+p+";\n          if ("+(1===q)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              initializationValue,\n              initializationValue,\n              initializationValue\n            );\n\n            "+r+"\n          } else if ("+(2===q)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+h+", d),\n              initializationValue,\n              initializationValue\n            );\n\n            "+r+"\n          } else if ("+(3===q)+") {\n            vec4 values = vec4(\n              getValue(batch, xR, xC, d),\n              getValue(batch, xR, xC + "+h+", d),\n              getValue(batch, xR, xC + 2 * "+h+", d),\n              initializationValue\n            );\n\n            "+r+"\n          }\n        }\n        setOutput("+o+");\n      }\n    "}},fZ=function(a,b,c){if(this.variableNames=["x"],"avg"===b&&c)throw Error("Cannot compute positions for average pool.");var d=a.filterWidth,e=a.strideDepth,f=a.strideHeight,g=a.strideWidth,h=a.dilationDepth,i=a.dilationHeight,j=a.dilationWidth,k=a.effectiveFilterDepth,l=a.effectiveFilterHeight,m=a.effectiveFilterWidth,n=a.padInfo.front,o=a.padInfo.top,p=a.padInfo.left;this.outputShape=a.outShape;var q="avg"===b,r="0.0";if(q||(r="-1.0 / 1e-20"),c)this.userCode="\n        const ivec3 strides =\n            ivec3("+e+", "+f+", "+g+");\n        const ivec3 pads = ivec3("+n+", "+o+", "+p+");\n\n        void main() {\n          ivec5 coords = getOutputCoords();\n          int batch = coords.x;\n          int ch = coords.u;\n\n          ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n          int xDCorner = xCorner.x;\n          int xRCorner = xCorner.y;\n          int xCCorner = xCorner.z;\n\n          // max/min x(?, ?, ?, ch) to get y(yD, yR, yC, ch).\n          // ? = to be determined\n          float minMaxValue = 0.0;\n          float minMaxValueFound = 0.0;\n          int minMaxPosition = 0;\n\n          for (int wD = 0; wD < "+k+";\n              wD += "+h+") {\n            int xD = xDCorner + wD;\n\n            if (xD < 0 || xD >= "+a.inDepth+") {\n              continue;\n            }\n\n            for (int wR = 0; wR < "+l+";\n                wR += "+i+") {\n              int xR = xRCorner + wR;\n\n              if (xR < 0 || xR >= "+a.inHeight+") {\n                continue;\n              }\n\n              for (int wC = 0; wC < "+m+";\n                  wC += "+j+") {\n                int xC = xCCorner + wC;\n\n                if (xC < 0 || xC >= "+a.inWidth+") {\n                  continue;\n                }\n\n                float value = getX(batch, xD, xR, xC, ch);\n\n                // If a min / max value has already been found, use it. If not,\n                // use the current value.\n                float currMinMaxValue = mix(\n                    value, minMaxValue, minMaxValueFound);\n                if (value >= currMinMaxValue) {\n                  minMaxValue = value;\n                  minMaxValueFound = 1.0;\n                  minMaxPosition =\n                      wD * "+l+" * "+m+" +\n                      wR * "+m+" + wC;;\n                }\n              }\n            }\n          }\n          setOutput(float(minMaxPosition));\n        }\n      ";else{var s=b+"("+b+"("+b+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"avg"===b&&(s="avgValue / count");var t=4*Math.floor(d/4),u=d%4,v="\n      if ("+q+") {\n        avgValue += dot(values, ones);\n      } else {\n        minMaxValue = max(values, minMaxValue);\n      }\n    ";this.userCode="\n      const ivec3 strides =\n        ivec3("+e+", "+f+", "+g+");\n      const ivec3 pads = ivec3("+n+", "+o+", "+p+");\n      const float initializationValue = "+r+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float count = 0.0;\n\n      float getValue(int batch, int xD, int xR, int xC, int ch) {\n        if (xC < 0 || xC >= "+a.inWidth+") {\n          return initializationValue;\n        }\n        count += 1.0;\n        return getX(batch, xD, xR, xC, ch);\n      }\n\n      void main() {\n        ivec5 coords = getOutputCoords();\n        int batch = coords.x;\n        int ch = coords.u;\n\n        ivec3 xCorner = ivec3(coords.y, coords.z, coords.w) * strides - pads;\n        int xDCorner = xCorner.x;\n        int xRCorner = xCorner.y;\n        int xCCorner = xCorner.z;\n\n        // max/min x(?, ?, ?, d) to get y(yD, yR, yC, ch).\n        // ? = to be determined\n        vec4 minMaxValue = vec4("+r+");\n        float avgValue = 0.0;\n        count = 0.0;\n\n        for (int wD = 0; wD < "+k+";\n            wD += "+h+") {\n          int xD = xDCorner + wD;\n\n          if (xD < 0 || xD >= "+a.inDepth+") {\n            continue;\n          }\n\n          for (int wR = 0; wR < "+l+";\n            wR += "+i+") {\n            int xR = xRCorner + wR;\n\n            if (xR < 0 || xR >= "+a.inHeight+") {\n              continue;\n            }\n\n            for (int wC = 0; wC < "+t+"; wC += 4) {\n              int xC = xCCorner + wC * "+j+";\n\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+j+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+j+", ch),\n                getValue(batch, xD, xR, xC + 3 * "+j+", ch)\n              );\n\n              "+v+"\n            }\n\n            int xC = xCCorner + "+t+";\n            if ("+(1===u)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                initializationValue,\n                initializationValue,\n                initializationValue\n              );\n\n              "+v+"\n            } else if ("+(2===u)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+j+", ch),\n                initializationValue,\n                initializationValue\n              );\n\n              "+v+"\n            } else if ("+(3===u)+") {\n              vec4 values = vec4(\n                getValue(batch, xD, xR, xC, ch),\n                getValue(batch, xD, xR, xC + "+j+", ch),\n                getValue(batch, xD, xR, xC + 2 * "+j+", ch),\n                initializationValue\n              );\n\n              "+v+"\n            }\n          }\n          setOutput("+s+");\n        }\n      }\n    "}},f$=function(a,b){this.variableNames=["x"];var c=a.windowSize,d=a.batchSize,e=a.inSize,f=Math.ceil(e/c);this.outputShape=[d,f];var g="0.0",h="";"prod"===b?g="1.0":"min"===b?(g="1.0 / 1e-20",h="min"):"max"===b&&(g="-1.0 / 1e-20",h="max");var i=b+"("+b+"("+b+"(minMaxValue[0], minMaxValue[1]), minMaxValue[2]), minMaxValue[3])";"sum"===b?i="sumValue":"prod"===b?i="prodValue":"all"===b?i="allValue":"any"===b&&(i="anyValue");var j=4*Math.floor(c/4),k=c%4,l="\n      if ("+("sum"===b)+") {\n        sumValue += dot(values, ones);\n      } else if ("+("prod"===b)+") {\n        vec2 tmp = vec2(values[0], values[1]) * vec2(values[2], values[3]);\n        prodValue *= tmp[0] * tmp[1];\n      } else {\n        minMaxValue = "+h+"(values, minMaxValue);\n      }\n    ",m="vec4";"all"===b?(g="1.0",l="\n        bool reducedAllValue = all(values);\n        float floatedReducedAllValue = float(reducedAllValue);\n        allValue = float(allValue >= 1.0 && floatedReducedAllValue >= 1.0);\n      ",m="bvec4"):"any"===b&&(g="0.0",l="\n        bool reducedAnyValue = any(values);\n        float floatedReducedAnyValue = float(reducedAnyValue);\n        anyValue = float(anyValue >= 1.0 || floatedReducedAnyValue >= 1.0);\n      ",m="bvec4");var n="";e%c>0&&(n="\n        if (inIdx < 0 || inIdx >= "+e+") {\n          return initializationValue;\n        }\n      "),this.userCode="\n      const float initializationValue = "+g+";\n      const vec4 ones = vec4(1.0, 1.0, 1.0, 1.0);\n\n      float getValue(int batch, int inIdx) {\n        "+n+"\n        return getX(batch, inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = outIdx * "+c+";\n\n        vec4 minMaxValue = vec4("+g+");\n        float prodValue = 1.0;\n        float sumValue = 0.0;\n        float allValue = 1.0;\n        float anyValue = 0.0;\n\n        for (int i = 0; i < "+j+"; i += 4) {\n          int inIdx = inOffset + i;\n          "+m+" values = "+m+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          "+l+"\n        }\n\n        int inIdx = inOffset + "+j+";\n        if ("+(1===k)+") {\n          "+m+" values = "+m+"(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          "+l+"\n        } else if ("+(2===k)+") {\n          "+m+" values = "+m+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          "+l+"\n        } else if ("+(3===k)+") {\n          "+m+" values = "+m+"(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          "+l+"\n        }\n        setOutput("+i+");\n      }\n    "},f_=function(a,b){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a;for(var c="",d=0;d<4;d++){var e="thisRC = rc;";d%2==1&&(e+="thisRC.z += 1;"),d>1&&(e+="thisRC.y += 1;"),c+="\n        "+e+"\n        "+(d>0?"if(thisRC.y < rows && thisRC.z < cols){":"")+"\n          int flatIndex = getFlatIndex(thisRC);\n\n          ivec3 inputRC = inputCoordsFromReshapedOutCoords(flatIndex);\n          vec2 inputRCInnerDims = vec2(float(inputRC.y),float(inputRC.z));\n\n          result["+d+"] =\n            getChannel(getA(inputRC.x, inputRC.y, inputRC.z), inputRCInnerDims);\n        "+(d>0?"}":"")+"\n      "}this.userCode="\n      \n    ivec3 inputCoordsFromReshapedOutCoords(int index) {\n      "+eE(["r","c","d"],b)+"\n      return ivec3(r, c, d);\n    }\n  \n      "+eF(a)+"\n\n      void main() {\n        ivec3 rc = getOutputCoords();\n\n        vec4 result = vec4(0.);\n\n        ivec3 thisRC;\n        int rows = "+a[1]+";\n        int cols = "+a[2]+";\n\n        "+c+"\n\n        setOutput(result);\n      }\n    "},f0=function(a,b,c){this.variableNames=["dy"],this.outputShape=[],this.outputShape=b.shape;var d=b.shape,e=d[1],f=d[2],g=a.shape,h=g[1],i=g[2],j=[c&&h>1?e-1:e,c&&i>1?f-1:f],k=[c&&h>1?h-1:h,c&&i>1?i-1:i],l=j[0]/k[0],m=j[1]/k[1],n=1/l,o=1/m,p=2*Math.ceil(n)+2,q=2*Math.ceil(o)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+l+");\n        const float widthScale = float("+m+");\n\n        const float invHeightScale = float("+n+");\n        const float invWidthScale = float("+o+");\n\n        const int winHeight = int("+p+");\n        const int winWidth = int("+q+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(startRLerp - float(winHeight / 2));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(startCLerp - float(winWidth / 2));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+h+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+i+") {\n              continue;\n            }\n\n            float dxR = float(dyR) * heightScale;\n            int topDxRIndex = int(floor(dxR));\n            int bottomDxRIndex = int(min(ceil(dxR), "+(e-1)+".0));\n            float dxRLerp = dxR - float(topDxRIndex);\n            float inverseDxRLerp = 1.0 - dxRLerp;\n\n            float dxC = float(dyC) * widthScale;\n            int leftDxCIndex = int(floor(dxC));\n            int rightDxCIndex = int(min(ceil(dxC), "+(f-1)+".0));\n            float dxCLerp = dxC - float(leftDxCIndex);\n            float inverseDxCLerp = 1.0 - dxCLerp;\n\n            if (r == topDxRIndex && c == leftDxCIndex) {\n              // topLeft\n              accumulator +=\n                getDy(b, dyR, dyC, d) * inverseDxRLerp * inverseDxCLerp;\n            }\n\n            if (r == topDxRIndex && c == rightDxCIndex) {\n              // topRight\n              accumulator += getDy(b, dyR, dyC, d) * inverseDxRLerp * dxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == leftDxCIndex) {\n              // bottomLeft\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * inverseDxCLerp;\n            }\n\n            if (r == bottomDxRIndex && c == rightDxCIndex) {\n              // bottomRight\n              accumulator += getDy(b, dyR, dyC, d) * dxRLerp * dxCLerp;\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},f1=function(a,b,c,d){this.variableNames=["A"],this.outputShape=[];var e=a[0],f=a[1],g=a[2],h=a[3];this.outputShape=[e,b,c,h];var i=[d&&b>1?f-1:f,d&&c>1?g-1:g],j=[d&&b>1?b-1:b,d&&c>1?c-1:c];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+i[0]/j[0]+",\n          "+i[1]/j[1]+");\n      const vec2 inputShapeRC = vec2("+f+".0, "+g+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec2 sourceFloorRC = ivec2(sourceFracIndexRC);\n        ivec2 sourceCeilRC = ivec2(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        float topLeft = getA(b, sourceFloorRC.x, sourceFloorRC.y, d);\n        float bottomLeft = getA(b, sourceCeilRC.x, sourceFloorRC.y, d);\n        float topRight = getA(b, sourceFloorRC.x, sourceCeilRC.y, d);\n        float bottomRight = getA(b, sourceCeilRC.x, sourceCeilRC.y, d);\n\n        vec2 fracRC = sourceFracIndexRC - vec2(sourceFloorRC);\n\n        float top = topLeft + (topRight - topLeft) * fracRC.y;\n        float bottom = bottomLeft + (bottomRight - bottomLeft) * fracRC.y;\n        float newValue = top + (bottom - top) * fracRC.x;\n\n        setOutput(newValue);\n      }\n    "},f2=function(a,b,c,d){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=[];var e=a[0],f=a[1],g=a[2],h=a[3];this.outputShape=[e,b,c,h];var i=[d&&b>1?f-1:f,d&&c>1?g-1:g],j=[d&&b>1?b-1:b,d&&c>1?c-1:c];this.userCode="\n      const vec3 effectiveInputOverOutputRatioRC = vec3(\n          "+i[0]/j[0]+",\n          "+i[1]/j[1]+",\n          "+i[1]/j[1]+");\n      const vec3 inputShapeRC = vec3("+f+".0, "+g+".0,\n                                     "+g+".0);\n\n      float getAValue(int b, int r, int c, int d) {\n        return getChannel(getA(b, r, c, d), vec2(c, d));\n      }\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        // Calculate values for next column in yRC.z.\n        ivec3 yRC = coords.yzz + ivec3(0, 0, 1);\n\n        // Fractional source index.\n        vec3 sourceFracIndexRC = vec3(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the four integer indices.\n        ivec3 sourceFloorRC = ivec3(sourceFracIndexRC);\n        ivec3 sourceCeilRC = ivec3(\n          min(inputShapeRC - 1.0, ceil(sourceFracIndexRC)));\n\n        // Should we calculate next column and row elements in 2x2 packed cell.\n        bool hasNextCol = d < "+(h-1)+";\n        bool hasNextRow = coords.z < "+(c-1)+";\n\n        // In parallel, construct four corners for all four components in\n        // packed 2x2 cell.\n        vec4 topLeft = vec4(\n          getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 bottomLeft = vec4(\n          getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceFloorRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceFloorRC.z, d + 1) : 0.0);\n\n        vec4 topRight = vec4(\n          getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceFloorRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceFloorRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec4 bottomRight = vec4(\n          getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d),\n          hasNextCol ? getAValue(b, sourceCeilRC.x, sourceCeilRC.y, d + 1)\n                     : 0.0,\n          hasNextRow ? getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d)\n                     : 0.0,\n          (hasNextRow && hasNextCol) ?\n            getAValue(b, sourceCeilRC.x, sourceCeilRC.z, d + 1) : 0.0);\n\n        vec3 fracRC = sourceFracIndexRC - vec3(sourceFloorRC);\n\n        vec4 top = mix(topLeft, topRight, fracRC.yyzz);\n        vec4 bottom = mix(bottomLeft, bottomRight, fracRC.yyzz);\n        vec4 newValue = mix(top, bottom, fracRC.x);\n\n        setOutput(newValue);\n      }\n    "},f3=function(a,b,c){this.variableNames=["dy"],this.outputShape=[],this.outputShape=b.shape;var d=b.shape,e=d[1],f=d[2],g=a.shape,h=g[1],i=g[2],j=[c&&h>1?e-1:e,c&&i>1?f-1:f],k=[c&&h>1?h-1:h,c&&i>1?i-1:i],l=j[0]/k[0],m=j[1]/k[1],n=1/l,o=1/m,p=2*Math.ceil(n)+2,q=2*Math.ceil(o)+2;this.userCode="\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        int r = coords[1];\n        int c = coords[2];\n\n        float accumulator = 0.0;\n\n        const float heightScale = float("+l+");\n        const float widthScale = float("+m+");\n\n        const float invHeightScale = float("+n+");\n        const float invWidthScale = float("+o+");\n\n        const int winHeight = int("+p+");\n        const int winWidth = int("+q+");\n\n        // Compute bounds for where in dy we will look\n        float startRLerp = floor(float(r) * invHeightScale);\n        int startDyR = int(floor(startRLerp - float(winHeight / 2)));\n\n        float startCLerp = floor(float(c) * invWidthScale);\n        int startDyC = int(floor(startCLerp - float(winWidth / 2)));\n\n        // Loop over dy\n        for (int dyROffset = 0; dyROffset < winHeight; dyROffset++) {\n          int dyR = dyROffset + startDyR;\n\n          // Guard against the window exceeding the bounds of dy\n          if (dyR < 0 || dyR >= "+h+") {\n            continue;\n          }\n\n          for (int dyCOffset = 0; dyCOffset < winWidth; dyCOffset++) {\n            int dyC = dyCOffset + startDyC;\n\n            // Guard against the window exceeding the bounds of dy\n            if (dyC < 0 || dyC >= "+i+") {\n              continue;\n            }\n\n            float sourceFracRow =\n              float("+j[0]+") *\n                (float(dyR) / float("+k[0]+"));\n\n            float sourceFracCol =\n                float("+j[1]+") *\n                  (float(dyC) / float("+k[1]+"));\n\n            int sourceNearestRow = int(min(\n                float(int("+e+") - 1),\n                "+c+" ? float(round(sourceFracRow)) :\n                                  float(floor(sourceFracRow))));\n\n            int sourceNearestCol = int(min(\n                float(int("+f+") - 1),\n                "+c+" ? float(round(sourceFracCol)) :\n                                  float(floor(sourceFracCol))));\n\n            if (r == sourceNearestRow && c == sourceNearestCol) {\n              accumulator += getDy(b, dyR, dyC, d);\n            }\n          }\n        }\n        // End loop over dy\n\n        setOutput(accumulator);\n      }\n    "},f4=function(a,b,c,d){this.variableNames=["A"],this.outputShape=[];var e=a[0],f=a[1],g=a[2],h=a[3];this.outputShape=[e,b,c,h];var i=[d&&b>1?f-1:f,d&&c>1?g-1:g],j=[d&&b>1?b-1:b,d&&c>1?c-1:c];this.userCode="\n      const vec2 effectiveInputOverOutputRatioRC = vec2(\n          "+i[0]/j[0]+",\n          "+i[1]/j[1]+");\n      const vec2 inputShapeRC = vec2("+f+".0, "+g+".0);\n\n      void main() {\n        ivec4 coords = getOutputCoords();\n        int b = coords[0];\n        int d = coords[3];\n        ivec2 yRC = coords.yz;\n\n        // Fractional source index.\n        vec2 sourceFracIndexRC = vec2(yRC) * effectiveInputOverOutputRatioRC;\n\n        // Compute the coordinators of nearest neighbor point.\n        ivec2 sourceNearestRC = ivec2(\n          min(inputShapeRC - 1.0, floor(sourceFracIndexRC + "+(d?"0.5":"0.0")+")));\n\n        float newValue = getA(b, sourceNearestRC.x, sourceNearestRC.y, d);\n\n        setOutput(newValue);\n      }\n    "},f5=function(a,b){this.variableNames=["x"];var c=a.length;if(c>4)throw Error("WebGL backend: Reverse of rank-"+c+" tensor is not yet supported");if(this.outputShape=a,1!==c){var d=a.map(function(c,d){return -1!==b.indexOf(d)&&1!==a[d]?a[d]+" - coords["+d+"] - 1":"coords["+d+"]"}).join(","),e=eJ(c);this.userCode="\n      void main() {\n        "+e+" coords = getOutputCoords();\n        setOutput(getX("+d+"));\n      }\n    "}else this.userCode="\n        void main() {\n          int coord = getOutputCoords();\n          setOutput(getX("+a[0]+" - coord - 1));\n        }\n      "},f6=function(a,b){this.variableNames=["x"],this.packedInputs=!0,this.packedOutput=!0;var c,d,e,f=a.length;if(f>4)throw Error("WebGL backend: Reverse of rank-"+f+" tensor is not yet supported");this.outputShape=a;var g=eC("rc",f),h=g[f-1]+" + 1 < "+this.outputShape[f-1],i=g[f-2]+" + 1 < "+this.outputShape[f-2],j=eJ(f);function k(c){var d=a.map(function(d,e){return -1!==b.indexOf(e)&&1!==a[e]?a[e]+" - "+c[e]+" - 1":""+c[e]});return"getChannel(getX("+d.join(",")+"), vec2("+d.slice(-2).join(",")+"))"}this.userCode=1===f?"\n        void main(){\n          int rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = getChannel(getX("+a[0]+" - rc - 1),\n            "+a[0]+" - rc - 1);\n          if("+h+"){\n              result.g = getChannel(getX("+a[0]+" - (rc  + 1) - 1),\n                "+a[0]+" - (rc  + 1) - 1);\n          }\n          setOutput(result);\n        }\n      ":"\n        void main() {\n          "+j+" rc = getOutputCoords();\n          vec4 result = vec4(0.);\n          result.r = "+k(g.slice())+";\n          if("+h+"){\n            result.g = "+((c=g.slice())[f-1]="("+c[f-1]+" + 1)",k(c))+";\n          }\n          if("+i+") {\n            result.b = "+((d=g.slice())[f-2]="("+d[f-2]+" + 1)",k(d))+";\n            if("+h+") {\n              result.a = "+((e=g.slice())[f-1]="("+e[f-1]+" + 1)",e[f-2]="("+e[f-2]+" + 1)",k(e))+";\n            }\n          }\n          setOutput(result);\n        }\n    "},f7=function(a,b,c,d,e,f,g){void 0===g&&(g=!0),this.variableNames=["updates","indices","defaultValue"],this.outputShape=f;var h=eJ(e.length),i=eJ(f.length),j="";1===c?j="i":2===c&&(j="i, j");var k="getIndices("+j+")",l="";1===d?l="i":2===d&&(l="i, coords[1]");var m="getUpdates("+l+")";this.userCode="\n        "+h+" strides = "+h+"("+e+");\n\n        void main() {\n          "+i+" coords = getOutputCoords();\n          float sum = 0.0;\n          bool found = false;\n          for (int i = 0; i < "+a+"; i++) {\n            int flattenedIndex = 0;\n            for (int j = 0; j < "+b+"; j++) {\n              int index = round("+k+");\n              flattenedIndex += index * "+(b>1?"strides[j]":"strides")+";\n            }\n            if (flattenedIndex == coords[0]) {\n              sum += "+m+";\n              found = true;\n            }\n          }\n          setOutput(mix(getDefaultValue(), sum, float(found)));\n        }\n      "},f8=function(a,b){this.variableNames=["x","segmentIds"];var c=a.windowSize,d=a.batchSize,e=a.inSize,f=a.numSegments,g=f*Math.ceil(e/c);this.outputShape=[d,g];var h=4*Math.floor(c/4),i=c%4,j="\n        sumValue += dot(values, segFilter);\n    ",k="";e%c>0&&(k="\n        if (inIdx < 0 || inIdx >= "+e+") {\n          return initializationValue;\n        }\n      ");var l="";e%c>0&&(l="\n        if (inIdx < 0 || inIdx >= "+e+") {\n          return -1.0;\n        }\n      "),this.userCode="\n      const float initializationValue = 0.0;\n\n      float getValue(int batch, int inIdx) {\n        "+k+"\n        return getX(batch, inIdx);\n      }\n\n      float getSegmentIdAtIndex(int inIdx) {\n        "+l+"\n        return getSegmentIds(inIdx);\n      }\n\n      void main() {\n        ivec2 coords = getOutputCoords();\n        int batch = coords[0];\n        int outIdx = coords[1];\n        int inOffset = int(floor(float(outIdx) / float(\n          "+f+")) * float("+c+"));\n        int currentSeg = int(mod(float(outIdx), float("+f+")));\n\n        float sumValue = 0.0;\n\n        for (int i = 0; i < "+h+"; i += 4) {\n          int inIdx = inOffset + i;\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            getValue(batch, inIdx + 3)\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 3)) == currentSeg ? 1 : 0\n          );\n\n          "+j+"\n        }\n\n        int inIdx = inOffset + "+h+";\n        if ("+(1===i)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            initializationValue,\n            initializationValue,\n            initializationValue\n          );\n\n          int inIdxSeg = int(getSegmentIdAtIndex(inIdx));\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            0,\n            0,\n            0\n          );\n\n          "+j+"\n        } else if ("+(2===i)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            initializationValue,\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n              0,\n              0\n          );\n\n          "+j+"\n        } else if ("+(3===i)+") {\n          vec4 values = vec4(\n            getValue(batch, inIdx),\n            getValue(batch, inIdx + 1),\n            getValue(batch, inIdx + 2),\n            initializationValue\n          );\n\n          vec4 segFilter = vec4(\n            int(getSegmentIdAtIndex(inIdx)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 1)) == currentSeg ? 1 : 0,\n            int(getSegmentIdAtIndex(inIdx + 2)) == currentSeg ? 1 : 0,\n            0\n          );\n\n          "+j+"\n        }\n        setOutput(sumValue);\n      }\n    "},f9=function(a,b,c){if(this.variableNames=["c","a","b"],this.outputShape=b,c>4)throw Error("Where for rank "+c+" is not yet supported");if(1===c)e="resRC",d="resRC";else{for(var d,e,f=["resRC.x","resRC.y","resRC.z","resRC.w"],g=[],h=[],i=0;i<b.length;i++)h.push(""+f[i]),i<a&&g.push(""+f[i]);d=g.join(),e=h.join()}var j=eJ(c);this.userCode="\n      void main() {\n        "+j+" resRC = getOutputCoords();\n        float cVal = getC("+d+");\n        if (cVal >= 1.0) {\n          setOutput(getA("+e+"));\n        } else {\n          setOutput(getB("+e+"));\n        }\n      }\n    "},ga=function(){function a(a){this.variableNames=["source"],this.outputShape=a,this.rank=a.length;var b,c=eJ(this.rank),d="uniform int start["+this.rank+"];",e=function(a){if(1===a)return"sourceLoc";if(a<=6)return gb.slice(0,a).map(function(a){return"sourceLoc."+a}).join(",");throw Error("Slicing for rank "+a+" is not yet supported")}(this.rank);b="\n        "+c+" sourceLoc;\n        "+c+" coords = getOutputCoords();\n        "+a.map(function(a,b){return"sourceLoc."+gb[b]+" = start["+b+"] + coords."+gb[b]+";"}).join("\n")+"\n      ",this.userCode="\n      "+d+"\n      void main() {\n        "+b+"\n        setOutput(getSource("+e+"));\n      }\n    "}return a.prototype.getCustomSetupFunc=function(a){var b=this;if(a.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+a.length+")");return function(c,d){null==b.startLoc&&(b.startLoc=c.getUniformLocationNoThrow(d,"start"),null==b.startLoc)||c.gl.uniform1iv(b.startLoc,a)}},a}(),gb=["x","y","z","w","u","v"],gc=function(){function a(a){this.variableNames=["source"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.rank=a.length;var b=eJ(this.rank),c=eC("coords",this.rank),d=eC("sourceLoc",this.rank),e=1===this.rank?"sourceLoc":"vec2("+d.slice(-2).join()+")",f="getChannel(getSource("+d.join()+"), "+e+")",g="\n      result.x = "+f+";\n      if (++"+c[this.rank-1]+" < "+a[this.rank-1]+") {\n        ++"+d[this.rank-1]+";\n        result.y = "+f+";\n        --"+d[this.rank-1]+";\n      }\n    ",h=1===this.rank?"":"\n      --"+c[this.rank-1]+";\n      if (++"+c[this.rank-2]+" < "+a[this.rank-2]+") {\n        ++"+d[this.rank-2]+";\n        result.z = "+f+";\n        if (++"+c[this.rank-1]+" < "+a[this.rank-1]+") {\n          ++"+d[this.rank-1]+";\n          result.w = "+f+";\n        }\n      }\n    ",i=this.rank<=4?"sourceLoc = coords +\n            "+b+"("+a.map(function(a,b){return"start["+b+"]"}).join()+");":a.map(function(a,b){return d[b]+" = "+c[b]+" + start["+b+"];"}).join("\n");this.userCode="\n      uniform int start["+this.rank+"];\n      void main() {\n        "+b+" coords = getOutputCoords();\n        "+b+" sourceLoc;\n        "+i+"\n        vec4 result = vec4(0.);\n        "+g+"\n        "+h+"\n        setOutput(result);\n      }\n    "}return a.prototype.getCustomSetupFunc=function(a){var b=this;if(a.length!==this.rank)throw Error("The rank ("+this.rank+") of the program must match the length of start ("+a.length+")");return function(c,d){null==b.startLoc&&(b.startLoc=c.getUniformLocationNoThrow(d,"start"),null==b.startLoc)||c.gl.uniform1iv(b.startLoc,a)}},a}(),gd=function(a,b,c){this.variableNames=["x"],this.outputShape=c;var d=c.length,e=eJ(c.length),f=eJ(c.length),g="";if(1===d)g="coords * strides + begin";else{var h=0;g=c.map(function(a,b){return h++,1===c.length?"coords * strides["+b+"] + begin["+b+"]":"coords["+(h-1)+"] * strides["+b+"] + begin["+b+"]"}).join(",")}this.userCode="\n      "+e+" begin = "+e+"("+a+");\n      "+e+" strides = "+e+"("+b+");\n\n      void main() {\n        "+f+" coords = getOutputCoords();\n        setOutput(getX("+g+"));\n      }\n    "},ge=function(){function a(a){this.gpgpu=a,this.numUsedTextures=0,this.numFreeTextures=0,this.freeTextures={},this.logEnabled=!1,this.usedTextures={}}return a.prototype.acquireTexture=function(a,b,c){var d,e=gf(b,c),f=gg(a,e,c);if(f in this.freeTextures||(this.freeTextures[f]=[]),f in this.usedTextures||(this.usedTextures[f]=[]),this.freeTextures[f].length>0){this.numFreeTextures--,this.numUsedTextures++,this.log();var g=this.freeTextures[f].shift();return this.usedTextures[f].push(g),g}return this.numUsedTextures++,this.log(),e===a4.PACKED_2X2_FLOAT32?d=this.gpgpu.createPackedMatrixTexture(a[0],a[1]):e===a4.PACKED_2X2_FLOAT16?d=this.gpgpu.createFloat16PackedMatrixTexture(a[0],a[1]):e===a4.UNPACKED_FLOAT32?d=this.gpgpu.createFloat32MatrixTexture(a[0],a[1]):e===a4.UNPACKED_FLOAT16?d=this.gpgpu.createFloat16MatrixTexture(a[0],a[1]):e===a4.PACKED_4X1_UNSIGNED_BYTE&&(d=this.gpgpu.createUnsignedBytesMatrixTexture(a[0],a[1])),this.usedTextures[f].push(d),d},a.prototype.releaseTexture=function(a,b,c,d){if(null!=this.freeTextures){var e=gg(b,gf(c,d),d);e in this.freeTextures||(this.freeTextures[e]=[]),this.freeTextures[e].push(a),this.numFreeTextures++,this.numUsedTextures--;var f=this.usedTextures[e],g=f.indexOf(a);if(g<0)throw Error("Cannot release a texture that was never provided by this texture manager");f.splice(g,1),this.log()}},a.prototype.log=function(){if(this.logEnabled){var a=this.numFreeTextures+this.numUsedTextures;console.log("Free/Used",this.numFreeTextures+" / "+this.numUsedTextures,"("+a+")")}},a.prototype.getNumUsedTextures=function(){return this.numUsedTextures},a.prototype.getNumFreeTextures=function(){return this.numFreeTextures},a.prototype.dispose=function(){var a=this;if(null!=this.freeTextures){for(var b in this.freeTextures)this.freeTextures[b].forEach(function(b){a.gpgpu.deleteMatrixTexture(b)});for(var b in this.usedTextures)this.usedTextures[b].forEach(function(b){a.gpgpu.deleteMatrixTexture(b)});this.freeTextures=null,this.usedTextures=null,this.numUsedTextures=0,this.numFreeTextures=0}},a}();function gf(a,b){if(a===a3.UPLOAD)return a4.PACKED_2X2_FLOAT32;if(a===a3.RENDER||null==a)return w.getBool("WEBGL_RENDER_FLOAT32_ENABLED")?b?a4.PACKED_2X2_FLOAT32:a4.UNPACKED_FLOAT32:b?a4.PACKED_2X2_FLOAT16:a4.UNPACKED_FLOAT16;if(a===a3.DOWNLOAD||a===a3.PIXELS)return a4.PACKED_4X1_UNSIGNED_BYTE;throw Error("Unknown logical texture type "+a)}function gg(a,b,c){return a[0]+"_"+a[1]+"_"+b+"_"+c}var gh=function(a,b){this.variableNames=["A"];for(var c=Array(a.length),d=0;d<c.length;d++)c[d]=a[d]*b[d];this.outputShape=c,this.rank=c.length;var e=eJ(this.rank),f=function(a){var b=a.length;if(b>5)throw Error("Tile for rank "+b+" is not yet supported");if(1===b)return"imod(resRC, "+a[0]+")";for(var c=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u"],d=[],e=0;e<a.length;e++)d.push("imod("+c[e]+", "+a[e]+")");return d.join()}(a);this.userCode="\n      void main() {\n        "+e+" resRC = getOutputCoords();\n        setOutput(getA("+f+"));\n      }\n    "},gi=function(a,b){this.variableNames=["A"];for(var c=Array(a.length),d=0;d<c.length;d++)c[d]=a[b[d]];this.outputShape=c,this.rank=c.length;var e=eJ(this.rank),f=function(a){var b=a.length;if(b>6)throw Error("Transpose for rank "+b+" is not yet supported");for(var c=["resRC.x","resRC.y","resRC.z","resRC.w","resRC.u","resRC.v"],d=Array(b),e=0;e<a.length;e++)d[a[e]]=c[e];return d.join()}(b);this.userCode="\n    void main() {\n      "+e+" resRC = getOutputCoords();\n      setOutput(getA("+f+"));\n    }\n    "},gj=function(a,b){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0;for(var c=Array(a.length),d=0;d<c.length;d++)c[d]=a[b[d]];if(this.outputShape=c,this.rank=c.length,this.rank>6)throw Error("Packed transpose for rank "+this.rank+" is not yet supported.");var e=eJ(this.rank),f=eB("rc",this.rank),g=Array(this.rank);for(d=0;d<b.length;d++)g[b[d]]=f[d];var h="vec2("+g.slice(-2).join()+")",i="++"+f[this.rank-1]+" < "+c[this.rank-1],j="getChannel(getA("+g.join()+"), "+h+")";this.userCode="\n    void main() {\n      "+e+" rc = getOutputCoords();\n      vec4 result = vec4(0.);\n      result[0] = "+j+";\n      if("+i+") {\n        result[1] = "+j+";\n      }\n      --"+f[this.rank-1]+";\n      if(++"+f[this.rank-2]+" < "+c[this.rank-2]+") {\n        result[2] = "+j+";\n        if("+i+") {\n          result[3] = "+j+";\n        }\n      }\n      setOutput(result);\n    }\n    "},gk=function(a,b){this.variableNames=["A"],this.outputShape=a,this.userCode="\n      float unaryOperation(float x) {\n        "+b+"\n      }\n\n      void main() {\n        float x = getAAtOutCoords();\n        float y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},gl="if (isnan(x)) return x;",gm="return abs(x);",gn=gl+"\n  return (x < 0.0) ? 0.0 : x;\n",go=gl+"\n  return (x < 0.0) ? 0.0 : min(6.0, x);\n",gp="return (x >= 0.0) ? x : (exp(x) - 1.0);",gq="return -x;",gr="return ceil(x);",gs="return floor(x);",gt="return exp(x);",gu="return exp(x) - 1.0;",gv=gl+"\n  return sin(x);\n",gw=gl+"\n  return cos(x);\n",gx=gl+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return asin(x);\n",gy=gl+"\n  if (abs(x) > 1.) {\n    return NAN;\n  }\n  return acos(x);\n",gz=gl+"\n  return atan(x);\n",gA=gl+"return log(x + sqrt(x * x + 1.0));",gB=gl+"\n  if (x < 1.0) return NAN;\n  return log(x + sqrt(x * x - 1.0));",gC=gl+"\n  if ((x < -1.0) || (x > 1.0)) return NAN;\n  return (log(1.0 + x) - log(1.0 - x)) / 2.0;",gD="return x;",gE="\n  vec4 result = x * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",gF="\n  vec4 result = min(x, vec4(6.)) * vec4(greaterThanEqual(x, vec4(0.0)));\n  bvec4 isNaN = isnan(x);\n\n  result.r = isNaN.r ? x.r : result.r;\n  result.g = isNaN.g ? x.g : result.g;\n  result.b = isNaN.b ? x.b : result.b;\n  result.a = isNaN.a ? x.a : result.a;\n\n  return result;\n",gG="\n  vec4 result;\n\n  result.r = (x.r >= 0.0) ? x.r : (exp(x.r) - 1.0);\n  result.g = (x.g >= 0.0) ? x.g : (exp(x.g) - 1.0);\n  result.b = (x.b >= 0.0) ? x.b : (exp(x.b) - 1.0);\n  result.a = (x.a >= 0.0) ? x.a : (exp(x.a) - 1.0);\n\n  return result;\n",gH=function(a,b){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!0,this.outputShape=a,this.userCode="\n      vec4 unaryOperation(vec4 x) {\n        "+b+"\n      }\n\n      void main() {\n        vec4 x = getAAtOutCoords();\n        vec4 y = unaryOperation(x);\n\n        setOutput(y);\n      }\n    "},gI=function(a){this.variableNames=["A"],this.packedInputs=!0,this.packedOutput=!1,this.outputShape=a;var b=a.length,c=eC("rc",b),d=eJ(b),e=function(a,b){if(1===a)return"rc";for(var c="",d=0;d<a;d++)c+=b[d],d<a-1&&(c+=",");return c}(b,c),f=c.slice(-2),g=b<=1?"rc":"vec2("+f.join(",")+")";this.userCode="\n      void main() {\n        "+d+" rc = getOutputCoords();\n        vec4 packedInput = getA("+e+");\n\n        setOutput(getChannel(packedInput, "+g+"));\n      }\n    "},gJ={};function gK(a,b){if(void 0===b&&(b=!1),"linear"===a)return"return x;";if("relu"===a)return b?gE:gn;if("elu"===a)return b?gG:gp;if("relu6"===a)return b?gF:go;if("prelu"===a)return b?eX:eV;throw Error("Activation "+a+" has not been implemented for the WebGL backend.")}var gL=function(a){function b(b){var c,d=a.call(this)||this;if(d.pendingRead=new WeakMap,d.pendingDisposal=new WeakSet,d.dataRefCount=new WeakMap,d.numBytesInGPU=0,d.uploadWaitMs=0,d.downloadWaitMs=0,d.warnedAboutMemory=!1,d.pendingDeletes=0,d.disposed=!1,!w.getBool("HAS_WEBGL"))throw Error("WebGL is not supported on this device");if(null==b){var e=a8(w.getNumber("WEBGL_VERSION"));(c=w.getNumber("WEBGL_VERSION"))in gJ||(gJ[c]={}),d.binaryCache=gJ[c],d.gpgpu=new fK(e),d.canvas=e.canvas,d.gpgpuCreatedLocally=!0}else d.gpgpu=b,d.binaryCache={},d.gpgpuCreatedLocally=!1,d.canvas=b.gl.canvas;return d.textureManager=new ge(d.gpgpu),d.numMBBeforeWarning=null==w.global.screen?1024:w.global.screen.height*w.global.screen.width*window.devicePixelRatio*600/1024/1024,d.texData=new d1(d,a_),d}return r(b,a),b.prototype.numDataIds=function(){return this.texData.numDataIds()+(this.cpuBackend?this.cpuBackend.numDataIds():0)-this.pendingDeletes},b.prototype.write=function(a,b,c){if(w.getBool("DEBUG")&&this.checkNumericalProblems(a),"complex64"===c&&null!=a)throw Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");var d={};return this.texData.set(d,{shape:b,dtype:c,values:a,usage:a3.UPLOAD}),d},b.prototype.move=function(a,b,c,d){if(w.getBool("DEBUG")&&this.checkNumericalProblems(b),"complex64"===d)throw Error("Cannot write to a complex64 dtype. Please use tf.complex(real, imag).");this.texData.set(a,{shape:c,dtype:d,values:b,usage:a3.UPLOAD})},b.prototype.readSync=function(a){var b=this.texData.get(a),c=b.values,d=b.dtype,e=b.complexTensors,f=b.slice,g=b.shape,h=b.isPacked;if(null!=f){var i=void 0;i=h?new gH(g,gD):new gk(g,gD);var j=this.runWebGLProgram(i,[{dataId:a,shape:g,dtype:d}],d),k=this.readSync(j.dataId);return this.disposeData(j.dataId),k}if(null!=c)return this.convertAndCacheOnCPU(a);if("string"===d)return c;var l,m,n=null!=this.activeTimers;return n&&(l=ap()),m="complex64"===d?en(e.real.dataSync(),e.imag.dataSync()):this.getValuesFromTexture(a),n&&(this.downloadWaitMs+=ap()-l),this.convertAndCacheOnCPU(a,m)},b.prototype.read=function(a){return s(this,void 0,void 0,function(){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,u,v;return t(this,function(t){switch(t.label){case 0:if(this.pendingRead.has(a))return b=this.pendingRead.get(a),[2,new Promise(function(a){return b.push(a)})];if(d=(c=this.texData.get(a)).values,e=c.shape,f=c.slice,g=c.dtype,h=c.complexTensors,i=c.isPacked,null!=f)return j=void 0,j=i?new gH(e,gD):new gk(e,gD),k=this.runWebGLProgram(j,[{dataId:a,shape:e,dtype:g}],g),l=this.read(k.dataId),this.disposeData(k.dataId),[2,l];if(null!=d)return[2,this.convertAndCacheOnCPU(a)];if(!w.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")&&2===w.getNumber("WEBGL_VERSION"))throw Error("tensor.data() with WEBGL_DOWNLOAD_FLOAT_ENABLED=false and WEBGL_VERSION=2 not yet supported.");return m=null,"complex64"!==g&&w.get("WEBGL_BUFFER_SUPPORTED")&&(n=this.decode(a),o=this.texData.get(n.dataId),m=(v=this.gpgpu).createBufferFromTexture.apply(v,[o.texture].concat(a9(e)))),this.pendingRead.set(a,[]),"complex64"===g?[3,2]:[4,this.gpgpu.createAndWaitForFence()];case 1:t.sent(),t.label=2;case 2:return"complex64"!==g?[3,4]:[4,Promise.all([h.real.data(),h.imag.data()])];case 3:return p=en((q=t.sent())[0],q[1]),[3,5];case 4:null==m?p=this.getValuesFromTexture(a):(r=O(e),p=this.gpgpu.downloadFloat32MatrixFromBuffer(m,r)),t.label=5;case 5:return null!=n&&this.disposeData(n.dataId),s=this.convertAndCacheOnCPU(a,p),u=this.pendingRead.get(a),this.pendingRead.delete(a),u.forEach(function(a){return a(s)}),this.pendingDisposal.has(a)&&(this.pendingDisposal.delete(a),this.disposeData(a),this.pendingDeletes--),[2,s]}})})},b.prototype.checkNumericalProblems=function(a){if(null!=a)for(var b=0;b<a.length;b++){var c=a[b];if(!bd(c)){if(w.getBool("WEBGL_RENDER_FLOAT32_CAPABLE"))throw Error("The value "+c+" cannot be represented with your current settings. Consider enabling float32 rendering: 'tf.env().set('WEBGL_RENDER_FLOAT32_ENABLED', true);'");throw Error("The value "+c+" cannot be represented on this device.")}}},b.prototype.getValuesFromTexture=function(a){var b,c=this.texData.get(a),d=c.shape,e=c.dtype,f=c.isPacked,g=O(d);if(w.getBool("WEBGL_DOWNLOAD_FLOAT_ENABLED")){var h=this.decode(a),i=this.texData.get(h.dataId),j=(b=this.gpgpu).downloadMatrixFromPackedTexture.apply(b,[i.texture].concat(a9(d))).subarray(0,g);return this.disposeData(h.dataId),j}var k=w.getBool("WEBGL_PACK")&&!0===f,l=k?bJ(d):d,m=k?new fl(l):new fk(l),n=this.runWebGLProgram(m,[{shape:l,dtype:e,dataId:a}],"float32"),o=this.texData.get(n.dataId),p=this.gpgpu.downloadByteEncodedFloatMatrixFromOutputTexture(o.texture,o.texShape[0],o.texShape[1]).subarray(0,g);return this.disposeData(n.dataId),p},b.prototype.time=function(a){return s(this,void 0,void 0,function(){var b,c,d,e,f,g,h;return t(this,function(i){switch(i.label){case 0:return b=this.activeTimers,c=[],d=!1,null==this.programTimersStack?(this.programTimersStack=c,d=!0):this.activeTimers.push(c),this.activeTimers=c,a(),e=N(this.activeTimers.map(function(a){return a.query})).filter(function(a){return null!=a}),f=N(this.activeTimers.map(function(a){return a.name})).filter(function(a){return null!=a}),this.activeTimers=b,d&&(this.programTimersStack=null),g={uploadWaitMs:this.uploadWaitMs,downloadWaitMs:this.downloadWaitMs,kernelMs:null,wallMs:null},w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[4,Promise.all(e)]:[3,2];case 1:return h=i.sent(),g.kernelMs=J(h),g.getExtraProfileInfo=function(){return h.map(function(a,b){return{name:f[b],ms:a}}).map(function(a){return a.name+": "+a.ms}).join(", ")},[3,3];case 2:g.kernelMs={error:"WebGL query timers are not supported in this environment."},i.label=3;case 3:return this.uploadWaitMs=0,this.downloadWaitMs=0,[2,g]}})})},b.prototype.memory=function(){return{unreliable:!1,numBytesInGPU:this.numBytesInGPU}},b.prototype.startTimer=function(){return w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.beginQuery():{startMs:ap(),endMs:null}},b.prototype.endTimer=function(a){return w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?this.gpgpu.endQuery():a.endMs=ap(),a},b.prototype.getQueryTime=function(a){return s(this,void 0,void 0,function(){var b;return t(this,function(c){return w.getNumber("WEBGL_DISJOINT_QUERY_TIMER_EXTENSION_RELIABLE")>0?[2,this.gpgpu.waitForQueryAndGetTime(a)]:[2,(b=a).endMs-b.startMs]})})},b.prototype.disposeData=function(a){if(!this.pendingDisposal.has(a)){if(this.pendingRead.has(a))return this.pendingDisposal.add(a),void this.pendingDeletes++;if(this.texData.has(a)){this.releaseGPUData(a);var b=this.texData.get(a).complexTensors;null!=b&&(b.real.dispose(),b.imag.dispose()),this.texData.delete(a)}}},b.prototype.releaseGPUData=function(a){var b=this.texData.get(a),c=b.texture,d=b.dtype,e=b.texShape,f=b.usage,g=b.isPacked,h=b.slice,i=h&&h.origDataId||a,j=this.dataRefCount.get(i);j>1?this.dataRefCount.set(i,j-1):(this.dataRefCount.delete(i),null!=c&&(this.numBytesInGPU-=this.computeBytes(e,d),this.textureManager.releaseTexture(c,e,f,g)));var k=this.texData.get(a);k.texture=null,k.texShape=null,k.isPacked=!1,k.slice=null},b.prototype.getTexture=function(a){return this.uploadToGPU(a),this.texData.get(a).texture},b.prototype.getDataInfo=function(a){return this.texData.get(a)},b.prototype.getCPUBackend=function(){return w.getBool("WEBGL_CPU_FORWARD")?(null==this.cpuBackend&&(this.cpuBackend=a_.findBackend("cpu")),this.cpuBackend):null},b.prototype.shouldExecuteOnCPU=function(a,b){var c=this;return void 0===b&&(b=128),null!=this.getCPUBackend()&&a.every(function(a){return null==c.texData.get(a.dataId).texture&&a.size<b})},b.prototype.getGPGPUContext=function(){return this.gpgpu},b.prototype.complex=function(a,b){var c=this.makeOutput(a.shape,"complex64");return this.texData.get(c.dataId).complexTensors={real:a_.keep(a.clone()),imag:a_.keep(b.clone())},c},b.prototype.real=function(a){return this.texData.get(a.dataId).complexTensors.real.clone()},b.prototype.imag=function(a){return this.texData.get(a.dataId).complexTensors.imag.clone()},b.prototype.slice=function(a,b,c){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.slice(a,b,c);if(0===O(c))return cz([],c,a.dtype);var d=this.texData.get(a.dataId).isPacked,e=dR(a.shape,b,c);if(d||!e){var f=w.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new gc(c):new ga(c),g=f.getCustomSetupFunc(b);return this.compileAndRun(f,[a],null,g)}return this.uploadToGPU(a.dataId),this.shallowSlice(a,b,c)},b.prototype.shallowSlice=function(a,b,c){var d=this.texData.get(a.dataId),e=this.makeOutput(c,a.dtype),f=this.texData.get(e.dataId);Object.assign(f,d),f.shape=c,f.dtype=a.dtype;var g=dS(b,a.strides);d.slice&&(g+=d.slice.flatOffset),f.slice={flatOffset:g,origDataId:d.slice&&d.slice.origDataId||a.dataId};var h=this.dataRefCount.get(f.slice.origDataId)||1;return this.dataRefCount.set(f.slice.origDataId,h+1),e},b.prototype.stridedSlice=function(a,b,c,d){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.stridedSlice(a,b,c,d);var e=dO(b,c,d);if(e.some(function(a){return 0===a}))return cz([],e);var f=new gd(b,d,e);return this.compileAndRun(f,[a])},b.prototype.reverse=function(a,b){var c=w.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new f6(a.shape,b):new f5(a.shape,b);return this.compileAndRun(c,[a])},b.prototype.concat=function(a,b){if("complex64"===a[0].dtype){var c=a.map(function(a){return cx(a)}),d=a.map(function(a){return cy(a)});return cw(this.concat(c,b),this.concat(d,b))}if(this.shouldExecuteOnCPU(a))return this.cpuBackend.concat(a,b);if(1===a.length)return a[0];if(a.length>w.getNumber("WEBGL_MAX_TEXTURES_IN_SHADER")){var e=Math.floor(a.length/2),f=this.concat(a.slice(0,e),b),g=this.concat(a.slice(e),b);return this.concat([f,g],b)}if(w.getBool("WEBGL_PACK_ARRAY_OPERATIONS")&&a[0].rank>1){var h=new e1(a.map(function(a){return a.shape}),b);return this.compileAndRun(h,a)}var i=cu(a.map(function(a){return a.shape}),b),j=a.map(function(a){return a.as2D(-1,O(a.shape.slice(b)))}),k=new e0(j.map(function(a){return a.shape}));return this.compileAndRun(k,j).reshape(i)},b.prototype.neg=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.neg(a);if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,gq,a.dtype);var b=new gk(a.shape,gq);return this.compileAndRun(b,[a])},b.prototype.batchMatMul=function(a,b,c,d){var e=c?a.shape[2]:a.shape[1],f=d?b.shape[1]:b.shape[2],g=c?a.shape[1]:a.shape[2],h=a.shape[0];if((1===e||1===f)&&g>1e3){c&&(a=a.transpose([0,2,1])),d&&(b=b.transpose([0,2,1]));var i=1===f?a:a.as3D(h,g,1),j=1===f?2:1,k=1===f?b.as3D(h,1,g):b;return this.multiply(i,k).sum(j,!0)}var l=aN(a.dtype,b.dtype),m=new fS(a.shape,[h,e,f],c,d);return this.compileAndRun(m,[a,b],l)},b.prototype.fusedBatchMatMul=function(a){var b=a.a,c=a.b,d=a.transposeA,e=a.transposeB,f=a.bias,g=a.activation,h=a.preluActivationWeights,i=d?b.shape[2]:b.shape[1],j=e?c.shape[1]:c.shape[2],k=b.shape[0],l=aN(b.dtype,c.dtype),m=g?gK(g,!0):null,n=new fS(b.shape,[k,i,j],d,e,null!=f,m,null!=h),o=[b,c];return f&&o.push(f),h&&o.push(h),this.compileAndRun(n,o,l)},b.prototype.multiply=function(a,b){if("complex64"===a.dtype){var c=this.texData.get(a.dataId),d=this.texData.get(b.dataId),e=new eR("return areal * breal - aimag * bimag;",a.shape,b.shape),f=new eR("return areal * bimag + aimag * breal;",a.shape,b.shape),g=[this.makeComplexComponentTensorInfo(a,c.complexTensors.real),this.makeComplexComponentTensorInfo(a,c.complexTensors.imag),this.makeComplexComponentTensorInfo(b,d.complexTensors.real),this.makeComplexComponentTensorInfo(b,d.complexTensors.imag)],h=this.compileAndRun(e,g),i=this.compileAndRun(f,g),j=this.complex(h,i);return h.dispose(),i.dispose(),j}if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.multiply(a,b);if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,eU,a.dtype);var k=new eW(eU,a.shape,b.shape);return this.compileAndRun(k,[a,b],a.dtype)},b.prototype.batchNormalization=function(a,b,c,d,e,f){var g=[a,b,c],h=null;null!=f&&(h=f.shape,g.push(f));var i=null;if(null!=e&&(i=e.shape,g.push(e)),w.getBool("WEBGL_PACK_NORMALIZATION")){var j=new eQ(a.shape,b.shape,c.shape,h,i,d);return this.compileAndRun(j,g)}var k=new eP(a.shape,b.shape,c.shape,h,i,d);return this.compileAndRun(k,g)},b.prototype.localResponseNormalization4D=function(a,b,c,d,e){var f=w.getBool("WEBGL_PACK_NORMALIZATION")?new fP(a.shape,b,c,d,e):new fN(a.shape,b,c,d,e);return this.compileAndRun(f,[a])},b.prototype.LRNGrad=function(a,b,c,d,e,f,g){var h=new fO(b.shape,d,e,f,g);return this.compileAndRun(h,[b,c,a])},b.prototype.tile=function(a,b){if("string"===a.dtype){var c=this.readSync(a.dataId).map(function(a){return as(a)});return ev(c6(a.shape,a.dtype,c),b)}var d=new gh(a.shape,b);return this.compileAndRun(d,[a])},b.prototype.pad=function(a,b,c){var d=w.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new fX(a.shape,b,c):new fW(a.shape,b,c);return this.compileAndRun(d,[a])},b.prototype.transpose=function(a,b){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.transpose(a,b);var c=w.getBool("WEBGL_PACK_ARRAY_OPERATIONS")?new gj(a.shape,b):new gi(a.shape,b);return this.compileAndRun(c,[a])},b.prototype.gather=function(a,b,c){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.gather(a,b,c);var d=new fq(a.shape,b.size,c);return this.compileAndRun(d,[a,b])},b.prototype.batchToSpaceND=function(a,b,c){K(a.rank<=4,function(){return"batchToSpaceND for rank > 4 with a WebGL backend not implemented yet"});var d=b.reduce(function(a,b){return a*b}),e=dA(a.shape,b,d),f=dB(e.length,b.length),g=dC(a.shape,b,d),h=dD(c,b.length),i=dE(g,c,b.length);return a.reshape(e).transpose(f).reshape(g).slice(h,i)},b.prototype.spaceToBatchND=function(a,b,c){K(a.rank<=4,function(){return"spaceToBatchND for rank > 4 with a WebGL backend not implemented yet"});var d=b.reduce(function(a,b){return a*b}),e=[[0,0]];e.push.apply(e,c);for(var f=1+b.length;f<a.shape.length;++f)e.push([0,0]);var g=a.pad(e),h=dA(g.shape,b,d,!1),i=dB(h.length,b.length,!1),j=dC(g.shape,b,d,!1);return g.reshape(h).transpose(i).reshape(j)},b.prototype.reduce=function(a,b,c){var d=a.shape[0],e=a.shape[1],f=new f$({windowSize:dH(e),inSize:e,batchSize:d},b),g=this.compileAndRun(f,[a],c);return 1===g.shape[1]?g:this.reduce(g,b,c)},b.prototype.argReduce=function(a,b,c){void 0===c&&(c=null);var d=a.shape[0],e=a.shape[1];null!=c&&(d=c.shape[0],e=c.shape[1]);var f=new eA({windowSize:dH(e),inSize:e,batchSize:d},b,null==c),g=[a];null!=c&&g.push(c);var h=this.compileAndRun(f,g,"int32");return 1===h.shape[1]?h:this.argReduce(a,b,h)},b.prototype.argReducePacked=function(a,b,c){void 0===c&&(c=null);var d=null!=c?c.shape:a.shape,e=dH(d[d.length-1]),f=new eM(d,e,b,null==c),g=null==c?[a]:[a,c],h=this.compileAndRun(f,g,"int32");return h.rank===a.rank?this.argReducePacked(a,b,h):h},b.prototype.sum=function(a,b){cp("sum",b,a.rank);var c=cn(a.shape,b),d=c[0],e=O(c[1]),f=a.as2D(-1,e),g=aO(a.dtype);return this.reduce(f,"sum",g).reshape(d)},b.prototype.prod=function(a,b){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.prod(a,b);var c=cn(a.shape,b),d=c[0],e=O(c[1]),f=a.as2D(-1,e),g=aO(a.dtype);return this.reduce(f,"prod",g).reshape(d)},b.prototype.unsortedSegmentSum=function(a,b,c){var d=0,e=cq([0],a.rank),f=a;null!=e&&(f=a.transpose(e),d=cs(1,a.rank)[0]);var g=function(a,b,c){for(var d=[],e=a.length,f=0;f<e;f++)f!==b?d.push(a[f]):d.push(c);return d}(f.shape,d,c),h=O([f.shape[d]]),i=f.as2D(-1,h),j=aO(a.dtype),k=this.segOpCompute(i,"unsortedSegmentSum",b,j,c).reshape(g);return null!=e&&(k=k.transpose(cr(e))),k},b.prototype.segOpCompute=function(a,b,c,d,e){var f=a.shape[0],g=a.shape[1],h=function(a,b){var c,d=!1;for(a<=30?(c=a,d=!0):c=aj(a,Math.floor(Math.sqrt(a)));!d;)c>b||c===a?d=!0:c=aj(a,c+1);return c}(g,e),i=new f8({windowSize:h,inSize:g,batchSize:f,numSegments:e},b),j=this.compileAndRun(i,[a,c],d);return j.shape[1]===e?j:(c=cN(0,e).tile([g/h]),this.segOpCompute(j,b,c,d,e))},b.prototype.argMinMaxReduce=function(a,b,c){var d=[b];if(cp("arg"+c.charAt(0).toUpperCase()+c.slice(1),d,a.rank),!w.getBool("WEBGL_PACK_REDUCE")||a.rank<=2){var e=cn(a.shape,d),f=e[0],g=O(e[1]),h=a.as2D(-1,g);return this.argReduce(h,c).reshape(f)}return this.argReducePacked(a,c)},b.prototype.argMin=function(a,b){return this.argMinMaxReduce(a,b,"min")},b.prototype.argMax=function(a,b){return this.argMinMaxReduce(a,b,"max")},b.prototype.cumsum=function(a,b,c,d){if(b!==a.rank-1)throw Error("WebGL cumsum shader expects an inner-most axis="+(a.rank-1)+" but got axis="+b);var e=new fe(a.shape,c,d);return this.compileAndRun(e,[a])},b.prototype.equal=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(equal(a, b));\n","bool");var c=new eW("return float(a == b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.notEqual=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(notEqual(a, b));\n","bool");var c=new eW("return float(a != b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.less=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.less(a,b);if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(lessThan(a, b));\n","bool");var c=new eW("return float(a < b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.lessEqual=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(lessThanEqual(a, b));\n","bool");var c=new eW("return float(a <= b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.greater=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.greater(a,b);if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(greaterThan(a, b));\n","bool");var c=new eW("return float(a > b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.greaterEqual=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(greaterThanEqual(a, b));\n","bool");var c=new eW("return float(a >= b);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.logicalNot=function(a){var b=new gk(a.shape,"return float(!(x >= 1.0));");return this.compileAndRun(b,[a])},b.prototype.logicalAnd=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return vec4(\n    vec4(greaterThanEqual(a, vec4(1.0))) *\n    vec4(greaterThanEqual(b, vec4(1.0))));\n","bool");var c=new eW("return float(a >= 1.0 && b >= 1.0);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.logicalOr=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  return min(\n    vec4(greaterThanEqual(a, vec4(1.0))) +\n    vec4(greaterThanEqual(b, vec4(1.0))),\n    vec4(1.0));\n","bool");var c=new eW("return float(a >= 1.0 || b >= 1.0);",a.shape,b.shape);return this.compileAndRun(c,[a,b],"bool")},b.prototype.select=function(a,b,c){var d=new f9(a.rank,b.shape,b.rank);return this.compileAndRun(d,[a,b,c],aN(b.dtype,c.dtype))},b.prototype.where=function(a){cg("tf.where() in webgl locks the UI thread. Call tf.whereAsync() instead");var b=a.dataSync();return ex(a.shape,b)},b.prototype.topk=function(a,b,c){return ew(a.dataSync(),a.shape,a.dtype,b)},b.prototype.min=function(a,b){cp("min",b,a.rank);var c=cn(a.shape,b),d=c[0],e=O(c[1]),f=a.as2D(-1,e);return this.reduce(f,"min",f.dtype).reshape(d)},b.prototype.minimum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.minimum(a,b);var c=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY("\n  vec4 result = vec4(min(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new eW("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return min(a, b);\n",a.shape,b.shape);return this.compileAndRun(c,[a,b])},b.prototype.mod=function(a,b){var c=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY("\n  vec4 result = mod(a, b);\n  vec4 isNaN = vec4(equal(b, vec4(0.0)));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new eW("if (b == 0.0) return NAN;\n  return mod(a, b);",a.shape,b.shape);return this.compileAndRun(c,[a,b])},b.prototype.max=function(a,b){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.max(a,b);cp("max",b,a.rank);var c=cn(a.shape,b),d=c[0],e=O(c[1]),f=a.as2D(-1,e);return this.reduce(f,"max",f.dtype).reshape(d)},b.prototype.maximum=function(a,b){if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.maximum(a,b);var c=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY("\n  vec4 result = vec4(max(a, b));\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new eW("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return max(a, b);\n",a.shape,b.shape);return this.compileAndRun(c,[a,b])},b.prototype.all=function(a,b){cp("all",b,a.rank);var c=cn(a.shape,b),d=c[0],e=O(c[1]),f=a.as2D(-1,e);return this.reduce(f,"all",f.dtype).reshape(d)},b.prototype.any=function(a,b){cp("any",b,a.rank);var c=cn(a.shape,b),d=c[0],e=O(c[1]),f=a.as2D(-1,e);return this.reduce(f,"any",f.dtype).reshape(d)},b.prototype.realDivide=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  // vec4 one = vec4(equal(a, b));\n  // return one + (vec4(1.0) - one) * a / b;\n  vec4 result = a / b;\n  if(a.x == b.x) {\n    result.x = 1.;\n  }\n  if(a.y == b.y) {\n    result.y = 1.;\n  }\n  if(a.z == b.z) {\n    result.z = 1.;\n  }\n  if(a.w == b.w) {\n    result.w = 1.;\n  }\n\n  return result;\n","float32",!0);var c=new eW("\nif (a == b) {\n  return 1.0;\n};\nreturn a / b;",a.shape,b.shape);return this.compileAndRun(c,[a,b],"float32")},b.prototype.floorDiv=function(a,b){if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,"\n  ivec4 ia = round(a);\n  ivec4 ib = round(b);\n  bvec4 cond = notEqual(ib, ivec4(0));\n  ivec4 result = ivec4(0);\n  vec4 s = sign(a) * sign(b);\n\n  // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n  if (cond[0]) {\n    result[0] = idiv(ia[0], ib[0], s[0]);\n  }\n  if (cond[1]) {\n    result[1] = idiv(ia[1], ib[1], s[1]);\n  }\n  if (cond[2]) {\n    result[2] = idiv(ia[2], ib[2], s[2]);\n  }\n  if (cond[3]) {\n    result[3] = idiv(ia[3], ib[3], s[3]);\n  }\n  return vec4(result);\n","int32");var c=new eW("\n  float s = sign(a) * sign(b);\n  int ia = round(a);\n  int ib = round(b);\n  if (ib != 0) {\n    // Windows (D3D) wants guaranteed non-zero int division at compile-time.\n    return float(idiv(ia, ib, s));\n  } else {\n    return NAN;\n  }\n",a.shape,b.shape);return this.compileAndRun(c,[a,b],"int32")},b.prototype.add=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,eS);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.add(a,b);var c=aN(a.dtype,b.dtype);if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,eS,c);var d=new eW(eS,a.shape,b.shape);return this.compileAndRun(d,[a,b],c)},b.prototype.packedUnaryOp=function(a,b,c){var d=new gH(a.shape,b);return this.compileAndRun(d,[a],c)},b.prototype.packedBinaryOp=function(a,b,c,d,e){void 0===e&&(e=!1);var f=new eY(c,a.shape,b.shape,e);return this.compileAndRun(f,[a,b],d)},b.prototype.complexSeparableBinaryOp=function(a,b,c){var d=this,e=this.texData.get(a.dataId),f=this.texData.get(b.dataId),g=[[e.complexTensors.real,f.complexTensors.real],[e.complexTensors.imag,f.complexTensors.imag]].map(function(e){var f=e[0],g=e[1],h=d.makeComplexComponentTensorInfo(a,f),i=d.makeComplexComponentTensorInfo(b,g),j=new eW(c,a.shape,b.shape);return d.compileAndRun(j,[h,i],aN(f.dtype,g.dtype))}),h=g[0],i=g[1],j=this.complex(h,i);return h.dispose(),i.dispose(),j},b.prototype.makeComplexComponentTensorInfo=function(a,b){return{dataId:b.dataId,dtype:b.dtype,shape:a.shape}},b.prototype.addN=function(a){if(1===a.length)return a[0];if(a.length>w.get("WEBGL_MAX_TEXTURES_IN_SHADER")){var b=Math.floor(a.length/2),c=this.addN(a.slice(0,b)),d=this.addN(a.slice(b));return this.addN([c,d])}var e=a.map(function(a){return a.dtype}).reduce(function(a,b){return aN(a,b)}),f=a.map(function(a){return a.shape}),g=w.getBool("WEBGL_PACK")?new ez(a[0].shape,f):new ey(a[0].shape,f);return this.compileAndRun(g,a,e)},b.prototype.subtract=function(a,b){if("complex64"===a.dtype&&"complex64"===b.dtype)return this.complexSeparableBinaryOp(a,b,eT);if(this.shouldExecuteOnCPU([a,b]))return this.cpuBackend.subtract(a,b);var c=aN(a.dtype,b.dtype);if(w.getBool("WEBGL_PACK_BINARY_OPERATIONS"))return this.packedBinaryOp(a,b,eT,a.dtype);var d=new eW(eT,a.shape,b.shape);return this.compileAndRun(d,[a,b],c)},b.prototype.pow=function(a,b){var c=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY("\n  // isModRound1 has 1 for components with round(mod(b, 2.0)) == 1, 0 otherwise.\n  vec4 isModRound1 = vec4(equal(round(mod(b, 2.0)), ivec4(1)));\n  vec4 multiplier = sign(a) * isModRound1 + (vec4(1.0) - isModRound1);\n  vec4 result = multiplier * pow(abs(a), b);\n\n  // Ensure that a^0 = 1, including 0^0 = 1 as this correspond to TF and JS\n  bvec4 isExpZero = equal(b, vec4(0.0));\n  result.r = isExpZero.r ? 1.0 : result.r;\n  result.g = isExpZero.g ? 1.0 : result.g;\n  result.b = isExpZero.b ? 1.0 : result.b;\n  result.a = isExpZero.a ? 1.0 : result.a;\n\n  vec4 isNaN = vec4(lessThan(a, vec4(0.0))) * vec4(lessThan(floor(b), b));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new eW("\nif(a < 0.0 && floor(b) < b){\n  return NAN;\n}\nif (b == 0.0) {\n  return 1.0;\n}\nreturn (round(mod(b, 2.0)) != 1) ?\n    pow(abs(a), b) : sign(a) * pow(abs(a), b);\n",a.shape,b.shape),d=aN(a.dtype,b.dtype);return this.compileAndRun(c,[a,b],d)},b.prototype.ceil=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.ceil(a);if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,gr,a.dtype);var b=new gk(a.shape,gr);return this.compileAndRun(b,[a])},b.prototype.floor=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.floor(a);if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,gs,a.dtype);var b=new gk(a.shape,gs);return this.compileAndRun(b,[a])},b.prototype.sign=function(a){var b=new gk(a.shape,"\n  if (isnan(x)) { return 0.0; }\n  return sign(x);\n");return this.compileAndRun(b,[a])},b.prototype.isNaN=function(a){var b=new gk(a.shape,"return float(isnan(x));");return this.compileAndRun(b,[a],"bool")},b.prototype.isInf=function(a){var b=new gk(a.shape,"return float(isinf(x));");return this.compileAndRun(b,[a],"bool")},b.prototype.isFinite=function(a){var b=new gk(a.shape,"return float(!isnan(x) && !isinf(x));");return this.compileAndRun(b,[a],"bool")},b.prototype.round=function(a){var b=new gk(a.shape,"\n  // OpenGL ES does not support round function.\n  // The algorithm is based on banker's rounding.\n  float base = floor(x);\n  if ((x - base) < 0.5) {\n    return floor(x);\n  } else if ((x - base) > 0.5) {\n    return ceil(x);\n  } else {\n    if (mod(base, 2.0) == 0.0) {\n      return base;\n    } else {\n      return base + 1.0;\n    }\n  }\n");return this.compileAndRun(b,[a])},b.prototype.exp=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.exp(a);if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,gt,a.dtype);var b=new gk(a.shape,gt);return this.compileAndRun(b,[a])},b.prototype.expm1=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.expm1(a);if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,gu,a.dtype);var b=new gk(a.shape,gu);return this.compileAndRun(b,[a])},b.prototype.softmax=function(a,b){var c=W([b],a.shape),d=this.max(a,c),e=co(d.shape,c),f=this.subtract(a,d.reshape(e)),g=this.exp(f),h=this.sum(g,c).reshape(e);return this.realDivide(g,h)},b.prototype.log=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.log(a);if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,"\n  vec4 result = log(x);\n  vec4 isNaN = vec4(lessThan(x, vec4(0.0)));\n  result.r = isNaN.r == 1.0 ? NAN : result.r;\n  result.g = isNaN.g == 1.0 ? NAN : result.g;\n  result.b = isNaN.b == 1.0 ? NAN : result.b;\n  result.a = isNaN.a == 1.0 ? NAN : result.a;\n\n  return result;\n",a.dtype);var b=new gk(a.shape,"if (x < 0.0) return NAN;\n  return log(x);");return this.compileAndRun(b,[a])},b.prototype.log1p=function(a){var b=new gk(a.shape,"return log(1.0 + x);");return this.compileAndRun(b,[a])},b.prototype.sqrt=function(a){var b=new gk(a.shape,"return sqrt(x);");return this.compileAndRun(b,[a])},b.prototype.rsqrt=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.rsqrt(a);var b=new gk(a.shape,"return inversesqrt(x);");return this.compileAndRun(b,[a])},b.prototype.reciprocal=function(a){var b=new gk(a.shape,"return 1.0 / x;");return this.compileAndRun(b,[a])},b.prototype.relu=function(a){var b;return b=w.getBool("WEBGL_PACK")?new gH(a.shape,gE):new gk(a.shape,gn),this.compileAndRun(b,[a])},b.prototype.relu6=function(a){var b;return b=w.getBool("WEBGL_PACK")?new gH(a.shape,gF):new gk(a.shape,go),this.compileAndRun(b,[a])},b.prototype.prelu=function(a,b){var c=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY(eX,a.shape,b.shape):new eW(eV,a.shape,b.shape);return this.compileAndRun(c,[a,b])},b.prototype.elu=function(a){if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,gG,a.dtype);var b=new gk(a.shape,gp);return this.compileAndRun(b,[a])},b.prototype.eluDer=function(a,b){var c=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY("\n  vec4 bGTEZero = vec4(greaterThanEqual(b, vec4(0.)));\n  return (bGTEZero * a) + ((vec4(1.0) - bGTEZero) * (a * (b + vec4(1.0))));\n",a.shape,b.shape):new eW("return (b >= 1.0) ? a : a * (b + 1.0);",a.shape,b.shape);return this.compileAndRun(c,[a,b])},b.prototype.selu=function(a){var b=new gk(a.shape,"\n  // Stable and Attracting Fixed Point (0, 1) for Normalized Weights.\n  // see: https://arxiv.org/abs/1706.02515\n  float scaleAlpha = 1.7580993408473768;\n  float scale = 1.0507009873554805;\n  return (x >= 0.0) ? scale * x : scaleAlpha * (exp(x) - 1.0);\n");return this.compileAndRun(b,[a])},b.prototype.int=function(a){var b=new gk(a.shape,"return float(int(x));");return this.compileAndRun(b,[a],"int32")},b.prototype.clip=function(a,b,c){var d,e=(d=w.getBool("WEBGL_PACK_CLIP")?new e$(a.shape):new eZ(a.shape)).getCustomSetupFunc(b,c);return this.compileAndRun(d,[a],null,e)},b.prototype.abs=function(a){if(this.shouldExecuteOnCPU([a]))return this.cpuBackend.abs(a);if(w.getBool("WEBGL_PACK_UNARY_OPERATIONS"))return this.packedUnaryOp(a,gm,a.dtype);var b=new gk(a.shape,gm);return this.compileAndRun(b,[a])},b.prototype.complexAbs=function(a){var b=this.texData.get(a.dataId),c=new e_(a.shape),d=[this.makeComplexComponentTensorInfo(a,b.complexTensors.real),this.makeComplexComponentTensorInfo(a,b.complexTensors.imag)];return this.compileAndRun(c,d)},b.prototype.sigmoid=function(a){var b=new gk(a.shape,"return 1.0 / (1.0 + exp(-1.0 * x));");return this.compileAndRun(b,[a])},b.prototype.softplus=function(a){var b=new gk(a.shape,"\n  float epsilon = 1.1920928955078125e-7;\n  float threshold = log(epsilon) + 2.0;\n\n  bool too_large = x > -threshold;\n  bool too_small = x < threshold;\n\n  float result;\n  float exp_x = exp(x);\n\n  if (too_large){\n    result = x;\n  }\n  else if (too_small){\n    result = exp_x;\n  }\n  else{\n    result = log(exp_x + 1.0);\n  }\n  return result;\n");return this.compileAndRun(b,[a])},b.prototype.sin=function(a){var b=new gk(a.shape,gv);return this.compileAndRun(b,[a])},b.prototype.cos=function(a){var b=new gk(a.shape,gw);return this.compileAndRun(b,[a])},b.prototype.tan=function(a){var b=new gk(a.shape,"return tan(x);");return this.compileAndRun(b,[a])},b.prototype.asin=function(a){var b=new gk(a.shape,gx);return this.compileAndRun(b,[a])},b.prototype.acos=function(a){var b=new gk(a.shape,gy);return this.compileAndRun(b,[a])},b.prototype.atan=function(a){var b=new gk(a.shape,gz);return this.compileAndRun(b,[a])},b.prototype.atan2=function(a,b){var c=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY("\n  vec4 result = atan(a, b);\n  vec4 isNaN = min(vec4(isnan(a)) + vec4(isnan(b)), vec4(1.0));\n  \n  result.r = isNaN.r > 0. ? NAN : result.r;\n  result.g = isNaN.g > 0. ? NAN : result.g;\n  result.b = isNaN.b > 0. ? NAN : result.b;\n  result.a = isNaN.a > 0. ? NAN : result.a;\n\n  return result;\n",a.shape,b.shape):new eW("\n  if (isnan(a)) return a;\n  if (isnan(b)) return b;\n\n  return atan(a, b);\n",a.shape,b.shape);return this.compileAndRun(c,[a,b])},b.prototype.sinh=function(a){var b=new gk(a.shape,"\n  float e2x = exp(x);\n  return (e2x - 1.0 / e2x) / 2.0;\n");return this.compileAndRun(b,[a])},b.prototype.cosh=function(a){var b=new gk(a.shape,"\n  float e2x = exp(-x);\n  return (e2x + 1.0 / e2x) / 2.0;\n");return this.compileAndRun(b,[a])},b.prototype.tanh=function(a){var b=new gk(a.shape,"\n  float e2x = exp(-2.0 * abs(x));\n  return sign(x) * (1.0 - e2x) / (1.0 + e2x);\n");return this.compileAndRun(b,[a])},b.prototype.asinh=function(a){var b=new gk(a.shape,gA);return this.compileAndRun(b,[a])},b.prototype.acosh=function(a){var b=new gk(a.shape,gB);return this.compileAndRun(b,[a])},b.prototype.atanh=function(a){var b=new gk(a.shape,gC);return this.compileAndRun(b,[a])},b.prototype.erf=function(a){var b=new gk(a.shape,'\n  // Error function is calculated approximately with elementary function.\n  // See "Handbook of Mathematical Functions with Formulas,\n  // Graphs, and Mathematical Tables", Abramowitz and Stegun.\n  float p = 0.3275911;\n  float a1 = 0.254829592;\n  float a2 = -0.284496736;\n  float a3 = 1.421413741;\n  float a4 = -1.453152027;\n  float a5 = 1.061405429;\n\n  float sign = sign(x);\n  x = abs(x);\n  float t = 1.0 / (1.0 + p * x);\n  return sign * (1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*exp(-x*x));\n');return this.compileAndRun(b,[a])},b.prototype.step=function(a,b){var c,d=new gk(a.shape,(void 0===(c=b)&&(c=0),gl+"\n    return x > 0.0 ? 1.0 : float("+c+");\n  "));return this.compileAndRun(d,[a])},b.prototype.conv2dByMatMul=function(a,b,c,d,e,f){var g=a.shape,h=this.texData.get(a.dataId),i=c.inChannels,j=g[0]*g[1]*g[2],k=c.outChannels,l="channelsLast"===c.dataFormat,m=g[2]%2!=0&&!!h.isPacked;if((1===j||1===k)&&i>1e3||!w.getBool("WEBGL_LAZILY_UNPACK")||!w.getBool("WEBGL_PACK_BINARY_OPERATIONS")||!m){var n=l?g[0]*g[1]*g[2]:g[0]*g[2]*g[3],o=this.reshape(a,[1,n,c.inChannels]),p=this.reshape(b,[1,c.inChannels,c.outChannels]);return this.reshape(this.fusedBatchMatMul({a:o,b:p,transposeA:!1,transposeB:!1,bias:d,activation:e,preluActivationWeights:f}),c.outShape)}var q=l?g[0]*g[1]*(g[2]+1):g[0]*g[2]*(g[3]+1),r={dataId:a.dataId,shape:[1,q,c.inChannels],dtype:a.dtype},s=h.shape;h.shape=h.shape.slice(),h.shape[h.shape.length-2]++,K(bL(h.shape,r.shape),function(){return"packed reshape "+h.shape+" to "+r.shape+" isn't free"});var t=this.reshape(b,[1,c.inChannels,c.outChannels]),u=this.fusedBatchMatMul({a:r,b:t,transposeA:!1,transposeB:!1,bias:d,activation:e,preluActivationWeights:f}),v=this.texData.get(u.dataId);return K(v.isPacked,function(){return"batchMatMul result is expected to be packed"}),h.shape=s,v.shape=c.outShape,a_.makeTensorFromDataId(u.dataId,c.outShape,u.dtype)},b.prototype.conv2dWithIm2Row=function(a,b,c,d,e,f){var g=c.filterWidth,h=c.filterHeight,i=c.inChannels,j=c.outWidth,k=c.outHeight,l="channelsLast"===c.dataFormat,m=g*h*i,n=k*j,o=[m,n],p=a.squeeze([0]),q=b.reshape([1,m,-1]),r=new fM(o,p.shape,c),s=this.compileAndRun(r,[p]).reshape([1,o[0],o[1]]),t=null!=f,u=e?gK(e,!0):null,v=new fS(s.shape,[1,n,c.outChannels],!0,!1,null!=d,u,t),w=[s,q];d&&w.push(d),t&&w.push(f);var x=this.compileAndRun(v,w);return l?x.reshape([1,k,j,c.outChannels]):x.reshape([1,c.outChannels,k,j])},b.prototype.fusedConv2d=function(a){var b=a.input,c=a.filter,d=a.convInfo,e=a.bias,f=a.activation,g=a.preluActivationWeights;if(1===d.filterHeight&&1===d.filterWidth&&1===d.dilationHeight&&1===d.dilationWidth&&1===d.strideHeight&&1===d.strideWidth&&("SAME"===d.padInfo.type||"VALID"===d.padInfo.type))return this.conv2dByMatMul(b,c,d,e,f,g);if(w.getBool("WEBGL_CONV_IM2COL")&&1===b.shape[0])return this.conv2dWithIm2Row(b,c,d,e,f,g);var h=null!=g,i=new e9(d,null!=e,f?gK(f,!1):null,h),j=[b,c];return e&&j.push(e),g&&j.push(g),this.compileAndRun(i,j)},b.prototype.conv2d=function(a,b,c){if(1===c.filterHeight&&1===c.filterWidth&&1===c.dilationHeight&&1===c.dilationWidth&&1===c.strideHeight&&1===c.strideWidth&&("SAME"===c.padInfo.type||"VALID"===c.padInfo.type))return this.conv2dByMatMul(a,b,c);if(w.getBool("WEBGL_CONV_IM2COL")&&1===a.shape[0])return this.conv2dWithIm2Row(a,b,c);var d=new e9(c);return this.compileAndRun(d,[a,b])},b.prototype.conv2dDerInput=function(a,b,c){var d=new e4(c);return this.compileAndRun(d,[a,b])},b.prototype.conv2dDerFilter=function(a,b,c){var d=new e3(c);return this.compileAndRun(d,[a,b])},b.prototype.fusedDepthwiseConv2D=function(a){var b,c=a.input,d=a.filter,e=a.convInfo,f=a.bias,g=a.activation,h=a.preluActivationWeights,i=w.getBool("WEBGL_PACK_DEPTHWISECONV")&&e.strideWidth<=2&&e.outChannels/e.inChannels==1,j=g?gK(g,i):null,k=[c,d],l=null!=f,m=null!=h;return l&&k.push(f),m&&k.push(h),b=i?new fc(e,l,j,m):new fb(e,l,j,m),this.compileAndRun(b,k)},b.prototype.depthwiseConv2D=function(a,b,c){var d;return d=w.getBool("WEBGL_PACK_DEPTHWISECONV")&&c.strideWidth<=2&&c.outChannels/c.inChannels==1?new fc(c):new fb(c),this.compileAndRun(d,[a,b])},b.prototype.depthwiseConv2DDerInput=function(a,b,c){var d=new e8(c);return this.compileAndRun(d,[a,b])},b.prototype.depthwiseConv2DDerFilter=function(a,b,c){var d=new e7(c);return this.compileAndRun(d,[a,b])},b.prototype.conv3d=function(a,b,c){var d=new fa(c);return this.compileAndRun(d,[a,b])},b.prototype.conv3dDerInput=function(a,b,c){var d=new e6(c);return this.compileAndRun(d,[a,b])},b.prototype.conv3dDerFilter=function(a,b,c){var d=new e5(c);return this.compileAndRun(d,[a,b])},b.prototype.maxPool=function(a,b){var c=new fY(b,"max",!1);return this.compileAndRun(c,[a])},b.prototype.avgPool=function(a,b){var c=new fY(b,"avg",!1);return this.compileAndRun(c,[a],"float32")},b.prototype.maxPoolBackprop=function(a,b,c,d){var e=new fY(d,"max",!0),f=this.compileAndRun(e,[b]),g=new fQ(d),h=this.compileAndRun(g,[a,f],b.dtype);return f.dispose(),h},b.prototype.avgPoolBackprop=function(a,b,c){var d=new eN(c);return this.compileAndRun(d,[a],b.dtype)},b.prototype.cast=function(a,b){return ej(a,b,this)},b.prototype.unstack=function(a,b){for(var c=a.shape[b],d=Array(a.rank-1),e=0,f=0;f<a.rank;f++)f!==b&&(d[e++]=a.shape[f]);var g=Array(a.rank).fill(0),h=a.shape.slice();h[b]=1;var i=Array(c);for(f=0;f<i.length;f++)g[b]=f,i[f]=this.slice(a,g,h).reshape(d);return i},b.prototype.avgPool3d=function(a,b){var c=new fZ(b,"avg",!1);return this.compileAndRun(c,[a],"float32")},b.prototype.avgPool3dBackprop=function(a,b,c){var d=new eO(c);return this.compileAndRun(d,[a],b.dtype)},b.prototype.maxPool3d=function(a,b){var c=new fZ(b,"max",!1);return this.compileAndRun(c,[a],"float32")},b.prototype.maxPool3dBackprop=function(a,b,c,d){var e=new fZ(d,"max",!0),f=this.compileAndRun(e,[b]),g=new fR(d),h=this.compileAndRun(g,[a,f],b.dtype);return f.dispose(),h},b.prototype.reshape=function(a,b){var c=this.texData.get(a.dataId);if(c.isPacked&&!bL(a.shape,b)&&(null===c.texture||!bL(c.shape,b))){var d=this.packedReshape(a,b);return a_.makeTensorFromDataId(d.dataId,d.shape,d.dtype)}return ek(a,b)},b.prototype.resizeBilinear=function(a,b,c,d){var e=w.getBool("WEBGL_PACK_IMAGE_OPERATIONS")?new f2(a.shape,b,c,d):new f1(a.shape,b,c,d);return this.compileAndRun(e,[a],"float32")},b.prototype.resizeBilinearBackprop=function(a,b,c){var d=new f0(a,b,c);return this.compileAndRun(d,[a])},b.prototype.resizeNearestNeighbor=function(a,b,c,d){var e=new f4(a.shape,b,c,d);return this.compileAndRun(e,[a])},b.prototype.resizeNearestNeighborBackprop=function(a,b,c){var d=new f3(a,b,c);return this.compileAndRun(d,[a])},b.prototype.multinomial=function(a,b,c,d){var e=b?a:d_(a),f=new fT(e.shape[0],e.shape[1],c),g=f.getCustomSetupFunc(d);return this.compileAndRun(f,[e],"int32",g)},b.prototype.oneHot=function(a,b,c,d){var e=new fU(a.size,b,c,d);return this.compileAndRun(e,[a])},b.prototype.diag=function(a){var b=new fj(a.size);return this.compileAndRun(b,[a])},b.prototype.nonMaxSuppression=function(a,b,c,d,e){return cg("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead"),eq(a.dataSync(),b.dataSync(),c,d,e)},b.prototype.cropAndResize=function(a,b,c,d,e,f){var g=new fd(a.shape,b.shape,d,e,f);return this.compileAndRun(g,[a,b,c],"float32")},b.prototype.depthToSpace=function(a,b,c){K(b>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+b});var d=a.shape[0],e="NHWC"===c?a.shape[1]:a.shape[2],f="NHWC"===c?a.shape[2]:a.shape[3],g="NHWC"===c?a.shape[3]:a.shape[1],h=e*b,i=f*b,j=g/(b*b),k=new fi("NHWC"===c?[d,h,i,j]:[d,j,h,i],b,c);return this.compileAndRun(k,[a])},b.prototype.split=function(a,b,c){return eu(a,b,c)},b.prototype.scatterND=function(a,b,c){var d=dK(0,a,c),e=d.sliceRank,f=d.numUpdates,g=d.sliceSize,h=d.strides,i=d.outputSize,j=[i/g,g],k=a.reshape([f,e]),l=b.reshape([f,g]);if(0===i)return ek(cz([]),c);var m=cB(0),n=new f7(f,e,k.rank,l.rank,h,j);return this.compileAndRun(n,[l,k,m]).reshape(c)},b.prototype.sparseToDense=function(a,b,c,d){var e=dK(0,a,c),f=e.sliceRank,g=e.numUpdates,h=e.strides,i=e.outputSize,j=new f7(g,f,a.rank,b.rank,h,[i,1],!1);return this.compileAndRun(j,[b,a,d]).reshape(c)},b.prototype.fft=function(a){return this.fftImpl(a,!1)},b.prototype.ifft=function(a){return this.fftImpl(a,!0)},b.prototype.fftImpl=function(a,b){var c=this.texData.get(a.dataId),d=new fo("return real * expR - imag * expI;",a.shape,b),e=new fo("return real * expI + imag * expR;",a.shape,b),f=[this.makeComplexComponentTensorInfo(a,c.complexTensors.real),this.makeComplexComponentTensorInfo(a,c.complexTensors.imag)],g=this.compileAndRun(d,f),h=this.compileAndRun(e,f),i=this.complex(g,h).as2D(a.shape[0],a.shape[1]);return g.dispose(),h.dispose(),i},b.prototype.gatherND=function(a,b){var c=b.shape,d=c[c.length-1],e=dF(a,b),f=e[0],g=e[1],h=e[2],i=e[3],j=b.reshape([g,d]),k=a.reshape([a.size/h,h]),l=new fr(d,i,[g,h]);return this.compileAndRun(l,[k,j]).reshape(f)},b.prototype.fill=function(a,b,c){if("string"===(c=c||ah(b))){var d=Z(c,O(a));return d.fill(b),a_.makeTensor(d,a,c,this)}var e=new fp(a,b),f=e.getCustomSetupFunc(b);return this.compileAndRun(e,[],c,f)},b.prototype.onesLike=function(a){if("string"===a.dtype)throw Error("onesLike is not supported under string dtype");return this.fill(a.shape,1,a.dtype)},b.prototype.zerosLike=function(a){return this.fill(a.shape,"string"===a.dtype?"":0,a.dtype)},b.prototype.linspace=function(a,b,c){return el(a,b,c)},b.prototype.makeTensorInfo=function(a,b){var c=this.write(null,a,b);return this.texData.get(c).usage=null,{dataId:c,shape:a,dtype:b}},b.prototype.makeOutput=function(a,b){var c=this.makeTensorInfo(a,b).dataId;return a_.makeTensorFromDataId(c,a,b,this)},b.prototype.unpackTensor=function(a){var b=new gI(a.shape);return this.runWebGLProgram(b,[a],a.dtype)},b.prototype.packTensor=function(a){var b=new fV(a.shape);return this.runWebGLProgram(b,[a],a.dtype,null,!0)},b.prototype.packedReshape=function(a,b){var c=[bH(a.shape)].concat(bI(a.shape)),d={dtype:a.dtype,shape:c,dataId:a.dataId},e=new f_([bH(b)].concat(bI(b)),c),f=this.runWebGLProgram(e,[d],a.dtype,null,!0);return{dataId:f.dataId,shape:b,dtype:f.dtype}},b.prototype.decode=function(a){var b,c=this.texData.get(a),d=c.isPacked,e=c.shape,f=c.dtype,g=bJ(e);return b=d?new fh(g):new fg(g),{dtype:f,shape:e,dataId:this.runWebGLProgram(b,[{shape:g,dtype:f,dataId:a}],f,null,!0).dataId}},b.prototype.runWebGLProgram=function(a,b,c,d,e){var f,g,h,i=this;void 0===e&&(e=!1);var j=this.makeTensorInfo(a.outputShape,c),k=this.texData.get(j.dataId);if(a.packedOutput&&(k.isPacked=!0),a.outPackingScheme===a2.DENSE&&(k.texShape=a9(a.outputShape).map(function(a){return 2*a})),null!=a.outTexUsage&&(k.usage=a.outTexUsage),0===O(j.shape))return k.values=Y(j.dtype,0),j;var l=[],m=b.map(function(b){if("complex64"===b.dtype)throw Error("GPGPUProgram does not support complex64 input. For complex64 dtypes, please separate the program into real and imaginary parts.");var c=i.texData.get(b.dataId);if(null==c.texture){if(!a.packedInputs&&O(b.shape)<=w.getNumber("WEBGL_SIZE_UPLOAD_UNIFORM"))return{shape:b.shape,texData:null,isUniform:!0,uniformValues:c.values};a.packedInputs&&(c.isPacked=!0,c.shape=b.shape)}else if(!!c.isPacked!=!!a.packedInputs)b=c.isPacked?i.unpackTensor(b):i.packTensor(b),l.push(b),c=i.texData.get(b.dataId);else if(c.isPacked&&!bL(c.shape,b.shape)){var d=b,e=b.shape;b.shape=c.shape,b=i.packedReshape(b,e),l.push(b),c=i.texData.get(b.dataId),d.shape=e}return i.uploadToGPU(b.dataId),{shape:b.shape,texData:c,isUniform:!1}});this.uploadToGPU(j.dataId);var n,o,p,q={shape:j.shape,texData:k,isUniform:!1},r=(n="",m.concat(q).forEach(function(a){var b=null!=a.texData&&null!=a.texData.slice&&a.texData.slice.flatOffset>0,c=a.isUniform?"uniform":a.texData.texShape;n+=a.shape+"_"+c+"_"+b}),o=a.userCode,a.constructor.name+("_"+n+"_")+o),s=this.getAndSaveBinary(r,function(){return function(a,b,c,d){var e=b.userCode,f=c.map(function(a,c){var d={logicalShape:a.shape,texShape:a.isUniform?null:a.texData.texShape,isUniform:a.isUniform,isPacked:!a.isUniform&&a.texData.isPacked,flatOffset:null};return null!=a.texData&&null!=a.texData.slice&&a.texData.slice.flatOffset>0&&(d.flatOffset=a.texData.slice.flatOffset),{name:b.variableNames[c],shapeInfo:d}}),g=f.map(function(a){return a.shapeInfo}),h={logicalShape:d.shape,texShape:d.texData.texShape,isUniform:!1,isPacked:d.texData.isPacked,flatOffset:null},i=function(a,b,c,d){var e=[];a.forEach(function(a){var b=O(a.shapeInfo.logicalShape);a.shapeInfo.isUniform?e.push("uniform float "+a.name+(b>1?"["+b+"]":"")+";"):(e.push("uniform sampler2D "+a.name+";"),e.push("uniform int offset"+a.name+";"))});var f,g,h=e.join("\n"),i=a.map(function(a){var c,e,f,g;return void 0===(c=d)&&(c=!1),e=""+(c?function a(b){var c,d,e,f;switch(b.shapeInfo.logicalShape.length){case 0:return"\n    vec4 "+("get"+(c=b.name).charAt(0).toUpperCase()+c.slice(1))+"() {\n      return "+eD().texture2D+"("+c+", halfCR);\n    }\n  ";case 1:return"\n    vec4 "+("get"+(d=b.name).charAt(0).toUpperCase()+d.slice(1))+"(int index) {\n      vec2 uv = packedUVfrom1D(\n        "+(f=[Math.ceil((e=b.shapeInfo.texShape)[0]/2),Math.ceil(e[1]/2)])[0]+", "+f[1]+", index);\n      return "+eD().texture2D+"("+d+", uv);\n    }\n  ";case 2:return function(a){var b=a.shapeInfo.logicalShape,c=a.name,d="get"+c.charAt(0).toUpperCase()+c.slice(1),e=a.shapeInfo.texShape,f=e[0],g=e[1],h=eD();if(null!=e&&P(b,e))return"\n      vec4 "+d+"(int row, int col) {\n        vec2 uv = (vec2(col, row) + halfCR) / vec2("+g+".0, "+f+".0);\n\n        return "+h.texture2D+"("+c+", uv);\n      }\n    ";var i=[Math.ceil(e[0]/2),Math.ceil(e[1]/2)];return"\n    vec4 "+d+"(int row, int col) {\n      vec2 uv = packedUVfrom2D("+Math.ceil(b[1]/2)+", "+i[0]+", "+i[1]+", row, col);\n      return "+h.texture2D+"("+c+", uv);\n    }\n  "}(b);case 3:return function(b){var c=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=b.shapeInfo.texShape,g=[Math.ceil(f[0]/2),Math.ceil(f[1]/2)];if(1===c[0])return"\n        "+a(eK(b,c.slice(1)))+"\n        vec4 "+e+"(int b, int row, int col) {\n          return "+e+"("+eL(["b","row","col"],[1,2])+");\n        }\n      ";var h=g[0],i=g[1],j=Math.ceil(c[2]/2);return"\n    vec4 "+e+"(int b, int row, int col) {\n      vec2 uv = packedUVfrom3D(\n        "+h+", "+i+", "+j*Math.ceil(c[1]/2)+", "+j+", b, row, col);\n      return "+eD().texture2D+"("+d+", uv);\n    }\n  "}(b);default:return function(a){for(var b=a.shapeInfo.logicalShape,c=b.length,d=a.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=a.shapeInfo.texShape,g=[Math.ceil(f[0]/2),Math.ceil(f[1]/2)],h=g[0],i=g[1],j=Math.ceil(b[c-1]/2),k=j*Math.ceil(b[c-2]/2),l="int b, int row, int col",m="b * "+k+" + (row / 2) * "+j+" + (col / 2)",n=2;n<c-1;n++)l="int b"+n+", "+l,k*=b[c-n-1],m="b"+n+" * "+k+" + "+m;return"\n    vec4 "+e+"("+l+") {\n      int index = "+m+";\n      int texR = index / "+i+";\n      int texC = index - texR * "+i+";\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+i+", "+h+");\n      return "+eD().texture2D+"("+d+", uv);\n    }\n  "}(b)}}(a):function a(b){var c=b.shapeInfo.logicalShape;switch(c.length){case 0:return function(a){var b=a.name,c="get"+b.charAt(0).toUpperCase()+b.slice(1);if(a.shapeInfo.isUniform)return"float "+c+"() {return "+b+";}";var d=a.shapeInfo.texShape,e=d[0],f=d[1];if(1===e&&1===f)return"\n      float "+c+"() {\n        return sampleTexture("+b+", halfCR);\n      }\n    ";var g=a.shapeInfo.texShape;return"\n    float "+c+"() {\n      vec2 uv = uvFromFlat("+g[0]+", "+g[1]+", "+eH(b)+");\n      return sampleTexture("+b+", uv);\n    }\n  "}(b);case 1:return function(a){var b=a.name,c="get"+b.charAt(0).toUpperCase()+b.slice(1);if(a.shapeInfo.isUniform)return"\n      float "+c+"(int index) {\n        "+eI(a)+"\n      }\n    ";var d=a.shapeInfo.texShape,e=d[0],f=d[1];if(1===f&&1===e)return"\n      float "+c+"(int index) {\n        return sampleTexture("+b+", halfCR);\n      }\n    ";var g=eH(b);return 1===f?"\n      float "+c+"(int index) {\n        vec2 uv = vec2(0.5, (float(index + "+g+") + 0.5) / "+e+".0);\n        return sampleTexture("+b+", uv);\n      }\n    ":1===e?"\n      float "+c+"(int index) {\n        vec2 uv = vec2((float(index + "+g+") + 0.5) / "+f+".0, 0.5);\n        return sampleTexture("+b+", uv);\n      }\n    ":"\n    float "+c+"(int index) {\n      vec2 uv = uvFromFlat("+e+", "+f+", index + "+g+");\n      return sampleTexture("+b+", uv);\n    }\n  "}(b);case 2:return function(b){var c=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=b.shapeInfo.texShape;if(null!=f&&P(c,f)){var g=f[0];return"\n    float "+e+"(int row, int col) {\n      vec2 uv = (vec2(col, row) + halfCR) / vec2("+f[1]+".0, "+g+".0);\n      return sampleTexture("+d+", uv);\n    }\n  "}var h=X(c),i=h.newShape,j=h.keptDims;if(i.length<c.length)return"\n      "+a(eK(b,i))+"\n      float "+e+"(int row, int col) {\n        return "+e+"("+eL(["row","col"],j)+");\n      }\n    ";if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col) {\n        int index = round(dot(vec2(row, col), vec2("+c[1]+", 1)));\n        "+eI(b)+"\n      }\n    ";var k=f[0],l=f[1],m=eH(d);return 1===l?"\n    float "+e+"(int row, int col) {\n      float index = dot(vec3(row, col, "+m+"), vec3("+c[1]+", 1, 1));\n      vec2 uv = vec2(0.5, (index + 0.5) / "+k+".0);\n      return sampleTexture("+d+", uv);\n    }\n  ":1===k?"\n    float "+e+"(int row, int col) {\n      float index = dot(vec3(row, col, "+m+"), vec3("+c[1]+", 1, 1));\n      vec2 uv = vec2((index + 0.5) / "+l+".0, 0.5);\n      return sampleTexture("+d+", uv);\n    }\n  ":"\n  float "+e+"(int row, int col) {\n    // Explicitly use integer operations as dot() only works on floats.\n    int index = row * "+c[1]+" + col + "+m+";\n    vec2 uv = uvFromFlat("+k+", "+l+", index);\n    return sampleTexture("+d+", uv);\n  }\n"}(b);case 3:return function(b){var c=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=c[1]*c[2],g=c[2],h=X(c),i=h.newShape,j=h.keptDims;if(i.length<c.length)return"\n        "+a(eK(b,i))+"\n        float "+e+"(int row, int col, int depth) {\n          return "+e+"("+eL(["row","col","depth"],j)+");\n        }\n      ";if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth) {\n        int index = round(dot(vec3(row, col, depth),\n                          vec3("+f+", "+g+", 1)));\n        "+eI(b)+"\n      }\n    ";var k=b.shapeInfo.texShape,l=k[0],m=k[1],n=b.shapeInfo.flatOffset;return m===f&&null==n?"\n        float "+e+"(int row, int col, int depth) {\n          float texR = float(row);\n          float texC = dot(vec2(col, depth), vec2("+g+", 1));\n          vec2 uv = (vec2(texC, texR) + halfCR) /\n                     vec2("+m+".0, "+l+".0);\n          return sampleTexture("+d+", uv);\n        }\n      ":m===g&&null==n?"\n    float "+e+"(int row, int col, int depth) {\n      float texR = dot(vec2(row, col), vec2("+c[1]+", 1));\n      float texC = float(depth);\n      vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+m+".0, "+l+".0);\n      return sampleTexture("+d+", uv);\n    }\n  ":"\n      float "+e+"(int row, int col, int depth) {\n        // Explicitly use integer operations as dot() only works on floats.\n        int index = row * "+f+" + col * "+g+" + depth + "+eH(d)+";\n        vec2 uv = uvFromFlat("+l+", "+m+", index);\n        return sampleTexture("+d+", uv);\n      }\n  "}(b);case 4:return function(b){var c=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=c[3],g=c[2]*f,h=c[1]*g,i=X(c),j=i.newShape,k=i.keptDims;if(j.length<c.length)return"\n      "+a(eK(b,j))+"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        return "+e+"("+eL(["row","col","depth","depth2"],k)+");\n      }\n    ";if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        int index = round(dot(vec4(row, col, depth, depth2),\n                          vec4("+h+", "+g+", "+f+", 1)));\n        "+eI(b)+"\n      }\n    ";var l=b.shapeInfo.flatOffset,m=b.shapeInfo.texShape,n=m[0],o=m[1];return o===h&&null==l?"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        float texR = float(row);\n        float texC =\n            dot(vec3(col, depth, depth2),\n                vec3("+g+", "+f+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+o+".0, "+n+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ":o===f&&null==l?"\n      float "+e+"(int row, int col, int depth, int depth2) {\n        float texR = dot(vec3(row, col, depth),\n                         vec3("+c[1]*c[2]+", "+c[2]+", 1));\n        float texC = float(depth2);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+o+".0, "+n+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ":"\n    float "+e+"(int row, int col, int depth, int depth2) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+h+" + col * "+g+" +\n          depth * "+f+" + depth2;\n      vec2 uv = uvFromFlat("+n+", "+o+", index + "+eH(d)+");\n      return sampleTexture("+d+", uv);\n    }\n  "}(b);case 5:return function(b){var c=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=c[4],g=c[3]*f,h=c[2]*g,i=c[1]*h,j=X(c),k=j.newShape,l=j.keptDims;if(k.length<c.length)return"\n      "+a(eK(b,k))+"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        return "+e+"("+eL(["row","col","depth","depth2","depth3"],l)+");\n      }\n    ";if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        float index = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+i+", "+h+", "+g+", "+f+")) +\n          depth3;\n        "+eI(b)+"\n      }\n    ";var m=b.shapeInfo.flatOffset,n=b.shapeInfo.texShape,o=n[0],p=n[1];return p===i&&null==m?"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n                         vec4("+h+", "+g+", "+f+", 1));\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+p+".0, "+o+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ":p===f&&null==m?"\n      float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n        float texR = dot(\n          vec4(row, col, depth, depth2),\n          vec4("+c[1]*c[2]*c[3]+",\n               "+c[2]*c[3]+", "+c[3]+", 1));\n        int texC = depth3;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+p+".0, "+o+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ":"\n    float "+e+"(int row, int col, int depth, int depth2, int depth3) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+i+" + col * "+h+" + depth * "+g+" +\n          depth2 * "+f+" + depth3 + "+eH(d)+";\n      vec2 uv = uvFromFlat("+o+", "+p+", index);\n      return sampleTexture("+d+", uv);\n    }\n  "}(b);case 6:return function(b){var c=b.shapeInfo.logicalShape,d=b.name,e="get"+d.charAt(0).toUpperCase()+d.slice(1),f=X(c),g=f.newShape,h=f.keptDims;if(g.length<c.length)return"\n      "+a(eK(b,g))+"\n      float "+e+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        return "+e+"("+eL(["row","col","depth","depth2","depth3","depth4"],h)+");\n      }\n    ";var i=c[5],j=c[4]*i,k=c[3]*j,l=c[2]*k,m=c[1]*l;if(b.shapeInfo.isUniform)return"\n      float "+e+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n        int index = round(dot(\n          vec4(row, col, depth, depth2),\n          vec4("+m+", "+l+", "+k+", "+j+")) +\n          dot(\n            vec2(depth3, depth4),\n            vec2("+i+", 1)));\n        "+eI(b)+"\n      }\n    ";var n=b.shapeInfo.flatOffset,o=b.shapeInfo.texShape,p=o[0],q=o[1];return q===m&&null==n?"\n      float "+e+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        int texR = row;\n        float texC = dot(vec4(col, depth, depth2, depth3),\n          vec4("+l+", "+k+", "+j+", "+i+")) +\n               float(depth4);\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                   vec2("+q+".0, "+p+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ":q===i&&null==n?"\n      float "+e+"(int row, int col, int depth,\n                    int depth2, int depth3, int depth4) {\n        float texR = dot(vec4(row, col, depth, depth2),\n          vec4("+c[1]*c[2]*c[3]*c[4]+",\n               "+c[2]*c[3]*c[4]+",\n               "+c[3]*c[4]+",\n               "+c[4]+")) + float(depth3);\n        int texC = depth4;\n        vec2 uv = (vec2(texC, texR) + halfCR) /\n                  vec2("+q+".0, "+p+".0);\n        return sampleTexture("+d+", uv);\n      }\n    ":"\n    float "+e+"(int row, int col, int depth,\n                  int depth2, int depth3, int depth4) {\n      // Explicitly use integer operations as dot() only works on floats.\n      int index = row * "+m+" + col * "+l+" + depth * "+k+" +\n          depth2 * "+j+" + depth3 * "+i+" + depth4 + "+eH(d)+";\n      vec2 uv = uvFromFlat("+p+", "+q+", index);\n      return sampleTexture("+d+", uv);\n    }\n  "}(b);default:throw Error(c.length+"-D input sampling is not yet supported")}}(a)),f=a.shapeInfo.logicalShape,g=b.logicalShape,f.length<=g.length&&(e+=c?function(a,b){var c,d=a.name,e=d.charAt(0).toUpperCase()+d.slice(1),f=a.shapeInfo.logicalShape.length,g=b.logicalShape.length,h=d4(a.shapeInfo.logicalShape,b.logicalShape),i=eJ(g),j=g-f,k=["x","y","z","w","u","v"];c=0===f?"":g<2&&h.length>=1?"coords = 0;":h.map(function(a){return"coords."+k[a+j]+" = 0;"}).join("\n");var l="";l=g<2&&f>0?"coords":a.shapeInfo.logicalShape.map(function(a,b){return"coords."+k[b+j]}).join(", ");var m="return outputValue;",n=1===O(a.shapeInfo.logicalShape),o=1===O(b.logicalShape);if(1!==f||n||o){if(n&&!o)m=1===g?"\n        return vec4(outputValue.x, outputValue.x, 0., 0.);\n      ":"\n        return vec4(outputValue.x);\n      ";else if(h.length){var p=f-2,q=f-1;h.indexOf(p)>-1&&h.indexOf(q)>-1?m="return vec4(outputValue.x);":h.indexOf(p)>-1?m="return vec4(outputValue.x, outputValue.y, outputValue.x, outputValue.y);":h.indexOf(q)>-1&&(m="return vec4(outputValue.xx, outputValue.zz);")}}else m="\n      return vec4(outputValue.xy, outputValue.xy);\n    ";return"\n    vec4 get"+e+"AtOutCoords() {\n      "+i+" coords = getOutputCoords();\n      "+c+"\n      vec4 outputValue = get"+e+"("+l+");\n      "+m+"\n    }\n  "}(a,b):function(a,b){var c=a.name,d=c.charAt(0).toUpperCase()+c.slice(1),e="get"+d+"AtOutCoords",f=b.texShape,g=a.shapeInfo.texShape,h=a.shapeInfo.logicalShape.length,i=b.logicalShape.length;if(!a.shapeInfo.isUniform&&h===i&&null==a.shapeInfo.flatOffset&&P(g,f))return"\n      float "+e+"() {\n        return sampleTexture("+c+", resultUV);\n      }\n    ";var j,k=eJ(i),l=d4(a.shapeInfo.logicalShape,b.logicalShape),m=i-h,n=["x","y","z","w","u","v"];j=0===h?"":i<2&&l.length>=1?"coords = 0;":l.map(function(a){return"coords."+n[a+m]+" = 0;"}).join("\n");return"\n    float "+e+"() {\n      "+k+" coords = getOutputCoords();\n      "+j+"\n      return get"+d+"("+(i<2&&h>0?"coords":a.shapeInfo.logicalShape.map(function(a,b){return"coords."+n[b+m]}).join(", "))+");\n    }\n  "}(a,b)),e}).join("\n"),j=b.texShape,k=eD(),l="\n    float sampleTexture(sampler2D textureSampler, vec2 uv) {\n      return "+k.texture2D+"(textureSampler, uv).r;\n    }\n  ",m=k.version+"\n    precision highp float;\n    precision highp int;\n    precision highp sampler2D;\n    "+k.varyingFs+" vec2 resultUV;\n    "+k.defineOutput+"\n    const vec2 halfCR = vec2(0.5, 0.5);\n\n    struct ivec5\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n    };\n\n    struct ivec6\n    {\n      int x;\n      int y;\n      int z;\n      int w;\n      int u;\n      int v;\n    };\n\n    uniform float NAN;\n    "+k.defineSpecialNaN+"\n    "+k.defineSpecialInf+"\n    "+k.defineRound+"\n\n    int imod(int x, int y) {\n      return x - y * (x / y);\n    }\n\n    int idiv(int a, int b, float sign) {\n      int res = a / b;\n      int mod = imod(a, b);\n      if (sign < 0. && mod != 0) {\n        res -= 1;\n      }\n      return res;\n    }\n\n    //Based on the work of Dave Hoskins\n    //https://www.shadertoy.com/view/4djSRW\n    #define HASHSCALE1 443.8975\n    float random(float seed){\n      vec2 p = resultUV * seed;\n      vec3 p3  = fract(vec3(p.xyx) * HASHSCALE1);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n\n    \nvec2 uvFromFlat(int texNumR, int texNumC, int index) {\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\nvec2 packedUVfrom1D(int texNumR, int texNumC, int index) {\n  int texelIndex = index / 2;\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n    \nvec2 packedUVfrom2D(int texelsInLogicalRow, int texNumR,\n  int texNumC, int row, int col) {\n  int texelIndex = (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = texelIndex / texNumC;\n  int texC = texelIndex - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n    \nvec2 packedUVfrom3D(int texNumR, int texNumC,\n    int texelsInBatch, int texelsInLogicalRow, int b,\n    int row, int col) {\n  int index = b * texelsInBatch + (row / 2) * texelsInLogicalRow + (col / 2);\n  int texR = index / texNumC;\n  int texC = index - texR * texNumC;\n  return (vec2(texC, texR) + halfCR) / vec2(texNumC, texNumR);\n}\n\n  ";return b.isPacked?(f=function(a,b){switch(a.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===(f=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)])[0]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.x * "+f[1]+".0);\n      }\n    ":1===f[1]?"\n      int getOutputCoords() {\n        return 2 * int(resultUV.y * "+f[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+f[0]+", "+f[1]+"));\n      return 2 * (resTexRC.x * "+f[1]+" + resTexRC.y);\n    }\n  ";case 2:var c,d,e,f,g=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)];if(P(a,b))return"\n      ivec2 getOutputCoords() {\n        return 2 * ivec2(resultUV.yx * vec2("+g[0]+", "+g[1]+"));\n      }\n    ";var h=Math.ceil(a[1]/2);return"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+g[0]+", "+g[1]+"));\n\n      int index = resTexRC.x * "+g[1]+" + resTexRC.y;\n      int r = 2 * (index / "+h+");\n      int c = imod(index, "+h+") * 2;\n\n      return ivec2(r, c);\n    }\n  ";case 3:return c=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)],e=(d=Math.ceil(a[2]/2))*Math.ceil(a[1]/2),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+c[0]+", "+c[1]+"));\n      int index = resTexRC.x * "+c[1]+" + resTexRC.y;\n\n      int b = index / "+e+";\n      index -= b * "+e+";\n\n      int r = 2 * (index / "+d+");\n      int c = imod(index, "+d+") * 2;\n\n      return ivec3(b, r, c);\n    }\n  ";default:return function(a,b){for(var c=[Math.ceil(b[0]/2),Math.ceil(b[1]/2)],d=Math.ceil(a[a.length-1]/2),e=d*Math.ceil(a[a.length-2]/2),f=e,g="",h="b, r, c",i=2;i<a.length-1;i++)f*=a[a.length-i-1],g="\n      int b"+i+" = index / "+f+";\n      index -= b"+i+" * "+f+";\n    "+g,h="b"+i+", "+h;return"\n    ivec"+a.length+" getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+c[0]+", "+c[1]+"));\n      int index = resTexRC.x * "+c[1]+" + resTexRC.y;\n\n      "+g+"\n\n      int b = index / "+e+";\n      index -= b * "+e+";\n\n      int r = 2 * (index / "+d+");\n      int c = imod(index, "+d+") * 2;\n\n      return ivec"+a.length+"("+h+");\n    }\n  "}(a,b)}}(b.logicalShape,j),g="\n    void setOutput(vec4 val) {\n      "+k.output+" = val;\n    }\n  "):(f=function(a,b){var c,d,e,f;switch(a.length){case 0:return"\n    int getOutputCoords() {\n      return 0;\n    }\n  ";case 1:return 1===b[0]?"\n      int getOutputCoords() {\n        return int(resultUV.x * "+b[1]+".0);\n      }\n    ":1===b[1]?"\n      int getOutputCoords() {\n        return int(resultUV.y * "+b[0]+".0);\n      }\n    ":"\n    int getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+b[0]+", "+b[1]+"));\n      return resTexRC.x * "+b[1]+" + resTexRC.y;\n    }\n  ";case 2:return P(a,b)?"\n      ivec2 getOutputCoords() {\n        return ivec2(resultUV.yx * vec2("+b[0]+", "+b[1]+"));\n      }\n    ":1===a[1]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+b[0]+", "+b[1]+"));\n        int index = resTexRC.x * "+b[1]+" + resTexRC.y;\n        return ivec2(index, 0);\n      }\n    ":1===a[0]?"\n      ivec2 getOutputCoords() {\n        ivec2 resTexRC = ivec2(resultUV.yx *\n                               vec2("+b[0]+", "+b[1]+"));\n        int index = resTexRC.x * "+b[1]+" + resTexRC.y;\n        return ivec2(0, index);\n      }\n    ":"\n    ivec2 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+b[0]+", "+b[1]+"));\n      int index = resTexRC.x * "+b[1]+" + resTexRC.y;\n      int r = index / "+a[1]+";\n      int c = index - r * "+a[1]+";\n      return ivec2(r, c);\n    }\n  ";case 3:return c=eE(["r","c","d"],a),"\n    ivec3 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n                             vec2("+b[0]+", "+b[1]+"));\n      int index = resTexRC.x * "+b[1]+" + resTexRC.y;\n      "+c+"\n      return ivec3(r, c, d);\n    }\n  ";case 4:return d=eE(["r","c","d","d2"],a),"\n    ivec4 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+b[0]+", "+b[1]+"));\n      int index = resTexRC.x * "+b[1]+" + resTexRC.y;\n      "+d+"\n      return ivec4(r, c, d, d2);\n    }\n  ";case 5:return e=eE(["r","c","d","d2","d3"],a),"\n    ivec5 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx * vec2("+b[0]+",\n                             "+b[1]+"));\n\n      int index = resTexRC.x * "+b[1]+" + resTexRC.y;\n\n      "+e+"\n\n      ivec5 outShape = ivec5(r, c, d, d2, d3);\n      return outShape;\n    }\n  ";case 6:return f=eE(["r","c","d","d2","d3","d4"],a),"\n    ivec6 getOutputCoords() {\n      ivec2 resTexRC = ivec2(resultUV.yx *\n        vec2("+b[0]+", "+b[1]+"));\n      int index = resTexRC.x * "+b[1]+" + resTexRC.y;\n\n      "+f+"\n\n      ivec6 result = ivec6(r, c, d, d2, d3, d4);\n      return result;\n    }\n  ";default:throw Error(a.length+"-D output sampling is not yet supported")}}(b.logicalShape,j),g="\n    void setOutput(float val) {\n      "+k.output+" = vec4(val, 0, 0, 0);\n    }\n  "),d&&(m+="\n  float getChannel(vec4 frag, vec2 innerDims) {\n    vec2 modCoord = mod(innerDims, 2.);\n    return modCoord.x == 0. ?\n      (modCoord.y == 0. ? frag.r : frag.g) :\n      (modCoord.y == 0. ? frag.b : frag.a);\n  }\n  float getChannel(vec4 frag, int dim) {\n    float modCoord = mod(float(dim), 2.);\n    return modCoord == 0. ? frag.r : frag.g;\n  }\n"),[m,l,g,h,f,i,c].join("\n")}(f,h,e,b.packedInputs),j=a.createProgram(i),k=null,l=a.getUniformLocation(j,"NAN",!1);1===w.getNumber("WEBGL_VERSION")&&(k=a.getUniformLocation(j,"INFINITY",!1));for(var m={},n=0;n<b.variableNames.length;n++){var o=b.variableNames[n];m[o]=a.getUniformLocation(j,o,!1),m["offset"+o]=a.getUniformLocation(j,"offset"+o,!1)}return{program:b,source:i,webGLProgram:j,uniformLocations:m,inShapeInfos:g,outShapeInfo:h,infLoc:k,nanLoc:l}}(i.gpgpu,a,m,q)}),t=null!=this.activeTimers;if(t&&(p=this.startTimer()),f=this.gpgpu,fL(s.inShapeInfos,m),fL([s.outShapeInfo],[q]),g=q.texData.texture,h=q.texData.texShape,q.texData.isPacked?f.setOutputPackedMatrixTexture(g,h[0],h[1]):f.setOutputMatrixTexture(g,h[0],h[1]),f.setProgram(s.webGLProgram),1===w.getNumber("WEBGL_VERSION")&&null!==s.infLoc&&f.gl.uniform1f(s.infLoc,1/0),null!==s.nanLoc&&f.gl.uniform1f(s.nanLoc,NaN),m.forEach(function(a,b){var c=s.program.variableNames[b],d=s.uniformLocations[c],e=s.uniformLocations["offset"+c];if(null!=d)if(a.isUniform)if(2>O(a.shape))f.gl.uniform1f(d,a.uniformValues[0]);else{var g=a.uniformValues;g instanceof Float32Array||(g=new Float32Array(g)),f.gl.uniform1fv(d,g)}else null!=a.texData.slice&&null!=e&&f.gl.uniform1i(e,a.texData.slice.flatOffset),f.setInputMatrixTexture(a.texData.texture,d,b)}),null!=d&&d(f,s.webGLProgram),f.executeProgram(),l.forEach(function(a){return i.disposeData(a.dataId)}),t&&(p=this.endTimer(p),this.activeTimers.push({name:a.constructor.name,query:this.getQueryTime(p)})),!w.getBool("WEBGL_LAZILY_UNPACK")&&k.isPacked&&!1===e){var u=this.unpackTensor(j);return this.disposeData(j.dataId),u}return j},b.prototype.compileAndRun=function(a,b,c,d,e){void 0===e&&(e=!1),c=c||b[0].dtype;var f=this.runWebGLProgram(a,b,c,d,e);return a_.makeTensorFromDataId(f.dataId,f.shape,f.dtype)},b.prototype.getAndSaveBinary=function(a,b){return a in this.binaryCache||(this.binaryCache[a]=b()),this.binaryCache[a]},b.prototype.getTextureManager=function(){return this.textureManager},b.prototype.dispose=function(){var a=this;this.disposed||(w.getBool("IS_TEST")||Object.keys(this.binaryCache).forEach(function(b){a.gpgpu.deleteProgram(a.binaryCache[b].webGLProgram),delete a.binaryCache[b]}),this.textureManager.dispose(),null!=this.canvas&&"undefined"!=typeof HTMLCanvasElement&&this.canvas instanceof HTMLCanvasElement?this.canvas.remove():this.canvas=null,this.gpgpuCreatedLocally&&(this.gpgpu.program=null,this.gpgpu.dispose()),this.disposed=!0)},b.prototype.floatPrecision=function(){var a=this;return null==this.floatPrecisionValue&&(this.floatPrecisionValue=b3(function(){if(!w.get("WEBGL_RENDER_FLOAT32_ENABLED")){var b=w.getBool("DEBUG");w.set("DEBUG",!1);var c=a.abs(cB(1e-8)).dataSync()[0];if(w.set("DEBUG",b),c>0)return 32}return 16})),this.floatPrecisionValue},b.prototype.epsilon=function(){return 32===this.floatPrecision()?1e-7:1e-4},b.prototype.uploadToGPU=function(a){var b,c=this.texData.get(a),d=c.shape,e=c.dtype,f=c.values,g=c.texture,h=c.usage,i=c.isPacked;if(null==g){var j,k=null!=this.activeTimers;k&&(j=ap());var l=c.texShape;if(null==l&&(c.texShape=l=bK(d,i)),null!=f){var m=bJ(d),n=void 0,o=l[1],p=l[0],q=f instanceof Uint8Array;i?(o=(b=ba(l[0],l[1]))[0],n=new fn(m,[p=b[1],o],q)):n=new fm(m,[p,o],q);var r=this.makeTensorInfo([p,o],e);this.texData.get(r.dataId).usage=q?a3.PIXELS:a3.UPLOAD,this.gpgpu.uploadDenseMatrixToTexture(this.getTexture(r.dataId),o,p,f);var s=this.runWebGLProgram(n,[r],e,null,!0),t=this.texData.get(s.dataId);c.texture=t.texture,c.texShape=t.texShape,c.isPacked=t.isPacked,c.usage=t.usage,this.disposeData(r.dataId),this.texData.delete(s.dataId),c.values=null,k&&(this.uploadWaitMs+=ap()-j)}else c.texture=this.acquireTexture(l,h,e,i)}},b.prototype.convertAndCacheOnCPU=function(a,b){var c=this.texData.get(a),d=c.dtype;return this.releaseGPUData(a),null!=b&&(c.values=function(a,b){if("float32"===b||"complex64"===b)return a;if("int32"===b||"bool"===b){for(var c="int32"===b?new Int32Array(a.length):new Uint8Array(a.length),d=0;d<c.length;++d)c[d]=Math.round(a[d]);return c}throw Error("Unknown dtype "+b)}(b,d)),c.values},b.prototype.acquireTexture=function(a,b,c,d){if(this.numBytesInGPU+=this.computeBytes(a,c),!this.warnedAboutMemory&&this.numBytesInGPU>1024*this.numMBBeforeWarning*1024){var e=(this.numBytesInGPU/1024/1024).toFixed(2);this.warnedAboutMemory=!0,console.warn("High memory usage in GPU: "+e+" MB, most likely due to a memory leak")}return this.textureManager.acquireTexture(a,b,d)},b.prototype.computeBytes=function(a,b){return a[0]*a[1]*ac(b)},b}(d2);a0()&&a_.registerBackend("webgl",function(){return new gL},2);var gM=cv({square_:function(a){var b=cj(a,"x","square"),c=[b];return a_.runKernelFunc(function(a,c){return c([b]),a.square(b)},{x:b},null,"Square",{},c,[])}}),gN="SquaredDifference",gO=cv({squaredDifference_:function(a,b){var c,d=cj(a,"a","squaredDifference"),e=cj(b,"b","squaredDifference");d=(c=aP(d,e))[0],e=c[1],d6(d.shape,e.shape);var f={a:d,b:e},g=[d,e];return a_.runKernelFunc(function(a,b){var c=a.squaredDifference(d,e);return b([d,e]),c},f,function(a,b){var c=b[0],d=b[1],e=cB(2);return{a:function(){return a.mul(c.sub(d).mul(e))},b:function(){return a.mul(d.sub(c).mul(e))}}},gN,{},g,[])}}),gP=cv({abs_:function(a){var b=cj(a,"x","abs");return"complex64"===b.dtype?a_.runKernelFunc(function(a){return a.complexAbs(b)},{$x:b}):a_.runKernelFunc(function(a,c){var d=a.abs(b);return c([b]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return a.mul(c.toFloat().step(-1))}}},"Abs")}}),gQ=cv({acos_:function(a){var b=cj(a,"x","acos");return a_.runKernelFunc(function(a,c){var d=a.acos(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.divStrict(cB(1).sub(c.toFloat().square()).sqrt()).neg()}}})}}),gR=cv({acosh_:function(a){var b=cj(a,"x","acosh");return a_.runKernelFunc(function(a,c){var d=a.acosh(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.divStrict(c.toFloat().square().sub(1).sqrt())}}})}}),gS=cv({asin_:function(a){var b=cj(a,"x","asin");return a_.runKernelFunc(function(a,c){var d=a.asin(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.divStrict(cB(1).sub(c.toFloat().square()).sqrt())}}})}}),gT=cv({asinh_:function(a){var b=cj(a,"x","asinh");return a_.runKernelFunc(function(a,c){var d=a.asinh(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.divStrict(cB(1).add(c.toFloat().square()).sqrt())}}})}}),gU=cv({atan_:function(a){var b=cj(a,"x","atan");return a_.runKernelFunc(function(a,c){var d=a.atan(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.div(c.toFloat().square().add(1))}}})}}),gV=cv({atanh_:function(a){var b=cj(a,"x","atanh");return a_.runKernelFunc(function(a,c){var d=a.atanh(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.div(cB(1).sub(c.toFloat().square()))}}})}}),gW=cv({ceil_:function(a){var b=cj(a,"x","ceil");return a_.runKernelFunc(function(a){return a.ceil(b)},{$x:b},function(a){return{$x:function(){return cP(a)}}})}}),gX=cv({clipByValue_:function(a,b,c){var d=cj(a,"x","clipByValue");K(b<=c,function(){return"Error in clip: min ("+b+") must be less than or equal to max ("+c+")."});var e=[d];return a_.runKernelFunc(function(a,e){var f=a.clip(d,b,c);return e([d]),f},{x:d},function(a,d){var e=d[0];return{x:function(){return a.where(e.greaterEqual(b).logicalAnd(e.lessEqual(c)),cP(a))}}},"ClipByValue",{min:b,max:c},e)}}),gY=cv({cos_:function(a){var b=cj(a,"x","cos"),c=[b];return a_.runKernelFunc(function(a,c){var d=a.cos(b);return c([b]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return c.toFloat().sin().neg().mul(a)}}},"Cos",{},c)}}),gZ=cv({cosh_:function(a){var b=cj(a,"x","cosh");return a_.runKernelFunc(function(a,c){var d=a.cosh(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return c.toFloat().sinh().mulStrict(a)}}})}}),g$=cv({erf_:function(a){var b=cj(a,"x","erf");return K("int32"===b.dtype||"float32"===b.dtype,function(){return"Input dtype must be `int32` or `float32`."}),"int32"===b.dtype&&(b=b.toFloat()),a_.runKernelFunc(function(a,c){var d=a.erf(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.mul(c.square().neg().exp().mul(2/Math.sqrt(Math.PI)))}}})}}),g_=cv({exp_:function(a){var b=cj(a,"x","exp");return a_.runKernelFunc(function(a,c){var d=a.exp(b);return c([d]),d},{x:b},function(a,b){return{x:function(){return a.mulStrict(b[0])}}},"Exp",{},[],[!0])}}),g0=cv({expm1_:function(a){var b=cj(a,"x","expm1");return a_.runKernelFunc(function(a,c){var d=a.expm1(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.mul(c.exp())}}})}}),g1=cv({floor_:function(a){var b=cj(a,"x","floor");return a_.runKernelFunc(function(a){return a.floor(b)},{$x:b},function(a){return{$x:function(){return cP(a)}}})}}),g2=cv({log_:function(a){var b=cj(a,"x","log"),c=[b];return a_.runKernelFunc(function(a,c){var d=a.log(b);return c([b]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return a.div(c.toFloat())}}},"Log",{},c)}}),g3=cv({log1p_:function(a){var b=cj(a,"x","log1p");return a_.runKernelFunc(function(a,c){var d=a.log1p(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.div(c.add(1))}}})}}),g4=cv({logSigmoid_:function(a){var b=cj(a,"x","logSigmoid");return a_.runKernelFunc(function(a,c){var d=a.softplus(b.neg()).neg();return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.mul(c.neg().sigmoid())}}})}}),g5=cv({neg_:function(a){var b=cj(a,"x","neg"),c=[b];return a_.runKernelFunc(function(a){return a.neg(b)},{x:b},function(a){return{x:function(){return a.neg()}}},"Neg",{},c)}}),g6=cv({reciprocal_:function(a){var b=cj(a,"x","reciprocal");return a_.runKernelFunc(function(a,c){var d=a.reciprocal(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.div(c.square().neg())}}})}}),g7=cv({round_:function(a){var b=cj(a,"x","round");return a_.runKernelFunc(function(a){return a.round(b)},{$x:b},function(a){return{$x:function(){return cP(a)}}})}}),g8=cv({rsqrt_:function(a){var b=cj(a,"x","rsqrt"),c=[b];return a_.runKernelFunc(function(a,c){var d=a.rsqrt(b);return c([b]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return a.div(c.pow(1.5).mul(2)).neg()}}},"Rsqrt",{},c)}}),g9=cv({sigmoid_:function(a){var b=cj(a,"x","sigmoid");return a_.runKernelFunc(function(a,c){var d=a.sigmoid(b);return c([d]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return a.mul(c.mul(cB(1).sub(c)))}}},"Sigmoid")}}),ha=cv({sign_:function(a){var b=cj(a,"x","sign");return a_.runKernelFunc(function(a){return a.sign(b)},{$x:b},function(a){return{$x:function(){return cP(a)}}})}}),hb=cv({isNaN_:function(a){var b=cj(a,"x","isNaN");return a_.runKernelFunc(function(a){return a.isNaN(b)},{$x:b},function(a){return{$x:function(){return cP(a)}}})}}),hc=cv({isInf_:function(a){var b=cj(a,"x","isInf");return a_.runKernelFunc(function(a){return a.isInf(b)},{$x:b},function(a){return{$x:function(){return cP(a)}}})}}),hd=cv({isFinite_:function(a){var b=cj(a,"x","isFinite");return a_.runKernelFunc(function(a){return a.isFinite(b)},{$x:b},function(a){return{$x:function(){return cP(a)}}})}}),he=cv({sin_:function(a){var b=cj(a,"x","sin"),c=[b];return a_.runKernelFunc(function(a,c){var d=a.sin(b);return c([b]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return c.toFloat().cos().mul(a)}}},"Sin",{},c)}}),hf=cv({sinh_:function(a){var b=cj(a,"x","sinh");return a_.runKernelFunc(function(a,c){var d=a.sinh(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return c.toFloat().cosh().mulStrict(a)}}})}}),hg=cv({softplus_:function(a){var b=cj(a,"x","softplus");return a_.runKernelFunc(function(a,c){var d=a.softplus(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.mul(c.sigmoid())}}})}}),hh=cv({sqrt_:function(a){var b=cj(a,"x","sqrt");return a_.runKernelFunc(function(a,c){var d=a.sqrt(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.div(c.toFloat().sqrt().mul(2))}}})}}),hi=cv({step_:function(a,b){void 0===b&&(b=0);var c=cj(a,"x","step");return a_.runKernelFunc(function(a){return a.step(c,b)},{$x:c},function(a){return{$x:function(){return cP(a)}}})}}),hj=cv({tan_:function(a){var b=cj(a,"x","tan");return a_.runKernelFunc(function(a,c){var d=a.tan(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a.div(c.cos().square())}}})}}),hk=cv({tanh_:function(a){var b=cj(a,"x","tanh");return a_.runKernelFunc(function(a,c){var d=a.tanh(b);return c([d]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return cB(1).sub(c.square()).mulStrict(a)}}},"Tanh",{},null,[!0])}});function hl(a,b,c,d,e,f){var g,h,i=cj(a,"x","batchNorm"),j=cj(b,"mean","batchNorm"),k=cj(c,"variance","batchNorm");return null!=e&&(g=cj(e,"scale","batchNorm")),null!=d&&(h=cj(d,"offset","batchNorm")),K(2===i.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+i.rank+"."}),K(2===j.rank||1===j.rank,function(){return"Error in batchNorm2D: mean must be rank 2 or rank 1 but got rank "+j.rank+"."}),K(2===k.rank||1===k.rank,function(){return"Error in batchNorm2D: variance must be rank 2 or rank 1 but got rank "+k.rank+"."}),null!=g&&K(2===g.rank||1===g.rank,function(){return"Error in batchNorm2D: scale must be rank 2 or rank 1 but got rank "+g.rank+"."}),null!=h&&K(2===h.rank||1===h.rank,function(){return"Error in batchNorm2D: offset must be rank 2 or rank 1 but got rank "+h.rank+"."}),ho(i,j,k,h,g,f)}function hm(a,b,c,d,e,f){var g,h,i=cj(a,"x","batchNorm"),j=cj(b,"mean","batchNorm"),k=cj(c,"variance","batchNorm");return null!=e&&(g=cj(e,"scale","batchNorm")),null!=d&&(h=cj(d,"offset","batchNorm")),K(3===i.rank,function(){return"Error in batchNorm3D: x must be rank 3 but got rank "+i.rank+"."}),K(3===j.rank||1===j.rank,function(){return"Error in batchNorm3D: mean must be rank 3 or rank 1 but got rank "+j.rank+"."}),K(3===k.rank||1===k.rank,function(){return"Error in batchNorm3D: variance must be rank 3 or rank 1 but got rank "+k.rank+"."}),null!=g&&K(3===g.rank||1===g.rank,function(){return"Error in batchNorm3D: scale must be rank 3 or rank 1 but got rank "+g.rank+"."}),null!=h&&K(3===h.rank||1===h.rank,function(){return"Error in batchNorm3D: offset must be rank 3 or rank 1 but got rank "+h.rank+"."}),ho(i,j,k,h,g,f)}function hn(a,b,c,d,e,f){var g,h,i=cj(a,"x","batchNorm"),j=cj(b,"mean","batchNorm"),k=cj(c,"variance","batchNorm");return null!=e&&(g=cj(e,"scale","batchNorm")),null!=d&&(h=cj(d,"offset","batchNorm")),K(4===i.rank,function(){return"Error in batchNorm4D: x must be rank 4 but got rank "+i.rank+"."}),K(4===j.rank||1===j.rank,function(){return"Error in batchNorm4D: mean must be rank 4 or rank 1 but got rank "+j.rank+"."}),K(4===k.rank||1===k.rank,function(){return"Error in batchNorm4D: variance must be rank 4 or rank 1 but got rank "+k.rank+"."}),null!=g&&K(4===g.rank||1===g.rank,function(){return"Error in batchNorm4D: scale must be rank 4 or rank 1 but got rank "+g.rank+"."}),null!=h&&K(4===h.rank||1===h.rank,function(){return"Error in batchNorm4D: offset must be rank 4 or rank 1 but got rank "+h.rank+"."}),ho(i,j,k,h,g,f)}function ho(a,b,c,d,e,f){null==f&&(f=.001);var g,h,i,j=cj(a,"x","batchNorm"),k=cj(b,"mean","batchNorm"),l=cj(c,"variance","batchNorm");null!=e&&(g=cj(e,"scale","batchNorm")),null!=d&&(h=cj(d,"offset","batchNorm")),K(k.rank===l.rank,function(){return"Batch normalization gradient requires mean and variance to have equal ranks."}),K(null==h||k.rank===h.rank,function(){return"Batch normalization gradient requires mean and offset to have equal ranks."}),K(null==g||k.rank===g.rank,function(){return"Batch normalization gradient requires mean and scale to have equal ranks."}),i=0===j.rank||1===j.rank?j.as4D(1,1,1,j.size):2===j.rank?j.as4D(1,1,j.shape[0],j.shape[1]):3===j.rank?j.as4D(1,j.shape[0],j.shape[1],j.shape[2]):j;var m=[j,k,l,g];return a_.runKernelFunc(function(a,b){var c=a.batchNormalization(i,hp(k),hp(l),f,hp(g),hp(h));return b([j,k,l,g]),c},{x:j,mean:k,variance:l,scale:g,offset:h},function(a,b){var c=b[0],d=b[1],e=b[2],g=b[3],h=null==g?cB(1):g,j=d5(d.shape,i.shape),k=[];if(1===d.rank){for(var l=0;l<i.shape.length-1;++l)k.push(i.shape[l]);k.push(1)}var m=c.sub(d),n=a.mul(h),o=g8(e.add(cB(f))),p=o.mul(o).mul(o).mul(cB(-.5));return{x:function(){return 1===d.rank?a.mul(dw(o.as4D(1,1,1,d.shape[0]),k)).mul(h).reshape(c.shape):a.mul(o).mul(h).reshape(c.shape)},mean:function(){var a=o.mul(cB(-1)).mul(n);return 1===d.rank&&(a=a.sum(j)),a.reshape(d.shape)},variance:function(){var a=p.mul(m).mul(n);return 1===d.rank&&(a=a.sum(j)),a.reshape(d.shape)},scale:function(){var b=m.mul(o),c=a.mul(b);return 1===d.rank&&(c=c.sum(j)),c.reshape(d.shape)},offset:function(){var b=a;return 1===d.rank&&(b=b.sum(j)),b.reshape(d.shape)}}},"BatchNormalization",{varianceEpsilon:f},m).reshape(j.shape)}function hp(a){return null==a?null:0===a.rank?a.as1D():1===a.rank?a:2===a.rank?a.as4D(1,1,a.shape[0],a.shape[1]):3===a.rank?a.as4D(1,a.shape[0],a.shape[1],a.shape[2]):a}function hq(){b$("tf.batchNormalization() is going away. Use tf.batchNorm() instead, and note the positional argument change of scale, offset, and varianceEpsilon")}var hr=cv({batchNormalization2d_:function(a,b,c,d,e,f){return void 0===d&&(d=.001),hq(),hl(a,b,c,f,e,d)}}),hs=cv({batchNormalization3d_:function(a,b,c,d,e,f){return void 0===d&&(d=.001),hq(),hm(a,b,c,f,e,d)}}),ht=cv({batchNormalization4d_:function(a,b,c,d,e,f){return void 0===d&&(d=.001),hq(),hn(a,b,c,f,e,d)}}),hu=cv({batchNormalization_:function(a,b,c,d,e,f){return void 0===d&&(d=.001),hq(),ho(a,b,c,f,e,d)}}),hv=cv({batchNorm_:ho}),hw=cv({batchNorm2d_:hl}),hx=cv({batchNorm3d_:hm}),hy=cv({batchNorm4d_:hn}),hz=cv({logicalAnd_:function(a,b){var c=cj(a,"a","logicalAnd","bool"),d=cj(b,"b","logicalAnd","bool");return d6(c.shape,d.shape),a_.runKernelFunc(function(a){return a.logicalAnd(c,d)},{a:c,b:d},null,"LogicalAnd")}}),hA=cv({logicalNot_:function(a){var b=cj(a,"x","logicalNot","bool");return a_.runKernelFunc(function(a){return a.logicalNot(b)},{$x:b})}}),hB=cv({logicalOr_:function(a,b){var c=cj(a,"a","logicalOr","bool"),d=cj(b,"b","logicalOr","bool");return d6(c.shape,d.shape),a_.runKernelFunc(function(a){return a.logicalOr(c,d)},{$a:c,$b:d})}}),hC=cv({logicalXor_:function(a,b){var c=cj(a,"a","logicalXor","bool"),d=cj(b,"b","logicalXor","bool");return d6(c.shape,d.shape),hB(a,b).logicalAnd(hz(a,b).logicalNot())}}),hD=cv({where_:function(a,b,c){var d=cj(b,"a","where"),e=cj(c,"b","where"),f=cj(a,"condition","where","bool");return L(d.shape,e.shape,"Error in where: "),1===f.rank?K(f.shape[0]===d.shape[0],function(){return"The first dimension of `a` must match the size of `condition`."}):L(f.shape,e.shape,"Error in where: "),a_.runKernelFunc(function(a,b){var c=a.select(f,d,e);return b([f]),c},{$condition:f,$a:d,$b:e},function(a,b){var c=b[0];return{$condition:function(){return cP(c).toFloat()},$a:function(){return a.mul(c.cast(a.dtype))},$b:function(){return a.mul(c.logicalNot().cast(a.dtype))}}})}}),hE=function(a){return s(this,void 0,void 0,function(){var b,c,d;return t(this,function(e){switch(e.label){case 0:return[4,(b=cj(a,"condition","whereAsync","bool")).data()];case 1:return c=e.sent(),d=ex(b.shape,c),a!==b&&b.dispose(),[2,d]}})})},hF=cv({add_:function(a,b){var c,d=cj(a,"a","add"),e=cj(b,"b","add");d=(c=aP(d,e))[0],e=c[1];var f=d6(d.shape,e.shape);return a_.runKernelFunc(function(a){return a.add(d,e)},{a:d,b:e},function(a){return{a:function(){var b=a,c=d5(d.shape,f);return c.length>0&&(b=b.sum(c)),b.reshape(d.shape)},b:function(){var b=a,c=d5(e.shape,f);return c.length>0&&(b=b.sum(c)),b.reshape(e.shape)}}},"Add")}}),hG=cv({addN_:function(a){K(Array.isArray(a),function(){return"The argument passed to tf.addN() must be a list of tensors"}),K(a.length>=1,function(){return"Must pass at least one tensor to tf.addN(), but got "+a.length});var b=a.map(function(a,b){return cj(a,"tensors"+b,"addN")}),c=b[0];return b.forEach(function(a){if(a.dtype!==c.dtype)throw Error("All tensors passed to tf.addN() must have the same dtype")}),b.forEach(function(a){if(!P(a.shape,c.shape))throw Error("All tensors passed to tf.addN() must have the same shape")}),a_.runKernelFunc(function(a){return a.addN(b)},b,function(a){var c={};return b.forEach(function(b,d){c[d]=function(){return a.clone()}}),c},"AddN")}}),hH=cv({addStrict_:function(a,b){var c=cj(a,"a","addStrict"),d=cj(b,"b","addStrict");return L(c.shape,d.shape,"Error in addStrict: "),c.add(d)}}),hI=cv({atan2_:function(a,b){var c,d=cj(a,"a","atan2"),e=cj(b,"b","atan2");d=(c=aP(d,e))[0],e=c[1];var f=d6(d.shape,e.shape);return a_.runKernelFunc(function(a,b){var c=a.atan2(d,e);return b([d,e]),c},{$a:d,$b:e},function(a,b){var c=b[0],d=b[1];return{$a:function(){var b=hF(c.square(),d.square()),e=a.mul(d.div(b)),g=d5(c.shape,f);return g.length>0&&(e=e.sum(g)),e.reshape(c.shape)},$b:function(){var b=hF(c.square(),d.square()),e=g5(a.mul(c.div(b))),g=d5(d.shape,f);return g.length>0&&(e=e.sum(g)),e.reshape(d.shape)}}})}}),hJ=cv({div_:function(a,b){var c,d=cj(a,"a","div"),e=cj(b,"b","div");if(d=(c=aP(d,e))[0],e=c[1],"int32"===d.dtype&&"int32"===e.dtype)return hM(d,e);var f=d6(d.shape,e.shape);return a_.runKernelFunc(function(a,b){var c=a.realDivide(d,e);return b([d,e]),c},{a:d,b:e},function(a,b){var c=b[0],d=b[1];return{a:function(){var b=a.div(d.toFloat()),e=d5(c.shape,f);return e.length>0?b.sum(e).reshape(c.shape):b},b:function(){var b=a.mul(c.toFloat()),e=d5(d.shape,f);e.length>0&&(b=b.sum(e).reshape(d.shape));var g=d.square();return b.div(g.toFloat()).neg()}}},"Div")}}),hK=cv({divNoNan_:function(a,b){var c,d=cj(a,"a","div"),e=cj(b,"b","div"),f=hJ(d=(c=aP(d,e))[0],e=c[1]),g=cP(f);return hD(e.equal(g),g,f)}}),hL=cv({divStrict_:function(a,b){var c=cj(a,"a","div"),d=cj(b,"b","div");return L(c.shape,d.shape,"Error in divideStrict: "),c.div(d)}}),hM=cv({floorDiv_:function(a,b){var c,d=cj(a,"a","floorDiv"),e=cj(b,"b","floorDiv");d=(c=aP(d,e))[0],e=c[1];var f=d6(d.shape,e.shape);return a_.runKernelFunc(function(a,b){var c=a.floorDiv(d,e);return b([d,e]),c},{a:d,b:e},function(a,b){var c=b[0],d=b[1];return{a:function(){var b=a.div(d.toFloat()),e=d5(c.shape,f);return e.length>0?b.sum(e).reshape(c.shape):b},b:function(){var b=a.mul(c.toFloat()),e=d5(d.shape,f);e.length>0&&(b=b.sum(e).reshape(d.shape));var g=d.square();return b.div(g.toFloat()).neg()}}},"FloorDiv")}}),hN=cv({maximum_:function(a,b){var c,d=cj(a,"a","maximum"),e=cj(b,"b","maximum");return d=(c=aP(d,e))[0],e=c[1],"bool"===d.dtype&&(d=d.toInt(),e=e.toInt()),d6(d.shape,e.shape),a_.runKernelFunc(function(a,b){var c=a.maximum(d,e);return b([d,e]),c},{a:d,b:e},function(a,b){var c=b[0],d=b[1];return{a:function(){return a.mul(c.greaterEqual(d).toFloat())},b:function(){return a.mul(c.less(d).toFloat())}}},"Maximum")}}),hO=cv({maximumStrict_:function(a,b){var c=cj(a,"a","maximumStrict"),d=cj(b,"b","maximumStrict");return L(c.shape,d.shape,"Error in maximumStrict: "),c.maximum(d)}}),hP=cv({minimum_:function(a,b){var c,d=cj(a,"a","minimum"),e=cj(b,"b","minimum");return d=(c=aP(d,e))[0],e=c[1],"bool"===d.dtype&&(d=d.toInt(),e=e.toInt()),d6(d.shape,e.shape),a_.runKernelFunc(function(a,b){var c=a.minimum(d,e);return b([d,e]),c},{a:d,b:e},function(a,b){var c=b[0],d=b[1];return{a:function(){return a.mul(c.lessEqual(d).toFloat())},b:function(){return a.mul(c.greater(d).toFloat())}}},"Minimum")}}),hQ=cv({minimumStrict_:function(a,b){var c=cj(a,"a","minimumStrict"),d=cj(b,"b","minimumStrict");return L(c.shape,d.shape,"Error in minimumStrict: "),c.minimum(d)}}),hR=cv({mod_:function(a,b){var c,d=cj(a,"a","mod"),e=cj(b,"b","mod");d=(c=aP(d,e))[0],e=c[1];var f=d6(d.shape,e.shape);return a_.runKernelFunc(function(a,b){var c=a.mod(d,e);return b([d,e]),c},{$a:d,$b:e},function(a,b){var c=b[0],d=b[1];return{$a:function(){var b=d5(c.shape,f);return b.length>0?a.sum(b).reshape(c.shape):a},$b:function(){var b=a.mul(c.div(d).floor().neg()),e=d5(d.shape,f);return e.length>0?b.sum(e).reshape(d.shape):b}}})}}),hS=cv({modStrict_:function(a,b){var c=cj(a,"a","modStrict"),d=cj(b,"b","modStrict");return L(c.shape,d.shape,"Error in modStrict: "),c.mod(d)}}),hT=cv({mul_:function(a,b){var c,d=cj(a,"a","mul"),e=cj(b,"b","mul");d=(c=aP(d,e))[0],e=c[1];var f=d6(d.shape,e.shape);return a_.runKernelFunc(function(a,b){var c=a.multiply(d,e);return b([d,e]),c},{a:d,b:e},function(a,b){var c=b[0],d=b[1];return{a:function(){var b=a.mul(d.toFloat()),e=d5(c.shape,f);return e.length>0?b.sum(e).reshape(c.shape):b},b:function(){var b=a.mul(c.toFloat()),e=d5(d.shape,f);return e.length>0?b.sum(e).reshape(d.shape):b}}},"Mul")}}),hU=cv({mulStrict_:function(a,b){var c=cj(a,"a","mul"),d=cj(b,"b","mul");return L(c.shape,d.shape,"Error in multiplyStrict: "),c.mul(d)}}),hV=cv({pow_:function(a,b){var c,d=cj(a,"base","pow"),e=cj(b,"exp","pow");d=(c=aP(d,e))[0],e=c[1];var f=d6(d.shape,e.shape),g=[d,e];return a_.runKernelFunc(function(a,b){var c=a.pow(d,e);return b([d,e,c]),c},{a:d,b:e},function(a,b){var c=b[0],d=b[1],e=b[2];return{a:function(){var b=d.toFloat(),e=a.mul(b.mul(c.pow(b.sub(cB(1))))),g=d5(c.shape,f);return g.length>0&&(e=e.sum(g)),e.reshape(c.shape)},b:function(){var b=c.greater(0),g=c.log().where(b,cP(c)),h=a.mul(e.mul(g)),i=d5(d.shape,f);return i.length>0&&(h=h.sum(i)),h.reshape(d.shape)}}},"Pow",{},g,[!0])}}),hW=cv({powStrict_:function(a,b){return L(a.shape,b.shape,"Error in powStrict: "),a.pow(b)}}),hX=cv({squaredDifferenceStrict_:function(a,b){var c=cj(a,"a","squaredDifferenceStrict"),d=cj(b,"b","squaredDifferenceStrict");return L(c.shape,d.shape,"Error in squaredDifferenceStrict: "),c.squaredDifference(d)}}),hY=cv({sub_:function(a,b){var c,d=cj(a,"a","sub"),e=cj(b,"b","sub");d=(c=aP(d,e))[0],e=c[1];var f=d6(d.shape,e.shape);return a_.runKernelFunc(function(a){return a.subtract(d,e)},{a:d,b:e},function(a){return{a:function(){var b=a,c=d5(d.shape,f);return c.length>0&&(b=b.sum(c)),b.reshape(d.shape)},b:function(){var b=a,c=d5(e.shape,f);return c.length>0&&(b=b.sum(c)),b.neg().reshape(e.shape)}}},"Sub")}}),hZ=cv({subStrict_:function(a,b){var c=cj(a,"a","subStrict"),d=cj(b,"b","subStrict");return L(c.shape,d.shape,"Error in subStrict: "),c.sub(d)}}),h$=cv({equal_:function(a,b){var c,d=cj(a,"a","equal"),e=cj(b,"b","equal");return d=(c=aP(d,e))[0],e=c[1],d6(d.shape,e.shape),a_.runKernelFunc(function(a){return a.equal(d,e)},{$a:d,$b:e})}}),h_=cv({equalStrict_:function(a,b){var c=cj(a,"a","equalStrict"),d=cj(b,"b","equalStrict");return L(c.shape,d.shape,"Error in equalStrict: "),c.equal(d)}}),h0=cv({greater_:function(a,b){var c,d=cj(a,"a","greater"),e=cj(b,"b","greater");return d=(c=aP(d,e))[0],e=c[1],d6(d.shape,e.shape),a_.runKernelFunc(function(a){return a.greater(d,e)},{a:d,b:e},null,"Greater")}}),h1=cv({greaterEqual_:function(a,b){var c,d=cj(a,"a","greaterEqual"),e=cj(b,"b","greaterEqual");return d=(c=aP(d,e))[0],e=c[1],d6(d.shape,e.shape),a_.runKernelFunc(function(a,b){var c=a.greaterEqual(d,e);return b([d,e]),c},{a:d,b:e},function(a,b){var c=b[0],d=b[1];return{a:function(){return cP(c)},b:function(){return cP(d)}}},"GreaterEqual")}}),h2=cv({greaterEqualStrict_:function(a,b){var c=cj(a,"a","greaterEqualStrict"),d=cj(b,"b","greaterEqualStrict");return L(c.shape,d.shape,"Error in greaterEqualStrict: "),c.greaterEqual(d)}}),h3=cv({greaterStrict_:function(a,b){var c=cj(a,"a","greaterStrict"),d=cj(b,"b","greaterStrict");return L(c.shape,d.shape,"Error in greaterStrict: "),c.greater(d)}}),h4=cv({less_:function(a,b){var c,d=cj(a,"a","less"),e=cj(b,"b","less");return d=(c=aP(d,e))[0],e=c[1],d6(d.shape,e.shape),a_.runKernelFunc(function(a){return a.less(d,e)},{a:d,b:e},null,"Less")}}),h5=cv({lessEqual_:function(a,b){var c,d=cj(a,"a","lessEqual"),e=cj(b,"b","lessEqual");return d=(c=aP(d,e))[0],e=c[1],d6(d.shape,e.shape),a_.runKernelFunc(function(a,b){var c=a.lessEqual(d,e);return b([d,e]),c},{a:d,b:e},null,"LessEqual")}}),h6=cv({lessEqualStrict_:function(a,b){var c=cj(a,"a","lessEqualStrict"),d=cj(b,"b","lessEqualStrict");return L(c.shape,d.shape,"Error in lessEqualStrict: "),c.lessEqual(d)}}),h7=cv({lessStrict_:function(a,b){var c=cj(a,"a","lessStrict"),d=cj(b,"b","lessStrict");return L(c.shape,d.shape,"Error in lessStrict: "),c.less(d)}}),h8=cv({notEqual_:function(a,b){var c,d=cj(a,"a","notEqual"),e=cj(b,"b","notEqual");return d=(c=aP(d,e))[0],e=c[1],d6(d.shape,e.shape),a_.runKernelFunc(function(a){return a.notEqual(d,e)},{a:d,b:e},null,"NotEqual")}}),h9=cv({notEqualStrict_:function(a,b){var c=cj(a,"a","notEqualStrict"),d=cj(b,"b","notEqualStrict");return L(c.shape,d.shape,"Error in notEqualStrict: "),c.notEqual(d)}});function ia(a,b){for(var c=[],d=a;d<b;++d)c.push(d);return c}function ib(a){for(var b=[],c=0;c<a.length;++c)for(var d=0;d<a[c].length;++d)b.push(a[c][d]);return b}var ic=cv({gather_:function(a,b,c){void 0===c&&(c=0);var d=cj(a,"x","gather"),e=cj(b,"indices","gather","int32");c=W(c,d.shape)[0];var f=function(a,b,c){for(var d=a.shape[c],e=[],f=1,g=1,h=0;h<c;h++)e.push(a.shape[h]),f*=a.shape[h];for(h=0;h<b.rank;h++)e.push(b.shape[h]);for(h=c+1;h<a.rank;h++)e.push(a.shape[h]),g*=a.shape[h];return{batchSize:f,sliceSize:g,dimSize:d,outputShape:e}}(d,e,c);return a_.runKernelFunc(function(a,b){var f=a.gather(d,e.flatten(),c);return b([e]),f},{x:d,indices:e},function(a,b){var e=b[0];return{x:function(){var b=d.shape,f=e.size,g=b.slice(0,c),h=g.length,i=b.slice(c,b.length).slice(1),j=i.length,k=ia(0,h),l=ia(h+1,h+1+j),m=ib([g,[f],i]),n=a.reshape(m),o=e.reshape([f]),p=ib([[h],k,l]),q=id(n.transpose(p),o,d.shape[c]),r=cr(p);return q.transpose(r)},indices:function(){return e}}},"Gather",{axis:c}).reshape(f.outputShape)}}),id=cv({unsortedSegmentSum_:function(a,b,c){var d=cj(a,"x","unsortedSegmentSum"),e=cj(b,"segmentIds","unsortedSegmentSum","int32");return K(Q(c),function(){return"numSegments must be of dtype int"}),a_.runKernelFunc(function(a,b){var f=a.unsortedSegmentSum(d,e,c);return b([e]),f},{$x:d},function(a,b){var c=b[0];return{$x:function(){return function(a,b){for(var c=hN(b,cP(b)),d=ic(a,c),e=h1(b,cB(0,"int32")),f=d.rank-e.rank,g=0;g<f;++g)e=de(e,g+1);e=hz(e,cJ(d.shape,"bool"));var h=cP(d);return hD(e,d,h)}(a,c)}}})}}),ie=function(a,b,c){return s(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l,m,n,o,p;return t(this,function(q){switch(q.label){case 0:for(d=cj(a,"tensor","boolMask"),e=cj(b,"mask","boolMask","bool"),f=null==c?0:c,g=e.rank,h=d.shape,K(g>0,function(){return"mask cannot be scalar"}),L(h.slice(f,f+g),e.shape,"mask's shape must match the first K dimensions of tensor's shape,"),i=1,j=f;j<f+g;j++)i*=h[j];return k=h.slice(0,f).concat([i],h.slice(f+g)),l=d.reshape(k),[4,hE(m=e.reshape([-1]))];case 1:return o=(n=q.sent()).squeeze([1]),p=ic(l,o,f),a!==d&&d.dispose(),b!==e&&e.dispose(),o.dispose(),l.dispose(),m.dispose(),n.dispose(),[2,p]}})})};function ig(a,b,c,d,e,f,g){void 0===f&&(f="NHWC"),K(a.length===b.rank,function(){return"Length of inShape ("+a.length+") and rank of dy ("+b.rank+") must match"});var h=a,i=b,j=!1;3===b.rank&&(j=!0,i=b.as4D(1,b.shape[0],b.shape[1],b.shape[2]),h=[1,a[0],a[1],a[2]]),K(4===h.length,function(){return"Error in conv2dDerInput: inShape must be length 4, but got length "+h.length+"."}),K(4===i.rank,function(){return"Error in conv2dDerInput: dy must be rank 4, but got rank "+i.rank}),K(4===c.rank,function(){return"Error in conv2dDerInput: filter must be rank 4, but got rank "+c.rank});var k="NHWC"===f?h[3]:h[1],l="NHWC"===f?i.shape[3]:i.shape[1];K(k===c.shape[2],function(){return"Error in conv2dDerInput: depth of input ("+k+") must match input depth for filter "+c.shape[2]+"."}),K(l===c.shape[3],function(){return"Error in conv2dDerInput: depth of output ("+l+") must match output depth for filter "+c.shape[3]+"."}),null!=g&&K(Q(e),function(){return"Error in conv2dDerInput: pad must be an integer when using, dimRoundingMode "+g+" but got pad "+e+"."});var m=ei(f),n=d9(h,c.shape,d,1,e,g,!1,m),o=a_.runKernelFunc(function(a,b){var d=a.conv2dDerInput(i,c,n);return b([c,i]),d},{dy4D:i,filter:c},function(a,b){var c=b[0],h=b[1];return{dy4D:function(){return ik(a,c,d,e,f,1,g)},filter:function(){return im(a,h,c.shape,d,e,f,g)}}});return j?o.as3D(o.shape[1],o.shape[2],o.shape[3]):o}function ih(a){var b="number"==typeof a?[a,a,a]:2===a.length?[a[0],a[1],1]:a,c=b[0],d=b[1],e=b[2];return 1===c&&1===d&&1===e}function ii(a,b,c,d,e){K(a.length===b.rank,function(){return"Length of inShape ("+a.length+") and rank of dy ("+b.rank+") must match"});var f=a,g=b,h=!1;4===b.rank&&(h=!0,g=b.as5D(1,b.shape[0],b.shape[1],b.shape[2],b.shape[3]),f=[1,a[0],a[1],a[2],a[3]]);var i=f[4],j=g.shape[4];K(5===f.length,function(){return"Error in conv3dDerInput: inShape must be length 5, but got length "+f.length+"."}),K(5===g.rank,function(){return"Error in conv3dDerInput: dy must be rank 5, but got rank "+g.rank}),K(5===c.rank,function(){return"Error in conv3dDerInput: filter must be rank 5, but got rank "+c.rank}),K(i===c.shape[3],function(){return"Error in conv3dDerInput: depth of input ("+i+") must match input depth for filter "+c.shape[3]+"."}),K(j===c.shape[4],function(){return"Error in conv3dDerInput: depth of output ("+j+") must match output depth for filter "+c.shape[4]+"."});var k=ea(f,c.shape,d,1,e),l=a_.runKernelFunc(function(a){return a.conv3dDerInput(g,c,k)},{dy5D:g});return h?l.as4D(l.shape[1],l.shape[2],l.shape[3],l.shape[4]):l}var ij=cv({conv1d_:function(a,b,c,d,e,f,g){void 0===e&&(e="NWC"),void 0===f&&(f=1);var h=cj(a,"x","conv1d"),i=cj(b,"filter","conv1d"),j=h,k=!1;2===h.rank&&(k=!0,j=h.as3D(1,h.shape[0],h.shape[1])),K(3===j.rank,function(){return"Error in conv1d: input must be rank 3, but got rank "+j.rank+"."}),K(3===i.rank,function(){return"Error in conv1d: filter must be rank 3, but got rank "+i.rank+"."}),null!=g&&K(Q(d),function(){return"Error in conv1d: pad must be an integer when using, dimRoundingMode "+g+" but got pad "+d+"."}),K(j.shape[2]===i.shape[1],function(){return"Error in conv1d: depth of input ("+j.shape[2]+") must match input depth for filter "+i.shape[1]+"."}),K(eh(c,f),function(){return"Error in conv1D: Either stride or dilation must be 1. Got stride "+c+" and dilation '"+f+"'"}),K("NWC"===e,function(){return"Error in conv1d: got dataFormat of "+e+" but only NWC is currently supported."});var l=i.as4D(1,i.shape[0],i.shape[1],i.shape[2]),m=ik(j.as4D(j.shape[0],1,j.shape[1],j.shape[2]),l,[1,c],d,"NHWC",[1,f],g);return k?m.as2D(m.shape[2],m.shape[3]):m.as3D(m.shape[0],m.shape[2],m.shape[3])}}),ik=cv({conv2d_:function(a,b,c,d,e,f,g){void 0===e&&(e="NHWC"),void 0===f&&(f=[1,1]);var h=cj(a,"x","conv2d"),i=cj(b,"filter","conv2d"),j=h,k=!1;3===h.rank&&(k=!0,j=h.as4D(1,h.shape[0],h.shape[1],h.shape[2])),K(4===j.rank,function(){return"Error in conv2d: input must be rank 4, but got rank "+j.rank+"."}),K(4===i.rank,function(){return"Error in conv2d: filter must be rank 4, but got rank "+i.rank+"."}),null!=g&&K(Q(d),function(){return"Error in conv2d: pad must be an integer when using, dimRoundingMode "+g+" but got pad "+d+"."});var l="NHWC"===e?j.shape[3]:j.shape[1];K(l===i.shape[2],function(){return"Error in conv2d: depth of input ("+l+") must match input depth for filter "+i.shape[2]+"."}),K(eh(c,f),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+f+"'"});var m=ei(e),n=d9(j.shape,i.shape,c,f,d,g,!1,m),o=[i,j],p=a_.runKernelFunc(function(a,b){var c=a.conv2d(j,i,n);return b([i,j]),c},{x:j,filter:i},function(a,b){var g=b[0],h=b[1];return K(eg(f),function(){return"Error in gradient of conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+f+"'"}),{x:function(){return io(h.shape,a,g,c,d,e)},filter:function(){return im(h,a,g.shape,c,d,e)}}},"Conv2D",n,o);return k?p.as3D(p.shape[1],p.shape[2],p.shape[3]):p}}),il=cv({conv3d_:function(a,b,c,d,e,f){void 0===e&&(e="NDHWC"),void 0===f&&(f=[1,1,1]);var g,h=cj(a,"x","conv3d"),i=cj(b,"filter","conv3d"),j=h,k=!1;4===h.rank&&(k=!0,j=h.as5D(1,h.shape[0],h.shape[1],h.shape[2],h.shape[3])),K(5===j.rank,function(){return"Error in conv3d: input must be rank 5, but got rank "+j.rank+"."}),K(5===i.rank,function(){return"Error in conv3d: filter must be rank 5, but got rank "+i.rank+"."}),K(j.shape[4]===i.shape[3],function(){return"Error in conv3d: depth of input ("+j.shape[4]+") must match input depth for filter "+i.shape[3]+"."}),K((g=f,ih(c)||ih(g)),function(){return"Error in conv3D: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+f+"'"}),K("NDHWC"===e,function(){return"Error in conv3d: got dataFormat of "+e+" but only NDHWC is currently supported."});var l=ea(j.shape,i.shape,c,f,d),m=a_.runKernelFunc(function(a,b){var c=a.conv3d(j,i,l);return b([j,i]),c},{x:j,$filter:i},function(a,b){K(ih(f),function(){return"Error in gradient of conv3D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+f+"'"});var e=b[0],g=b[1];return{x:function(){return ii(e.shape,a,g,c,d)},$filter:function(){var b,f,h,i;return b=g.shape,f=e,4===e.rank&&(f=e.as5D(1,e.shape[0],e.shape[1],e.shape[2],e.shape[3])),4===(h=a).rank&&(h=a.as5D(1,a.shape[0],a.shape[1],a.shape[2],a.shape[3])),K(5===f.rank,function(){return"Error in conv3dDerFilter: input must be rank 5, but got shape "+f.shape+"."}),K(5===h.rank,function(){return"Error in conv3dDerFilter: dy must be rank 5, but got shape "+h.shape+"."}),K(5===b.length,function(){return"Error in conv3dDerFilter: filterShape must be length 5, but got "+b+"."}),K(f.shape[4]===b[3],function(){return"Error in conv3dDerFilter: depth of input "+f.shape[4]+") must match input depth in filter ("+b[3]+"."}),K(h.shape[4]===b[4],function(){return"Error in conv3dDerFilter: depth of dy ("+h.shape[4]+") must match output depth for filter ("+b[4]+")."}),i=ea(f.shape,b,c,1,d),a_.runKernelFunc(function(a){return a.conv3dDerFilter(f,h,i)},{x5D:f,dy5D:h})}}});return k?m.as4D(m.shape[1],m.shape[2],m.shape[3],m.shape[4]):m}}),im=cv({conv2dDerFilter_:function(a,b,c,d,e,f,g){void 0===f&&(f="NHWC");var h=a;3===a.rank&&(h=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var i=b;3===i.rank&&(i=b.as4D(1,b.shape[0],b.shape[1],b.shape[2])),K(4===h.rank,function(){return"Error in conv2dDerFilter: input must be rank 4, but got shape "+h.shape+"."}),K(4===i.rank,function(){return"Error in conv2dDerFilter: dy must be rank 4, but got shape "+i.shape+"."}),K(4===c.length,function(){return"Error in conv2dDerFilter: filterShape must be length 4, but got "+c+"."});var j="NHWC"===f?h.shape[3]:h.shape[1],k="NHWC"===f?i.shape[3]:i.shape[1];K(j===c[2],function(){return"Error in conv2dDerFilter: depth of input "+j+") must match input depth in filter ("+c[2]+"."}),K(k===c[3],function(){return"Error in conv2dDerFilter: depth of dy ("+k+") must match output depth for filter ("+c[3]+")."}),null!=g&&K(Q(e),function(){return"Error in conv2dDerFilter: pad must be an integer when using, dimRoundingMode "+g+" but got pad "+e+"."});var l=ei(f),m=d9(h.shape,c,d,1,e,g,!1,l);return a_.runKernelFunc(function(a){return a.conv2dDerFilter(h,i,m)},{x4D:h,dy4D:i})}}),io=cv({conv2dDerInput_:ig}),ip=cv({depthwiseConv2d_:function(a,b,c,d,e,f,g){void 0===e&&(e="NHWC"),void 0===f&&(f=[1,1]);var h=cj(a,"x","depthwiseConv2d"),i=cj(b,"filter","depthwiseConv2d"),j=h,k=!1;3===h.rank&&(k=!0,j=h.as4D(1,h.shape[0],h.shape[1],h.shape[2])),K(4===j.rank,function(){return"Error in depthwiseConv2d: input must be rank 4, but got rank "+j.rank+"."}),K(4===i.rank,function(){return"Error in depthwiseConv2d: filter must be rank 4, but got rank "+i.rank+"."}),K(j.shape[3]===i.shape[2],function(){return"Error in depthwiseConv2d: number of input channels ("+j.shape[3]+") must match the inChannels dimension in filter "+i.shape[2]+"."}),null==f&&(f=[1,1]),K(eh(c,f),function(){return"Error in depthwiseConv2d: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+f+"'"}),null!=g&&K(Q(d),function(){return"Error in depthwiseConv2d: pad must be an integer when using, dimRoundingMode "+g+" but got pad "+d+"."});var l=d9(j.shape,i.shape,c,f,d,g,!0),m=[j,i],n=a_.runKernelFunc(function(a,b){var c=a.depthwiseConv2D(j,i,l);return b([j,i]),c},{x:j,filter:i},function(a,b){K(eg(f),function(){return"Error in gradient of depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+f+"'"});var c=b[0],d=b[1];return{x:function(){return iq(c.shape,a,d,l)},filter:function(){return ir(c,a,d.shape,l)}}},"DepthwiseConv2dNative",l,m);return k?n.as3D(n.shape[1],n.shape[2],n.shape[3]):n}}),iq=cv({depthwiseConv2dDerInput_:function(a,b,c,d){var e=b,f=!1;3===b.rank&&(f=!0,e=b.as4D(1,b.shape[0],b.shape[1],b.shape[2]));var g=a_.runKernelFunc(function(a){return a.depthwiseConv2DDerInput(e,c,d)},{dy4D:e});return f?g.as3D(g.shape[1],g.shape[2],g.shape[3]):g}}),ir=cv({depthwiseConv2dDerFilter_:function(a,b,c,d){var e=a;3===a.rank&&(e=a.as4D(1,a.shape[0],a.shape[1],a.shape[2]));var f=b;return 3===f.rank&&(f=b.as4D(1,b.shape[0],b.shape[1],b.shape[2])),a_.runKernelFunc(function(a){return a.depthwiseConv2DDerFilter(e,f,d)},{x4D:e,dy4D:f})}}),is=cv({separableConv2d_:function(a,b,c,d,e,f,g){void 0===f&&(f=[1,1]),void 0===g&&(g="NHWC");var h=cj(a,"x","separableConv2d"),i=cj(b,"depthwiseFilter","separableConv2d"),j=cj(c,"pointwiseFilter","separableConv2d"),k=h,l=!1;if(3===h.rank&&(l=!0,k=h.as4D(1,h.shape[0],h.shape[1],h.shape[2])),"NCHW"===g)throw Error("separableConv2d currently does not support dataFormat NCHW; only NHWC is supported");K(4===k.rank,function(){return"Error in separableConv2d: input must be rank 4, but got rank "+k.rank+"."}),K(4===i.rank,function(){return"Error in separableConv2d: depthwise filter must be rank 4, but got rank "+i.rank+"."}),K(4===j.rank,function(){return"Error in separableConv2d: pointwise filter must be rank 4, but got rank "+i.rank+"."}),K(1===j.shape[0],function(){return"Error in separableConv2d: the first dimension of pointwise filter  must be 1, but got "+j.shape[0]+"."}),K(1===j.shape[1],function(){return"Error in separableConv2d: the second dimension of pointwise filter must be 1, but got "+j.shape[1]+"."});var m=i.shape[2],n=i.shape[3];K(j.shape[2]===m*n,function(){return"Error in separableConv2d: the third dimension of pointwise filter must be "+m*n+", but got "+j.shape[2]+"."});var o=ik(ip(k,i,d,e,g,f),j,1,"valid",g);return l?o.as3D(o.shape[1],o.shape[2],o.shape[3]):o}}),it=cv({conv2dTranspose_:function(a,b,c,d,e,f){return ig(c,cj(a,"x","conv2dTranspose"),cj(b,"filter","conv2dTranspose"),d,e,"NHWC",f)}}),iu=cv({conv3dTranspose_:function(a,b,c,d,e){return ii(c,cj(a,"x","conv3dTranspose"),cj(b,"filter","conv3dTranspose"),d,e)}}),iv=cv({matMul_:function(a,b,c,d){void 0===c&&(c=!1),void 0===d&&(d=!1);var e,f=cj(a,"a","matMul"),g=cj(b,"b","matMul");f=(e=aP(f,g))[0],g=e[1];var h=c?f.shape[f.rank-2]:f.shape[f.rank-1],i=d?g.shape[g.rank-1]:g.shape[g.rank-2],j=c?f.shape[f.rank-1]:f.shape[f.rank-2],k=d?g.shape[g.rank-2]:g.shape[g.rank-1],l=f.shape.slice(0,-2),m=g.shape.slice(0,-2),n=O(l),o=O(m);K(f.rank>=2&&g.rank>=2&&f.rank===g.rank,function(){return"Error in matMul: inputs must have the same rank of at least 2, got ranks "+f.rank+" and "+g.rank+"."}),K(P(l,m),function(){return"Error in matMul: outer dimensions ("+l+") and ("+m+") of Tensors with shapes "+f.shape+" and "+g.shape+" must match."}),K(h===i,function(){return"Error in matMul: inner shapes ("+h+") and ("+i+") of Tensors with shapes "+f.shape+" and "+g.shape+" and transposeA="+c+" and transposeB="+d+" must match."});var p=f.shape.slice(0,-2).concat([j,k]),q=c?f.as3D(n,h,j):f.as3D(n,j,h),r=d?g.as3D(o,k,i):g.as3D(o,i,k),s={transposeA:c,transposeB:d};return a_.runKernelFunc(function(a,b){var e=a.batchMatMul(q,r,c,d);return b([q,r]),e},{a:q,b:r},function(a,b){var e=b[0],f=b[1];return c||d?!c&&d?{a:function(){return a.matMul(f,!1,!1)},b:function(){return a.matMul(e,!0,!1)}}:c&&!d?{a:function(){return f.matMul(a,!1,!0)},b:function(){return e.matMul(a,!1,!1)}}:{a:function(){return f.matMul(a,!0,!0)},b:function(){return a.matMul(e,!0,!0)}}:{a:function(){return a.matMul(f,!1,!0)},b:function(){return e.matMul(a,!0,!1)}}},"BatchMatMul",s).reshape(p)}}),iw=cv({dot_:function(a,b){var c=cj(a,"t1","dot"),d=cj(b,"t2","dot");K((1===c.rank||2===c.rank)&&(1===d.rank||2===d.rank),function(){return"Error in dot: inputs must all be rank 1 or 2, but got ranks "+c.rank+" and "+d.rank+"."});var e=1===c.rank?c.size:c.shape[1],f=1===d.rank?d.size:d.shape[0];return K(e===f,function(){return"Error in dot: inner dimensions of inputs must match, but got "+e+" and "+f+"."}),1===c.rank&&1===d.rank?c.as2D(1,-1).matMul(d.as2D(-1,1)).asScalar():1===c.rank&&2===d.rank?c.as2D(1,-1).matMul(d.as2D(d.shape[0],d.shape[1])).as1D():2===c.rank&&1===d.rank?c.matMul(d.as2D(-1,1)).as1D():c.matMul(d.as2D(d.shape[0],d.shape[1]))}}),ix=cv({outerProduct_:function(a,b){var c=cj(a,"v1","outerProduct"),d=cj(b,"v2","outerProduct");return K(1===c.rank&&1===d.rank,function(){return"Error in outerProduct: inputs must be rank 1, but got ranks "+c.rank+" and "+d.rank+"."}),c.as2D(-1,1).matMul(d.as2D(1,-1))}}),iy=cv({reverse_:function(a,b){var c=cj(a,"x","reverse");if(0===c.rank)return c.clone();var d=W(b,c.shape);return a_.runKernelFunc(function(a){return a.reverse(c,d)},{$x:c},function(a){return{$x:function(){return a.reverse(d)}}}).reshapeAs(c)}}),iz=cv({reverse1d_:function(a){var b=cj(a,"x","reverse");return K(1===b.rank,function(){return"Error in reverse1D: x must be rank 1 but got rank "+b.rank+"."}),iy(b,0)}}),iA=cv({reverse2d_:function(a,b){var c=cj(a,"x","reverse");return K(2===c.rank,function(){return"Error in reverse2D: x must be rank 2 but got rank "+c.rank+"."}),iy(c,b)}}),iB=cv({reverse3d_:function(a,b){var c=cj(a,"x","reverse");return K(3===c.rank,function(){return"Error in reverse3D: x must be rank 3 but got rank "+c.rank+"."}),iy(c,b)}}),iC=cv({reverse4d_:function(a,b){var c=cj(a,"x","reverse");return K(4===c.rank,function(){return"Error in reverse4D: x must be rank 4 but got rank "+c.rank+"."}),iy(c,b)}});function iD(a,b,c,d,e,f){var g=cj(a,"x","maxPool"),h=g,i=!1;3===g.rank&&(i=!0,h=g.as4D(1,g.shape[0],g.shape[1],g.shape[2])),null==d&&(d=[1,1]),K(4===h.rank,function(){return"Error in maxPool: input must be rank 4 but got rank "+h.rank+"."}),K(eh(c,d),function(){return"Error in maxPool: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+d+"'"}),null!=f&&K(Q(e),function(){return"Error in maxPool: pad must be an integer when using, dimRoundingMode "+f+" but got pad "+e+"."});var j=d7(h.shape,b,c,d,e,f);if(1===j.filterWidth&&1===j.filterHeight&&P(j.inShape,j.outShape))return g.clone();var k=[h],l=a_.runKernelFunc(function(a,b){var c=a.maxPool(h,j);return b([h,c]),c},{x:h},function(a,f){var g=f[0],h=f[1];return{x:function(){var f,i,j,k,l;return f=d,i=cj(a,"dy","maxPoolBackprop"),j=cj(g,"input","maxPoolBackprop"),k=cj(h,"output","maxPoolBackprop"),K(j.rank===i.rank,function(){return"Rank of input ("+j.rank+") does not match rank of dy ("+i.rank+")"}),null==f&&(f=[1,1]),K(eh(c,f),function(){return"Error in maxPoolBackProp: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+f+"'"}),K(4===i.rank,function(){return"Error in maxPoolBackprop: dy must be rank 4 but got rank "+i.rank+"."}),K(4===j.rank,function(){return"Error in maxPoolBackprop: input must be rank 4 but got rank "+j.rank+"."}),l=d7(j.shape,b,c,f,e,void 0),a_.runKernelFunc(function(a){return a.maxPoolBackprop(i,j,k,l)},{$dy:i,$input:j})}}},"MaxPool",j,k);return i?l.as3D(l.shape[1],l.shape[2],l.shape[3]):l}function iE(a,b,c,d,e,f){var g=cj(a,"x","avgPool","float32");null==d&&(d=[1,1]),K(eh(c,d),function(){return"Error in avgPool: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+d+"'"});var h=g,i=!1;3===g.rank&&(i=!0,h=g.as4D(1,g.shape[0],g.shape[1],g.shape[2])),K(4===h.rank,function(){return"Error in avgPool: x must be rank 4 but got rank "+h.rank+"."}),null!=f&&K(Q(e),function(){return"Error in avgPool: pad must be an integer when using, dimRoundingMode "+f+" but got pad "+e+"."});var j=d7(h.shape,b,c,d,e,f);if(1===j.filterWidth&&1===j.filterHeight&&P(j.inShape,j.outShape))return g.clone();var k=a_.runKernelFunc(function(a){return a.avgPool(h,j)},{x:h},function(a){return{x:function(){var f,g,i,j,k,l,m,n,o;return f=h,g=d,i=cj(a,"dy","avgPoolBackprop"),K((j=cj(f,"input","avgPoolBackprop")).rank===i.rank,function(){return"Rank of input ("+j.rank+") does not match rank of dy ("+i.rank+")"}),null==g&&(g=[1,1]),K(eh(c,g),function(){return"Error in avgPoolBackprop: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+g+"'"}),k=j,l=i,m=!1,3===j.rank&&(m=!0,k=j.as4D(1,j.shape[0],j.shape[1],j.shape[2]),l=i.as4D(1,i.shape[0],i.shape[1],i.shape[2])),K(4===l.rank,function(){return"Error in avgPoolBackprop: dy must be rank 4 but got rank "+l.rank+"."}),K(4===k.rank,function(){return"Error in avgPoolBackprop: input must be rank 4 but got rank "+k.rank+"."}),n=d7(k.shape,b,c,g,e),o=a_.runKernelFunc(function(a){return a.avgPoolBackprop(l,k,n)},{dy4D:l,input4D:k}),m?o.as3D(o.shape[1],o.shape[2],o.shape[3]):o}}},"AvgPool",j);return k=k.cast(g.dtype),i?k.as3D(k.shape[1],k.shape[2],k.shape[3]):k}var iF=cv({maxPool_:function(a,b,c,d,e){return iD(a,b,c,1,d,e)}}),iG=cv({avgPool_:function(a,b,c,d,e){return iE(a,b,c,1,d,e)}}),iH=cv({pool_:function(a,b,c,d,e,f){null==e&&(e=[1,1]),null==f&&(f=1),0===d&&(d="valid");var g,h,i,j,k,l,m,n,o,p,q=cj(a,"x","maxPool"),r=q,s=!1;3===q.rank&&(s=!0,r=q.as4D(1,q.shape[0],q.shape[1],q.shape[2])),K(eh(f,e),function(){return"Error in pool: Either strides or dilations must be 1. Got strides "+f+" and dilations '"+e+"'"});var t,u=d7(r.shape,b,f,e,d),v=[u.dilationHeight,u.dilationWidth];t="same"===d?(g=[u.filterHeight,u.filterWidth],i=(h=g.map(function(a,b){return a+(a-1)*(v[b]-1)}).map(function(a){return a-1})).map(function(a){return Math.floor(a/2)}),j=h.map(function(a,b){return a-i[b]}),h.map(function(a,b){return[i[b],j[b]]})):[[0,0],[0,0]];var w=1===v[0]&&1===v[1],x=(k=[u.inHeight,u.inWidth],l=t.map(function(a){return a[0]}),n=k.concat(l,m=t.map(function(a){return a[1]})),o=v.map(function(a,b){return(a-n[b]%a)%a}),p=m.map(function(a,b){return a+o[b]}),[v.map(function(a,b){return[l[b],p[b]]}),v.map(function(a,b){return[0,o[b]]})]),y=x[0],z=x[1],A=w?d:"valid",B=w?r:dt(r,v,y),C=("avg"===c?function(){return iE(B,b,f,1,A)}:function(){return iD(B,b,f,1,A)})(),D=w?C:c8(C,v,z);return s?D.as3D(D.shape[1],D.shape[2],D.shape[3]):D}}),iI=cv({maxPool3d_:function(a,b,c,d,e,f,g){void 0===f&&(f="NDHWC");var h=cj(a,"x","maxPool3d"),i=h,j=!1;4===h.rank&&(j=!0,i=h.as5D(1,h.shape[0],h.shape[1],h.shape[2],h.shape[3])),null==g&&(g=[1,1,1]),K(5===i.rank,function(){return"Error in maxPool3d: x must be rank 5 but got rank "+i.rank+"."}),K("NDHWC"===f,function(){return"Error in maxPool3d: Only NDHWC is currently supported, but got dataFormat of "+f}),K(eh(c,g),function(){return"Error in maxPool3d: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+g+"'"}),null!=e&&K(Q(d),function(){return"Error in maxPool3d: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+d+"."});var k=d8(i.shape,b,c,g,d,e,f),l=a_.runKernelFunc(function(a,b){var c=a.maxPool3d(i,k);return b([i,c]),c},{x:i},function(a,f){var h=f[0],i=f[1];return{x:function(){var f,j,k,l,m,n,o,p,q,r;return f=g,j=cj(a,"dy","maxPool3dBackprop"),k=cj(h,"input","maxPool3dBackprop"),l=cj(i,"output","maxPool3dBackprop"),m=j,n=k,o=l,p=!1,4===k.rank&&(p=!0,m=j.as5D(1,j.shape[0],j.shape[1],j.shape[2],j.shape[3]),n=k.as5D(1,k.shape[0],k.shape[1],k.shape[2],k.shape[3]),o=l.as5D(1,l.shape[0],l.shape[1],l.shape[2],l.shape[3])),K(5===m.rank,function(){return"Error in maxPool3dBackprop: dy must be rank 5 but got rank "+m.rank+"."}),K(5===n.rank,function(){return"Error in maxPool3dBackprop: input must be rank 5 but got rank "+n.rank+"."}),K(5===o.rank,function(){return"Error in maxPool3dBackprop: output must be rank 5 but got rank "+o.rank+"."}),null==f&&(f=[1,1,1]),K(eh(c,f),function(){return"Error in maxPool3dBackprop: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+f+"'"}),null!=e&&K(Q(d),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+d+"."}),q=d8(n.shape,b,c,f,d,e),r=a_.runKernelFunc(function(a){return a.maxPool3dBackprop(m,n,o,q)},{dy5D:m,input5D:n}),p?r.as4D(r.shape[1],r.shape[2],r.shape[3],r.shape[4]):r}}});return j?l.as4D(l.shape[1],l.shape[2],l.shape[3],l.shape[4]):l}}),iJ=cv({avgPool3d_:function(a,b,c,d,e,f,g){void 0===f&&(f="NDHWC");var h=cj(a,"x","avgPool3d","float32"),i=h,j=!1;4===h.rank&&(j=!0,i=h.as5D(1,h.shape[0],h.shape[1],h.shape[2],h.shape[3])),null==g&&(g=[1,1,1]),K(5===i.rank,function(){return"Error in avgPool3d: x must be rank 5 but got rank "+i.rank+"."}),K("NDHWC"===f,function(){return"Error in avgPool3d: Only NDHWC is currently supported, but got dataFormat of "+f}),K(eh(c,g),function(){return"Error in avgPool3d: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+g+"'"}),null!=e&&K(Q(d),function(){return"Error in avgPool3d: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+d+"."});var k=d8(i.shape,b,c,g,d,e,f),l=a_.runKernelFunc(function(a){return a.avgPool3d(i,k)},{x:i},function(a){return{x:function(){var f,h,j,k,l,m,n,o,p;return f=i,h=g,j=cj(a,"dy","avgPool3dBackprop"),k=cj(f,"input","avgPool3dBackprop"),l=j,m=k,n=!1,4===k.rank&&(n=!0,l=j.as5D(1,j.shape[0],j.shape[1],j.shape[2],j.shape[3]),m=k.as5D(1,k.shape[0],k.shape[1],k.shape[2],k.shape[3])),K(5===l.rank,function(){return"Error in avgPool3dBackprop: dy must be rank 5 but got rank "+l.rank+"."}),K(5===m.rank,function(){return"Error in avgPool3dBackprop: input must be rank 5 but got rank "+m.rank+"."}),null==h&&(h=[1,1,1]),K(eh(c,h),function(){return"Error in avgPool3dBackprop: Either strides or dilations must be 1. Got strides "+c+" and dilations '"+h+"'"}),null!=e&&K(Q(d),function(){return"Error in maxPool3dBackprop: pad must be an integer when using, dimRoundingMode "+e+" but got pad "+d+"."}),o=d8(m.shape,b,c,h,d,e),p=a_.runKernelFunc(function(a){return a.avgPool3dBackprop(l,m,o)},{dy5D:l,input5D:m}),n?p.as4D(p.shape[1],p.shape[2],p.shape[3],p.shape[4]):p}}});return l=l.cast(i.dtype),j?l.as4D(l.shape[1],l.shape[2],l.shape[3],l.shape[4]):l}}),iK=cv({slice_:function(a,b,c){var d,e,f=cj(a,"x","slice");if(0===f.rank)throw Error("Slicing scalar is not possible");(d="number"==typeof b?[b].concat(Array(f.rank-1).fill(0)):b.length<f.rank?b.concat(Array(f.rank-b.length).fill(0)):b.slice()).forEach(function(a){K(-1!==a,function(){return"slice() does not support negative begin indexing."})}),e=(e=null==c?Array(f.rank).fill(-1):"number"==typeof c?[c].concat(Array(f.rank-1).fill(-1)):c.length<f.rank?c.concat(Array(f.rank-c.length).fill(-1)):c).map(function(a,b){return a>=0?a:(K(-1===a,function(){return"Negative size values should be exactly -1 but got "+a+" for the slice() size at index "+b+"."}),f.shape[b]-d[b])}),dM(f,d,e);var g=f.shape,h={begin:d,size:e};return a_.runKernelFunc(function(a){return a.slice(f,d,e)},{x:f},function(a){for(var b=[],c=0;c<a.rank;c++)b.push([d[c],g[c]-d[c]-e[c]]);return{x:function(){return a.pad(b)}}},"Slice",h)}}),iL=cv({slice1d_:function(a,b,c){var d=cj(a,"x","slice1d");return K(1===d.rank,function(){return"slice1d expects a rank-1 tensor, but got a rank-"+d.rank+" tensor"}),iK(d,[b],[c])}}),iM=cv({slice2d_:function(a,b,c){var d=cj(a,"x","slice2d");return K(2===d.rank,function(){return"slice2d expects a rank-2 tensor, but got a rank-"+d.rank+" tensor"}),iK(d,b,c)}}),iN=cv({slice3d_:function(a,b,c){var d=cj(a,"x","slice3d");return K(3===d.rank,function(){return"slice3d expects a rank-3 tensor, but got a rank-"+d.rank+" tensor"}),iK(d,b,c)}}),iO=cv({slice4d_:function(a,b,c){var d=cj(a,"x","slice4d");return K(4===d.rank,function(){return"slice4d expects a rank-4 tensor, but got a rank-"+d.rank+" tensor"}),iK(d,b,c)}});function iP(a,b,c,d,e){return b.rank<c.rank&&(b=b.reshape(co(b.shape,d))),a.rank<c.rank&&(a=a.reshape(co(a.shape,d))),{x:function(){var d=a.mul(c.equal(b).cast(a.dtype));return null==e?d:d.transpose(e)}}}var iQ=cv({all_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","all","bool"),e=W(b,d.shape),f=e,g=cq(f,d.rank);null!=g&&(d=d.transpose(g),f=cs(f.length,d.rank));var h=a_.runKernelFunc(function(a){return a.all(d,f)},{$x:d});if(c){var i=co(h.shape,e);return h.reshape(i)}return h}}),iR=cv({any_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","any","bool"),e=W(b,d.shape),f=e,g=cq(f,d.rank);null!=g&&(d=d.transpose(g),f=cs(f.length,d.rank));var h=a_.runKernelFunc(function(a){return a.any(d,f)},{$x:d});if(c){var i=co(h.shape,e);return h.reshape(i)}return h}}),iS=cv({argMax_:function(a,b){void 0===b&&(b=0);var c=cj(a,"x","argMax");null==b&&(b=0);var d=W(b,c.shape),e=cq(d,c.rank);null!=e&&(c=c.transpose(e),d=cs(d.length,c.rank));var f={axis:d[0]},g=[c];return a_.runKernelFunc(function(a,b){var e=a.argMax(c,d[0]);return b([c]),e},{x:c},function(a,b){var c=b[0];return{x:function(){return cP(c)}}},"ArgMax",f,g)}}),iT=cv({argMin_:function(a,b){void 0===b&&(b=0);var c=cj(a,"x","argMin");null==b&&(b=0);var d=W(b,c.shape),e=cq(d,c.rank);return null!=e&&(c=c.transpose(e),d=cs(d.length,c.rank)),a_.runKernelFunc(function(a,b){var e=a.argMin(c,d[0]);return b([c]),e},{$x:c},function(a,b){var c=b[0];return{$x:function(){return cP(c)}}})}}),iU=cv({logSumExp_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","logSumExp"),e=W(b,d.shape),f=d.max(e,!0),g=d.sub(f).exp().sum(e).log(),h=f.reshape(g.shape).add(g);if(c){var i=co(h.shape,e);return h.reshape(i)}return h}}),iV=cv({max_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","max"),e=d,f=W(b,d.shape),g=f,h=cq(g,d.rank);null!=h&&(d=d.transpose(h),g=cs(g.length,d.rank));var i=[d],j=a_.runKernelFunc(function(a,b){var c=a.max(d,g);return b([e,c]),c},{x:d},function(a,b){return iP(a,b[1],b[0],f,h)},"Max",{axes:g},i,[!0]);if(c){var k=co(j.shape,f);j=j.reshape(k)}return j}}),iW=cv({mean_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","mean"),e=W(b,d.shape),f=O(cn(d.shape,e)[1]);return dZ(function(a){var d=cB(f);return{value:(d.dtype===a.dtype?a:a.cast(d.dtype)).div(d).sum(b,c),gradFunc:function(b){var c=a.shape.slice();return e.forEach(function(a){c[a]=1}),b.reshape(c).mul(cJ(a.shape,"float32")).div(f)}}})(d)}}),iX=cv({min_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","min"),e=d,f=W(b,d.shape),g=f,h=cq(g,d.rank);null!=h&&(d=d.transpose(h),g=cs(g.length,d.rank));var i=[d],j=a_.runKernelFunc(function(a,b){var c=a.min(d,g);return b([e,c]),c},{x:d},function(a,b){return iP(a,b[1],b[0],f,h)},"Min",{axes:g},i,[!0]);if(c){var k=co(j.shape,f);j=j.reshape(k)}return j}}),iY=cv({moments_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=W(b,(a=cj(a,"x","moments")).shape),e=a.mean(d,c),f=e.shape;c||(f=co(e.shape,d));var g=a.toFloat().sub(e.reshape(f)).square();return{mean:e,variance:g.mean(d,c)}}}),iZ=cv({sum_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","sum");"bool"===d.dtype&&(d=d.toInt());var e=W(b,d.shape);return dZ(function(a){var b=cq(e,a.rank),d=e,f=a;null!=b&&(f=a.transpose(b),d=cs(d.length,a.rank));var g=function(b){var c=a.shape.slice();return e.forEach(function(a){c[a]=1}),b.reshape(c).mul(cJ(a.shape,"float32"))},h={axes:d},i=a_.runKernelFunc(function(a){return a.sum(f,d)},{x:f},function(a){return{x:function(){return g(a)}}},"Sum",h);if(c){var j=co(i.shape,e);i=i.reshape(j)}return{value:i,gradFunc:g}})(d)}}),i$=cv({prod_:function(a,b,c){void 0===b&&(b=null),void 0===c&&(c=!1);var d=cj(a,"x","prod");"bool"===d.dtype&&(d=d.toInt());var e=W(b,d.shape),f=cq(e,d.rank),g=e,h=d;null!=f&&(h=d.transpose(f),g=cs(g.length,d.rank));var i=a_.runKernelFunc(function(a){return a.prod(h,g)},{permutedX:h});if(c){var j=co(i.shape,e);i=i.reshape(j)}return i}}),i_=cv({elu_:function(a){var b=cj(a,"x","elu");return a_.runKernelFunc(function(a,c){var d=a.elu(b);return c([d]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){return a_.runKernelFunc(function(b){return b.eluDer(a,c)},{dy:a,y:c})}}})}}),i0=cv({leakyRelu_:function(a,b){void 0===b&&(b=.2);var c=cj(a,"x","leakyRelu");return hN(cB(b).mul(c),c)}}),i1=cv({prelu_:function(a,b){var c=cj(a,"x","prelu"),d=cj(b,"alpha","prelu");return a_.runKernelFunc(function(a,b){var e=a.prelu(c,d);return b([c,d]),e},{x:c,alpha:d},function(a,b){var c=b[0],d=b[1],e=c.greater(0);return{x:function(){return hD(e,a,a.mul(d))},alpha:function(){var b=hD(e,cP(a),a.mul(c)),f=d5(d.shape,a.shape);return f.length>0&&(b=b.sum(f)),b.reshape(d.shape)}}},"Prelu")}}),i2=cv({relu_:function(a){var b=cj(a,"x","relu");return"bool"===b.dtype?b.toInt():a_.runKernelFunc(function(a,c){var d=a.relu(b);return c([b]),d},{x:b},function(a,b){var c=b[0];return{x:function(){return a.mulStrict(c.step().toFloat())}}},"Relu")}}),i3=cv({relu6_:function(a){var b=cj(a,"x","relu6");return"bool"===b.dtype?b.toInt():a_.runKernelFunc(function(a,c){var d=a.relu6(b);return c([b]),d},{x:b},function(a,b){var c=b[0],d=c.lessEqual(6).mul(c.step());return{x:function(){return a.mulStrict(d.toFloat())}}},"Relu6")}}),i4=cv({selu_:function(a){var b=cj(a,"x","selu");return a_.runKernelFunc(function(a,c){var d=a.selu(b);return c([b]),d},{$x:b},function(a,b){var c=b[0];return{$x:function(){var b=c.greater(cB(0)),d=cB(1.7580993408473768),e=cB(1.0507009873554805);return hD(b,a.mul(e),a.mul(d).mul(c.toFloat().exp()))}}})}}),i5=cv({transpose_:function(a,b){var c=cj(a,"x","transpose");if(null==b&&(b=c.shape.map(function(a,b){return b}).reverse()),K(c.rank===b.length,function(){return"Error in transpose: rank of input "+c.rank+" must match length of perm "+b+"."}),b.forEach(function(a){K(a>=0&&a<c.rank,function(){return"All entries in 'perm' must be between 0 and "+(c.rank-1)+" but got "+b})}),c.rank<=1)return c.clone();var d={perm:b};return a_.runKernelFunc(function(a){return a.transpose(c,b)},{x:c},function(a){var c=cr(b);return{x:function(){return a.transpose(c)}}},"Transpose",d)}}),i6=cv({localResponseNormalization_:function(a,b,c,d,e){void 0===b&&(b=5),void 0===c&&(c=1),void 0===d&&(d=1),void 0===e&&(e=.5);var f=cj(a,"x","localResponseNormalization");K(4===f.rank||3===f.rank,function(){return"Error in localResponseNormalization: x must be rank 3 or 4 but got\n               rank "+f.rank+"."}),K(Q(b),function(){return"Error in localResponseNormalization: depthRadius must be an integer but got depthRadius "+b+"."});var g=f,h=!1;3===f.rank&&(h=!0,g=f.as4D(1,f.shape[0],f.shape[1],f.shape[2]));var i=a_.runKernelFunc(function(a,f){var h=a.localResponseNormalization4D(g,b,c,d,e);return f([g,h]),h},{x4D:g},function(a,f){var g=f[0],h=f[1];return{x4D:function(){return a_.runKernelFunc(function(f){return f.LRNGrad(a,g,h,b,c,d,e)},{})}}});return h?i.as3D(i.shape[1],i.shape[2],i.shape[3]):i}}),i7=cv({norm_:function(a,b,c,d){void 0===b&&(b="euclidean"),void 0===c&&(c=null),void 0===d&&(d=!1);var e=function a(b,c,d){if(void 0===d&&(d=null),0===b.rank)return b.abs();if(1!==b.rank&&null===d)return a(b.reshape([-1]),c,d);if(1===b.rank||"number"==typeof d||Array.isArray(d)&&1===d.length){if(1===c)return b.abs().sum(d);if(c===1/0)return b.abs().max(d);if(c===-1/0)return b.abs().min(d);if("euclidean"===c||2===c)return b.abs().pow(cB(2,"int32")).sum(d).sqrt();throw Error("Error in norm: invalid ord value: "+c)}if(Array.isArray(d)&&2===d.length){if(1===c)return b.abs().sum(d[0]).max(d[1]-1);if(c===1/0)return b.abs().sum(d[1]).max(d[0]);if(c===-1/0)return b.abs().sum(d[1]).min(d[0]);if("fro"===c||"euclidean"===c)return b.square().sum(d).sqrt();throw Error("Error in norm: invalid ord value: "+c)}throw Error("Error in norm: invalid axis: "+d)}(a=cj(a,"x","norm"),b,c),f=e.shape;if(d){var g=W(c,a.shape);f=co(e.shape,g)}return e.reshape(f)}}),i8=cv({basicLSTMCell_:function(a,b,c,d,e,f){var g=cj(a,"forgetBias","basicLSTMCell"),h=cj(b,"lstmKernel","basicLSTMCell"),i=cj(c,"lstmBias","basicLSTMCell"),j=cj(d,"data","basicLSTMCell"),k=cj(e,"c","basicLSTMCell"),l=cj(f,"h","basicLSTMCell"),m=j.concat(l,1).matMul(h).add(i),n=m.shape[0],o=m.shape[1]/4,p=[n,o],q=m.slice([0,0],p),r=m.slice([0,o],p),s=m.slice([0,2*o],p),t=m.slice([0,3*o],p),u=q.sigmoid().mulStrict(r.tanh()).addStrict(k.mulStrict(g.add(s).sigmoid())),v=u.tanh().mulStrict(t.sigmoid());return[u,v]}}),i9=cv({multiRNNCell_:function(a,b,c,d){for(var e=cj(b,"data","multiRNNCell"),f=ck(c,"c","multiRNNCell"),g=ck(d,"h","multiRNNCell"),h=e,i=[],j=0;j<a.length;j++){var k=a[j](h,f[j],g[j]);i.push(k[0]),i.push(k[1]),h=k[1]}var l=[],m=[];for(j=0;j<i.length;j+=2)l.push(i[j]),m.push(i[j+1]);return[l,m]}}),ja=cv({movingAverage_:function(a,b,c,d,e){void 0===e&&(e=!0);var f=cj(a,"v","movingAverage"),g=cj(b,"x","movingAverage"),h=cj(c,"decay","movingAverage");aQ(f,g),K(P(f.shape,g.shape),function(){return"Shape mismatch in v and x"});var i=cB(1),j=i.sub(h),k=g.sub(f).mul(j);if(e){K(null!=d,function(){return"When using zeroDebias: true, step is required."});var l=cj(d,"step","movingAverage");k=k.div(i.sub(hV(h,l)))}return f.add(k)}}),jb=cv({stridedSlice_:function(a,b,c,d,e,f,g,h,i){if(void 0===e&&(e=0),void 0===f&&(f=0),void 0===g&&(g=0),void 0===h&&(h=0),void 0===i&&(i=0),null==d&&(d=Array(b.length)),0!==g)throw Error("ellipsis mask is not yet supported");var j=cj(a,"x","stridedSlice"),k=dN(h),l=j.shape.slice();k.forEach(function(a){b[a]=0,c[a]=1,l.splice(a,0,1)}),j=j.reshape(l);for(var m=0;m<j.rank;m++)b[m]=dP(e,b,d,j.shape,m),c[m]=dQ(f,c,d,j.shape,m),d[m]=d[m]||1;var n=dN(i);n.forEach(function(a){c[a]=b[a]+1,d[a]=1});var o=dO(b,c,d),p=o.filter(function(a,b){return -1===n.indexOf(b)});return d.every(function(a){return 1===a})?iK(j,b,o).reshape(p):a_.runKernelFunc(function(a){return a.stridedSlice(j,b,c,d)},{$x:j}).reshape(p)}}),jc=cv({topk_:function(a,b,c){void 0===b&&(b=1),void 0===c&&(c=!0);var d=cj(a,"x","topk");if(0===d.rank)throw Error("topk() expects the input to be of rank 1 or higher");var e=d.shape[d.shape.length-1];if(b>e)throw Error("'k' passed to topk() must be <= the last dimension ("+e+") but got "+b);var f=a_.runKernelFunc(function(a){return a.topk(d,b,c)},{$x:d});return{values:f[0],indices:f[1]}}}),jd=cv({scatterND_:function(a,b,c){var d=cj(a,"indices","scatterND","int32"),e=cj(b,"updates","scatterND");return dJ(e,d,c),a_.runKernelFunc(function(a){return a.scatterND(d,e,c)},{indices:d,updates:e},null,"ScatterNd",{shape:c})}}),je=cv({fft_:function(a){K("complex64"===a.dtype,function(){return"The dtype for tf.spectral.fft() must be complex64 but got "+a.dtype+"."});var b=a.shape[a.shape.length-1],c=a.size/b,d=a.as2D(c,b);return a_.runKernelFunc(function(a){return a.fft(d)},{input:a}).reshape(a.shape)}}),jf=cv({ifft_:function(a){K("complex64"===a.dtype,function(){return"The dtype for tf.spectral.ifft() must be complex64 but got "+a.dtype+"."});var b=a.shape[a.shape.length-1],c=a.size/b,d=a.as2D(c,b);return a_.runKernelFunc(function(a){return a.ifft(d)},{input:a}).reshape(a.shape)}}),jg=cv({rfft_:function(a,b){K("float32"===a.dtype,function(){return"The dtype for rfft() must be real value but got "+a.dtype});var c,d=a.shape[a.shape.length-1],e=a.size/d;if(null!=b&&b<d){var f=a.shape.map(function(a){return 0}),g=a.shape.map(function(a){return a});g[a.shape.length-1]=b,c=a.slice(f,g),d=b}else if(null!=b&&b>d){var h=a.shape.map(function(a){return a});h[a.shape.length-1]=b-d,c=a.concat(cK(h),a.shape.length-1),d=b}else c=a;var i=c.zerosLike(),j=je(cw(c,i).as2D(e,d)),k=Math.floor(d/2)+1,l=cx(j),m=cy(j),n=l.split([k,d-k],l.shape.length-1),o=m.split([k,d-k],m.shape.length-1),p=c.shape.slice();return p[c.shape.length-1]=k,cw(n[0],o[0]).reshape(p)}}),jh=cv({irfft_:function(a){var b=a.shape[a.shape.length-1],c=a.size/b;if(b<=2){var d=a.as2D(c,b),e=jf(d);return cx(e)}var f=[c,2*(b-1)],g=cx(a).as2D(c,b),h=cy(a).as2D(c,b),i=g.slice([0,1],[c,b-2]).reverse(1),j=h.slice([0,1],[c,b-2]).reverse(1).mul(cB(-1));return cx(e=jf(d=cw(g.concat(i,1),h.concat(j,1)).as2D(f[0],f[1])))}}),ji=Object.freeze({fft:je,ifft:jf,rfft:jg,irfft:jh}),jj=cv({sparseToDense_:function(a,b,c,d){void 0===d&&(d=0);var e=cj(a,"sparseIndices","sparseToDense","int32"),f=cj(b,"sparseValues","sparseToDense"),g=cj(d,"defaultValue","sparseToDense",f.dtype);return function(a,b,c,d){if("int32"!==a.dtype)throw Error("tf.sparseToDense() expects the indices to be int32 type, but the dtype was "+a.dtype+".");if(a.rank>2)throw Error("sparseIndices should be a scalar, vector, or matrix, but got shape "+a.shape+".");var e=a.rank>0?a.shape[0]:1,f=a.rank>1?a.shape[1]:1;if(c.length!==f)throw Error("outputShape has incorrect number of elements:, "+c.length+", should be: "+f+".");var g=b.size;if(0!==b.rank&&(1!==b.rank||g!==e))throw Error("sparseValues has incorrect shape "+b.shape+", should be [] or ["+e+"]");if(b.dtype!==d.dtype)throw Error("sparseValues.dtype must match defaultValues.dtype")}(e,f,c,g),a_.runKernelFunc(function(a){return a.sparseToDense(e,f,c,g)},{$sparseIndices:e,$sparseValues:f,$defaultValue:g})}}),jk=cv({gatherND_:function(a,b){var c=cj(b,"indices","gatherND","int32"),d=cj(a,"x","gatherND");return a_.runKernelFunc(function(a){return a.gatherND(d,c)},{x:d,indices:c},null,"GatherNd")}}),jl=cv({diag_:function(a){var b=cj(a,"x","diag").flatten(),c=a.shape.concat(a.shape);return a_.runKernelFunc(function(a){return a.diag(b)},{$x:b}).reshape(c)}}),jm=cv({dropout_:function(a,b,c,d){var e=cj(a,"x","dropout");if(K("float32"===e.dtype,function(){return"x has to be a floating point tensor since it's going to be scaled, but got a "+e.dtype+" tensor instead."}),K(b>=0&&b<1,function(){return"rate must be a float in the range [0, 1), but got "+b+"."}),0===b)return a instanceof aF?e.clone():e;var f=function(a,b){if(null==b)return a.shape.slice();if(P(a.shape,b))return b;if(a.shape.length===b.length){for(var c=[],d=0;d<a.shape.length;d++)null==b[d]&&null!=a.shape[d]?c.push(a.shape[d]):c.push(b[d]);return c}return b}(e,c),g=1-b,h=dr(f,0,1,"float32",d).add(g).floor().div(g);return e.mul(h)}});function jn(a,b,c){for(var d=1-a%2,e=new Float32Array(a),f=0;f<a;++f){var g=2*Math.PI*f/(a+d-1);e[f]=b-c*Math.cos(g)}return cC(e,"float32")}var jo,jp=cv({hannWindow_:function(a){return jn(a,.5,.5)}}),jq=cv({hammingWindow_:function(a){return jn(a,.54,.46)}}),jr=cv({frame_:function(a,b,c,d,e){void 0===d&&(d=!1),void 0===e&&(e=0);for(var f=0,g=[];f+b<=a.size;)g.push(iK(a,f,b)),f+=c;if(d)for(;f<a.size;){var h=f+b-a.size,i=cQ([iK(a,f,b-h),cL([h],e)]);g.push(i),f+=c}return 0===g.length?cD([],[0,b]):cQ(g).as2D(g.length,b)}}),js=cv({stft_:function(a,b,c,d,e){void 0===e&&(e=jp),null==d&&(d=Math.floor(Math.pow(2,Math.ceil(Math.log(b)/Math.log(2)))));for(var f=jr(a,b,c),g=hT(f,e(b)),h=[],i=0;i<f.shape[0];i++)h.push(jg(g.slice([i,0],[1,b]),d));return cQ(h)}}),jt=Object.freeze({hannWindow:jp,hammingWindow:jq,frame:jr,stft:js}),ju=function(a,b,c){return void 0===c&&(c=1),s(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l,m,n,o,p,q;return t(this,function(r){switch(r.label){case 0:return d=cj(a,"predictions","inTopK"),e=cj(b,"targets","inTopK"),K(d.rank>1,function(){return"inTopK() expects the predictions to be of rank 2 or higher, but got "+d.rank}),K(d.rank-1===e.rank,function(){return"predictions rank should be 1 larger than targets rank, but got predictions rank "+d.rank+" and targets rank "+e.rank}),L(d.shape.slice(0,d.shape.length-1),e.shape,"predictions's shape should be align with the targets' shape, except the last dimension."),f=d.shape[d.shape.length-1],K(c>0&&c<=f,function(){return"'k' passed to inTopK() must be > 0 && <= the predictions last dimension ("+f+"), but got "+c}),[4,d.data()];case 1:return g=r.sent(),[4,e.data()];case 2:for(h=r.sent(),k=(i=[g.length/f,f])[1],l=Y("bool",j=i[0]),m=0;m<j;m++){for(n=m*k,o=g.subarray(n,n+k),p=[],q=0;q<o.length;q++)p.push({value:o[q],index:q});for(p.sort(function(a,b){return b.value-a.value}),l[m]=0,q=0;q<c;q++)if(p[q].index===h[m]){l[m]=1;break}}return a!==d&&d.dispose(),b!==e&&e.dispose(),[2,cz(l,e.shape,"bool")]}})})};(jU=jo||(jo={}))[jU.NONE=0]="NONE",jU[jU.MEAN=1]="MEAN",jU[jU.SUM=2]="SUM",jU[jU.SUM_BY_NONZERO_WEIGHTS=3]="SUM_BY_NONZERO_WEIGHTS";var jv=cv({absoluteDifference_:function(a,b,c,d){void 0===d&&(d=jo.SUM_BY_NONZERO_WEIGHTS);var e=cj(a,"labels","absoluteDifference"),f=cj(b,"predictions","absoluteDifference"),g=null;return null!=c&&(g=cj(c,"weights","absoluteDifference")),L(e.shape,f.shape,"Error in absoluteDifference: "),jw(e.sub(f).abs(),g,d)}}),jw=cv({computeWeightedLoss_:function(a,b,c){void 0===c&&(c=jo.SUM_BY_NONZERO_WEIGHTS);var d=cj(a,"losses","computeWeightedLoss"),e=null;null!=b&&(e=cj(b,"weights","computeWeightedLoss"));var f=null==e?d:d.mul(e);if(c===jo.NONE)return f;if(c===jo.SUM)return f.sum();if(c===jo.MEAN){if(null==e)return f.mean();var g=d.size/e.size,h=f.sum().div(e.sum());return g>1?h.div(cB(g)):h}if(c===jo.SUM_BY_NONZERO_WEIGHTS){if(null==e)return f.sum().div(cB(d.size));var i=e.mul(cJ(d.shape)).notEqual(cB(0)).sum().toFloat();return f.sum().div(i)}throw Error("Unknown reduction: "+c)}}),jx=cv({cosineDistance_:function(a,b,c,d,e){void 0===e&&(e=jo.SUM_BY_NONZERO_WEIGHTS);var f=cj(a,"labels","cosineDistance"),g=cj(b,"predictions","cosineDistance"),h=null;return null!=d&&(h=cj(d,"weights","cosineDistance")),L(f.shape,g.shape,"Error in cosineDistance: "),jw(cB(1).sub(f.mul(g).sum(c,!0)),h,e)}}),jy=cv({hingeLoss_:function(a,b,c,d){void 0===d&&(d=jo.SUM_BY_NONZERO_WEIGHTS);var e=cj(a,"labels","hingeLoss"),f=cj(b,"predictions","hingeLoss"),g=null;null!=c&&(g=cj(c,"weights","hingeLoss")),L(e.shape,f.shape,"Error in hingeLoss: ");var h=cB(1);return e=cB(2).mul(e).sub(h),jw(h.sub(e.mul(f)).relu(),g,d)}}),jz=cv({huberLoss_:function(a,b,c,d,e){void 0===d&&(d=1),void 0===e&&(e=jo.SUM_BY_NONZERO_WEIGHTS);var f=cj(a,"labels","huberLoss"),g=cj(b,"predictions","huberLoss"),h=null;null!=c&&(h=cj(c,"weights","huberLoss")),L(f.shape,g.shape,"Error in huberLoss: ");var i=cB(d),j=g.sub(f).abs(),k=hP(j,i),l=j.sub(k);return jw(cB(.5).mul(k.square()).add(i.mul(l)),h,e)}}),jA=cv({logLoss_:function(a,b,c,d,e){void 0===d&&(d=1e-7),void 0===e&&(e=jo.SUM_BY_NONZERO_WEIGHTS);var f=cj(a,"labels","logLoss"),g=cj(b,"predictions","logLoss"),h=null;null!=c&&(h=cj(c,"weights","logLoss")),L(f.shape,g.shape,"Error in logLoss: ");var i=cB(1),j=cB(d);return jw(f.mul(g.add(j).log()).neg().sub(i.sub(f).mul(i.sub(g).add(j).log())),h,e)}}),jB=cv({meanSquaredError_:function(a,b,c,d){void 0===d&&(d=jo.SUM_BY_NONZERO_WEIGHTS);var e=cj(a,"labels","meanSquaredError"),f=cj(b,"predictions","meanSquaredError"),g=null;return null!=c&&(g=cj(c,"weights","meanSquaredError")),L(e.shape,f.shape,"Error in meanSquaredError: "),jw(e.squaredDifference(f),g,d)}}),jC=cv({sigmoidCrossEntropy_:function(a,b,c,d,e){void 0===d&&(d=0),void 0===e&&(e=jo.SUM_BY_NONZERO_WEIGHTS);var f,g,h,i,j,k=cj(a,"multiClassLabels","sigmoidCrossEntropy"),l=cj(b,"logits","sigmoidCrossEntropy"),m=null;if(null!=c&&(m=cj(c,"weights","sigmoidCrossEntropy")),L(k.shape,l.shape,"Error in sigmoidCrossEntropy: "),d>0){var n=cB(d),o=cB(1),p=cB(.5);k=k.mul(o.sub(n)).add(p.mul(n))}return jw((f=cj(k,"labels","sigmoidCrossEntropyWithLogits"),g=cj(l,"logits","sigmoidCrossEntropyWithLogits"),L(f.shape,g.shape,"Error in sigmoidCrossEntropyWithLogits: "),h=g.relu(),i=g.mul(f),j=g.abs().neg().exp().log1p(),h.sub(i).add(j)),m,e)}}),jD=cv({softmaxCrossEntropy_:function(a,b,c,d,e){void 0===d&&(d=0),void 0===e&&(e=jo.SUM_BY_NONZERO_WEIGHTS);var f=cj(a,"onehotLabels","softmaxCrossEntropy"),g=cj(b,"logits","softmaxCrossEntropy"),h=null;if(null!=c&&(h=cj(c,"weights","softmaxCrossEntropy")),L(f.shape,g.shape,"Error in softmaxCrossEntropy: "),d>0){var i=cB(d),j=cB(1),k=cB(f.shape[1]);f=f.mul(j.sub(i)).add(i.div(k))}return jw(function(a,b,c){if(void 0===c&&(c=-1),-1===c&&(c=b.rank-1),c!==b.rank-1)throw Error("Softmax cross entropy along a non-last dimension is not yet supported. Labels / logits was rank "+b.rank+" and dim was "+c);return dZ(function(a,b,d){var e=b.logSumExp([c],!0),f=b.toFloat().sub(e);return d([a,f]),{value:f.mul(a).neg().sum([c]),gradFunc:function(a,b){var d=b[0],e=b[1],f=co(a.shape,[c]);return[a.reshape(f).mul(d.toFloat().sub(e.exp())),a.reshape(f).mul(e.exp().sub(d.toFloat()))]}}})(a,b)}(f,g),h,e)}}),jE=Object.freeze({get Reduction(){return jo},absoluteDifference:jv,computeWeightedLoss:jw,cosineDistance:jx,hingeLoss:jy,huberLoss:jz,logLoss:jA,meanSquaredError:jB,sigmoidCrossEntropy:jC,softmaxCrossEntropy:jD});function jF(a,b){return void 0===b&&(b=!1),a_.tidy(function(){if(2!==a.shape.length)throw Error("qr2d() requires a 2D Tensor, but got a "+a.shape.length+"D Tensor.");for(var c=a.shape[0],d=a.shape[1],e=df(c),f=a.clone(),g=cD([[1]],[1,1]),h=g.clone(),i=c>=d?d:c,j=function(a){var b,i=f,j=h,k=e;h=(b=a_.tidy(function(){var b=f.slice([a,a],[c-a,1]),i=b.norm(),j=f.slice([a,a],[1,1]),k=cD([[-1]]).where(j.greater(0),cD([[1]])),l=j.sub(k.mul(i)),m=b.div(l);h=1===m.shape[0]?g.clone():g.concat(m.slice([1,0],[m.shape[0]-1,m.shape[1]]),0);var n=k.matMul(l).div(i).neg(),o=f.slice([a,0],[c-a,d]),p=n.mul(h);if(0===a)f=o.sub(p.matMul(h.transpose().matMul(o)));else{var q=o.sub(p.matMul(h.transpose().matMul(o)));f=f.slice([0,0],[a,d]).concat(q,0)}var r=e.slice([0,a],[c,e.shape[1]-a]);if(0===a)e=r.sub(r.matMul(h).matMul(p.transpose()));else{var s=r.sub(r.matMul(h).matMul(p.transpose()));e=e.slice([0,0],[c,a]).concat(s,1)}return[h,f,e]}))[0],f=b[1],e=b[2],b4([i,j,k])},k=0;k<i;++k)j(k);return!b&&c>d&&(e=e.slice([0,0],[c,d]),f=f.slice([0,0],[d,d])),[e,f]})}var jG=Object.freeze({bandPart:cv({bandPart_:function(a,b,c){if(b%1!=0)throw Error("bandPart(): numLower must be an integer, got "+b+".");if(c%1!=0)throw Error("bandPart(): numUpper must be an integer, got "+c+".");var d=cj(a,"a","bandPart");if(d.rank<2)throw Error("bandPart(): Rank must be at least 2, got "+d.rank+".");var e=d.shape,f=d.shape.slice(-2),g=f[0],h=f[1];if(!(b<=g))throw Error("bandPart(): numLower ("+b+") must not be greater than the number of rows ("+g+").");if(!(c<=h))throw Error("bandPart(): numUpper ("+c+") must not be greater than the number of columns ("+h+").");b<0&&(b=g),c<0&&(c=h);var i=hY(cN(0,g,1,"int32").reshape([-1,1]),cN(0,h,1,"int32")),j=hz(i.lessEqual(cB(+b,"int32")),i.greaterEqual(cB(-c,"int32"))),k=cK([g,h],d.dtype);return dv(dy(d.reshape([-1,g,h])).map(function(a){return hD(j,a,k)})).reshape(e)}}),gramSchmidt:cv({gramSchmidt_:function(a){if(Array.isArray(a)){b=!1,K(null!=a&&a.length>0,function(){return"Gram-Schmidt process: input must not be null, undefined, or empty"});for(var b,c=a[0].shape[0],d=function(b){K(a[b].shape[0]===c,function(){return"Gram-Schmidt: Non-unique lengths found in the input vectors: ("+a[b].shape[0]+" vs. "+c+")"})},e=1;e<a.length;++e)d(e)}else b=!0,a=cV(a,a.shape[0],0).map(function(a){return du(a,[0])});K(a.length<=a[0].shape[0],function(){return"Gram-Schmidt: Number of vectors ("+a.length+") exceeds number of dimensions ("+a[0].shape[0]+")."});var f=[],g=a,h=function(a){f.push(a_.tidy(function(){var b=g[a];if(a>0)for(var c=0;c<a;++c){var d=iZ(f[c].mulStrict(b)).mul(f[c]);b=b.sub(d)}return b.div(i7(b,"euclidean"))}))};for(e=0;e<a.length;++e)h(e);return b?dv(f,0):f}}),qr:cv({qr_:function(a,b){if(void 0===b&&(b=!1),a.rank<2)throw Error("qr() requires input tensor to have a rank >= 2, but got rank "+a.rank);if(2===a.rank)return jF(a,b);var c=a.shape.slice(0,a.shape.length-2).reduce(function(a,b){return a*b}),d=dy(a.reshape([c,a.shape[a.shape.length-2],a.shape[a.shape.length-1]]),0),e=[],f=[];return d.forEach(function(a){var c=jF(a,b),d=c[0],g=c[1];e.push(d),f.push(g)}),[dv(e,0).reshape(a.shape),dv(f,0).reshape(a.shape)]}})});function jH(a,b,c,d,e,f){null==d&&(d=.5),null==e&&(e=-1/0),null==f&&(f=0);var g=a.shape[0];return c=Math.min(c,g),K(0<=d&&d<=1,function(){return"iouThreshold must be in [0, 1], but was '"+d+"'"}),K(2===a.rank,function(){return"boxes must be a 2D tensor, but was of rank '"+a.rank+"'"}),K(4===a.shape[1],function(){return"boxes must have 4 columns, but 2nd dimension was "+a.shape[1]}),K(1===b.rank,function(){return"scores must be a 1D tensor"}),K(b.shape[0]===g,function(){return"scores has incompatible shape with boxes. Expected "+g+", but was "+b.shape[0]}),K(0<=f&&f<=1,function(){return"softNmsSigma must be in [0, 1], but was '"+f+"'"}),{maxOutputSize:c,iouThreshold:d,scoreThreshold:e,softNmsSigma:f}}var jI=Object.freeze({resizeBilinear:cv({resizeBilinear_:function(a,b,c){void 0===c&&(c=!1);var d=cj(a,"images","resizeBilinear");K(3===d.rank||4===d.rank,function(){return"Error in resizeBilinear: x must be rank 3 or 4, but got rank "+d.rank+"."}),K(2===b.length,function(){return"Error in resizeBilinear: new shape must 2D, but got shape "+b+"."});var e=d,f=!1;3===d.rank&&(f=!0,e=d.as4D(1,d.shape[0],d.shape[1],d.shape[2]));var g=b[0],h=b[1],i=a_.runKernelFunc(function(a,b){return b([e]),a.resizeBilinear(e,g,h,c)},{x:e},function(a,b){return{x:function(){return a_.runKernelFunc(function(d){return d.resizeBilinearBackprop(a,b[0],c)},{})}}},"ResizeBilinear",{alignCorners:c,newHeight:g,newWidth:h});return f?i.as3D(i.shape[1],i.shape[2],i.shape[3]):i}}),resizeNearestNeighbor:cv({resizeNearestNeighbor_:function(a,b,c){void 0===c&&(c=!1);var d=cj(a,"images","resizeNearestNeighbor");K(3===d.rank||4===d.rank,function(){return"Error in resizeNearestNeighbor: x must be rank 3 or 4, but got rank "+d.rank+"."}),K(2===b.length,function(){return"Error in resizeNearestNeighbor: new shape must 2D, but got shape "+b+"."}),K("float32"===d.dtype||"int32"===d.dtype,function(){return"`images` must have `int32` or `float32` as dtype"});var e=d,f=!1;3===d.rank&&(f=!0,e=d.as4D(1,d.shape[0],d.shape[1],d.shape[2]));var g=b[0],h=b[1],i=a_.runKernelFunc(function(a,b){return b([e]),a.resizeNearestNeighbor(e,g,h,c)},{batchImages:e},function(a,b){return{batchImages:function(){return a_.runKernelFunc(function(d){return d.resizeNearestNeighborBackprop(a,b[0],c)},{})}}});return f?i.as3D(i.shape[1],i.shape[2],i.shape[3]):i}}),nonMaxSuppression:cv({nonMaxSuppression_:function(a,b,c,d,e){void 0===d&&(d=.5),void 0===e&&(e=-1/0);var f=cj(a,"boxes","nonMaxSuppression"),g=cj(b,"scores","nonMaxSuppression"),h=jH(f,g,c,d,e);c=h.maxOutputSize,d=h.iouThreshold,e=h.scoreThreshold;var i={maxOutputSize:c,iouThreshold:d,scoreThreshold:e};return a_.runKernelFunc(function(a){return a.nonMaxSuppression(f,g,c,d,e)},{boxes:f,scores:g},null,"NonMaxSuppressionV3",i)}}),nonMaxSuppressionAsync:function(a,b,c,d,e){return void 0===d&&(d=.5),void 0===e&&(e=-1/0),s(this,void 0,void 0,function(){var f,g,h,i,j;return t(this,function(k){switch(k.label){case 0:return f=cj(a,"boxes","nonMaxSuppressionAsync"),g=cj(b,"scores","nonMaxSuppressionAsync"),c=(h=jH(f,g,c,d,e)).maxOutputSize,d=h.iouThreshold,e=h.scoreThreshold,[4,Promise.all([f.data(),g.data()])];case 1:return j=eq((i=k.sent())[0],i[1],c,d,e),f!==a&&f.dispose(),g!==b&&g.dispose(),[2,j]}})})},nonMaxSuppressionWithScore:cv({nonMaxSuppressionWithScore_:function(a,b,c,d,e,f){void 0===d&&(d=.5),void 0===e&&(e=-1/0),void 0===f&&(f=0);var g=cj(a,"boxes","nonMaxSuppression"),h=cj(b,"scores","nonMaxSuppression"),i=jH(g,h,c,d,e,f),j={maxOutputSize:c=i.maxOutputSize,iouThreshold:d=i.iouThreshold,scoreThreshold:e=i.scoreThreshold,softNmsSigma:f=i.softNmsSigma},k=a_.runKernel("NonMaxSuppressionV5",{boxes:g,scores:h},j);return{selectedIndices:k[0],selectedScores:k[1]}}}),nonMaxSuppressionWithScoreAsync:function(a,b,c,d,e,f){return void 0===d&&(d=.5),void 0===e&&(e=-1/0),void 0===f&&(f=0),s(this,void 0,void 0,function(){var g,h,i,j,k;return t(this,function(l){switch(l.label){case 0:return g=cj(a,"boxes","nonMaxSuppressionAsync"),h=cj(b,"scores","nonMaxSuppressionAsync"),c=(i=jH(g,h,c,d,e,f)).maxOutputSize,d=i.iouThreshold,e=i.scoreThreshold,f=i.softNmsSigma,[4,Promise.all([g.data(),h.data()])];case 1:return k=er((j=l.sent())[0],j[1],c,d,e,f),g!==a&&g.dispose(),h!==b&&h.dispose(),[2,k]}})})},cropAndResize:cv({cropAndResize_:function(a,b,c,d,e,f){var g=cj(a,"image","cropAndResize"),h=cj(b,"boxes","cropAndResize","float32"),i=cj(c,"boxInd","cropAndResize","int32");e=e||"bilinear",f=f||0;var j=h.shape[0];return K(4===g.rank,function(){return"Error in cropAndResize: image must be rank 4,but got rank "+g.rank+"."}),K(2===h.rank&&4===h.shape[1],function(){return"Error in cropAndResize: boxes must be have size ["+j+",4] but had shape "+h.shape+"."}),K(1===i.rank&&i.shape[0]===j,function(){return"Error in cropAndResize: boxInd must be have size ["+j+"] but had shape "+h.shape+"."}),K(2===d.length,function(){return"Error in cropAndResize: cropSize must be of length 2, but got length "+d.length+"."}),K(d[0]>=1&&d[1]>=1,function(){return"cropSize must be atleast [1,1], but was "+d}),K("bilinear"===e||"nearest"===e,function(){return"method must be bilinear or nearest, but was "+e}),a_.runKernelFunc(function(a,b){return a.cropAndResize(g,h,i,d,e,f)},{images:g,boxes:h,boxInd:i},null,"CropAndResize",{method:e,extrapolationValue:f,cropSize:d})}})}),jJ=function(a,b){return!(a>0)||"linear"===b},jK=function(a,b,c){if(null==c||"linear"===c)return a;if("relu"===c)return a.mul(b.step());throw Error("Gradient for activation "+c+" has not been implemented yet.")},jL=function(a,b){var c=b,d=d5(a.shape,b.shape);return d.length>0&&(c=c.sum(d)),c.reshape(a.shape)},jM=function(a,b,c){if("linear"===b)return a;if("relu"===b)return i2(a);if("elu"===b)return i_(a);if("relu6"===b)return i3(a);if("prelu"===b)return i1(a,c);throw Error("Unknown fused activation "+b+".")},jN=Object.freeze({matMul:cv({fusedMatMul_:function(a){var b,c=a.a,d=a.b,e=a.transposeA,f=void 0!==e&&e,g=a.transposeB,h=void 0!==g&&g,i=a.bias,j=a.activation,k=void 0===j?"linear":j,l=a.preluActivationWeights;if(!1===jJ(a_.state.gradientDepth,k)){var m=iv(c,d,f,h);return null!=i&&(m=hF(m,i)),jM(m,k,l)}var n=cj(c,"a","fused matMul"),o=cj(d,"b","fused matMul");n=(b=aP(n,o))[0],o=b[1];var p=f?n.shape[n.rank-2]:n.shape[n.rank-1],q=h?o.shape[o.rank-1]:o.shape[o.rank-2],r=f?n.shape[n.rank-1]:n.shape[n.rank-2],s=h?o.shape[o.rank-2]:o.shape[o.rank-1],t=n.shape.slice(0,-2),u=o.shape.slice(0,-2),v=O(t),w=O(u);K(n.rank>=2&&o.rank>=2&&n.rank===o.rank,function(){return"Error in fused matMul: inputs must have the same rank of at least 2, got ranks "+n.rank+" and "+o.rank+"."}),K(P(t,u),function(){return"Error in fused matMul: outer dimensions ("+t+") and ("+u+") of Tensors with shapes "+n.shape+" and "+o.shape+" must match."}),K(p===q,function(){return"Error in fused matMul: inner shapes ("+p+") and ("+q+") of Tensors with shapes "+n.shape+" and "+o.shape+" and transposeA="+f+" and transposeB="+h+" must match."});var x,y,z=n.shape.slice(0,-2).concat([r,s]),A=f?n.as3D(v,p,r):n.as3D(v,r,p),B=h?o.as3D(w,s,q):o.as3D(w,q,s);null!=i&&d6(z,(x=aP(x=cj(i,"bias","fused matMul"),n)[0]).shape),null!=l&&(y=cj(l,"prelu weights","fused matMul"));var C={a:A,b:B};null!=i&&(C.bias=x),null!=l&&(C.preluActivationWeights=y);var D=[A,B];return a_.runKernelFunc(function(a,b){var c=a.fusedBatchMatMul({a:A,b:B,transposeA:f,transposeB:h,bias:x,activation:k,preluActivationWeights:y});return b([A,B,c]),c},C,function(a,b){var c=b[0],d=b[1],e=jK(a,b[2],k),g={};return null!=i&&(g={bias:function(){return jL(x,e)}}),f||h?!f&&h?Object.assign({a:function(){return e.matMul(d,!1,!1)},b:function(){return e.matMul(c,!0,!1)}},g):f&&!h?Object.assign({a:function(){return d.matMul(e,!1,!0)},b:function(){return c.matMul(e,!1,!1)}},g):Object.assign({a:function(){return d.matMul(e,!0,!0)},b:function(){return e.matMul(c,!0,!0)}},g):Object.assign({a:function(){return e.matMul(d,!1,!0)},b:function(){return c.matMul(e,!0,!1)}},g)},"_FusedMatMul",{transposeA:f,transposeB:h,activation:k},D,[!0]).reshape(z)}}),conv2d:cv({fusedConv2d_:function(a){var b=a.x,c=a.filter,d=a.strides,e=a.pad,f=a.dataFormat,g=void 0===f?"NHWC":f,h=a.dilations,i=void 0===h?[1,1]:h,j=a.dimRoundingMode,k=a.bias,l=a.activation,m=void 0===l?"linear":l,n=a.preluActivationWeights;if(m=m||"linear",!1===jJ(a_.state.gradientDepth,m)){var o=ik(b,c,d,e,g,i,j);return null!=k&&(o=hF(o,k)),jM(o,m,n)}var p=cj(b,"x","conv2d"),q=cj(c,"filter","conv2d"),r=p,s=!1;3===p.rank&&(s=!0,r=p.as4D(1,p.shape[0],p.shape[1],p.shape[2])),K(4===r.rank,function(){return"Error in fused conv2d: input must be rank 4, but got rank "+r.rank+"."}),K(4===q.rank,function(){return"Error in fused conv2d: filter must be rank 4, but got rank "+q.rank+"."}),null!=j&&K(Q(e),function(){return"Error in fused conv2d: pad must be an integer when using, dimRoundingMode "+j+" but got pad "+e+"."}),K(r.shape[3]===q.shape[2],function(){return"Error in conv2d: depth of input ("+r.shape[3]+") must match input depth for filter "+q.shape[2]+"."}),K(eh(d,i),function(){return"Error in conv2D: Either strides or dilations must be 1. Got strides "+d+" and dilations '"+i+"'"}),K("NHWC"===g,function(){return"Error in conv2d: got dataFormat of "+g+" but only NHWC is currently supported."});var t,u,v=d9(r.shape,q.shape,d,i,e,j);null!=k&&(t=aP(t=cj(k,"bias","fused conv2d"),p)[0],d6(v.outShape,t.shape)),null!=n&&(u=cj(n,"prelu weights","fused conv2d"));var w={x:r,filter:q};null!=k&&(w.bias=t),null!=n&&(w.preluActivationWeights=u);var x=[q,r],y=a_.runKernelFunc(function(a,b){var c=a.fusedConv2d({input:r,filter:q,convInfo:v,bias:t,activation:m,preluActivationWeights:u});return b([q,r,c]),c},w,function(a,b){var c=b[0],f=b[1],g=jK(a,b[2],m);K(eg(i),function(){return"Error in gradient of fused conv2D: dilation rates greater than 1 are not yet supported in gradients. Got dilations '"+i+"'"});var h={};return null!=k&&(h={bias:function(){return jL(t,g)}}),Object.assign({x:function(){return io(f.shape,g,c,d,e)},filter:function(){return im(f,g,c.shape,d,e)}},h)},"FusedConv2D",{convInfo:v,activation:m},x,[!0]);return s?y.as3D(y.shape[1],y.shape[2],y.shape[3]):y}}),depthwiseConv2d:cv({fusedDepthwiseConv2d_:function(a){var b=a.x,c=a.filter,d=a.strides,e=a.pad,f=a.dataFormat,g=a.dilations,h=void 0===g?[1,1]:g,i=a.dimRoundingMode,j=a.bias,k=a.activation,l=void 0===k?"linear":k,m=a.preluActivationWeights;if(!1===jJ(a_.state.gradientDepth,l)){var n=ip(b,c,d,e,void 0===f?"NHWC":f,h,i);return null!=j&&(n=hF(n,j)),jM(n,l,m)}var o=cj(b,"x","depthwiseConv2d"),p=cj(c,"filter","depthwiseConv2d"),q=o,r=!1;3===o.rank&&(r=!0,q=o.as4D(1,o.shape[0],o.shape[1],o.shape[2])),K(4===q.rank,function(){return"Error in fused depthwiseConv2d: input must be rank 4, but got rank "+q.rank+"."}),K(4===p.rank,function(){return"Error in fused depthwiseConv2d: filter must be rank 4, but got rank "+p.rank+"."}),K(q.shape[3]===p.shape[2],function(){return"Error in fused depthwiseConv2d: number of input channels ("+q.shape[3]+") must match the inChannels dimension in filter "+p.shape[2]+"."}),null==h&&(h=[1,1]),K(eh(d,h),function(){return"Error in fused depthwiseConv2d: Either strides or dilations must be 1. Got strides "+d+" and dilations '"+h+"'"}),null!=i&&K(Q(e),function(){return"Error in fused depthwiseConv2d: pad must be an integer when using dimRoundingMode "+i+" but got pad "+e+"."});var s,t,u=d9(q.shape,p.shape,d,h,e,i,!0);null!=j&&(s=aP(s=cj(j,"bias","fused conv2d"),o)[0],d6(u.outShape,s.shape)),null!=m&&(t=cj(m,"prelu weights","fused depthwiseConv2d"));var v={x:q,filter:p};null!=j&&(v.bias=s),null!=m&&(v.preluActivationWeights=t);var w=[p,q],x=a_.runKernelFunc(function(a,b){var c=a.fusedDepthwiseConv2D({input:q,filter:p,convInfo:u,bias:s,activation:l,preluActivationWeights:t});return b([p,q,c]),c},v,function(a,b){K(eg(h),function(){return"Error in gradient of fused depthwiseConv2d: dilation rates greater than 1 are not yet supported. Got dilations '"+h+"'"});var c=b[0],d=b[1],e=jK(a,b[2],l),f={};return null!=j&&(f={bias:function(){return jL(s,e)}}),Object.assign({x:function(){return iq(d.shape,e,c,u)},filter:function(){return ir(d,e,c.shape,u)}},f)},"FusedDepthwiseConv2D",{convInfo:u,activation:l},w,[!0]);return r?x.as3D(x.shape[1],x.shape[2],x.shape[3]):x}})}),jO=Object.freeze({image:jI,linalg:jG,losses:jE,spectral:ji,fused:jN,signal:jt,square:gM,squaredDifference:gO,conv1d:ij,conv2d:ik,conv3d:il,depthwiseConv2d:ip,separableConv2d:is,conv2dTranspose:it,conv3dTranspose:iu,op:cv,batchNormalization2d:hr,batchNormalization3d:hs,batchNormalization4d:ht,batchNormalization:hu,batchNorm:hv,batchNorm2d:hw,batchNorm3d:hx,batchNorm4d:hy,booleanMaskAsync:ie,complex:cw,real:cx,imag:cy,concat:cQ,concat1d:cR,concat2d:cS,concat3d:cT,concat4d:cU,split:cV,matMul:iv,dot:iw,outerProduct:ix,reverse:iy,reverse1d:iz,reverse2d:iA,reverse3d:iB,reverse4d:iC,maxPool:iF,avgPool:iG,pool:iH,maxPool3d:iI,avgPool3d:iJ,slice:iK,slice1d:iL,slice2d:iM,slice3d:iN,slice4d:iO,abs:gP,acos:gQ,acosh:gR,asin:gS,asinh:gT,atan:gU,atanh:gV,ceil:gW,clipByValue:gX,cos:gY,cosh:gZ,erf:g$,exp:g_,expm1:g0,floor:g1,log:g2,log1p:g3,logSigmoid:g4,neg:g5,reciprocal:g6,round:g7,rsqrt:g8,sigmoid:g9,sign:ha,isNaN:hb,isInf:hc,isFinite:hd,sin:he,sinh:hf,softplus:hg,sqrt:hh,step:hi,tan:hj,tanh:hk,all:iQ,any:iR,argMax:iS,argMin:iT,logSumExp:iU,max:iV,mean:iW,min:iX,moments:iY,sum:iZ,prod:i$,equal:h$,equalStrict:h_,greater:h0,greaterEqual:h1,greaterEqualStrict:h2,greaterStrict:h3,less:h4,lessEqual:h5,lessEqualStrict:h6,lessStrict:h7,notEqual:h8,notEqualStrict:h9,add:hF,addN:hG,addStrict:hH,atan2:hI,div:hJ,divNoNan:hK,divStrict:hL,floorDiv:hM,maximum:hN,maximumStrict:hO,minimum:hP,minimumStrict:hQ,mod:hR,modStrict:hS,mul:hT,mulStrict:hU,pow:hV,powStrict:hW,squaredDifferenceStrict:hX,sub:hY,subStrict:hZ,elu:i_,leakyRelu:i0,prelu:i1,relu:i2,relu6:i3,selu:i4,logicalAnd:hz,logicalNot:hA,logicalOr:hB,logicalXor:hC,where:hD,whereAsync:hE,buffer:c6,print:c7,batchToSpaceND:c8,broadcastTo:c9,cast:da,clone:db,cumsum:dc,depthToSpace:dd,expandDims:de,eye:df,multinomial:dg,oneHot:dh,pad:di,pad1d:dj,pad2d:dk,pad3d:dl,pad4d:dm,rand:dn,randomNormal:dp,randomGamma:dq,randomUniform:dr,reshape:ds,spaceToBatchND:dt,squeeze:du,stack:dv,tile:dw,truncatedNormal:dx,unstack:dy,setdiff1dAsync:dz,fill:cL,linspace:cM,ones:cJ,range:cN,scalar:cB,tensor:cz,tensor1d:cC,tensor2d:cD,tensor3d:cE,tensor4d:cF,tensor5d:cG,tensor6d:cH,variable:cI,zeros:cK,onesLike:cO,zerosLike:cP,transpose:i5,softmax:d_,logSoftmax:d0,localResponseNormalization:i6,norm:i7,gather:ic,unsortedSegmentSum:id,basicLSTMCell:i8,multiRNNCell:i9,movingAverage:ja,stridedSlice:jb,topk:jc,scatterND:jd,fft:je,ifft:jf,rfft:jg,irfft:jh,sparseToDense:jj,gatherND:jk,diag:jl,dropout:jm,hannWindow:jp,hammingWindow:jq,frame:jr,stft:js,inTopKAsync:ju});function jP(a,b){Array.isArray(a)||(a=[a]),a.forEach(function(a){null!=a&&K("complex64"!==a.dtype,function(){return b+" does not support complex64 tensors."})})}function jQ(a,b,c,d){if("linear"===c)return a.linear(b);if("relu"===c)return a.relu(b);if("elu"===c)return a.elu(b);if("relu6"===c)return a.relu6(b);if("prelu"===c)return a.prelu(b,d);throw Error("Activation "+c+" has not been implemented for the CPU backend.")}var jR=function(a){function b(){var b=a.call(this)||this;return b.blockSize=48,b.firstUse=!0,b.data=new d1(b,a_),b}return r(b,a),b.prototype.write=function(a,b,c){this.firstUse&&(this.firstUse=!1,w.get("IS_NODE")&&cg("\n============================\nHi there . Looks like you are running TensorFlow.js in Node.js. To speed things up dramatically, install our node backend, which binds to TensorFlow C++, by running npm i @tensorflow/tfjs-node, or npm i @tensorflow/tfjs-node-gpu if you have CUDA. Then call require('@tensorflow/tfjs-node'); (-gpu suffix for CUDA) at the start of your program. Visit https://github.com/tensorflow/tfjs-node for more details.\n============================"));var d={};return this.data.set(d,{values:a,dtype:c}),d},b.prototype.move=function(a,b,c,d){this.data.set(a,{values:b,dtype:d})},b.prototype.numDataIds=function(){return this.data.numDataIds()},b.prototype.read=function(a){return s(this,void 0,void 0,function(){return t(this,function(b){return[2,this.readSync(a)]})})},b.prototype.readSync=function(a){var b=this.data.get(a),c=b.dtype,d=b.complexTensors;return"complex64"===c?en(this.readSync(d.real.dataId),this.readSync(d.imag.dataId)):this.data.get(a).values},b.prototype.bufferSync=function(a){var b=this.readSync(a.dataId),c=b;if("string"===a.dtype)try{c=b.map(function(a){return as(a)})}catch(a){throw Error("Failed to decode encoded string bytes into utf-8")}return c6(a.shape,a.dtype,c)},b.prototype.makeOutput=function(a,b,c){var d=this.write(a,b,c);return a_.makeTensorFromDataId(d,b,c,this)},b.prototype.disposeData=function(a){if(this.data.has(a)){var b=this.data.get(a).complexTensors;null!=b&&(b.real.dispose(),b.imag.dispose()),this.data.delete(a)}},b.prototype.time=function(a){return s(this,void 0,void 0,function(){var b;return t(this,function(c){return b=ap(),a(),[2,{kernelMs:ap()-b}]})})},b.prototype.memory=function(){return{unreliable:!0,reasons:["The reported memory is an upper bound. Due to automatic garbage collection, the true allocated memory may be less."]}},b.prototype.complex=function(a,b){var c=this.makeOutput(null,a.shape,"complex64");return this.data.get(c.dataId).complexTensors={real:a_.keep(a.clone()),imag:a_.keep(b.clone())},c},b.prototype.real=function(a){return this.data.get(a.dataId).complexTensors.real.clone()},b.prototype.imag=function(a){return this.data.get(a.dataId).complexTensors.imag.clone()},b.prototype.slice=function(a,b,c){if(jP(a,"slice"),dR(a.shape,b,c)){var d=dS(b,a.strides),e=O(c);return cz(this.readSync(a.dataId).subarray(d,d+e),c,a.dtype)}for(var f=c6(c,a.dtype),g=this.bufferSync(a),h=0;h<f.size;++h){var i=f.indexToLoc(h).map(function(a,c){return a+b[c]});f.values[h]=g.get.apply(g,i)}return f.toTensor()},b.prototype.stridedSlice=function(a,b,c,d){jP(a,"stridedSlice");var e=dO(b,c,d);if(e.some(function(a){return 0===a}))return cz([],e);for(var f=c6(e,a.dtype),g=this.bufferSync(a),h=0;h<f.size;h++){for(var i=f.indexToLoc(h),j=Array(i.length),k=0;k<j.length;k++)j[k]=i[k]*d[k]+b[k];f.set.apply(f,[g.get.apply(g,j)].concat(i))}return f.toTensor()},b.prototype.diag=function(a){for(var b=this.readSync(a.dataId),c=c6([a.size,a.size],a.dtype),d=c.values,e=0;e<b.length;e++)d[e*a.size+e]=b[e];return c.toTensor()},b.prototype.unstack=function(a,b){for(var c=a.shape[b],d=Array(a.rank-1),e=0,f=0;f<a.rank;f++)f!==b&&(d[e++]=a.shape[f]);var g=Array(a.rank).fill(0),h=a.shape.slice();h[b]=1;var i=Array(c);for(f=0;f<i.length;f++)g[b]=f,i[f]=this.slice(a,g,h).reshape(d);return i},b.prototype.reverse=function(a,b){jP(a,"reverse");for(var c=c6(a.shape,a.dtype),d=this.bufferSync(a),e=0;e<c.size;e++)!function(e){var f=c.indexToLoc(e),g=f.slice();b.forEach(function(b){return g[b]=a.shape[b]-1-g[b]}),c.set.apply(c,[d.get.apply(d,g)].concat(f))}(e);return c.toTensor()},b.prototype.concat=function(a,b){var c=this;if("complex64"===a[0].dtype){var d=a.map(function(a){return cx(a)}),e=a.map(function(a){return cy(a)});return cw(this.concat(d,b),this.concat(e,b))}var f=a.map(function(a){var c=O(a.shape.slice(b));return a.as2D(-1,c)}),g=cu(f.map(function(a){return a.shape}),1),h=c6(g,a[0].dtype).values;if(1===f[0].shape[0]){var i=0;f.forEach(function(a){h.set(c.readSync(a.dataId),i),i+=a.size})}else{var j=0;f.forEach(function(a){for(var b=c.readSync(a.dataId),d=0,e=0;e<a.shape[0];++e)for(var f=e*g[1]+j,i=0;i<a.shape[1];++i)h[f+i]=b[d++];j+=a.shape[1]})}return cz(h,cu(a.map(function(a){return a.shape}),b),a[0].dtype)},b.prototype.neg=function(a){return jP(a,"neg"),this.multiply(cB(-1),a)},b.prototype.add=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(a,b,c,d){return{real:a+c,imag:b+d}}):this.broadcastedBinaryOp(a,b,aN(a.dtype,b.dtype),function(a,b){return a+b})},b.prototype.addN=function(a){var b=this;jP(a,"addN");for(var c=a.map(function(a){return b.readSync(a.dataId)}),d=c6(a[0].shape,a[0].dtype),e=d.values,f=0;f<a.length;f++)for(var g=c[f],h=0;h<e.length;h++)e[h]+=g[h];return d.toTensor()},b.prototype.softmax=function(a,b){var c=W([b],a.shape),d=this.max(a,c),e=co(d.shape,c),f=this.subtract(a,d.reshape(e)),g=this.exp(f),h=this.sum(g,c).reshape(e);return this.realDivide(g,h)},b.prototype.subtract=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(a,b,c,d){return{real:a-c,imag:b-d}}):this.broadcastedBinaryOp(a,b,aN(a.dtype,b.dtype),function(a,b){return a-b})},b.prototype.pow=function(a,b){return jP([a,b],"pow"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.pow(a,b)})},b.prototype.batchMatMul=function(a,b,c,d){jP([a,b],"matMul");for(var e=c?a.shape[1]:a.shape[2],f=c?a.shape[2]:a.shape[1],g=d?b.shape[1]:b.shape[2],h=a.shape[0],i=this.readSync(a.dataId),j=this.readSync(b.dataId),k=c?[a.strides[0],1,a.strides[1]]:[a.strides[0],a.strides[1],1],l=k[0],m=k[1],n=k[2],o=d?[1,b.strides[1],b.strides[0]]:[b.strides[1],1,b.strides[0]],p=o[0],q=o[1],r=o[2],s=f*g,t=c6([h,f,g],a.dtype),u=t.values,v=this.blockSize,w=0;w<h;w++)for(var x=0;x<f;x+=v)for(var y=0;y<g;y+=v)for(var z=0;z<e;z+=v)for(var A=Math.min(x+v,f),B=Math.min(y+v,g),C=Math.min(z+v,e),D=x;D<A;D++)for(var E=y;E<B;E++){for(var F=0,G=z;G<C;G++)F+=i[w*l+D*m+G*n]*j[G*p+E*q+w*r];u[w*s+(D*g+E)]+=F}return t.toTensor()},b.prototype.fusedBatchMatMul=function(a){var b=a.a,c=a.b,d=a.transposeA,e=a.transposeB,f=a.bias,g=a.activation,h=a.preluActivationWeights,i=this.batchMatMul(b,c,d,e);return f&&(i=this.add(i,f)),g&&(i=jQ(this,i,g,h)),i},b.prototype.multiply=function(a,b){return"complex64"===a.dtype||"complex64"===b.dtype?this.broadcastedBinaryComplexOp(a.cast("complex64"),b.cast("complex64"),function(a,b,c,d){return{real:a*c-b*d,imag:a*d+b*c}}):this.broadcastedBinaryOp(a,b,aN(a.dtype,b.dtype),function(a,b){return a*b})},b.prototype.realDivide=function(a,b){return jP([a,b],"realDivide"),this.broadcastedBinaryOp(a,b,"float32",function(a,b){return a/b})},b.prototype.floorDiv=function(a,b){return jP([a,b],"floorDiv"),this.broadcastedBinaryOp(a,b,"int32",function(a,b){return Math.floor(a/b)})},b.prototype.sum=function(a,b){jP(a,"sum"),cp("sum",b,a.rank);for(var c=cn(a.shape,b),d=c[0],e=c[1],f=cK(d,aN(a.dtype,"int32")),g=O(e),h=this.readSync(f.dataId),i=this.readSync(a.dataId),j=0;j<h.length;++j){for(var k=j*g,l=0,m=0;m<g;++m)l+=i[k+m];h[j]=l}return f},b.prototype.prod=function(a,b){jP(a,"sum");for(var c=cn(a.shape,b),d=c[0],e=c[1],f=cK(d,aN(a.dtype,"int32")),g=O(e),h=this.readSync(f.dataId),i=this.readSync(a.dataId),j=0;j<h.length;++j){for(var k=j*g,l=1,m=0;m<g;++m)l*=i[k+m];h[j]=l}return f},b.prototype.unsortedSegmentSum=function(a,b,c){jP(a,"unsortedSegmentSum");for(var d=[],e=a.rank-b.rank,f=0;f<e;++f)b=b.expandDims(f+1);for(f=0;f<c;++f){var g=h$(cB(f,"int32"),b).asType("float32").mul(a).sum(0);d.push(g)}return dv(d)},b.prototype.argMin=function(a,b){jP(a,"argMin");var c=[b];cp("argMin",c,a.rank);for(var d=cn(a.shape,c),e=d[0],f=d[1],g=cK(e,"int32"),h=O(f),i=this.readSync(g.dataId),j=this.readSync(a.dataId),k=0;k<i.length;++k){for(var l=k*h,m=j[l],n=0,o=0;o<h;++o){var p=j[l+o];p<m&&(m=p,n=o)}i[k]=n}return g},b.prototype.argMax=function(a,b){jP(a,"argMax");var c=[b];cp("argMax",c,a.rank);for(var d=cn(a.shape,c),e=d[0],f=d[1],g=cK(e,"int32"),h=O(f),i=this.readSync(g.dataId),j=this.readSync(a.dataId),k=0;k<i.length;++k){for(var l=k*h,m=j[l],n=0,o=0;o<h;++o){var p=j[l+o];p>m&&(m=p,n=o)}i[k]=n}return g},b.prototype.cumsum=function(a,b,c,d){if(jP(a,"cumsum"),b!==a.rank-1)throw Error("backend.cumsum in CPU expects an inner-most axis="+(a.rank-1)+" but got axis="+b);for(var e=aN(a.dtype,"int32"),f=cK(a.shape,e),g=this.readSync(f.dataId),h=this.readSync(a.dataId),i=a.shape[a.rank-1],j=d?function(a,b){return a+i-b-1}:function(a,b){return a+b},k=0;k<h.length;k+=i)for(var l=0;l<i;l++){var m=j(k,l);if(0===l)g[m]=c?0:h[m];else{var n=j(k,l-1);g[m]=c?h[n]+g[n]:h[m]+g[n]}}return f},b.prototype.equal=function(a,b){return jP([a,b],"equal"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return+(a===b)})},b.prototype.notEqual=function(a,b){return jP([a,b],"notEqual"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return+(a!==b)})},b.prototype.less=function(a,b){return jP([a,b],"less"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return+(a<b)})},b.prototype.lessEqual=function(a,b){return jP([a,b],"lessEqual"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return+(a<=b)})},b.prototype.greater=function(a,b){return jP([a,b],"greater"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return+(a>b)})},b.prototype.greaterEqual=function(a,b){return jP([a,b],"greaterEqual"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return+(a>=b)})},b.prototype.logicalNot=function(a){jP(a,"logicalNot");for(var b=this.readSync(a.dataId),c=new Uint8Array(b.length),d=0;d<b.length;++d)c[d]=+!b[d];return this.makeOutput(c,a.shape,"bool")},b.prototype.logicalAnd=function(a,b){return jP([a,b],"logicalAnd"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a&&b})},b.prototype.logicalOr=function(a,b){return jP([a,b],"logicalOr"),this.broadcastedBinaryOp(a,b,"bool",function(a,b){return a||b})},b.prototype.select=function(a,b,c){jP([a,b,c],"select");for(var d=this.readSync(a.dataId),e=this.readSync(b.dataId),f=this.readSync(c.dataId),g=cK(b.shape,aN(b.dtype,c.dtype)),h=this.readSync(g.dataId),i=0,j=0===a.rank||a.rank>1||1===b.rank?1:O(b.shape.slice(1)),k=0;k<d.length;k++)for(var l=0;l<j;l++)1===d[k]?h[i++]=e[k]:h[i++]=f[k];return g},b.prototype.where=function(a){jP([a],"where");var b=this.readSync(a.dataId);return ex(a.shape,b)},b.prototype.topk=function(a,b,c){return jP(a,"topk"),ew(this.readSync(a.dataId),a.shape,a.dtype,b)},b.prototype.min=function(a,b){jP(a,"min"),cp("min",b,a.rank);for(var c=cn(a.shape,b),d=c[0],e=c[1],f=cK(d,a.dtype),g=O(e),h=this.readSync(f.dataId),i=this.readSync(a.dataId),j=0;j<h.length;++j){for(var k=j*g,l=i[k],m=0;m<g;++m){var n=i[k+m];n<l&&(l=n)}h[j]=l}return f},b.prototype.minimum=function(a,b){return jP([a,b],"minimum"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.min(a,b)})},b.prototype.mod=function(a,b){return jP([a,b],"mod"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){var c=a%b;return a<0&&b<0||a>=0&&b>=0?c:(c+b)%b})},b.prototype.max=function(a,b){jP(a,"max"),cp("max",b,a.rank);for(var c=cn(a.shape,b),d=c[0],e=c[1],f=cK(d,a.dtype),g=O(e),h=this.readSync(f.dataId),i=this.readSync(a.dataId),j=0;j<h.length;++j){for(var k=j*g,l=i[k],m=0;m<g;++m){var n=i[k+m];n>l&&(l=n)}h[j]=l}return f},b.prototype.maximum=function(a,b){return jP([a,b],"maximum"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.max(a,b)})},b.prototype.all=function(a,b){jP(a,"all"),cp("all",b,a.rank);for(var c=cn(a.shape,b),d=c[0],e=c[1],f=cK(d,a.dtype),g=O(e),h=this.readSync(f.dataId),i=this.readSync(a.dataId),j=0;j<h.length;++j){for(var k=j*g,l=i[k],m=0;m<g;++m){var n=i[k+m];l=l&&n}h[j]=l}return f},b.prototype.any=function(a,b){jP(a,"any"),cp("any",b,a.rank);for(var c=cn(a.shape,b),d=c[0],e=c[1],f=cK(d,a.dtype),g=O(e),h=this.readSync(f.dataId),i=this.readSync(a.dataId),j=0;j<h.length;++j){for(var k=j*g,l=i[k],m=0;m<g;++m){var n=i[k+m];l=l||n}h[j]=l}return f},b.prototype.squaredDifference=function(a,b){return jP([a,b],"squaredDifference"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){var c=a-b;return c*c})},b.prototype.ceil=function(a){jP(a,"ceil");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d)c[d]=Math.ceil(b[d]);return this.makeOutput(c,a.shape,"float32")},b.prototype.floor=function(a){jP(a,"floor");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d)c[d]=Math.floor(b[d]);return this.makeOutput(c,a.shape,"float32")},b.prototype.sign=function(a){jP(a,"x");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d)b[d]<0?c[d]=-1:b[d]>0?c[d]=1:c[d]=0;return this.makeOutput(c,a.shape,"float32")},b.prototype.isNaN=function(a){jP(a,"x");for(var b=this.readSync(a.dataId),c=new Uint8Array(b.length),d=0;d<b.length;++d)Number.isNaN(b[d])&&(c[d]=1);return this.makeOutput(c,a.shape,"bool")},b.prototype.isInf=function(a){jP(a,"x");for(var b=this.readSync(a.dataId),c=new Uint8Array(b.length),d=0;d<b.length;++d)Math.abs(b[d])===1/0&&(c[d]=1);return this.makeOutput(c,a.shape,"bool")},b.prototype.isFinite=function(a){jP(a,"x");for(var b=this.readSync(a.dataId),c=new Uint8Array(b.length),d=0;d<b.length;++d)Number.isFinite(b[d])&&(c[d]=1);return this.makeOutput(c,a.shape,"bool")},b.prototype.round=function(a){jP(a,"round");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d){var e=Math.floor(b[d]);b[d]-e<.5?c[d]=Math.floor(b[d]):b[d]-e>.5?c[d]=Math.ceil(b[d]):c[d]=e%2==0?e:e+1}return this.makeOutput(c,a.shape,"float32")},b.prototype.exp=function(a){jP(a,"exp");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d)c[d]=Math.exp(b[d]);return this.makeOutput(c,a.shape,"float32")},b.prototype.expm1=function(a){jP(a,"expm1");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d)c[d]=Math.expm1(b[d]);return this.makeOutput(c,a.shape,"float32")},b.prototype.log=function(a){jP(a,"log");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d){var e=b[d];c[d]=Math.log(e)}return this.makeOutput(c,a.shape,"float32")},b.prototype.log1p=function(a){jP(a,"log1p");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d){var e=b[d];c[d]=Math.log1p(e)}return this.makeOutput(c,a.shape,"float32")},b.prototype.sqrt=function(a){jP(a,"sqrt");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d){var e=b[d];c[d]=Math.sqrt(e)}return this.makeOutput(c,a.shape,"float32")},b.prototype.rsqrt=function(a){jP(a,"rsqrt");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d){var e=b[d];c[d]=1/Math.sqrt(e)}return this.makeOutput(c,a.shape,"float32")},b.prototype.reciprocal=function(a){jP(a,"reciprocal");for(var b=this.readSync(a.dataId),c=new Float32Array(b.length),d=0;d<b.length;++d)c[d]=1/b[d];return this.makeOutput(c,a.shape,"float32")},b.prototype.linear=function(a){return a},b.prototype.relu=function(a){jP(a,"relu");for(var b=cK(a.shape,a.dtype),c=this.readSync(b.dataId),d=this.readSync(a.dataId),e=0;e<d.length;++e)c[e]=Math.max(0,d[e]);return b},b.prototype.relu6=function(a){jP(a,"relu");for(var b=cK(a.shape,a.dtype),c=this.readSync(b.dataId),d=this.readSync(a.dataId),e=0;e<d.length;++e)c[e]=Math.min(Math.max(0,d[e]),6);return b},b.prototype.prelu=function(a,b){return jP([a,b],"prelu"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return a<0?b*a:a})},b.prototype.elu=function(a){jP(a,"elu");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d){var e=c[d];b[d]=e>=0?e:Math.exp(e)-1}return this.makeOutput(b,a.shape,"float32")},b.prototype.eluDer=function(a,b){jP([a,b],"eluDer");for(var c=new Float32Array(b.size),d=this.readSync(b.dataId),e=this.readSync(a.dataId),f=0;f<d.length;++f){var g=d[f];c[f]=g>=1?e[f]:e[f]*(g+1)}return this.makeOutput(c,b.shape,"float32")},b.prototype.selu=function(a){jP(a,"selu");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d){var e=c[d];b[d]=e>=0?1.0507009873554805*e:1.7580993408473768*(Math.exp(e)-1)}return this.makeOutput(b,a.shape,"float32")},b.prototype.clip=function(a,b,c){jP(a,"clip");for(var d=new Float32Array(a.size),e=this.readSync(a.dataId),f=0;f<e.length;++f){var g=e[f];d[f]=g>c?c:g<b?b:g}return this.makeOutput(d,a.shape,"float32")},b.prototype.abs=function(a){for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.abs(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.complexAbs=function(a){for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<a.size;++d){var e=c[2*d],f=c[2*d+1];b[d]=Math.hypot(e,f)}return this.makeOutput(b,a.shape,"float32")},b.prototype.int=function(a){jP(a,"int");for(var b=new Int32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=c[d];return this.makeOutput(b,a.shape,"int32")},b.prototype.sigmoid=function(a){jP(a,"sigmoid");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=1/(1+Math.exp(-c[d]));return this.makeOutput(b,a.shape,"float32")},b.prototype.softplus=function(a){jP(a,"softplus");for(var b=Math.log(11920928955078125e-23)+2,c=new Float32Array(a.size),d=this.readSync(a.dataId),e=0;e<d.length;++e){var f=d[e]>-b,g=d[e]<b,h=Math.exp(d[e]),i=void 0;i=g?h:f?d[e]:Math.log(1+h),c[e]=i}return this.makeOutput(c,a.shape,"float32")},b.prototype.sin=function(a){jP(a,"sin");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.sin(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.cos=function(a){jP(a,"cos");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.cos(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.tan=function(a){jP(a,"tan");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.tan(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.asin=function(a){jP(a,"asin");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.asin(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.acos=function(a){jP(a,"acos");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.acos(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.atan=function(a){jP(a,"atan");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.atan(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.atan2=function(a,b){return jP([a,b],"atan2"),this.broadcastedBinaryOp(a,b,a.dtype,function(a,b){return Math.atan2(a,b)})},b.prototype.sinh=function(a){jP(a,"sinh");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.sinh(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.cosh=function(a){jP(a,"cosh");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.cosh(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.tanh=function(a){jP(a,"tanh");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=R(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.asinh=function(a){jP(a,"asinh");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.asinh(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.acosh=function(a){jP(a,"acosh");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.acosh(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.atanh=function(a){jP(a,"atanh");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d)b[d]=Math.atanh(c[d]);return this.makeOutput(b,a.shape,"float32")},b.prototype.erf=function(a){jP(a,"erf");for(var b=new Float32Array(a.size),c=this.readSync(a.dataId),d=0;d<c.length;++d){var e=Math.sign(c[d]),f=Math.abs(c[d]),g=1/(1+.3275911*f);b[d]=e*(1-((((1.061405429*g-1.453152027)*g+1.421413741)*g-.284496736)*g+.254829592)*g*Math.exp(-f*f))}return this.makeOutput(b,a.shape,"float32")},b.prototype.step=function(a,b){void 0===b&&(b=0),jP(a,"step");for(var c=new Float32Array(a.size),d=this.readSync(a.dataId),e=0;e<d.length;++e){var f=d[e];isNaN(f)?c[e]=NaN:c[e]=f>0?1:b}return this.makeOutput(c,a.shape,"float32")},b.prototype.fusedConv2d=function(a){var b=a.input,c=a.filter,d=a.convInfo,e=a.bias,f=a.activation,g=a.preluActivationWeights,h=this.conv2d(b,c,d);return e&&(h=this.add(h,e)),f&&(h=jQ(this,h,f,g)),h},b.prototype.conv2d=function(a,b,c){jP([a,b],"conv2d");for(var d=c.filterHeight,e=c.filterWidth,f=c.dilationHeight,g=c.dilationWidth,h=c.padInfo.left,i=c.padInfo.top,j="channelsLast"===c.dataFormat,k=c6(c.outShape,a.dtype),l=a.strides[0],m=j?a.strides[1]:a.strides[2],n=j?a.strides[2]:1,o=j?1:a.strides[1],p=k.strides[0],q=j?k.strides[1]:k.strides[2],r=j?k.strides[2]:1,s=j?1:k.strides[1],t=this.readSync(a.dataId),u=this.readSync(b.dataId),v=k.values,w=0;w<c.batchSize;++w)for(var x=w*l,y=w*p,z=0;z<c.outHeight;++z)for(var A=y+z*q,B=z*c.strideHeight-i,C=0;C<d;C++){var D=B+C*f;if(!(D<0||D>=c.inHeight))for(var E=C*b.strides[0],F=x+D*m,G=0;G<c.outWidth;++G)for(var H=A+G*r,I=G*c.strideWidth-h,J=0;J<e;J++){var K=I+J*g;if(!(K<0||K>=c.inWidth))for(var L=F+K*n,M=E+J*b.strides[1],N=0;N<c.inChannels;++N){for(var O=t[L+N*o],P=0;P<c.outChannels;++P)v[H+P*s]+=O*u[M+P];M+=c.outChannels}}}return k.toTensor()},b.prototype.conv3d=function(a,b,c){for(var d=c.filterDepth,e=c.filterHeight,f=c.filterWidth,g=c.dilationDepth,h=c.dilationHeight,i=c.dilationWidth,j=c.padInfo.front,k=c.padInfo.left,l=c.padInfo.top,m=c6(c.outShape,a.dtype),n=this.readSync(a.dataId),o=this.readSync(b.dataId),p=m.values,q=0;q<c.batchSize;++q)for(var r=q*a.strides[0],s=q*m.strides[0],t=0;t<c.outDepth;++t)for(var u=s+t*m.strides[1],v=t*c.strideDepth-j,w=0;w<d;w++){var x=v+w*g;if(!(x<0||x>=c.inDepth))for(var y=w*b.strides[0],z=r+x*a.strides[1],A=0;A<c.outHeight;++A)for(var B=u+A*m.strides[2],C=A*c.strideHeight-l,D=0;D<e;D++){var E=C+D*h;if(!(E<0||E>=c.inHeight))for(var F=y+D*b.strides[1],G=z+E*a.strides[2],H=0;H<c.outWidth;++H)for(var I=B+H*c.outChannels,J=H*c.strideWidth-k,K=0;K<f;K++){var L=J+K*i;if(!(L<0||L>=c.inWidth))for(var M=F+K*b.strides[2],N=G+L*c.inChannels,O=M,P=0;P<c.inChannels;++P){for(var Q=n[N+P],R=0;R<c.outChannels;++R)p[I+R]+=Q*o[O+R];O+=c.outChannels}}}}return m.toTensor()},b.prototype.conv2dDerInput=function(a,b,c){jP([a,b],"conv2dDerInput");for(var d=c6(c.inShape,"float32"),e=d.values,f=this.readSync(a.dataId),g=this.readSync(b.dataId),h=b.strides,i=h[0],j=h[1],k=h[2],l=c.batchSize,m=c.filterHeight,n=c.filterWidth,o=c.inChannels,p=c.inHeight,q=c.inWidth,r=c.outChannels,s=c.outHeight,t=c.outWidth,u=c.strideHeight,v=c.strideWidth,w=c.dataFormat,x=m-1-c.padInfo.top,y=n-1-c.padInfo.left,z="channelsLast"===w,A=d.strides[0],B=z?d.strides[1]:d.strides[2],C=z?d.strides[2]:1,D=z?1:d.strides[1],E=a.strides[0],F=z?a.strides[1]:a.strides[2],G=z?a.strides[2]:1,H=z?1:a.strides[1],I=0;I<l;++I)for(var J=0;J<o;++J)for(var K=0;K<p;++K)for(var L=K-x,M=Math.max(0,Math.ceil(L/u)),N=Math.min(s,(m+L)/u),O=0;O<q;++O){for(var P=O-y,Q=Math.max(0,Math.ceil(P/v)),R=Math.min(t,(n+P)/v),S=0,T=M;T<N;++T)for(var U=T*u-L,V=Q;V<R;++V)for(var W=E*I+F*T+G*V,X=i*(m-1-U)+j*(n-1-(V*v-P))+k*J,Y=0;Y<r;++Y)S+=f[W+H*Y]*g[X+Y];e[A*I+B*K+C*O+D*J]=S}return d.toTensor()},b.prototype.conv3dDerInput=function(a,b,c){for(var d=c6(c.inShape,"float32"),e=d.values,f=d.strides,g=f[0],h=f[1],i=f[2],j=f[3],k=this.readSync(a.dataId),l=a.strides,m=l[0],n=l[1],o=l[2],p=l[3],q=this.readSync(b.dataId),r=b.strides,s=r[0],t=r[1],u=r[2],v=r[3],w=c.batchSize,x=c.filterDepth,y=c.filterHeight,z=c.filterWidth,A=c.inChannels,B=c.inDepth,C=c.inHeight,D=c.inWidth,E=c.outChannels,F=c.outDepth,G=c.outHeight,H=c.outWidth,I=c.strideDepth,J=c.strideHeight,K=c.strideWidth,L=x-1-c.padInfo.front,M=y-1-c.padInfo.top,N=z-1-c.padInfo.left,O=0;O<w;++O)for(var P=0;P<A;++P)for(var Q=0;Q<B;++Q)for(var R=Q-L,S=Math.max(0,Math.ceil(R/I)),T=Math.min(F,(x+R)/I),U=0;U<C;++U)for(var V=U-M,W=Math.max(0,Math.ceil(V/J)),X=Math.min(G,(y+V)/J),Y=0;Y<D;++Y){for(var Z=Y-N,$=Math.max(0,Math.ceil(Z/K)),_=Math.min(H,(z+Z)/K),aa=0,ab=S;ab<T;++ab)for(var ac=ab*I-R,ad=W;ad<X;++ad)for(var ae=ad*J-V,af=$;af<_;++af)for(var ag=m*O+n*ab+o*ad+p*af,ah=s*(x-1-ac)+t*(y-1-ae)+u*(z-1-(af*K-Z))+v*P,ai=0;ai<E;++ai)aa+=k[ag+ai]*q[ah+ai];e[g*O+h*Q+i*U+j*Y+P]=aa}return d.toTensor()},b.prototype.conv2dDerFilter=function(a,b,c){jP([a,b],"conv2dDerFilter");for(var d=c.strideHeight,e=c.strideWidth,f=c.filterHeight,g=c.filterWidth,h="channelsLast"===c.dataFormat,i=c6(c.filterShape,"float32"),j=c.padInfo.left,k=c.padInfo.top,l=this.bufferSync(a),m=this.bufferSync(b),n=0;n<f;++n)for(var o=Math.max(0,Math.ceil((k-n)/d)),p=Math.min(c.outHeight,(c.inHeight+k-n)/d),q=0;q<g;++q)for(var r=Math.max(0,Math.ceil((j-q)/e)),s=Math.min(c.outWidth,(c.inWidth+j-q)/e),t=0;t<c.inChannels;++t)for(var u=0;u<c.outChannels;++u){for(var v=0,w=0;w<c.batchSize;++w)for(var x=o;x<p;++x)for(var y=n+x*d-k,z=r;z<s;++z){var A=q+z*e-j;v+=h?l.get(w,y,A,t)*m.get(w,x,z,u):l.get(w,t,y,A)*m.get(w,u,x,z)}i.set(v,n,q,t,u)}return i.toTensor()},b.prototype.conv3dDerFilter=function(a,b,c){for(var d=c.strideDepth,e=c.strideHeight,f=c.strideWidth,g=c.filterDepth,h=c.filterHeight,i=c.filterWidth,j=c6(c.filterShape,"float32"),k=j.values,l=j.strides,m=l[0],n=l[1],o=l[2],p=l[3],q=this.readSync(b.dataId),r=b.strides,s=r[0],t=r[1],u=r[2],v=r[3],w=this.readSync(a.dataId),x=a.strides,y=x[0],z=x[1],A=x[2],B=x[3],C=c.padInfo.front,D=c.padInfo.left,E=c.padInfo.top,F=0;F<g;++F)for(var G=Math.max(0,Math.ceil((C-F)/d)),H=Math.min(c.outDepth,(c.inDepth+C-F)/d),I=F*m,J=0;J<h;++J)for(var K=Math.max(0,Math.ceil((E-J)/e)),L=Math.min(c.outHeight,(c.inHeight+E-J)/e),M=J*n+I,N=0;N<i;++N)for(var O=Math.max(0,Math.ceil((D-N)/f)),P=Math.min(c.outWidth,(c.inWidth+D-N)/f),Q=N*o+M,R=0;R<c.inChannels;++R)for(var S=R*p+Q,T=0;T<c.outChannels;++T){for(var U=0,V=0;V<c.batchSize;++V)for(var W=V*y,X=V*s,Y=G;Y<H;++Y)for(var Z=(F+Y*d-C)*z+W,$=Y*t+X,_=K;_<L;++_)for(var aa=(J+_*e-E)*A+Z,ab=_*u+$,ac=O;ac<P;++ac){var ad=ac*v+ab;U+=w[(N+ac*f-D)*B+aa+R]*q[ad+T]}k[S+T]=U}return j.toTensor()},b.prototype.fusedDepthwiseConv2D=function(a){var b=a.input,c=a.filter,d=a.convInfo,e=a.bias,f=a.activation,g=a.preluActivationWeights,h=this.depthwiseConv2D(b,c,d);return e&&(h=this.add(h,e)),f&&(h=jQ(this,h,f,g)),h},b.prototype.depthwiseConv2D=function(a,b,c){jP([a,b],"depthwiseConv2D");for(var d=c.filterHeight,e=c.filterWidth,f=c.dilationHeight,g=c.dilationWidth,h=c.padInfo.left,i=c.padInfo.top,j=c.outChannels/c.inChannels,k=c6(c.outShape,a.dtype),l=this.readSync(a.dataId),m=this.readSync(b.dataId),n=k.values,o=0;o<c.batchSize;++o)for(var p=o*a.strides[0],q=o*k.strides[0],r=0;r<c.outHeight;++r)for(var s=q+r*k.strides[1],t=r*c.strideHeight-h,u=0;u<d;++u){var v=t+u*f;if(!(v<0||v>=c.inHeight))for(var w=u*b.strides[0],x=p+v*a.strides[1],y=0;y<c.outWidth;++y)for(var z=s+y*k.strides[2],A=y*c.strideWidth-i,B=0;B<e;++B){var C=A+B*g;if(!(C<0||C>=c.inWidth))for(var D=w+B*b.strides[1],E=x+C*c.inChannels,F=z,G=D,H=0;H<c.inChannels;++H){for(var I=l[E+H],J=0;J<j;++J)n[F+J]+=I*m[G+J];F+=j,G+=j}}}return k.toTensor()},b.prototype.depthwiseConv2DDerInput=function(a,b,c){jP([a,b],"depthwiseConv2DDerInput");for(var d=c6(c.inShape,"float32"),e=d.values,f=d.strides,g=f[0],h=f[1],i=f[2],j=this.readSync(a.dataId),k=a.strides,l=k[0],m=k[1],n=k[2],o=this.readSync(b.dataId),p=b.strides,q=p[0],r=p[1],s=p[2],t=c.batchSize,u=c.filterHeight,v=c.filterWidth,w=c.inChannels,x=c.inHeight,y=c.inWidth,z=c.outChannels,A=c.outHeight,B=c.outWidth,C=c.strideHeight,D=c.strideWidth,E=u-1-c.padInfo.top,F=v-1-c.padInfo.left,G=z/w,H=0;H<t;++H)for(var I=0;I<w;++I)for(var J=0;J<x;++J)for(var K=J-E,L=Math.max(0,Math.ceil(K/C)),M=Math.min(A,(u+K)/C),N=0;N<y;++N){for(var O=N-F,P=Math.max(0,Math.ceil(O/D)),Q=Math.min(B,(v+O)/D),R=0,S=L;S<M;++S)for(var T=S*C-K,U=P;U<Q;++U)for(var V=l*H+m*S+n*U,W=q*(u-1-T)+r*(v-1-(U*D-O))+s*I,X=0;X<G;++X)R+=j[V+(I*G+X)]*o[W+X];e[g*H+h*J+i*N+I]=R}return d.toTensor()},b.prototype.depthwiseConv2DDerFilter=function(a,b,c){jP([a,b],"depthwiseConv2DDerFilter");for(var d=c.strideHeight,e=c.strideWidth,f=c.filterHeight,g=c.filterWidth,h=c6(c.filterShape,"float32"),i=c.padInfo.left,j=c.padInfo.top,k=c.outChannels/c.inChannels,l=this.bufferSync(a),m=this.bufferSync(b),n=0;n<f;++n)for(var o=Math.max(0,Math.ceil((j-n)/d)),p=Math.min(c.outHeight,(c.inHeight+j-n)/d),q=0;q<g;++q)for(var r=Math.max(0,Math.ceil((i-q)/e)),s=Math.min(c.outWidth,(c.inWidth+i-q)/e),t=0;t<c.outChannels;++t){for(var u=Math.trunc(t/k),v=t%k,w=0,x=0;x<c.batchSize;++x)for(var y=o;y<p;++y)for(var z=n+y*d-j,A=r;A<s;++A){var B=q+A*e-i;w+=l.get(x,z,B,u)*m.get(x,y,A,t)}h.set(w,n,q,u,v)}return h.toTensor()},b.prototype.tile=function(a,b){return jP(a,"tile"),ev(this.bufferSync(a),b)},b.prototype.pad=function(a,b,c){jP(a,"pad");var d=b.map(function(b,c){return b[0]+a.shape[c]+b[1]}),e=b.map(function(a){return a[0]}),f=this.bufferSync(a),g=c6(d,a.dtype);0!==c&&g.values.fill(c);for(var h=0;h<a.size;h++){var i=f.indexToLoc(h),j=i.map(function(a,b){return a+e[b]});g.set.apply(g,[f.get.apply(f,i)].concat(j))}return g.toTensor()},b.prototype.transpose=function(a,b){jP(a,"transpose");for(var c=Array(a.rank),d=0;d<c.length;d++)c[d]=a.shape[b[d]];var e=this.readSync(a.dataId),f=c6(c,a.dtype),g=this.bufferSync(a);for(d=0;d<a.size;++d){for(var h=g.indexToLoc(d),i=Array(h.length),j=0;j<i.length;j++)i[j]=h[b[j]];var k=f.locToIndex(i);f.values[k]=e[d]}return f.toTensor()},b.prototype.gather=function(a,b,c){jP([a,b],"gather");var d=a.shape.slice(),e=this.readSync(b.dataId);d[c]=e.length;for(var f=c6(d,a.dtype),g=this.bufferSync(a),h=0;h<f.size;++h){var i=f.indexToLoc(h),j=i.slice();j[c]=e[i[c]];var k=g.locToIndex(j);f.values[h]=g.values[k]}return f.toTensor()},b.prototype.batchToSpaceND=function(a,b,c){jP([a],"batchToSpaceND");var d=b.reduce(function(a,b){return a*b}),e=dA(a.shape,b,d),f=dB(e.length,b.length),g=dC(a.shape,b,d),h=dD(c,b.length),i=dE(g,c,b.length);return a.reshape(e).transpose(f).reshape(g).slice(h,i)},b.prototype.spaceToBatchND=function(a,b,c){jP([a],"spaceToBatchND");var d=b.reduce(function(a,b){return a*b}),e=[[0,0]];e.push.apply(e,c);for(var f=1+b.length;f<a.shape.length;++f)e.push([0,0]);var g=a.pad(e),h=dA(g.shape,b,d,!1),i=dB(h.length,b.length,!1),j=dC(g.shape,b,d,!1);return g.reshape(h).transpose(i).reshape(j)},b.prototype.pool=function(a,b,c){jP(a,"pool");for(var d=b.strideHeight,e=b.strideWidth,f=b.dilationHeight,g=b.dilationWidth,h=b.effectiveFilterHeight,i=b.effectiveFilterWidth,j=b.padInfo.top,k=b.padInfo.left,l="max"===c?-1/0:1/0,m=this.readSync(a.dataId),n=c6(b.outShape,a.dtype),o=n.values,p=b.outShape[1]*b.outShape[2]*b.outShape[3],q=b.outShape[2]*b.outShape[3],r=b.outShape[3],s=0;s<b.batchSize;++s)for(var t=s*p,u=s*a.strides[0],v=0;v<b.inChannels;++v)for(var w=0;w<b.outHeight;++w)for(var x=w*d-j,y=Math.max(0,x),z=Math.min(b.inHeight,h+x),A=t+w*q,B=0;B<b.outWidth;++B){for(var C=B*e-k,D=Math.max(0,C),E=Math.min(b.inWidth,i+C),F=l,G=0,H=0,I=y;I<z;I+=f){for(var J=u+I*a.strides[1],K=D;K<E;K+=g){var L=m[J+K*a.strides[2]+v];"max"===c&&L>F?F=L:"avg"===c&&(G+=L,H++)}if(isNaN(F))break}o[A+B*r+v]="avg"===c?G/H:F}return n.toTensor()},b.prototype.maxPool=function(a,b){return this.pool(a,b,"max")},b.prototype.maxPoolPositions=function(a,b){for(var c=c6(b.outShape,"int32"),d=b.strideHeight,e=b.strideWidth,f=b.dilationHeight,g=b.dilationWidth,h=b.effectiveFilterHeight,i=b.effectiveFilterWidth,j=b.padInfo.top,k=b.padInfo.left,l=this.bufferSync(a),m=0;m<b.batchSize;++m)for(var n=0;n<b.inChannels;++n)for(var o=0;o<b.outHeight;++o){for(var p=o*d-j,q=p;q<0;)q+=f;for(var r=Math.min(b.inHeight,h+p),s=0;s<b.outWidth;++s){for(var t=s*e-k,u=t;u<0;)u+=g;for(var v=Math.min(b.inWidth,i+t),w=-1/0,x=-1,y=q;y<r;y+=f)for(var z=y-p,A=u;A<v;A+=g){var B=A-t,C=l.get(m,y,A,n);C>w&&(w=C,x=z*i+B)}c.set(x,m,o,s,n)}}return c.toTensor()},b.prototype.maxPoolBackprop=function(a,b,c,d){jP([b,c],"maxPoolBackprop");for(var e=this.maxPoolPositions(b,d),f=d.strideHeight,g=d.strideWidth,h=d.dilationHeight,i=d.dilationWidth,j=d.effectiveFilterHeight,k=d.effectiveFilterWidth,l=k-1-d.padInfo.left,m=j-1-d.padInfo.top,n=c6(b.shape,"float32"),o=this.bufferSync(e),p=this.bufferSync(a),q=0;q<d.batchSize;++q)for(var r=0;r<d.inChannels;++r)for(var s=0;s<d.inHeight;++s)for(var t=0;t<d.inWidth;++t){for(var u=s-m,v=t-l,w=0,x=0;x<j;x+=h){var y=(u+x)/f;if(!(y<0||y>=d.outHeight||Math.floor(y)!==y))for(var z=0;z<k;z+=i){var A=(v+z)/g;if(!(A<0||A>=d.outWidth||Math.floor(A)!==A)){var B=+(j*k-1-o.get(q,y,A,r)===x*k+z);0!==B&&(w+=p.get(q,y,A,r)*B)}}}n.set(w,q,s,t,r)}return n.toTensor()},b.prototype.avgPoolBackprop=function(a,b,c){jP([a,b],"avgPoolBackprop");for(var d=c.strideHeight,e=c.strideWidth,f=c.filterHeight,g=c.filterWidth,h=c.dilationHeight,i=c.dilationWidth,j=c.effectiveFilterHeight,k=c.effectiveFilterWidth,l=k-1-c.padInfo.left,m=j-1-c.padInfo.top,n=c6(b.shape,"float32"),o=1/(f*g),p=this.bufferSync(a),q=0;q<c.batchSize;++q)for(var r=0;r<c.inChannels;++r)for(var s=0;s<c.inHeight;++s)for(var t=0;t<c.inWidth;++t){for(var u=s-m,v=t-l,w=0,x=0;x<j;x+=h){var y=(u+x)/d;if(!(y<0||y>=c.outHeight||Math.floor(y)!==y))for(var z=0;z<k;z+=i){var A=(v+z)/e;A<0||A>=c.outWidth||Math.floor(A)!==A||(w+=p.get(q,y,A,r))}}n.set(w*o,q,s,t,r)}return n.toTensor()},b.prototype.pool3d=function(a,b,c){jP(a,"pool3d");for(var d=b.strideDepth,e=b.strideHeight,f=b.strideWidth,g=b.dilationDepth,h=b.dilationHeight,i=b.dilationWidth,j=b.effectiveFilterDepth,k=b.effectiveFilterHeight,l=b.effectiveFilterWidth,m=b.padInfo.front,n=b.padInfo.top,o=b.padInfo.left,p="max"===c?-1/0:1/0,q=this.readSync(a.dataId),r=c6(b.outShape,a.dtype),s=r.values,t=b.outShape[1]*b.outShape[2]*b.outShape[3]*b.outShape[4],u=b.outShape[2]*b.outShape[3]*b.outShape[4],v=b.outShape[3]*b.outShape[4],w=b.outShape[4],x=0;x<b.batchSize;++x)for(var y=x*t,z=x*a.strides[0],A=0;A<b.inChannels;++A)for(var B=0;B<b.outDepth;++B){for(var C=B*d-m,D=C;D<0;)D+=g;for(var E=Math.min(b.inDepth,j+C),F=y+B*u,G=0;G<b.outHeight;++G){for(var H=G*e-n,I=H;I<0;)I+=h;for(var J=Math.min(b.inHeight,k+H),K=F+G*v,L=0;L<b.outWidth;++L){for(var M=L*f-o,N=M;N<0;)N+=i;for(var O=Math.min(b.inWidth,l+M),P=K+L*w,Q=p,R=0,S=0,T=D;T<E;T+=g){for(var U=z+T*a.strides[1],V=I;V<J;V+=h){for(var W=U+V*a.strides[2],X=N;X<O;X+=i){var Y=q[W+X*a.strides[3]+A];if("max"===c&&Y>Q?Q=Y:"avg"===c&&(R+=Y,S++),isNaN(Q))break}if(isNaN(Q))break}if(isNaN(Q))break}s[P+A]="avg"===c?R/S:Q}}}return r.toTensor()},b.prototype.avgPool3d=function(a,b){return jP(a,"avgPool3d"),this.pool3d(a,b,"avg").toFloat()},b.prototype.avgPool3dBackprop=function(a,b,c){jP([a,b],"avgPool3dBackprop");for(var d=c.strideDepth,e=c.strideHeight,f=c.strideWidth,g=c.filterDepth,h=c.filterHeight,i=c.filterWidth,j=c.dilationDepth,k=c.dilationHeight,l=c.dilationWidth,m=c.effectiveFilterDepth,n=c.effectiveFilterHeight,o=c.effectiveFilterWidth,p=m-1-c.padInfo.front,q=o-1-c.padInfo.left,r=n-1-c.padInfo.top,s=c6(b.shape,"float32"),t=1/(g*h*i),u=this.bufferSync(a),v=0;v<c.batchSize;++v)for(var w=0;w<c.inChannels;++w)for(var x=0;x<c.inDepth;++x)for(var y=0;y<c.inHeight;++y)for(var z=0;z<c.inWidth;++z){for(var A=x-p,B=y-r,C=z-q,D=0,E=0;E<m;E+=j){var F=(A+E)/d;if(!(F<0||F>=c.outDepth||Math.floor(F)!==F))for(var G=0;G<n;G+=k){var H=(B+G)/e;if(!(H<0||H>=c.outHeight||Math.floor(H)!==H))for(var I=0;I<o;I+=l){var J=(C+I)/f;J<0||J>=c.outWidth||Math.floor(J)!==J||(D+=u.get(v,F,H,J,w))}}}s.set(D*t,v,x,y,z,w)}return s.toTensor()},b.prototype.maxPool3d=function(a,b){return jP(a,"maxPool3d"),this.pool3d(a,b,"max").toFloat()},b.prototype.maxPool3dPositions=function(a,b){for(var c=c6(b.outShape,"int32"),d=b.strideDepth,e=b.strideHeight,f=b.strideWidth,g=b.dilationDepth,h=b.dilationHeight,i=b.dilationWidth,j=b.effectiveFilterDepth,k=b.effectiveFilterHeight,l=b.effectiveFilterWidth,m=b.padInfo.front,n=b.padInfo.top,o=b.padInfo.left,p=this.bufferSync(a),q=0;q<b.batchSize;++q)for(var r=0;r<b.inChannels;++r)for(var s=0;s<b.outDepth;++s){for(var t=s*d-m,u=t;u<0;)u+=g;for(var v=Math.min(b.inDepth,j+t),w=0;w<b.outHeight;++w){for(var x=w*e-n,y=x;y<0;)y+=h;for(var z=Math.min(b.inHeight,k+x),A=0;A<b.outWidth;++A){for(var B=A*f-o,C=B;C<0;)C+=i;for(var D=Math.min(b.inWidth,l+B),E=-1/0,F=-1,G=u;G<v;G+=g)for(var H=G-t,I=y;I<z;I+=h)for(var J=I-x,K=C;K<D;K+=i){var L=K-B,M=p.get(q,G,I,K,r);M>=E&&(E=M,F=H*k*l+J*k+L)}c.set(F,q,s,w,A,r)}}}return c.toTensor()},b.prototype.maxPool3dBackprop=function(a,b,c,d){jP([b,c],"maxPool3dBackprop");for(var e=this.maxPool3dPositions(b,d),f=d.strideDepth,g=d.strideHeight,h=d.strideWidth,i=d.dilationDepth,j=d.dilationHeight,k=d.dilationWidth,l=d.effectiveFilterDepth,m=d.effectiveFilterHeight,n=d.effectiveFilterWidth,o=l-1-d.padInfo.front,p=n-1-d.padInfo.left,q=m-1-d.padInfo.top,r=c6(b.shape,"float32"),s=this.bufferSync(e),t=this.bufferSync(a),u=0;u<d.batchSize;++u)for(var v=0;v<d.inChannels;++v)for(var w=0;w<d.inDepth;++w)for(var x=0;x<d.inHeight;++x)for(var y=0;y<d.inWidth;++y){for(var z=w-o,A=x-q,B=y-p,C=0,D=0;D<l;D+=i){var E=(z+D)/f;if(!(E<0||E>=d.outDepth||Math.floor(E)!==E))for(var F=0;F<m;F+=j){var G=(A+F)/g;if(!(G<0||G>=d.outHeight||Math.floor(G)!==G))for(var H=0;H<n;H+=k){var I=(B+H)/h;if(!(I<0||I>=d.outWidth||Math.floor(I)!==I)){var J=+(l*m*n-1-s.get(u,E,G,I,v)===D*m*n+F*n+H);0!==J&&(C+=t.get(u,E,G,I,v)*J)}}}}r.set(C,u,w,x,y,v)}return r.toTensor()},b.prototype.cast=function(a,b){return ej(a,b,this)},b.prototype.reshape=function(a,b){return ek(a,b)},b.prototype.avgPool=function(a,b){return jP(a,"avgPool"),this.pool(a,b,"avg").toFloat()},b.prototype.resizeBilinear=function(a,b,c,d){jP(a,"resizeBilinear");for(var e=a.shape,f=e[0],g=e[1],h=e[2],i=e[3],j=this.readSync(a.dataId),k=new Float32Array(O([f,b,c,i])),l=[d&&b>1?g-1:g,d&&c>1?h-1:h],m=[d&&b>1?b-1:b,d&&c>1?c-1:c],n=0,o=l[0]/m[0],p=l[1]/m[1],q=0;q<f;q++)for(var r=0;r<b;r++)for(var s=o*r,t=Math.floor(s),u=s-t,v=Math.min(g-1,Math.ceil(s)),w=q*a.strides[0]+t*a.strides[1],x=q*a.strides[0]+v*a.strides[1],y=0;y<c;y++)for(var z=p*y,A=Math.floor(z),B=z-A,C=Math.min(h-1,Math.ceil(z)),D=w+A*a.strides[2],E=x+A*a.strides[2],F=w+C*a.strides[2],G=x+C*a.strides[2],H=0;H<i;H++){var I=j[D+H],J=j[E+H],K=I+(j[F+H]-I)*B,L=K+(J+(j[G+H]-J)*B-K)*u;k[n++]=L}return cz(k,[f,b,c,i])},b.prototype.resizeBilinearBackprop=function(a,b,c){jP([a,b],"resizeBilinearBackprop");for(var d=b.shape,e=d[0],f=d[1],g=d[2],h=d[3],i=a.shape,j=i[1],k=i[2],l=new Float32Array(e*f*g*h),m=[c&&j>1?f-1:f,c&&k>1?g-1:g],n=[c&&j>1?j-1:j,c&&k>1?k-1:k],o=m[0]/n[0],p=m[1]/n[1],q=this.readSync(a.dataId),r=0,s=0;s<e;s++)for(var t=s*b.strides[0],u=0;u<j;u++)for(var v=u*o,w=Math.floor(v),x=Math.min(Math.ceil(v),f-1),y=t+w*b.strides[1],z=t+x*b.strides[1],A=v-w,B=1-A,C=0;C<k;C++)for(var D=C*p,E=Math.floor(D),F=Math.min(Math.ceil(D),g-1),G=D-E,H=1-G,I=y+E*b.strides[2],J=y+F*b.strides[2],K=z+E*b.strides[2],L=z+F*b.strides[2],M=B*H,N=B*G,O=A*H,P=A*G,Q=0;Q<h;Q++){var R=q[r++];l[I+Q]+=R*M,l[J+Q]+=R*N,l[K+Q]+=R*O,l[L+Q]+=R*P}return cF(l,[e,g,f,h],b.dtype)},b.prototype.resizeNearestNeighbor=function(a,b,c,d){jP(a,"resizeNearestNeighbor");for(var e=a.shape,f=e[0],g=e[1],h=e[2],i=e[3],j=this.readSync(a.dataId),k=new Float32Array(f*b*c*i),l=[d&&b>1?g-1:g,d&&c>1?h-1:h],m=[d&&b>1?b-1:b,d&&c>1?c-1:c],n=l[0]/m[0],o=l[1]/m[1],p=0,q=0;q<f;q++)for(var r=q*a.strides[0],s=0;s<b;s++)for(var t=n*s,u=r+Math.min(g-1,d?Math.round(t):Math.floor(t))*a.strides[1],v=0;v<c;v++)for(var w=o*v,x=u+Math.min(h-1,d?Math.round(w):Math.floor(w))*a.strides[2],y=0;y<i;y++){var z=j[x+y];k[p++]=z}return cz(k,[f,b,c,i],a.dtype)},b.prototype.resizeNearestNeighborBackprop=function(a,b,c){jP([a,b],"resizeNearestNeighborBackprop");for(var d=b.shape,e=d[0],f=d[1],g=d[2],h=d[3],i=a.shape,j=i[1],k=i[2],l=new Float32Array(e*f*g*h),m=this.readSync(a.dataId),n=[c&&j>1?f-1:f,c&&k>1?g-1:g],o=[c&&j>1?j-1:j,c&&k>1?k-1:k],p=n[0]/o[0],q=n[1]/o[1],r=1/p,s=1/q,t=2*Math.ceil(r)+2,u=2*Math.ceil(s)+2,v=0;v<e;v++)for(var w=v*b.strides[0],x=0;x<f;x++)for(var y=w+x*b.strides[1],z=Math.floor(x*r),A=Math.floor(z-t/2),B=0;B<g;B++)for(var C=y+B*b.strides[2],D=Math.floor(B*s),E=Math.floor(D-u/2),F=0;F<h;F++){for(var G=0,H=0;H<t;H++){var I=H+A;if(!(I<0||I>=j)){var J=w+I*a.strides[1],K=I*p;if(x===Math.min(f-1,c?Math.round(K):Math.floor(K)))for(var L=0;L<u;L++){var M=L+E;if(!(M<0||M>=k)){var N=J+M*a.strides[2],O=M*q;B===Math.min(g-1,c?Math.round(O):Math.floor(O))&&(G+=m[N+F])}}}}l[C+F]=G}return cF(l,b.shape,b.dtype)},b.prototype.batchNormalization=function(a,b,c,d,e,f){jP([a,b,c,e,f],"batchNorm");for(var g=this.readSync(a.dataId),h=this.readSync(b.dataId),i=this.readSync(c.dataId),j=e?this.readSync(e.dataId):new Float32Array([1]),k=f?this.readSync(f.dataId):new Float32Array([0]),l=new Float32Array(g.length),m=k.length,n=j.length,o=i.length,p=h.length,q=0,r=0,s=0,t=0,u=0;u<g.length;++u)l[u]=k[q++]+(g[u]-h[r++])*j[s++]/Math.sqrt(i[t++]+d),q>=m&&(q=0),r>=p&&(r=0),s>=n&&(s=0),t>=o&&(t=0);return cF(l,a.shape)},b.prototype.localResponseNormalization4D=function(a,b,c,d,e){jP(a,"localResponseNormalization4D");for(var f=a.shape[3],g=f-1,h=this.readSync(a.dataId),i=a.size,j=new Float32Array(i),k=0;k<i;k++){var l=function(a){for(var c=a%f,d=a-c+Math.max(0,c-b),e=a-c+Math.min(c+b,g),i=0;d<=e;d++){var j=h[d];i+=j*j}return i}(k),m=h[k]*Math.pow(c+d*l,-e);j[k]=m}return cF(j,a.shape)},b.prototype.LRNGrad=function(a,b,c,d,e,f,g){jP(a,"LRNGrad");for(var h=a.shape[3],i=this.readSync(a.dataId),j=this.readSync(b.dataId),k=this.readSync(c.dataId),l=new Float32Array(a.size),m=a.size,n=0;n<m;n++){for(var o=n%h,p=n-o+Math.max(0,o-d),q=n-o+Math.min(h,o+d+1),r=0,s=p;s<q;s++)r+=Math.pow(j[s],2);for(r=f*r+e,s=p;s<q;s++){var t=-2*f*g*j[s]*k[n]/r;n===s&&(t+=Math.pow(r,-g)),t*=i[n],l[s]+=t}}return cF(l,a.shape)},b.prototype.multinomial=function(a,b,c,d){jP(a,"multinomial");for(var e=b?a:d_(a),f=e.shape[0],g=e.shape[1],h=cK([f,c],"int32"),i=this.readSync(h.dataId),j=this.readSync(e.dataId),k=0;k<f;++k){var l=k*g,m=new Float32Array(g-1);m[0]=j[l];for(var n=1;n<m.length;++n)m[n]=m[n-1]+j[l+n];for(var o=c2(d.toString()),p=k*c,q=0;q<c;++q){var r=o();i[p+q]=m.length;for(var s=0;s<m.length;s++)if(r<m[s]){i[p+q]=s;break}}}return h},b.prototype.oneHot=function(a,b,c,d){jP(a,"oneHot");var e=new Float32Array(a.size*b);e.fill(d);for(var f=this.readSync(a.dataId),g=0;g<a.size;++g)f[g]>=0&&f[g]<b&&(e[g*b+f[g]]=c);return cD(e,[a.size,b],"int32")},b.prototype.nonMaxSuppression=function(a,b,c,d,e){return jP(a,"nonMaxSuppression"),eq(this.readSync(a.dataId),this.readSync(b.dataId),c,d,e)},b.prototype.fft=function(a){return this.fftBatch(a,!1)},b.prototype.ifft=function(a){return this.fftBatch(a,!0)},b.prototype.fftBatch=function(a,b){for(var c=a.shape[0],d=a.shape[1],e=c6(a.shape,"float32"),f=c6(a.shape,"float32"),g=cx(a).as2D(c,d),h=cy(a).as2D(c,d),i=0;i<c;i++)for(var j=g.slice([i,0],[1,d]),k=h.slice([i,0],[1,d]),l=cw(j,k),m=this.readSync(this.fftImpl(l,b).dataId),n=0;n<d;n++){var o=eo(m,n);e.values[i*d+n]=o.real,f.values[i*d+n]=o.imag}return cw(e.toTensor(),f.toTensor()).as2D(c,d)},b.prototype.fftImpl=function(a,b){var c=a.as1D(),d=c.size;if(this.isExponentOf2(d)){var e=this.fftRadix2(c,d,b).as2D(a.shape[0],a.shape[1]);return b&&(e=cw(cx(e).div(cB(d)),cy(e).div(cB(d)))),e}var f=this.readSync(a.dataId),g=function(a){for(var b=new Float32Array(a.length/2),c=new Float32Array(a.length/2),d=0;d<a.length;d+=2)b[d/2]=a[d],c[d/2]=a[d+1];return{real:b,imag:c}}(this.fourierTransformByMatmul(f,d,b));return cw(g.real,g.imag).as2D(a.shape[0],a.shape[1])},b.prototype.isExponentOf2=function(a){return 0==(a&a-1)},b.prototype.fftRadix2=function(a,b,c){if(1===b)return a;var d=this.readSync(a.dataId),e=b/2,f=function(a){for(var b=Math.ceil(a.length/4),c=new Float32Array(b),d=new Float32Array(b),e=0;e<a.length;e+=4)c[Math.floor(e/4)]=a[e],d[Math.floor(e/4)]=a[e+1];return{real:c,imag:d}}(d),g=cw(f.real,f.imag).as1D(),h=function(a){for(var b=Math.floor(a.length/4),c=new Float32Array(b),d=new Float32Array(b),e=2;e<a.length;e+=4)c[Math.floor(e/4)]=a[e],d[Math.floor(e/4)]=a[e+1];return{real:c,imag:d}}(d),i=cw(h.real,h.imag).as1D();g=this.fftRadix2(g,e,c),i=this.fftRadix2(i,e,c);var j=function(a,b){for(var c=new Float32Array(a/2),d=new Float32Array(a/2),e=0;e<Math.ceil(a/2);e++){var f=(b?2:-2)*Math.PI*(e/a);c[e]=Math.cos(f),d[e]=Math.sin(f)}return{real:c,imag:d}}(b,c),k=cw(j.real,j.imag).mul(i),l=g.add(k),m=g.sub(k);return cw(cx(l).concat(cx(m)),cy(l).concat(cy(m))).as1D()},b.prototype.fourierTransformByMatmul=function(a,b,c){for(var d=new Float32Array(2*b),e=0;e<b;e++){for(var f,g,h,i=0,j=0,k=0;k<b;k++){var l=function(a,b,c){var d=(c?2:-2)*Math.PI*(a/b);return{real:Math.cos(d),imag:Math.sin(d)}}(e*k,b,c),m=eo(a,k);i+=m.real*l.real-m.imag*l.imag,j+=m.real*l.imag+m.imag*l.real}c&&(i/=b,j/=b),f=i,g=j,d[2*(h=e)]=f,d[2*h+1]=g}return d},b.prototype.depthToSpace=function(a,b,c){K("NHWC"===c,function(){return"Only NHWC dataFormat supported on CPU for depthToSpace. Got "+c}),K(b>1,function(){return"blockSize should be > 1 for depthToSpace, but was: "+b});for(var d=a.shape[0],e=a.shape[1],f=a.shape[2],g=a.shape[3],h=e*b,i=f*b,j=g/(b*b),k=this.readSync(a.dataId),l=new Float32Array(d*h*i*j),m=0,n=0;n<d;++n)for(var o=0;o<h;++o)for(var p=Math.floor(o/b),q=o%b,r=0;r<i;++r)for(var s=Math.floor(r/b),t=(q*b+r%b)*j,u=0;u<j;++u){var v=u+t+g*(s+f*(p+e*n));l[m++]=k[v]}return cF(l,[d,h,i,j])},b.prototype.broadcastedBinaryOp=function(a,b,c,d){var e=d6(a.shape,b.shape),f=c6(e,c),g=this.readSync(a.dataId),h=this.readSync(b.dataId),i=d4(a.shape,e),j=d4(b.shape,e),k=f.values;if(i.length+j.length===0)for(var l=0;l<k.length;++l)k[l]=d(g[l%g.length],h[l%h.length]);else{var m=this.bufferSync(a),n=this.bufferSync(b);for(l=0;l<k.length;++l)!function(c){var e=f.indexToLoc(c),l=e.slice(-a.rank);i.forEach(function(a){return l[a]=0});var o=m.locToIndex(l),p=e.slice(-b.rank);j.forEach(function(a){return p[a]=0});var q=n.locToIndex(p);k[c]=d(g[o],h[q])}(l)}return f.toTensor()},b.prototype.broadcastedBinaryComplexOp=function(a,b,c){var d=d6(a.shape,b.shape),e=c6(d,"float32"),f=c6(d,"float32"),g=this.readSync(a.dataId),h=this.readSync(b.dataId),i=d4(a.shape,d),j=d4(b.shape,d),k=e.values,l=f.values;if(i.length+j.length===0)for(var m=0;m<k.length;m++){var n=m%g.length,o=m%h.length,p=c(g[2*n],g[2*n+1],h[2*o],h[2*o+1]);k[m]=p.real,l[m]=p.imag}else{var q=this.bufferSync(this.data.get(a.dataId).complexTensors.real),r=this.bufferSync(this.data.get(b.dataId).complexTensors.real);for(m=0;m<k.length;m++)!function(d){var f=e.indexToLoc(d),m=f.slice(-a.rank);i.forEach(function(a){return m[a]=0});var n=q.locToIndex(m),o=f.slice(-b.rank);j.forEach(function(a){return o[a]=0});var p=r.locToIndex(o),s=c(g[2*n],g[2*n+1],h[2*p],h[2*p+1]);k[d]=s.real,l[d]=s.imag}(m)}return this.complex(e.toTensor(),f.toTensor())},b.prototype.split=function(a,b,c){return eu(a,b,c)},b.prototype.dispose=function(){},b.prototype.floatPrecision=function(){return 32},b.prototype.epsilon=function(){return 1e-7},b.prototype.cropAndResize=function(a,b,c,d,e,f){for(var g=a.shape,h=g[0],i=g[1],j=g[2],k=g[3],l=b.shape[0],m=d[0],n=d[1],o=c6([l,m,n,k],"float32"),p=this.readSync(b.dataId),q=this.readSync(c.dataId),r=this.readSync(a.dataId),s=a.strides,t=o.strides,u=0;u<l;u++){var v=4*u,w=p[v],x=p[v+1],y=p[v+2],z=p[v+3],A=q[u];if(!(A>=h))for(var B=m>1?(y-w)*(i-1)/(m-1):0,C=n>1?(z-x)*(j-1)/(n-1):0,D=0;D<m;D++){var E,F=m>1?w*(i-1)+D*B:.5*(w+y)*(i-1);if(F<0||F>i-1)for(var G=0;G<n;G++)for(var H=0;H<k;H++){var I=H+G*t[2]+D*t[1]+u*t[0];o.values[I]=f}else if("bilinear"===e){var J=Math.floor(F),K=Math.ceil(F),L=F-J;for(G=0;G<n;G++)if((E=n>1?x*(j-1)+G*C:.5*(x+z)*(j-1))<0||E>j-1)for(H=0;H<k;H++)I=H+G*t[2]+D*t[1]+u*t[0],o.values[I]=f;else{var M=Math.floor(E),N=Math.ceil(E),O=E-M;for(H=0;H<k;H++){var P=r[I=H+M*s[2]+J*s[1]+A*s[0]],Q=r[I=H+N*s[2]+J*s[1]+A*s[0]],R=r[I=H+M*s[2]+K*s[1]+A*s[0]],S=P+(Q-P)*O,T=R+(r[I=H+N*s[2]+K*s[1]+A*s[0]]-R)*O;I=H+G*t[2]+D*t[1]+u*t[0],o.values[I]=S+(T-S)*L}}}else for(G=0;G<n;++G)if((E=n>1?x*(j-1)+G*C:.5*(x+z)*(j-1))<0||E>j-1)for(H=0;H<k;H++)I=H+G*t[2]+D*t[1]+u*t[0],o.values[I]=f;else{var U=Math.round(E),V=Math.round(F);for(H=0;H<k;H++){var W=H+U*s[2]+V*s[1]+A*s[0],X=H+G*t[2]+D*t[1]+u*t[0];o.values[X]=r[W]}}}}return o.toTensor()},b.prototype.sparseToDense=function(a,b,c,d){var e=dK(0,a,c),f=e.sliceRank,g=e.numUpdates,h=e.sliceSize,i=e.strides,j=e.outputSize;return this.scatter(a,b,c,j,h,g,f,i,d,!1)},b.prototype.gatherND=function(a,b){var c=b.shape,d=c[c.length-1],e=dF(a,b),f=e[0],g=e[1],h=e[2],i=e[3];if(0===g)return cz([],f,a.dtype);for(var j=new aB([g,h],a.dtype),k=this.readSync(b.dataId),l=this.readSync(a.dataId),m=0;m<g;m++){for(var n=[],o=0,p=0;p<d;p++){var q=k[m*d+p];o+=q*i[p],n.push(q)}if(o<0||o>=a.size/h)throw Error("Invalid indices: "+n+" does not index into "+a.shape);for(var r=0;r<h;r++)j.values[m*h+r]=l[o*h+r]}return j.toTensor().reshape(f)},b.prototype.scatterND=function(a,b,c){var d=dK(0,a,c),e=d.sliceRank,f=d.numUpdates,g=d.sliceSize,h=d.strides,i=d.outputSize,j=cB(0);return this.scatter(a,b,c,i,g,f,e,h,j,!0)},b.prototype.fill=function(a,b,c){var d=Z(c=c||ah(b),O(a));return d.fill(b),a_.makeTensor(d,a,c,this)},b.prototype.onesLike=function(a){if("string"===a.dtype)throw Error("onesLike is not supported for string tensors");return this.fill(a.shape,1,a.dtype)},b.prototype.zerosLike=function(a){var b=Z(a.dtype,O(a.shape));return this.makeOutput(b,a.shape,a.dtype)},b.prototype.linspace=function(a,b,c){return el(a,b,c)},b.prototype.scatter=function(a,b,c,d,e,f,g,h,i,j){var k=this.readSync(a.dataId),l=this.readSync(b.dataId);if(0===d)return cz([],c,b.dtype);var m=new aB([d/e,e],b.dtype);m.values.fill(this.readSync(i.dataId)[0]);for(var n=0;n<f;n++){for(var o=[],p=0,q=0;q<g;q++){var r=k[n*g+q];o.push(r),p+=r*h[q]}if(p<0||p>=d/e)throw Error("Invalid indices: "+o+" does not index into "+c);for(var s=0;s<e;s++)j?m.values[p*e+s]+=l[n*e+s]:m.values[p*e+s]=0===b.rank?l[0]:l[n*e+s]}return m.toTensor().reshape(c)},b}(d2);a_.registerBackend("cpu",function(){return new jR},1);for(var jS=0,jT=[{kernelName:"NonMaxSuppressionV5",backendName:"cpu",kernelFunc:function(a){var b=a.inputs,c=a.backend,d=a.attrs,e=b.boxes,f=b.scores,g=d.maxOutputSize,h=d.iouThreshold,i=d.scoreThreshold,j=d.softNmsSigma;jP(e,"NonMaxSuppressionWithScore");var k=er(c.data.get(e.dataId).values,c.data.get(f.dataId).values,g,h,i,j);return[k.selectedIndices,k.selectedScores]}},{kernelName:"Square",backendName:"cpu",kernelFunc:function(a){var b=a.inputs,c=a.backend,d=b.x;jP(d,"square");for(var e=c.data.get(d.dataId).values,f=new Float32Array(e.length),g=0;g<e.length;++g){var h=e[g];f[g]=h*h}return{dataId:c.write(f,d.shape,d.dtype),shape:d.shape,dtype:d.dtype}}},{kernelName:gN,backendName:"cpu",kernelFunc:function(a){var b=a.inputs,c=a.backend,d=b.a,e=b.b;jP([d,e],gN);var f=c.data.get(d.dataId).values,g=c.data.get(e.dataId).values,h=function(a,b,c,d,e,f){var g=d6(a,b),h=g.length,i=ak(g),j=Y(e,O(g)),k=a.length,l=b.length,m=ak(a),n=ak(b),o=d4(a,g),p=d4(b,g);if(o.length+p.length===0)for(var q=0;q<j.length;++q)j[q]=f(c[q%c.length],d[q%d.length]);else for(q=0;q<j.length;++q)!function(a){var b=au(a,h,i),e=b.slice(-k);o.forEach(function(a){return e[a]=0});var g=at(e,k,m),q=b.slice(-l);p.forEach(function(a){return q[a]=0});var r=at(q,l,n);j[a]=f(c[g],d[r])}(q);return[j,g]}(d.shape,e.shape,f,g,d.dtype,function(a,b){var c=a-b;return c*c}),i=h[0],j=h[1];return{dataId:c.write(i,j,d.dtype),shape:j,dtype:d.dtype}}}];jS<jT.length;jS++)C(jT[jS]);for(var jU,jV,jW=function(a){this.variableNames=["A"];var b=eD(),c=a[0],d=a[1];this.outputShape=a,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n        vec2 uv = (vec2(texC, texR) + halfCR) / vec2("+d+".0, "+c+".0);\n\n        vec4 values = "+b.texture2D+"(A, uv);\n        float value;\n        if (depth == 0) {\n          value = values.r;\n        } else if (depth == 1) {\n          value = values.g;\n        } else if (depth == 2) {\n          value = values.b;\n        } else if (depth == 3) {\n          value = values.a;\n        }\n\n        setOutput(floor(value * 255.0 + 0.5));\n      }\n    "},jX=function(a){this.variableNames=["A"],this.packedInputs=!1,this.packedOutput=!0;var b=eD(),c=a[0],d=a[1];this.outputShape=a,this.userCode="\n      void main() {\n        ivec3 coords = getOutputCoords();\n        int texR = coords[0];\n        int texC = coords[1];\n        int depth = coords[2];\n\n        vec4 result = vec4(0.);\n\n        for(int row=0; row<=1; row++) {\n          for(int col=0; col<=1; col++) {\n            texC = coords[1] + row;\n            depth = coords[2] + col;\n\n            vec2 uv = (vec2(texC, texR) + halfCR) /\n                       vec2("+d+".0, "+c+".0);\n            vec4 values = "+b.texture2D+"(A, uv);\n            float value;\n            if (depth == 0) {\n              value = values.r;\n            } else if (depth == 1) {\n              value = values.g;\n            } else if (depth == 2) {\n              value = values.b;\n            } else if (depth == 3) {\n              value = values.a;\n            }\n\n            result[row * 2 + col] = floor(value * 255.0 + 0.5);\n          }\n        }\n\n        "+b.output+" = result;\n      }\n    "},jY=0,jZ=[{kernelName:"FromPixels",backendName:"webgl",kernelFunc:function(a){var b=a.inputs,c=a.backend,d=a.attrs,e=b.pixels,f=d.numChannels,g="undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement,h="undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement,i=g?[e.videoWidth,e.videoHeight]:[e.width,e.height],j=i[0],k=i[1],l=[k,j],m=[k,j,f];(h||g)&&(null==jV&&(jV=document.createElement("canvas").getContext("2d")),jV.canvas.width=j,jV.canvas.height=k,jV.drawImage(e,0,0,j,k),e=jV.canvas);var n=c.makeTensorInfo(l,"int32");c.texData.get(n.dataId).usage=a3.PIXELS,c.gpgpu.uploadPixelDataToTexture(c.getTexture(n.dataId),e);var o=w.getBool("WEBGL_PACK")?new jX(m):new jW(m),p=c.runWebGLProgram(o,[n],"int32");return c.disposeData(n.dataId),p}},{kernelName:"NonMaxSuppressionV5",backendName:"webgl",kernelFunc:function(a){var b=a.inputs,c=a.backend,d=a.attrs;cg("tf.nonMaxSuppression() in webgl locks the UI thread. Call tf.nonMaxSuppressionAsync() instead");var e=b.boxes,f=b.scores,g=d.maxOutputSize,h=d.iouThreshold,i=d.scoreThreshold,j=d.softNmsSigma,k=er(c.readSync(e.dataId),c.readSync(f.dataId),g,h,i,j);return[k.selectedIndices,k.selectedScores]}},{kernelName:"Square",backendName:"webgl",kernelFunc:function(a){var b=a.inputs,c=a.backend,d=b.x,e=new gk(d.shape,"return x * x;");return c.runWebGLProgram(e,[d],d.dtype)}},{kernelName:gN,backendName:"webgl",kernelFunc:function(a){var b=a.inputs,c=a.backend,d=b.a,e=b.b,f=w.getBool("WEBGL_PACK_BINARY_OPERATIONS")?new eY("return (a - b) * (a - b);",d.shape,e.shape):new eW("return (a - b) * (a - b);",d.shape,e.shape);return c.compileAndRun(f,[d,e])}}];jY<jZ.length;jY++)C(jZ[jY]);for(var j$=0,j_=[{kernelName:"Square",gradFunc:function(a,b){var c=b[0];return{x:function(){return a.mul(c.toFloat().mul(2))}}}},{kernelName:gN,gradFunc:function(a,b){var c=b[0],d=b[1],e=cB(2);return{a:function(){return hT(a,hT(e,hY(c,d)))},b:function(){return hT(a,hT(e,hY(d,c)))}}}}];j$<j_.length;j$++)D(j_[j$]);var j0=function(){function a(){}return a.prototype.fetch=function(a,b){return fetch(a,b)},a.prototype.now=function(){return performance.now()},a.prototype.encode=function(a,b){if("utf-8"!==b&&"utf8"!==b)throw Error("Browser's encoder only supports utf-8, but got "+b);return null==this.textEncoder&&(this.textEncoder=new TextEncoder),this.textEncoder.encode(a)},a.prototype.decode=function(a,b){return new TextDecoder(b).decode(a)},a}();w.get("IS_BROWSER")&&w.setPlatform("browser",new j0);var j1,j2=function(){function b(){this.util=a.r(24361),this.textEncoder=new this.util.TextEncoder}return b.prototype.fetch=function(b,c){return null!=w.global.fetch?w.global.fetch(b,c):(null==j1&&(j1=a.r(1051)),j1(b,c))},b.prototype.now=function(){var a=process.hrtime();return 1e3*a[0]+a[1]/1e6},b.prototype.encode=function(a,b){if("utf-8"!==b&&"utf8"!==b)throw Error("Node built-in encoder only supports utf-8, but got "+b);return this.textEncoder.encode(a)},b.prototype.decode=function(a,b){return 0===a.length?"":new this.util.TextDecoder(b).decode(a)},b}();w.get("IS_NODE")&&w.setPlatform("node",new j2);var j3={float32:4,int32:4,uint16:2,uint8:1,bool:1};function j4(a,b){for(var c={},d=0,e=0;e<b.length;e++)!function(b){var e=b.name,f=b.dtype,g=b.shape,h=O(g),i=void 0;if("quantization"in b){var j=b.quantization;if("uint8"!==j.dtype&&"uint16"!==j.dtype)throw Error("Weight "+b.name+" has unknown quantization dtype "+j.dtype+". Supported quantization dtypes are: 'uint8' and 'uint16'.");var k=j3[j.dtype],l=a.slice(d,d+h*k),m="uint8"===j.dtype?new Uint8Array(l):new Uint16Array(l);if("float32"===f)i=Float32Array.from(m,function(a){return a*j.scale+j.min});else{if("int32"!==f)throw Error("Unsupported dtype in weight '"+e+"': "+f);i=Int32Array.from(m,function(a){return Math.round(a*j.scale+j.min)})}d+=h*k}else if("string"===f){var n=O(b.shape);i=[];for(var o=0;o<n;o++){var p=new Uint32Array(a.slice(d,d+4))[0];d+=4;var q=new Uint8Array(a.slice(d,d+p));i.push(q),d+=p}}else{var r=j3[f];if(l=a.slice(d,d+h*r),"float32"===f)i=new Float32Array(l);else if("int32"===f)i=new Int32Array(l);else{if("bool"!==f)throw Error("Unsupported dtype in weight '"+e+"': "+f);i=new Uint8Array(l)}d+=h*r}c[e]=cz(i,g,f)}(b[e]);return c}var j5="undefined"!=typeof Buffer&&("undefined"==typeof Blob||"undefined"==typeof atob||"undefined"==typeof btoa);function j6(a){return j5?Buffer.byteLength(a):new Blob([a]).size}function j7(a){var b=0;a.forEach(function(a){b+=a.byteLength});var c=new Uint8Array(b),d=0;return a.forEach(function(a){c.set(new Uint8Array(a),d),d+=a.byteLength}),c.buffer}function j8(a){for(a=a.trim();a.endsWith("/");)a=a.slice(0,a.length-1);var b=a.split("/");return b[b.length-1]}function j9(a){if(a.modelTopology instanceof ArrayBuffer)throw Error("Expected JSON model topology, received ArrayBuffer.");return{dateSaved:new Date,modelTopologyType:"JSON",modelTopologyBytes:null==a.modelTopology?0:j6(JSON.stringify(a.modelTopology)),weightSpecsBytes:null==a.weightSpecs?0:j6(JSON.stringify(a.weightSpecs)),weightDataBytes:null==a.weightData?0:a.weightData.byteLength}}var ka=function(){function a(){this.saveRouters=[],this.loadRouters=[]}return a.getInstance=function(){return null==a.instance&&(a.instance=new a),a.instance},a.registerSaveRouter=function(b){a.getInstance().saveRouters.push(b)},a.registerLoadRouter=function(b){a.getInstance().loadRouters.push(b)},a.getSaveHandlers=function(b){return a.getHandlers(b,"save")},a.getLoadHandlers=function(b,c){return a.getHandlers(b,"load",c)},a.getHandlers=function(b,c,d){var e=[];return("load"===c?a.getInstance().loadRouters:a.getInstance().saveRouters).forEach(function(a){var c=a(b,d);null!==c&&e.push(c)}),e},a}(),kb=function(){function a(){this.managers={}}return a.getInstance=function(){return null==a.instance&&(a.instance=new a),a.instance},a.registerManager=function(b,c){K(null!=b,function(){return"scheme must not be undefined or null."}),b.endsWith("://")&&(b=b.slice(0,b.indexOf("://"))),K(b.length>0,function(){return"scheme must not be an empty string."});var d=a.getInstance();K(null==d.managers[b],function(){return"A model store manager is already registered for scheme '"+b+"'."}),d.managers[b]=c},a.getManager=function(a){var b=this.getInstance().managers[a];if(null==b)throw Error("Cannot find model manager for scheme '"+a+"'");return b},a.getSchemes=function(){return Object.keys(this.getInstance().managers)},a}();function kc(a){if(-1===a.indexOf("://"))throw Error("The url string provided does not contain a scheme. Supported schemes are: "+kb.getSchemes().join(","));return{scheme:a.split("://")[0],path:a.split("://")[1]}}function kd(a,b,c){return void 0===c&&(c=!1),s(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l;return t(this,function(m){switch(m.label){case 0:return K(a!==b,function(){return"Old path and new path are the same: '"+a+"'"}),K((d=ka.getLoadHandlers(a)).length>0,function(){return"Copying failed because no load handler is found for source URL "+a+"."}),K(d.length<2,function(){return"Copying failed because more than one ("+d.length+") load handlers for source URL "+a+"."}),e=d[0],K((f=ka.getSaveHandlers(b)).length>0,function(){return"Copying failed because no save handler is found for destination URL "+b+"."}),K(f.length<2,function(){return"Copying failed because more than one ("+d.length+") save handlers for destination URL "+b+"."}),g=f[0],h=kc(a).scheme,i=kc(a).path,j=h===kc(a).scheme,[4,e.load()];case 1:return k=m.sent(),c&&j?[4,kb.getManager(h).removeModel(i)]:[3,3];case 2:m.sent(),m.label=3;case 3:return[4,g.save(k)];case 4:return l=m.sent(),!c||j?[3,6]:[4,kb.getManager(h).removeModel(i)];case 5:m.sent(),m.label=6;case 6:return[2,l.modelArtifactsInfo]}})})}var ke="models_store",kf="model_info_store";function kg(){if(!w.getBool("IS_BROWSER"))throw Error("Failed to obtain IndexedDB factory because the current environmentis not a web browser.");var a=window||self,b=a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB||a.shimIndexedDB;if(null==b)throw Error("The current browser does not appear to support IndexedDB.");return b}function kh(a){var b=a.result;b.createObjectStore(ke,{keyPath:"modelPath"}),b.createObjectStore(kf,{keyPath:"modelPath"})}var ki=function(){function a(a){if(this.indexedDB=kg(),null==a||!a)throw Error("For IndexedDB, modelPath must not be null, undefined or empty.");this.modelPath=a}return a.prototype.save=function(a){return s(this,void 0,void 0,function(){return t(this,function(b){if(a.modelTopology instanceof ArrayBuffer)throw Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");return[2,this.databaseAction(this.modelPath,a)]})})},a.prototype.load=function(){return s(this,void 0,void 0,function(){return t(this,function(a){return[2,this.databaseAction(this.modelPath)]})})},a.prototype.databaseAction=function(a,b){var c=this;return new Promise(function(a,d){var e=c.indexedDB.open("tensorflowjs",1);e.onupgradeneeded=function(){return kh(e)},e.onsuccess=function(){var f=e.result;if(null==b){var g=f.transaction(ke,"readonly"),h=g.objectStore(ke).get(c.modelPath);h.onsuccess=function(){if(null==h.result)return f.close(),d(Error("Cannot find model with path '"+c.modelPath+"' in IndexedDB."));a(h.result.modelArtifacts)},h.onerror=function(a){return f.close(),d(h.error)},g.oncomplete=function(){return f.close()}}else{var i,j=j9(b),k=f.transaction(kf,"readwrite"),l=k.objectStore(kf),m=l.put({modelPath:c.modelPath,modelArtifactsInfo:j});m.onsuccess=function(){var e=(i=f.transaction(ke,"readwrite")).objectStore(ke).put({modelPath:c.modelPath,modelArtifacts:b,modelArtifactsInfo:j});e.onsuccess=function(){return a({modelArtifactsInfo:j})},e.onerror=function(a){var b=(l=k.objectStore(kf)).delete(c.modelPath);b.onsuccess=function(){return f.close(),d(e.error)},b.onerror=function(a){return f.close(),d(e.error)}}},m.onerror=function(a){return f.close(),d(m.error)},k.oncomplete=function(){null==i?f.close():i.oncomplete=function(){return f.close()}}}},e.onerror=function(a){return d(e.error)}})},a.URL_SCHEME="indexeddb://",a}(),kj=function(a){var b;return w.getBool("IS_BROWSER")&&!Array.isArray(a)&&a.startsWith(ki.URL_SCHEME)?(b=a.slice(ki.URL_SCHEME.length),new ki(b)):null};ka.registerSaveRouter(kj),ka.registerLoadRouter(kj);var kk=function(){function a(){this.indexedDB=kg()}return a.prototype.listModels=function(){return s(this,void 0,void 0,function(){var a=this;return t(this,function(b){return[2,new Promise(function(b,c){var d=a.indexedDB.open("tensorflowjs",1);d.onupgradeneeded=function(){return kh(d)},d.onsuccess=function(){var a=d.result,e=a.transaction(kf,"readonly"),f=e.objectStore(kf).getAll();f.onsuccess=function(){for(var a={},c=0,d=f.result;c<d.length;c++){var e=d[c];a[e.modelPath]=e.modelArtifactsInfo}b(a)},f.onerror=function(b){return a.close(),c(f.error)},e.oncomplete=function(){return a.close()}},d.onerror=function(a){return c(d.error)}})]})})},a.prototype.removeModel=function(a){return s(this,void 0,void 0,function(){var b=this;return t(this,function(c){var d;return a=(d=a).startsWith(ki.URL_SCHEME)?d.slice(ki.URL_SCHEME.length):d,[2,new Promise(function(c,d){var e=b.indexedDB.open("tensorflowjs",1);e.onupgradeneeded=function(){return kh(e)},e.onsuccess=function(){var b,f=e.result,g=f.transaction(kf,"readwrite"),h=g.objectStore(kf),i=h.get(a);i.onsuccess=function(){if(null==i.result)return f.close(),d(Error("Cannot find model with path '"+a+"' in IndexedDB."));var e=h.delete(a),g=function(){var e=(b=f.transaction(ke,"readwrite")).objectStore(ke).delete(a);e.onsuccess=function(){return c(i.result.modelArtifactsInfo)},e.onerror=function(a){return d(i.error)}};e.onsuccess=g,e.onerror=function(a){return g(),f.close(),d(i.error)}},i.onerror=function(a){return f.close(),d(i.error)},g.oncomplete=function(){null==b?f.close():b.oncomplete=function(){return f.close()}}},e.onerror=function(a){return d(e.error)}})]})})},a}();if(w.getBool("IS_BROWSER"))try{kb.registerManager(ki.URL_SCHEME,new kk)}catch(a){}var kl="tensorflowjs_models",km="info",kn=function(){function a(a){throw w.getBool("IS_BROWSER"),Error("The current environment does not support local storage.")}return a.prototype.save=function(a){return s(this,void 0,void 0,function(){var b,c,d;return t(this,function(e){if(a.modelTopology instanceof ArrayBuffer)throw Error("BrowserLocalStorage.save() does not support saving model topology in binary formats yet.");b=JSON.stringify(a.modelTopology),c=JSON.stringify(a.weightSpecs),d=j9(a);try{return this.LS.setItem(this.keys.info,JSON.stringify(d)),this.LS.setItem(this.keys.topology,b),this.LS.setItem(this.keys.weightSpecs,c),this.LS.setItem(this.keys.weightData,function(a){if(j5)return Buffer.from(a).toString("base64");for(var b=new Uint8Array(a),c="",d=0,e=b.length;d<e;d++)c+=String.fromCharCode(b[d]);return btoa(c)}(a.weightData)),this.LS.setItem(this.keys.modelMetadata,JSON.stringify({format:a.format,generatedBy:a.generatedBy,convertedBy:a.convertedBy,userDefinedMetadata:a.userDefinedMetadata})),[2,{modelArtifactsInfo:d}]}catch(a){throw this.LS.removeItem(this.keys.info),this.LS.removeItem(this.keys.topology),this.LS.removeItem(this.keys.weightSpecs),this.LS.removeItem(this.keys.weightData),this.LS.removeItem(this.keys.modelMetadata),Error("Failed to save model '"+this.modelPath+"' to local storage: size quota being exceeded is a possible cause of this failure: modelTopologyBytes="+d.modelTopologyBytes+", weightSpecsBytes="+d.weightSpecsBytes+", weightDataBytes="+d.weightDataBytes+".")}})})},a.prototype.load=function(){return s(this,void 0,void 0,function(){var a,b,c,d,e,f,g;return t(this,function(h){if(null==(a=JSON.parse(this.LS.getItem(this.keys.info))))throw Error("In local storage, there is no model with name '"+this.modelPath+"'");if("JSON"!==a.modelTopologyType)throw Error("BrowserLocalStorage does not support loading non-JSON model topology yet.");if(b={},null==(c=JSON.parse(this.LS.getItem(this.keys.topology))))throw Error("In local storage, the topology of model '"+this.modelPath+"' is missing.");if(b.modelTopology=c,null==(d=JSON.parse(this.LS.getItem(this.keys.weightSpecs))))throw Error("In local storage, the weight specs of model '"+this.modelPath+"' are missing.");if(b.weightSpecs=d,null!=(e=this.LS.getItem(this.keys.modelMetadata))&&(b.format=(f=JSON.parse(e)).format,b.generatedBy=f.generatedBy,b.convertedBy=f.convertedBy,b.userDefinedMetadata=f.userDefinedMetadata),null==(g=this.LS.getItem(this.keys.weightData)))throw Error("In local storage, the binary weight values of model '"+this.modelPath+"' are missing.");return b.weightData=function(a){if(j5){var b=Buffer.from(a,"base64");return b.buffer.slice(b.byteOffset,b.byteOffset+b.byteLength)}for(var c=atob(a),d=new Uint8Array(c.length),e=0;e<c.length;++e)d.set([c.charCodeAt(e)],e);return d.buffer}(g),[2,b]})})},a.URL_SCHEME="localstorage://",a}(),ko=function(a){var b;return w.getBool("IS_BROWSER")&&!Array.isArray(a)&&a.startsWith(kn.URL_SCHEME)?(b=a.slice(kn.URL_SCHEME.length),new kn(b)):null};ka.registerSaveRouter(ko),ka.registerLoadRouter(ko);var kp=function(){function a(){K(w.getBool("IS_BROWSER"),function(){return"Current environment is not a web browser"}),K(!0,function(){return"Current browser does not appear to support localStorage"}),this.LS=window.localStorage}return a.prototype.listModels=function(){return s(this,void 0,void 0,function(){var a,b,c,d,e;return t(this,function(f){for(a={},b=kl+"/",c="/"+km,d=0;d<this.LS.length;++d)(e=this.LS.key(d)).startsWith(b)&&e.endsWith(c)&&(a[function(a){var b=a.split("/");if(b.length<3)throw Error("Invalid key format: "+a);return b.slice(1,b.length-1).join("/")}(e)]=JSON.parse(this.LS.getItem(e)));return[2,a]})})},a.prototype.removeModel=function(a){return s(this,void 0,void 0,function(){var b,c;return t(this,function(d){var e,f;if(b={info:[kl,f=a=(e=a).startsWith(kn.URL_SCHEME)?e.slice(kn.URL_SCHEME.length):e,km].join("/"),topology:[kl,f,"model_topology"].join("/"),weightSpecs:[kl,f,"weight_specs"].join("/"),weightData:[kl,f,"weight_data"].join("/"),modelMetadata:[kl,f,"model_metadata"].join("/")},null==this.LS.getItem(b.info))throw Error("Cannot find model at path '"+a+"'");return c=JSON.parse(this.LS.getItem(b.info)),this.LS.removeItem(b.info),this.LS.removeItem(b.topology),this.LS.removeItem(b.weightSpecs),this.LS.removeItem(b.weightData),[2,c]})})},a}();if(w.getBool("IS_BROWSER"))try{kb.registerManager(kn.URL_SCHEME,new kp)}catch(a){}function kq(a){return new Promise(function(a){return setTimeout(a)}).then(a)}var kr=function(){function a(b){if(!w.getBool("IS_BROWSER"))throw Error("browserDownloads() cannot proceed because the current environment is not a browser.");b.startsWith(a.URL_SCHEME)&&(b=b.slice(a.URL_SCHEME.length)),null!=b&&0!==b.length||(b="model"),this.modelTopologyFileName=b+".json",this.weightDataFileName=b+".weights.bin"}return a.prototype.save=function(a){return s(this,void 0,void 0,function(){var b,c,d,e,f,g;return t(this,function(h){switch(h.label){case 0:if("undefined"==typeof document)throw Error("Browser downloads are not supported in this environment since `document` is not present");if(b=window.URL.createObjectURL(new Blob([a.weightData],{type:"application/octet-stream"})),!(a.modelTopology instanceof ArrayBuffer))return[3,1];throw Error("BrowserDownloads.save() does not support saving model topology in binary formats yet.");case 1:return c=[{paths:["./"+this.weightDataFileName],weights:a.weightSpecs}],d={modelTopology:a.modelTopology,format:a.format,generatedBy:a.generatedBy,convertedBy:a.convertedBy,weightsManifest:c},e=window.URL.createObjectURL(new Blob([JSON.stringify(d)],{type:"application/json"})),(f=null==this.jsonAnchor?document.createElement("a"):this.jsonAnchor).download=this.modelTopologyFileName,f.href=e,[4,kq(function(){return f.dispatchEvent(new MouseEvent("click"))})];case 2:return h.sent(),null==a.weightData?[3,4]:((g=null==this.weightDataAnchor?document.createElement("a"):this.weightDataAnchor).download=this.weightDataFileName,g.href=b,[4,kq(function(){return g.dispatchEvent(new MouseEvent("click"))})]);case 3:h.sent(),h.label=4;case 4:return[2,{modelArtifactsInfo:j9(a)}]}})})},a.URL_SCHEME="downloads://",a}(),ks=function(){function a(a){if(null==a||a.length<1)throw Error("When calling browserFiles, at least 1 file is required, but received "+a);this.files=a}return a.prototype.load=function(){return s(this,void 0,void 0,function(){var a,b,c=this;return t(this,function(d){return a=this.files[0],b=this.files.slice(1),[2,new Promise(function(d,e){var f=new FileReader;f.onload=function(f){var g=JSON.parse(f.target.result),h=g.modelTopology;if(null!=h){0===b.length&&d({modelTopology:h});var i=g.weightsManifest;if(null!=i){try{j=c.checkManifestAndWeightFiles(i,b)}catch(a){return void e(a)}var j,k=[],l=[],m=[];i.forEach(function(a){a.paths.forEach(function(a){l.push(a),m.push(null)}),k.push.apply(k,a.weights)}),i.forEach(function(a){a.paths.forEach(function(a){var b=new FileReader;b.onload=function(b){var c=b.target.result;m[l.indexOf(a)]=c,-1===m.indexOf(null)&&d({modelTopology:h,weightSpecs:k,weightData:j7(m),format:g.format,generatedBy:g.generatedBy,convertedBy:g.convertedBy,userDefinedMetadata:g.userDefinedMetadata})},b.onerror=function(b){return e("Failed to weights data from file of path '"+a+"'.")},b.readAsArrayBuffer(j[a])})})}else e(Error("weightManifest field is missing from file "+a.name))}else e(Error("modelTopology field is missing from file "+a.name))},f.onerror=function(b){return e("Failed to read model topology and weights manifest JSON from file '"+a.name+"'. BrowserFiles supports loading Keras-style tf.Model artifacts only.")},f.readAsText(a)})]})})},a.prototype.checkManifestAndWeightFiles=function(a,b){for(var c=[],d=b.map(function(a){return j8(a.name)}),e={},f=0;f<a.length;f++)a[f].paths.forEach(function(a){var f=j8(a);if(-1!==c.indexOf(f))throw Error("Duplicate file basename found in weights manifest: '"+f+"'");if(c.push(f),-1===d.indexOf(f))throw Error("Weight file with basename '"+f+"' is not provided.");e[a]=b[d.indexOf(f)]});if(c.length!==b.length)throw Error("Mismatch in the number of files in weights manifest ("+c.length+") and the number of weight files provided ("+b.length+").");return e},a}();function kt(a,b,c,d){K(null!=a&&Array.isArray(a)&&a.length>0,function(){return"promises must be a none empty array"}),e=c=null==c?0:c,f=d=null==d?1:d,K(e>=0&&e<=1,function(){return"Progress fraction must be in range [0, 1], but got startFraction "+e}),K(f>=0&&f<=1,function(){return"Progress fraction must be in range [0, 1], but got endFraction "+f}),K(f>=e,function(){return"startFraction must be no more than endFraction, but got startFraction "+e+" and endFraction "+f});var e,f,g=0;return Promise.all(a.map(function(e){return e.then(function(e){return b(c+ ++g/a.length*(d-c)),e}),e}))}function ku(a,b){return s(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k;return t(this,function(l){switch(l.label){case 0:return null==b&&(b={}),c=null==b.fetchFunc?w.platform.fetch:b.fetchFunc,d=a.map(function(a){return c(a,b.requestInit,{isBinary:!0})}),e=0,f=.5,null!=b.onProgress?[3,2]:[4,Promise.all(d)];case 1:return g=l.sent(),[3,4];case 2:return[4,kt(d,b.onProgress,e,f)];case 3:g=l.sent(),l.label=4;case 4:return h=g.map(function(a){return a.arrayBuffer()}),i=.5,j=1,null!=b.onProgress?[3,6]:[4,Promise.all(h)];case 5:return k=l.sent(),[3,8];case 6:return[4,kt(h,b.onProgress,i,j)];case 7:k=l.sent(),l.label=8;case 8:return[2,k]}})})}function kv(a){var b=this;return function(c,d,e){return void 0===d&&(d=""),s(b,void 0,void 0,function(){var b,f,g,h,i,j,k,l,m;return t(this,function(n){switch(n.label){case 0:if(b=c.map(function(){return!1}),f={},g=null!=e?e.map(function(){return!1}):[],h=[],c.forEach(function(a,c){var d=0;a.weights.forEach(function(a){var i=j3["quantization"in a?a.quantization.dtype:a.dtype]*O(a.shape),j=function(){b[c]=!0,null==f[c]&&(f[c]=[]),f[c].push({manifestEntry:a,groupOffset:d,sizeBytes:i})};null!=e?e.forEach(function(b,c){b===a.name&&(j(),g[c]=!0)}):j(),h.push(a.name),d+=i})}),!g.every(function(a){return a}))throw Error("Could not find weights in manifest with names: "+e.filter(function(a,b){return!g[b]}).join(", ")+". \nManifest JSON has weights with names: "+h.join(", ")+".");return i=b.reduce(function(a,b,c){return b&&a.push(c),a},[]),j=[],i.forEach(function(a){c[a].paths.forEach(function(a){var b=d+(d.endsWith("/")?"":"/")+a;j.push(b)})}),[4,a(j)];case 1:return k=n.sent(),l={},m=0,i.forEach(function(a){for(var b=c[a].paths.length,d=0,e=0;e<b;e++)d+=k[m+e].byteLength;for(var g=new ArrayBuffer(d),h=new Uint8Array(g),i=0,j=0;j<b;j++){var n=new Uint8Array(k[m+j]);h.set(n,i),i+=n.byteLength}f[a].forEach(function(a){var b=j4(g.slice(a.groupOffset,a.groupOffset+a.sizeBytes),[a.manifestEntry]);for(var c in b)l[c]=b[c]}),m+=b}),[2,l]}})})}}ka.registerSaveRouter(function(a){var b;return w.getBool("IS_BROWSER")&&!Array.isArray(a)&&a.startsWith(kr.URL_SCHEME)?(void 0===(b=a.slice(kr.URL_SCHEME.length))&&(b="model"),new kr(b)):null});var kw=function(){function a(a,b){if(this.DEFAULT_METHOD="POST",null==b&&(b={}),this.weightPathPrefix=b.weightPathPrefix,this.onProgress=b.onProgress,null!=b.fetchFunc?(K("function"==typeof b.fetchFunc,function(){return"Must pass a function that matches the signature of `fetch` (see https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API)"}),this.fetch=b.fetchFunc):this.fetch=w.platform.fetch,K(null!=a&&a.length>0,function(){return"URL path for http must not be null, undefined or empty."}),Array.isArray(a)&&K(2===a.length,function(){return"URL paths for http must have a length of 2, (actual length is "+a.length+")."}),this.path=a,null!=b.requestInit&&null!=b.requestInit.body)throw Error("requestInit is expected to have no pre-existing body, but has one.");this.requestInit=b.requestInit||{}}return a.prototype.save=function(a){return s(this,void 0,void 0,function(){var b,c,d,e;return t(this,function(f){switch(f.label){case 0:if(a.modelTopology instanceof ArrayBuffer)throw Error("BrowserHTTPRequest.save() does not support saving model topology in binary formats yet.");return(b=Object.assign({method:this.DEFAULT_METHOD},this.requestInit)).body=new FormData,c=[{paths:["./model.weights.bin"],weights:a.weightSpecs}],d={modelTopology:a.modelTopology,format:a.format,generatedBy:a.generatedBy,convertedBy:a.convertedBy,userDefinedMetadata:a.userDefinedMetadata,weightsManifest:c},b.body.append("model.json",new Blob([JSON.stringify(d)],{type:"application/json"}),"model.json"),null!=a.weightData&&b.body.append("model.weights.bin",new Blob([a.weightData],{type:"application/octet-stream"}),"model.weights.bin"),[4,this.fetch(this.path,b)];case 1:if((e=f.sent()).ok)return[2,{modelArtifactsInfo:j9(a),responses:[e]}];throw Error("BrowserHTTPRequest.save() failed due to HTTP response status "+e.status+".")}})})},a.prototype.load=function(){return s(this,void 0,void 0,function(){var a,b,c,d,e,f,g,h,i,j,k,l;return t(this,function(m){switch(m.label){case 0:return[4,this.fetch(this.path,this.requestInit)];case 1:if(!(a=m.sent()).ok)throw Error("Request to "+this.path+" failed with status code "+a.status+". Please verify this URL points to the model JSON of the model to load.");m.label=2;case 2:return m.trys.push([2,4,,5]),[4,a.json()];case 3:return b=m.sent(),[3,5];case 4:throw m.sent(),c="Failed to parse model JSON of response from "+this.path+".",this.path.endsWith(".pb")?c+=" Your path contains a .pb file extension. Support for .pb models have been removed in TensorFlow.js 1.0 in favor of .json models. You can re-convert your Python TensorFlow model using the TensorFlow.js 1.0 conversion scripts or you can convert your.pb models with the 'pb2json'NPM script in the tensorflow/tfjs-converter repository.":c+=" Please make sure the server is serving valid JSON for this request.",Error(c);case 5:if(d=b.modelTopology,e=b.weightsManifest,f=b.generatedBy,g=b.convertedBy,h=b.format,i=b.userDefinedMetadata,null==d&&null==e)throw Error("The JSON from HTTP path "+this.path+" contains neither model topology or manifest for weights.");return null==e?[3,7]:[4,this.loadWeights(e)];case 6:j=(l=m.sent())[0],k=l[1],m.label=7;case 7:return[2,{modelTopology:d,weightSpecs:j,weightData:k,userDefinedMetadata:i,generatedBy:f,convertedBy:g,format:h}]}})})},a.prototype.loadWeights=function(a){return s(this,void 0,void 0,function(){var b,c,d,e,f,g,h,i,j,k;return t(this,function(l){switch(l.label){case 0:var m,n,o;for(n=(m=Array.isArray(this.path)?this.path[1]:this.path).lastIndexOf("/"),o=m.lastIndexOf("?"),c=(b=[m.substring(0,n)+"/",o>n?m.substring(o):""])[0],d=b[1],e=this.weightPathPrefix||c,f=[],g=0,h=a;g<h.length;g++)i=h[g],f.push.apply(f,i.weights);return j=[],a.forEach(function(a){a.paths.forEach(function(a){j.push(e+a+d)})}),[4,ku(j,{requestInit:this.requestInit,fetchFunc:this.fetch,onProgress:this.onProgress})];case 1:return k=l.sent(),[2,[f,j7(k)]]}})})},a.URL_SCHEME_REGEX=/^https?:\/\//,a}();function kx(a){return null!=a.match(kw.URL_SCHEME_REGEX)}var ky=function(a,b){return"undefined"==typeof fetch?null:(Array.isArray(a)?a.every(function(a){return kx(a)}):kx(a))?kz(a,{onProgress:b}):null};function kz(a,b){return new kw(a,b)}ka.registerSaveRouter(ky),ka.registerLoadRouter(ky);var kA,kB=function(){function a(a){this.modelArtifacts=a}return a.prototype.load=function(){return s(this,void 0,void 0,function(){return t(this,function(a){return[2,this.modelArtifacts]})})},a}(),kC=function(){function a(a){this.saveHandler=a}return a.prototype.save=function(a){return s(this,void 0,void 0,function(){return t(this,function(b){return[2,this.saveHandler(a)]})})},a}(),kD=Object.freeze({browserFiles:function(a){return new ks(a)},browserHTTPRequest:function(a,b){return kz(a,b)},concatenateArrayBuffers:j7,decodeWeights:j4,encodeWeights:function(a,b){return s(this,void 0,void 0,function(){var c,d,e,f,g,h=this;return t(this,function(i){switch(i.label){case 0:for(c=[],d=[],e=Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a),f=function(f){var g=e[f],i=Array.isArray(a)?a[f].tensor:a[g];if("float32"!==i.dtype&&"int32"!==i.dtype&&"bool"!==i.dtype&&"string"!==i.dtype)throw Error("Unsupported dtype in weight '"+g+"': "+i.dtype);var j={name:g,shape:i.shape,dtype:i.dtype};if("string"===i.dtype){var k=new Promise(function(a){return s(h,void 0,void 0,function(){var b,c,d,e,f,g;return t(this,function(h){switch(h.label){case 0:return[4,i.bytes()];case 1:for(c=new Uint8Array((b=h.sent()).reduce(function(a,b){return a+b.length},0)+4*b.length),d=0,e=0;e<b.length;e++)g=new Uint8Array(new Uint32Array([(f=b[e]).length]).buffer),c.set(g,d),d+=4,c.set(f,d),d+=f.length;return a(c),[2]}})})});d.push(k)}else d.push(i.data());null!=b&&(j.group=b),c.push(j)},g=0;g<e.length;++g)f(g);return[4,Promise.all(d)];case 1:return[2,{data:function(a){if(null===a)throw Error("Invalid input value: "+JSON.stringify(a));var b=0,c=[];a.forEach(function(a){if(b+=a.byteLength,c.push(a.byteLength===a.buffer.byteLength?a:new a.constructor(a)),!(a instanceof Float32Array||a instanceof Int32Array||a instanceof Uint8Array))throw Error("Unsupported TypedArray subtype: "+a.constructor.name)});var d=new Uint8Array(b),e=0;return c.forEach(function(a){d.set(new Uint8Array(a.buffer),e),e+=a.byteLength}),d.buffer}(i.sent()),specs:c}]}})})},fromMemory:function(a,b,c,d){return 1==arguments.length?null!=a.modelTopology||null!=a.weightSpecs?new kB(a):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new kB({modelTopology:a})):(console.warn("Please call tf.io.fromMemory() with only one argument. The argument should be of type ModelArtifacts. The multi-argument signature of tf.io.fromMemory() has been deprecated and will be removed in a future release."),new kB({modelTopology:a,weightSpecs:b,weightData:c,trainingConfig:d}))},getLoadHandlers:function(a,b){return ka.getLoadHandlers(a,b)},getModelArtifactsInfoForJSON:j9,getSaveHandlers:function(a){return ka.getSaveHandlers(a)},http:kz,isHTTPScheme:kx,loadWeights:function(a,b,c,d){return void 0===b&&(b=""),s(this,void 0,void 0,function(){return t(this,function(e){return[2,kv(function(a){return ku(a,{requestInit:d})})(a,b,c)]})})},registerLoadRouter:function(a){return ka.registerLoadRouter(a)},registerSaveRouter:function(a){return ka.registerSaveRouter(a)},weightsLoaderFactory:kv,withSaveHandler:function(a){return new kC(a)},copyModel:function(a,b){return s(this,void 0,void 0,function(){return t(this,function(c){return[2,kd(a,b,!1)]})})},listModels:function(){return s(this,void 0,void 0,function(){var a,b,c,d,e,f,g;return t(this,function(h){switch(h.label){case 0:a=kb.getSchemes(),b={},c=0,d=a,h.label=1;case 1:return c<d.length?(e=d[c],[4,kb.getManager(e).listModels()]):[3,4];case 2:for(g in f=h.sent())b[e+"://"+g]=f[g];h.label=3;case 3:return c++,[3,1];case 4:return[2,b]}})})},moveModel:function(a,b){return s(this,void 0,void 0,function(){return t(this,function(c){return[2,kd(a,b,!0)]})})},removeModel:function(a){return s(this,void 0,void 0,function(){var b;return t(this,function(c){return b=kc(a),[2,kb.getManager(b.scheme).removeModel(b.path)]})})}}),kE=Object.freeze({confusionMatrix:cv({confusionMatrix_:function(a,b,c){var d=cj(a,"labels","confusionMatrix"),e=cj(b,"predictions","confusionMatrix");K(null==c||c>0&&Number.isInteger(c),function(){return"If provided, numClasses must be a positive integer, but got "+c}),K(1===d.rank,function(){return"Expected the rank of labels to be 1, but got "+d.rank}),K(1===e.rank,function(){return"Expected the rank of predictions to be 1, but got "+e.rank}),K(d.shape[0]===e.shape[0],function(){return"Mismatch in the number of examples: "+d.shape[0]+" vs. "+e.shape[0]+". Labels and predictions should have the same number of elements."}),K(c>0&&Number.isInteger(c),function(){return"numClasses is required to be a positive integer, but got "+c});var f=dh(d.asType("int32"),c),g=dh(e.asType("int32"),c);return f.transpose().matMul(g).asType("int32")}})}),kF=Object.freeze({toPixels:function(a,b){return s(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,u,v,w,x,y,z;return t(this,function(t){switch(t.label){case 0:if(c=cj(a,"img","toPixels"),a instanceof aF||(c=c.toInt()),2!==c.rank&&3!==c.rank)throw Error("toPixels only supports rank 2 or 3 tensors, got rank "+c.rank+".");if(e=(d=c.shape.slice(0,2))[0],f=d[1],(g=2===c.rank?1:c.shape[2])>4||2===g)throw Error("toPixels only supports depth of size 1, 3 or 4 but got "+g);return[4,c.data()];case 1:return h=t.sent(),i=c.min(),j=c.max(),[4,Promise.all([i.data(),j.data()])];case 2:if(l=(k=t.sent())[0],m=k[1],n=l[0],o=m[0],i.dispose(),j.dispose(),"float32"===c.dtype){if(n<0||o>1)throw Error("Tensor values for a float32 Tensor must be in the range [0 - 1] but got range ["+n+" - "+o+"].")}else{if("int32"!==c.dtype)throw Error("Unsupported type for toPixels: "+c.dtype+". Please use float32 or int32 tensors.");if(n<0||o>255)throw Error("Tensor values for a int32 Tensor must be in the range [0 - 255] but got range ["+n+" - "+o+"].")}for(p="float32"===c.dtype?255:1,q=new Uint8ClampedArray(f*e*4),r=0;r<e*f;++r)s=void 0,u=void 0,v=void 0,w=void 0,1===g?(s=h[r]*p,u=h[r]*p,v=h[r]*p,w=255):3===g?(s=h[3*r]*p,u=h[3*r+1]*p,v=h[3*r+2]*p,w=255):4===g&&(s=h[4*r]*p,u=h[4*r+1]*p,v=h[4*r+2]*p,w=h[4*r+3]*p),q[(x=4*r)+0]=Math.round(s),q[x+1]=Math.round(u),q[x+2]=Math.round(v),q[x+3]=Math.round(w);return null!=b&&(b.width=f,b.height=e,y=b.getContext("2d"),z=new ImageData(q,f,e),y.putImageData(z,0,0)),c!==a&&c.dispose(),[2,q]}})})},fromPixels:cv({fromPixels_:function(a,b){if(void 0===b&&(b=3),b>4)throw Error("Cannot construct Tensor with more than 4 channels from pixels.");if(null==a)throw Error("pixels passed to tf.browser.fromPixels() can not be null");var c=!1,d=!1,e=!1,f=!1,g=!1;if(a.data instanceof Uint8Array)c=!0;else if("undefined"!=typeof ImageData&&a instanceof ImageData)d=!0;else if("undefined"!=typeof HTMLVideoElement&&a instanceof HTMLVideoElement)e=!0;else if("undefined"!=typeof HTMLImageElement&&a instanceof HTMLImageElement)f=!0;else{if(null==a.getContext)throw Error("pixels passed to tf.browser.fromPixels() must be either an HTMLVideoElement, HTMLImageElement, HTMLCanvasElement, ImageData in browser, or OffscreenCanvas, ImageData in webworker or {data: Uint32Array, width: number, height: number}, but was "+a.constructor.name);g=!0}if(e&&e&&a.readyState<2)throw Error("The video element has not loaded data yet. Please wait for `loadeddata` event on the <video> element.");if(null!=z("FromPixels",a_.backendName))return a_.runKernel("FromPixels",{pixels:a},{numChannels:b});var h,i,j=e?[a.videoWidth,a.videoHeight]:[a.width,a.height],k=j[0],l=j[1];if(g?h=a.getContext("2d").getImageData(0,0,k,l).data:d||c?h=a.data:(f||e)&&(null==kA&&(kA=document.createElement("canvas").getContext("2d")),kA.canvas.width=k,kA.canvas.height=l,kA.drawImage(a,0,0,k,l),h=kA.getImageData(0,0,k,l).data),4===b)i=new Int32Array(h);else{var m=k*l;i=new Int32Array(m*b);for(var n=0;n<m;n++)for(var o=0;o<b;++o)i[n*b+o]=h[4*n+o]}return cE(i,[l,k,b],"int32")}})}),kG=function(){function a(){}return a.prototype.getClassName=function(){return this.constructor.className},a.fromConfig=function(a,b){return new a(b)},a}(),kH=function(){function a(){this.classNameMap={}}return a.getMap=function(){return null==a.instance&&(a.instance=new a),a.instance},a.register=function(b){a.getMap().classNameMap[b.className]=[b,b.fromConfig]},a}();function kI(a){K(null!=a.className,function(){return"Class being registered does not have the static className property defined."}),K("string"==typeof a.className,function(){return"className is required to be a string, but got type "+typeof a.className}),K(a.className.length>0,function(){return"Class being registered has an empty-string as its className, which is disallowed."}),kH.register(a)}var kJ=Object.freeze({Serializable:kG,SerializationMap:kH,registerClass:kI});function kK(){return 32===a_.backend.floatPrecision()?.001:.1}function kL(a,b,c){var d=!0;if((ab(a)||ab(b))&&(d=!1),ab(a)&&ab(b)&&(d=!0),d){var e=a.constructor.name,f=b.constructor.name;if(e!==f)throw Error("Arrays are of different type. Actual: "+e+". Expected: "+f)}if(Array.isArray(a)&&Array.isArray(b)){var g=ch(a),h=ch(b);if(!P(g,h))throw Error("Arrays have different shapes. Actual: ["+g+"]. Expected: ["+h+"]")}var i=ab(a)?a:N(a),j=ab(b)?b:N(b);if(i.length!==j.length)throw Error("Arrays have different lengths actual: "+i.length+" vs expected: "+j.length+".\nActual:   "+i+".\nExpected: "+j+".");for(var k=0;k<j.length;++k){var l=i[k],m=j[k];if(!c(l,m))throw Error("Arrays differ: actual["+k+"] = "+l+", expected["+k+"] = "+m+".\nActual:   "+i+".\nExpected: "+j+".")}}function kM(a,b,c){return!isFinite(a)&&!isFinite(b)||!(isNaN(a)||isNaN(b)||Math.abs(a-b)>c)}var kN=Object.freeze({TEST_EPSILON_FLOAT16:.1,expectArraysClose:function(a,b,c){return null==c&&(c=kK()),kL(a,b,function(a,b){return kM(a,b,c)})},testEpsilon:kK,expectPromiseToFail:function(a,b){a().then(function(){return b.fail()},function(){return b()})},expectArraysEqual:function(a,b){var c="string"==typeof b||"number"==typeof b||"boolean"==typeof b?[b]:b;return ae(a)||ae(a[0])||ae(b)||ae(b[0])?kL(a,c,function(a,b){return a==b}):kL(a,b,function(a,b){return kM(a,b,0)})},expectNumbersClose:function(a,b,c){if(null==c&&(c=kK()),!kM(a,b,c))throw Error("Numbers differ: actual === "+a+", expected === "+b)},expectValuesInRange:function(a,b,c){for(var d=0;d<a.length;d++)if(a[d]<b||a[d]>c)throw Error("Value out of range:"+a[d]+" low: "+b+", high: "+c)},expectArrayBuffersEqual:function(a,b){expect(new Float32Array(a)).toEqual(new Float32Array(b))}}),kO=Object.freeze({gpgpu_util:fJ,webgl_util:bV,forceHalfFloat:function(){w.set("WEBGL_FORCE_F16_TEXTURES",!0)},MathBackendWebGL:gL,setWebGLContext:a7,GPGPUContext:fK}),kP=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return r(b,a),b.prototype.minimize=function(a,b,c){void 0===b&&(b=!1);var d=this.computeGradients(a,c),e=d.value,f=d.grads;if(null!=c){var g=c.map(function(a){return{name:a.name,tensor:f[a.name]}});this.applyGradients(g)}else this.applyGradients(f);return b4(f),b?e:(e.dispose(),null)},Object.defineProperty(b.prototype,"iterations",{get:function(){return null==this.iterations_&&(this.iterations_=0),this.iterations_},enumerable:!0,configurable:!0}),b.prototype.incrementIterations=function(){this.iterations_=this.iterations+1},b.prototype.computeGradients=function(a,b){return dY(a,b)},b.prototype.dispose=function(){null!=this.iterations_&&b4(this.iterations_)},b.prototype.saveIterations=function(){return s(this,void 0,void 0,function(){return t(this,function(a){return null==this.iterations_&&(this.iterations_=0),[2,{name:"iter",tensor:cB(this.iterations_,"int32")}]})})},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){return t(this,function(a){throw Error("getWeights() is not implemented for this optimizer yet.")})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){return t(this,function(a){throw Error("setWeights() is not implemented for this optimizer class "+this.getClassName())})})},b.prototype.extractIterations=function(a){return s(this,void 0,void 0,function(){var b;return t(this,function(c){switch(c.label){case 0:return b=this,[4,a[0].tensor.data()];case 1:return b.iterations_=c.sent()[0],[2,a.slice(1)]}})})},b}(kG);Object.defineProperty(kP,Symbol.hasInstance,{value:function(a){return null!=a.minimize&&null!=a.computeGradients&&null!=a.applyGradients}});var kQ=function(a){function b(b,c,d){void 0===d&&(d=null);var e=a.call(this)||this;return e.learningRate=b,e.rho=c,e.epsilon=d,e.accumulatedGrads=[],e.accumulatedUpdates=[],null==d&&(e.epsilon=a_.backend.epsilon()),e}return r(b,a),b.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(c,d){var e=a_.registeredVariables[c];null==b.accumulatedGrads[d]&&(b.accumulatedGrads[d]={originalName:c+"/accum_grad",variable:b3(function(){return cP(e).variable(!1)})}),null==b.accumulatedUpdates[d]&&(b.accumulatedUpdates[d]={originalName:c+"/accum_var",variable:b3(function(){return cP(e).variable(!1)})});var f=Array.isArray(a)?a[d].tensor:a[c];if(null!=f){var g=b.accumulatedGrads[d].variable,h=b.accumulatedUpdates[d].variable;b3(function(){var a=g.mul(b.rho).add(f.square().mul(1-b.rho)),c=h.add(b.epsilon).sqrt().div(g.add(b.epsilon).sqrt()).mul(f),d=h.mul(b.rho).add(c.square().mul(1-b.rho));g.assign(a),h.assign(d);var i=c.mul(-b.learningRate).add(e);e.assign(i)})}}),this.incrementIterations()},b.prototype.dispose=function(){null!=this.accumulatedUpdates&&(b4(this.accumulatedGrads.map(function(a){return a.variable})),b4(this.accumulatedUpdates.map(function(a){return a.variable})))},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){var a;return t(this,function(b){switch(b.label){case 0:return a=this.accumulatedGrads.concat(this.accumulatedUpdates),[4,this.saveIterations()];case 1:return[2,[b.sent()].concat(a.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){var b;return t(this,function(c){switch(c.label){case 0:return[4,this.extractIterations(a)];case 1:return b=(a=c.sent()).length/2,this.accumulatedGrads=a.slice(0,b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedUpdates=a.slice(b,2*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},b.prototype.getConfig=function(){return{learningRate:this.learningRate,rho:this.rho,epsilon:this.epsilon}},b.fromConfig=function(a,b){return new a(b.learningRate,b.rho,b.epsilon)},b.className="Adadelta",b}(kP);kI(kQ);var kR=function(a){function b(b,c){void 0===c&&(c=.1);var d=a.call(this)||this;return d.learningRate=b,d.initialAccumulatorValue=c,d.accumulatedGrads=[],d}return r(b,a),b.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(c,d){var e=a_.registeredVariables[c];null==b.accumulatedGrads[d]&&(b.accumulatedGrads[d]={originalName:c+"/accumulator",variable:b3(function(){return cL(e.shape,b.initialAccumulatorValue).variable(!1)})});var f=Array.isArray(a)?a[d].tensor:a[c];if(null!=f){var g=b.accumulatedGrads[d].variable;b3(function(){var a=g.add(f.square());g.assign(a);var c=f.div(a.add(a_.backend.epsilon()).sqrt()).mul(-b.learningRate).add(e);e.assign(c)})}}),this.incrementIterations()},b.prototype.dispose=function(){null!=this.accumulatedGrads&&b4(this.accumulatedGrads.map(function(a){return a.variable}))},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){return t(this,function(a){switch(a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[a.sent()].concat(this.accumulatedGrads.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){return t(this,function(b){switch(b.label){case 0:return[4,this.extractIterations(a)];case 1:return a=b.sent(),this.accumulatedGrads=a.map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},b.prototype.getConfig=function(){return{learningRate:this.learningRate,initialAccumulatorValue:this.initialAccumulatorValue}},b.fromConfig=function(a,b){return new a(b.learningRate,b.initialAccumulatorValue)},b.className="Adagrad",b}(kP);kI(kR);var kS=function(a){function b(b,c,d,e){void 0===e&&(e=null);var f=a.call(this)||this;return f.learningRate=b,f.beta1=c,f.beta2=d,f.epsilon=e,f.accumulatedFirstMoment=[],f.accumulatedSecondMoment=[],b3(function(){f.accBeta1=cB(c).variable(),f.accBeta2=cB(d).variable()}),null==e&&(f.epsilon=a_.backend.epsilon()),f}return r(b,a),b.prototype.applyGradients=function(a){var b=this,c=Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a);b3(function(){var d=hY(1,b.accBeta1),e=hY(1,b.accBeta2);c.forEach(function(c,f){var g=a_.registeredVariables[c];null==b.accumulatedFirstMoment[f]&&(b.accumulatedFirstMoment[f]={originalName:c+"/m",variable:b3(function(){return cP(g).variable(!1)})}),null==b.accumulatedSecondMoment[f]&&(b.accumulatedSecondMoment[f]={originalName:c+"/v",variable:b3(function(){return cP(g).variable(!1)})});var h=Array.isArray(a)?a[f].tensor:a[c];if(null!=h){var i=b.accumulatedFirstMoment[f].variable,j=b.accumulatedSecondMoment[f].variable,k=i.mul(b.beta1).add(h.mul(1-b.beta1)),l=j.mul(b.beta2).add(h.square().mul(1-b.beta2)),m=k.div(d),n=l.div(e);i.assign(k),j.assign(l);var o=m.div(n.sqrt().add(b.epsilon)).mul(-b.learningRate).add(g);g.assign(o)}}),b.accBeta1.assign(b.accBeta1.mul(b.beta1)),b.accBeta2.assign(b.accBeta2.mul(b.beta2))}),this.incrementIterations()},b.prototype.dispose=function(){this.accBeta1.dispose(),this.accBeta2.dispose(),null!=this.accumulatedFirstMoment&&b4(this.accumulatedFirstMoment.map(function(a){return a.variable})),null!=this.accumulatedSecondMoment&&b4(this.accumulatedSecondMoment.map(function(a){return a.variable}))},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){var a;return t(this,function(b){switch(b.label){case 0:return a=this.accumulatedFirstMoment.concat(this.accumulatedSecondMoment),[4,this.saveIterations()];case 1:return[2,[b.sent()].concat(a.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){var b,c=this;return t(this,function(d){switch(d.label){case 0:return[4,this.extractIterations(a)];case 1:return a=d.sent(),b3(function(){c.accBeta1.assign(hV(c.beta1,c.iterations_+1)),c.accBeta2.assign(hV(c.beta2,c.iterations_+1))}),b=a.length/2,this.accumulatedFirstMoment=a.slice(0,b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedSecondMoment=a.slice(b,2*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},b.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon}},b.fromConfig=function(a,b){return new a(b.learningRate,b.beta1,b.beta2,b.epsilon)},b.className="Adam",b}(kP);kI(kS);var kT=function(a){function b(b,c,d,e,f){void 0===e&&(e=null),void 0===f&&(f=0);var g=a.call(this)||this;return g.learningRate=b,g.beta1=c,g.beta2=d,g.epsilon=e,g.decay=f,g.accumulatedFirstMoment=[],g.accumulatedWeightedInfNorm=[],b3(function(){g.iteration=cB(0).variable(),g.accBeta1=cB(c).variable()}),null==e&&(g.epsilon=a_.backend.epsilon()),g}return r(b,a),b.prototype.applyGradients=function(a){var b=this,c=Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a);b3(function(){var d=hY(1,b.accBeta1),e=hJ(-b.learningRate,b.iteration.mul(b.decay).add(1));c.forEach(function(c,f){var g=a_.registeredVariables[c];null==b.accumulatedFirstMoment[f]&&(b.accumulatedFirstMoment[f]={originalName:c+"/m",variable:cP(g).variable(!1)}),null==b.accumulatedWeightedInfNorm[f]&&(b.accumulatedWeightedInfNorm[f]={originalName:c+"/v",variable:cP(g).variable(!1)});var h=Array.isArray(a)?a[f].tensor:a[c];if(null!=h){var i=b.accumulatedFirstMoment[f].variable,j=b.accumulatedWeightedInfNorm[f].variable,k=i.mul(b.beta1).add(h.mul(1-b.beta1)),l=j.mul(b.beta2),m=h.abs(),n=l.maximum(m);i.assign(k),j.assign(n);var o=e.div(d).mul(k.div(n.add(b.epsilon))).add(g);g.assign(o)}}),b.iteration.assign(b.iteration.add(1)),b.accBeta1.assign(b.accBeta1.mul(b.beta1))}),this.incrementIterations()},b.prototype.dispose=function(){this.accBeta1.dispose(),this.iteration.dispose(),null!=this.accumulatedFirstMoment&&b4(this.accumulatedFirstMoment.map(function(a){return a.variable})),null!=this.accumulatedWeightedInfNorm&&b4(this.accumulatedWeightedInfNorm.map(function(a){return a.variable}))},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){return t(this,function(a){throw Error("getWeights() is not implemented for Adamax yet.")})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){return t(this,function(a){throw Error("setWeights() is not implemented for Adamax yet.")})})},b.prototype.getConfig=function(){return{learningRate:this.learningRate,beta1:this.beta1,beta2:this.beta2,epsilon:this.epsilon,decay:this.decay}},b.fromConfig=function(a,b){return new a(b.learningRate,b.beta1,b.beta2,b.epsilon,b.decay)},b.className="Adamax",b}(kP);kI(kT);var kU=function(a){function b(b){var c=a.call(this)||this;return c.learningRate=b,c.setLearningRate(b),c}return r(b,a),b.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(c,d){var e=Array.isArray(a)?a[d].tensor:a[c];if(null!=e){var f=a_.registeredVariables[c];b3(function(){var a=b.c.mul(e).add(f);f.assign(a)})}}),this.incrementIterations()},b.prototype.setLearningRate=function(a){this.learningRate=a,null!=this.c&&this.c.dispose(),this.c=b5(cB(-a))},b.prototype.dispose=function(){this.c.dispose()},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){return t(this,function(a){switch(a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[a.sent()]]}})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){return t(this,function(b){switch(b.label){case 0:return[4,this.extractIterations(a)];case 1:if(0!==(a=b.sent()).length)throw Error("SGD optimizer does not have settable weights.");return[2]}})})},b.prototype.getConfig=function(){return{learningRate:this.learningRate}},b.fromConfig=function(a,b){return new a(b.learningRate)},b.className="SGD",b}(kP);kI(kU);var kV=function(a){function b(b,c,d){void 0===d&&(d=!1);var e=a.call(this,b)||this;return e.learningRate=b,e.momentum=c,e.useNesterov=d,e.accumulations=[],e.m=cB(e.momentum),e}return r(b,a),b.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(c,d){var e=a_.registeredVariables[c];null==b.accumulations[d]&&(b.accumulations[d]={originalName:c+"/momentum",variable:b3(function(){return cP(e).variable(!1)})});var f=b.accumulations[d].variable,g=Array.isArray(a)?a[d].tensor:a[c];null!=g&&b3(function(){var a,c=b.m.mul(f).add(g);a=b.useNesterov?b.c.mul(g.add(c.mul(b.m))).add(e):b.c.mul(c).add(e),f.assign(c),e.assign(a)})}),this.incrementIterations()},b.prototype.dispose=function(){this.m.dispose(),null!=this.accumulations&&b4(this.accumulations.map(function(a){return a.variable}))},b.prototype.setMomentum=function(a){this.momentum=a},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){return t(this,function(a){switch(a.label){case 0:return[4,this.saveIterations()];case 1:return[2,[a.sent()].concat(this.accumulations.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){return t(this,function(b){switch(b.label){case 0:return[4,this.extractIterations(a)];case 1:return a=b.sent(),this.accumulations=a.map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),[2]}})})},b.prototype.getConfig=function(){return{learningRate:this.learningRate,momentum:this.momentum,useNesterov:this.useNesterov}},b.fromConfig=function(a,b){return new a(b.learningRate,b.momentum,b.useNesterov)},b.className="Momentum",b}(kU);kI(kV);var kW=function(a){function b(b,c,d,e,f){void 0===c&&(c=.9),void 0===d&&(d=0),void 0===e&&(e=null),void 0===f&&(f=!1);var g=a.call(this)||this;if(g.learningRate=b,g.decay=c,g.momentum=d,g.epsilon=e,g.accumulatedMeanSquares=[],g.accumulatedMoments=[],g.accumulatedMeanGrads=[],g.centered=f,null==e&&(g.epsilon=a_.backend.epsilon()),null==b)throw Error("learningRate for RMSPropOptimizer must be defined.");return g}return r(b,a),b.prototype.applyGradients=function(a){var b=this;(Array.isArray(a)?a.map(function(a){return a.name}):Object.keys(a)).forEach(function(c,d){var e=a_.registeredVariables[c];null==b.accumulatedMeanSquares[d]&&(b.accumulatedMeanSquares[d]={originalName:c+"/rms",variable:b3(function(){return cP(e).variable(!1)})}),null==b.accumulatedMoments[d]&&(b.accumulatedMoments[d]={originalName:c+"/momentum",variable:b3(function(){return cP(e).variable(!1)})}),null==b.accumulatedMeanGrads[d]&&b.centered&&(b.accumulatedMeanGrads[d]={originalName:c+"/mg",variable:b3(function(){return cP(e).variable(!1)})});var f=Array.isArray(a)?a[d].tensor:a[c];if(null!=f){var g=b.accumulatedMeanSquares[d].variable,h=b.accumulatedMoments[d].variable;b3(function(){var a=g.mul(b.decay).add(f.square().mul(1-b.decay));if(b.centered){var c=b.accumulatedMeanGrads[d].variable,i=c.mul(b.decay).add(f.mul(1-b.decay)),j=h.mul(b.momentum).add(f.mul(b.learningRate).div(a.sub(i.square().add(b.epsilon)).sqrt()));g.assign(a),c.assign(i),h.assign(j);var k=e.sub(j);e.assign(k)}else{var l=g.mul(b.decay).add(f.square().mul(1-b.decay));j=h.mul(b.momentum).add(f.mul(b.learningRate).div(l.add(b.epsilon).sqrt())),g.assign(l),h.assign(j),k=e.sub(j),e.assign(k)}})}}),this.incrementIterations()},b.prototype.dispose=function(){null!=this.accumulatedMeanSquares&&b4(this.accumulatedMeanSquares.map(function(a){return a.variable})),null!=this.accumulatedMeanGrads&&this.centered&&b4(this.accumulatedMeanGrads.map(function(a){return a.variable})),null!=this.accumulatedMoments&&b4(this.accumulatedMoments.map(function(a){return a.variable}))},b.prototype.getWeights=function(){return s(this,void 0,void 0,function(){var a;return t(this,function(b){switch(b.label){case 0:return a=this.accumulatedMeanSquares.concat(this.accumulatedMoments),this.centered&&a.push.apply(a,this.accumulatedMeanGrads),[4,this.saveIterations()];case 1:return[2,[b.sent()].concat(a.map(function(a){return{name:a.originalName,tensor:a.variable}}))]}})})},b.prototype.setWeights=function(a){return s(this,void 0,void 0,function(){var b;return t(this,function(c){switch(c.label){case 0:return[4,this.extractIterations(a)];case 1:return a=c.sent(),b=this.centered?a.length/3:a.length/2,this.accumulatedMeanSquares=a.slice(0,b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.accumulatedMoments=a.slice(b,2*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}}),this.centered&&(this.accumulatedMeanGrads=a.slice(2*b,3*b).map(function(a){return{originalName:a.name,variable:a.tensor.variable(!1)}})),[2]}})})},b.prototype.getConfig=function(){return{learningRate:this.learningRate,decay:this.decay,momentum:this.momentum,epsilon:this.epsilon,centered:this.centered}},b.fromConfig=function(a,b){return new a(b.learningRate,b.decay,b.momentum,b.epsilon,b.centered)},b.className="RMSProp",b}(kP);kI(kW);var kX=function(){function a(){}return a.sgd=function(a){return new kU(a)},a.momentum=function(a,b,c){return void 0===c&&(c=!1),new kV(a,b,c)},a.rmsprop=function(a,b,c,d,e){return void 0===b&&(b=.9),void 0===c&&(c=0),void 0===d&&(d=null),void 0===e&&(e=!1),new kW(a,b,c,d,e)},a.adam=function(a,b,c,d){return void 0===a&&(a=.001),void 0===b&&(b=.9),void 0===c&&(c=.999),void 0===d&&(d=null),new kS(a,b,c,d)},a.adadelta=function(a,b,c){return void 0===a&&(a=.001),void 0===b&&(b=.95),void 0===c&&(c=null),new kQ(a,b,c)},a.adamax=function(a,b,c,d,e){return void 0===a&&(a=.002),void 0===b&&(b=.9),void 0===c&&(c=.999),void 0===d&&(d=null),void 0===e&&(e=0),new kT(a,b,c,d,e)},a.adagrad=function(a,b){return void 0===b&&(b=.1),new kR(a,b)},a}(),kY={sgd:kX.sgd,momentum:kX.momentum,adadelta:kX.adadelta,adagrad:kX.adagrad,rmsprop:kX.rmsprop,adamax:kX.adamax,adam:kX.adam},kZ="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setImmediate?setImmediate:function(a){return a()};function k$(){return new Promise(function(a){return kZ(function(){return a()})})}function k_(a,b,c){if(void 0===c&&(c=!1),a.beginPath(),b.slice(1).forEach(function(c,d){var e=c.x,f=c.y,g=b[d];a.moveTo(g.x,g.y),a.lineTo(e,f)}),c){var d=b[b.length-1],e=b[0];if(!d||!e)return;a.moveTo(d.x,d.y),a.lineTo(e.x,e.y)}a.stroke()}aF.prototype.squaredDifference=function(a){return gO(this,a)},aD=jO,a.s(["AdadeltaOptimizer",()=>kQ,"AdagradOptimizer",()=>kR,"AdamOptimizer",()=>kS,"AdamaxOptimizer",()=>kT,"DataStorage",()=>d1,"ENV",()=>w,"Environment",()=>u,"KernelBackend",()=>d2,"MomentumOptimizer",()=>kV,"Optimizer",()=>kP,"RMSPropOptimizer",()=>kW,"Rank",()=>aG,"Reduction",()=>jo,"SGDOptimizer",()=>kU,"Tensor",()=>aF,"TensorBuffer",()=>aB,"Variable",()=>aL,"abs",()=>gP,"acos",()=>gQ,"acosh",()=>gR,"add",()=>hF,"addN",()=>hG,"addStrict",()=>hH,"all",()=>iQ,"any",()=>iR,"argMax",()=>iS,"argMin",()=>iT,"asin",()=>gS,"asinh",()=>gT,"atan",()=>gU,"atan2",()=>hI,"atanh",()=>gV,"avgPool",()=>iG,"avgPool3d",()=>iJ,"backend",()=>ce,"backend_util",()=>em,"basicLSTMCell",()=>i8,"batchNorm",()=>hv,"batchNorm2d",()=>hw,"batchNorm3d",()=>hx,"batchNorm4d",()=>hy,"batchNormalization",()=>hu,"batchNormalization2d",()=>hr,"batchNormalization3d",()=>hs,"batchNormalization4d",()=>ht,"batchToSpaceND",()=>c8,"booleanMaskAsync",()=>ie,"broadcastTo",()=>c9,"browser",()=>kF,"buffer",()=>c6,"cast",()=>da,"ceil",()=>gW,"clipByValue",()=>gX,"clone",()=>db,"complex",()=>cw,"concat",()=>cQ,"concat1d",()=>cR,"concat2d",()=>cS,"concat3d",()=>cT,"concat4d",()=>cU,"conv1d",()=>ij,"conv2d",()=>ik,"conv2dTranspose",()=>it,"conv3d",()=>il,"conv3dTranspose",()=>iu,"cos",()=>gY,"cosh",()=>gZ,"cumsum",()=>dc,"customGrad",()=>dZ,"deprecationWarn",()=>b$,"depthToSpace",()=>dd,"depthwiseConv2d",()=>ip,"diag",()=>jl,"disableDeprecationWarnings",()=>bZ,"dispose",()=>b4,"disposeVariables",()=>b_,"div",()=>hJ,"divNoNan",()=>hK,"divStrict",()=>hL,"dot",()=>iw,"dropout",()=>jm,"elu",()=>i_,"enableDebugMode",()=>bY,"enableProdMode",()=>bX,"engine",()=>b0,"env",()=>v,"equal",()=>h$,"equalStrict",()=>h_,"erf",()=>g$,"exp",()=>g_,"expandDims",()=>de,"expm1",()=>g0,"eye",()=>df,"fft",()=>je,"fill",()=>cL,"findBackend",()=>cb,"findBackendFactory",()=>cc,"floor",()=>g1,"floorDiv",()=>hM,"frame",()=>jr,"fused",()=>jN,"gather",()=>ic,"gatherND",()=>jk,"gather_util",()=>dG,"getBackend",()=>b9,"getGradient",()=>A,"getKernel",()=>z,"getKernelsForBackend",()=>B,"grad",()=>dU,"grads",()=>dV,"greater",()=>h0,"greaterEqual",()=>h1,"greaterEqualStrict",()=>h2,"greaterStrict",()=>h3,"hammingWindow",()=>jq,"hannWindow",()=>jp,"ifft",()=>jf,"imag",()=>cy,"image",()=>jI,"inTopKAsync",()=>ju,"io",()=>kD,"irfft",()=>jh,"isFinite",()=>hd,"isInf",()=>hc,"isNaN",()=>hb,"keep",()=>b5,"leakyRelu",()=>i0,"less",()=>h4,"lessEqual",()=>h5,"lessEqualStrict",()=>h6,"lessStrict",()=>h7,"linalg",()=>jG,"linspace",()=>cM,"localResponseNormalization",()=>i6,"log",()=>g2,"log1p",()=>g3,"logSigmoid",()=>g4,"logSoftmax",()=>d0,"logSumExp",()=>iU,"logicalAnd",()=>hz,"logicalNot",()=>hA,"logicalOr",()=>hB,"logicalXor",()=>hC,"losses",()=>jE,"matMul",()=>iv,"math",()=>kE,"max",()=>iV,"maxPool",()=>iF,"maxPool3d",()=>iI,"maximum",()=>hN,"maximumStrict",()=>hO,"mean",()=>iW,"memory",()=>b1,"min",()=>iX,"minimum",()=>hP,"minimumStrict",()=>hQ,"mod",()=>hR,"modStrict",()=>hS,"moments",()=>iY,"movingAverage",()=>ja,"mul",()=>hT,"mulStrict",()=>hU,"multiRNNCell",()=>i9,"multinomial",()=>dg,"neg",()=>g5,"nextFrame",()=>k$,"norm",()=>i7,"notEqual",()=>h8,"notEqualStrict",()=>h9,"oneHot",()=>dh,"ones",()=>cJ,"onesLike",()=>cO,"op",()=>cv,"outerProduct",()=>ix,"pad",()=>di,"pad1d",()=>dj,"pad2d",()=>dk,"pad3d",()=>dl,"pad4d",()=>dm,"pool",()=>iH,"pow",()=>hV,"powStrict",()=>hW,"prelu",()=>i1,"print",()=>c7,"prod",()=>i$,"profile",()=>b2,"rand",()=>dn,"randomGamma",()=>dq,"randomNormal",()=>dp,"randomUniform",()=>dr,"range",()=>cN,"ready",()=>b8,"real",()=>cx,"reciprocal",()=>g6,"registerBackend",()=>cd,"registerGradient",()=>D,"registerKernel",()=>C,"relu",()=>i2,"relu6",()=>i3,"removeBackend",()=>ca,"reshape",()=>ds,"reverse",()=>iy,"reverse1d",()=>iz,"reverse2d",()=>iA,"reverse3d",()=>iB,"reverse4d",()=>iC,"rfft",()=>jg,"round",()=>g7,"rsqrt",()=>g8,"scalar",()=>cB,"scatterND",()=>jd,"scatter_util",()=>dL,"selu",()=>i4,"separableConv2d",()=>is,"serialization",()=>kJ,"setBackend",()=>b7,"setPlatform",()=>cf,"setdiff1dAsync",()=>dz,"sigmoid",()=>g9,"sign",()=>ha,"signal",()=>jt,"sin",()=>he,"sinh",()=>hf,"slice",()=>iK,"slice1d",()=>iL,"slice2d",()=>iM,"slice3d",()=>iN,"slice4d",()=>iO,"slice_util",()=>dT,"softmax",()=>d_,"softplus",()=>hg,"spaceToBatchND",()=>dt,"sparseToDense",()=>jj,"spectral",()=>ji,"split",()=>cV,"sqrt",()=>hh,"square",()=>gM,"squaredDifference",()=>gO,"squaredDifferenceStrict",()=>hX,"squeeze",()=>du,"stack",()=>dv,"step",()=>hi,"stft",()=>js,"stridedSlice",()=>jb,"sub",()=>hY,"subStrict",()=>hZ,"sum",()=>iZ,"sumOutType",()=>aO,"tan",()=>hj,"tanh",()=>hk,"tensor",()=>cz,"tensor1d",()=>cC,"tensor2d",()=>cD,"tensor3d",()=>cE,"tensor4d",()=>cF,"tensor5d",()=>cG,"tensor6d",()=>cH,"tensor_util",()=>aY,"test_util",()=>kN,"tidy",()=>b3,"tile",()=>dw,"time",()=>b6,"topk",()=>jc,"train",()=>kY,"transpose",()=>i5,"truncatedNormal",()=>dx,"unregisterGradient",()=>F,"unregisterKernel",()=>E,"unsortedSegmentSum",()=>id,"unstack",()=>dy,"util",()=>av,"valueAndGrad",()=>dW,"valueAndGrads",()=>dX,"variable",()=>cI,"variableGrads",()=>dY,"version_core",()=>"1.7.0","webgl",()=>kO,"where",()=>hD,"whereAsync",()=>hE,"zeros",()=>cK,"zerosLike",()=>cP],51501),a.i(51501),a.s(["drawContour",()=>k_],44179);var k0=function(a,b){return(k0=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])})(a,b)};function k1(a,b){function c(){this.constructor=a}k0(a,b),a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)}var k2=function(){return(k2=Object.assign||function(a){for(var b,c=1,d=arguments.length;c<d;c++)for(var e in b=arguments[c])Object.prototype.hasOwnProperty.call(b,e)&&(a[e]=b[e]);return a}).apply(this,arguments)};function k3(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){var b;a.done?e(a.value):((b=a.value)instanceof c?b:new c(function(a){a(b)})).then(g,h)}i((d=d.apply(a,b||[])).next())})}function k4(a,b){var c,d,e,f,g={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]};return f={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(f[Symbol.iterator]=function(){return this}),f;function h(f){return function(h){var i=[f,h];if(c)throw TypeError("Generator is already executing.");for(;g;)try{if(c=1,d&&(e=2&i[0]?d.return:i[0]?d.throw||((e=d.return)&&e.call(d),0):d.next)&&!(e=e.call(d,i[1])).done)return e;switch(d=0,e&&(i=[2&i[0],e.value]),i[0]){case 0:case 1:e=i;break;case 4:return g.label++,{value:i[1],done:!1};case 5:g.label++,d=i[1],i=[0];continue;case 7:i=g.ops.pop(),g.trys.pop();continue;default:if(!(e=(e=g.trys).length>0&&e[e.length-1])&&(6===i[0]||2===i[0])){g=0;continue}if(3===i[0]&&(!e||i[1]>e[0]&&i[1]<e[3])){g.label=i[1];break}if(6===i[0]&&g.label<e[1]){g.label=e[1],e=i;break}if(e&&g.label<e[2]){g.label=e[2],g.ops.push(i);break}e[2]&&g.ops.pop(),g.trys.pop();continue}i=b.call(a,g)}catch(a){i=[6,a],d=0}finally{c=e=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}}}function k5(){for(var a=0,b=0,c=arguments.length;b<c;b++)a+=arguments[b].length;for(var d=Array(a),e=0,b=0;b<c;b++)for(var f=arguments[b],g=0,h=f.length;g<h;g++,e++)d[e]=f[g];return d}a.s(["computeReshapedDimensions",()=>lh,"getCenterPoint",()=>li,"isDimensions",()=>lg,"isEven",()=>le,"isFloat",()=>ld,"isTensor",()=>k8,"isTensor1D",()=>k9,"isTensor2D",()=>la,"isTensor3D",()=>lb,"isTensor4D",()=>lc,"isValidNumber",()=>lk,"isValidProbablitiy",()=>ll,"range",()=>lj,"round",()=>lf],32547);var k6=function(){function a(a,b){this._x=a,this._y=b}return Object.defineProperty(a.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),a.prototype.add=function(b){return new a(this.x+b.x,this.y+b.y)},a.prototype.sub=function(b){return new a(this.x-b.x,this.y-b.y)},a.prototype.mul=function(b){return new a(this.x*b.x,this.y*b.y)},a.prototype.div=function(b){return new a(this.x/b.x,this.y/b.y)},a.prototype.abs=function(){return new a(Math.abs(this.x),Math.abs(this.y))},a.prototype.magnitude=function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))},a.prototype.floor=function(){return new a(Math.floor(this.x),Math.floor(this.y))},a}(),k7=function(){function a(a,b){if(!lk(a)||!lk(b))throw Error("Dimensions.constructor - expected width and height to be valid numbers, instead have "+JSON.stringify({width:a,height:b}));this._width=a,this._height=b}return Object.defineProperty(a.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),a.prototype.reverse=function(){return new a(1/this.width,1/this.height)},a}();function k8(a,b){return a instanceof aF&&a.shape.length===b}function k9(a){return k8(a,1)}function la(a){return k8(a,2)}function lb(a){return k8(a,3)}function lc(a){return k8(a,4)}function ld(a){return a%1!=0}function le(a){return a%2==0}function lf(a,b){void 0===b&&(b=2);var c=Math.pow(10,b);return Math.floor(a*c)/c}function lg(a){return a&&a.width&&a.height}function lh(a,b){var c=a.width,d=a.height,e=b/Math.max(d,c);return new k7(Math.round(c*e),Math.round(d*e))}function li(a){return a.reduce(function(a,b){return a.add(b)},new k6(0,0)).div(new k6(a.length,a.length))}function lj(a,b,c){return Array(a).fill(0).map(function(a,d){return b+d*c})}function lk(a){return!!a&&a!==1/0&&a!==-1/0&&!isNaN(a)||0===a}function ll(a){return lk(a)&&0<=a&&a<=1}var lm=function(){function a(b,c){void 0===c&&(c=!0);var d=b||{},e=[d.left,d.top,d.right,d.bottom].every(lk),f=[d.x,d.y,d.width,d.height].every(lk);if(!f&&!e)throw Error("Box.constructor - expected box to be IBoundingBox | IRect, instead have "+JSON.stringify(d));var g=f?[d.x,d.y,d.width,d.height]:[d.left,d.top,d.right-d.left,d.bottom-d.top],h=g[0],i=g[1],j=g[2],k=g[3];a.assertIsValidBox({x:h,y:i,width:j,height:k},"Box.constructor",c),this._x=h,this._y=i,this._width=j,this._height=k}return a.isRect=function(a){return!!a&&[a.x,a.y,a.width,a.height].every(lk)},a.assertIsValidBox=function(b,c,d){if(void 0===d&&(d=!1),!a.isRect(b))throw Error(c+" - invalid box: "+JSON.stringify(b)+", expected object with properties x, y, width, height");if(!d&&(b.width<0||b.height<0))throw Error(c+" - width ("+b.width+") and height ("+b.height+") must be positive numbers")},Object.defineProperty(a.prototype,"x",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"y",{get:function(){return this._y},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"left",{get:function(){return this.x},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"top",{get:function(){return this.y},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"right",{get:function(){return this.x+this.width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"bottom",{get:function(){return this.y+this.height},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"area",{get:function(){return this.width*this.height},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"topLeft",{get:function(){return new k6(this.left,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"topRight",{get:function(){return new k6(this.right,this.top)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"bottomLeft",{get:function(){return new k6(this.left,this.bottom)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"bottomRight",{get:function(){return new k6(this.right,this.bottom)},enumerable:!0,configurable:!0}),a.prototype.round=function(){var b=[this.x,this.y,this.width,this.height].map(function(a){return Math.round(a)});return new a({x:b[0],y:b[1],width:b[2],height:b[3]})},a.prototype.floor=function(){var b=[this.x,this.y,this.width,this.height].map(function(a){return Math.floor(a)});return new a({x:b[0],y:b[1],width:b[2],height:b[3]})},a.prototype.toSquare=function(){var b=this.x,c=this.y,d=this.width,e=this.height,f=Math.abs(d-e);return d<e&&(b-=f/2,d+=f),e<d&&(c-=f/2,e+=f),new a({x:b,y:c,width:d,height:e})},a.prototype.rescale=function(b){var c=lg(b)?b.width:b,d=lg(b)?b.height:b;return new a({x:this.x*c,y:this.y*d,width:this.width*c,height:this.height*d})},a.prototype.pad=function(b,c){var d=[this.x-b/2,this.y-c/2,this.width+b,this.height+c];return new a({x:d[0],y:d[1],width:d[2],height:d[3]})},a.prototype.clipAtImageBorders=function(b,c){var d=this.x,e=this.y,f=this.right,g=this.bottom,h=Math.max(d,0),i=Math.max(e,0),j=Math.min(f-h,b-h),k=Math.min(g-i,c-i);return new a({x:h,y:i,width:j,height:k}).floor()},a.prototype.shift=function(b,c){var d=this.width,e=this.height;return new a({x:this.x+b,y:this.y+c,width:d,height:e})},a.prototype.padAtBorders=function(a,b){var c=this.width+1,d=this.height+1,e=c,f=d,g=this.left,h=this.top,i=this.right,j=this.bottom;return i>b&&(e=-i+b+c,i=b),j>a&&(f=-j+a+d,j=a),g<1&&(f=2-g,g=1),h<1&&(f=2-h,h=1),{dy:1,edy:f,dx:1,edx:e,y:h,ey:j,x:g,ex:i,w:c,h:d}},a.prototype.calibrate=function(b){return new a({left:this.left+b.left*this.width,top:this.top+b.top*this.height,right:this.right+b.right*this.width,bottom:this.bottom+b.bottom*this.height}).toSquare().round()},a}(),ln=function(a){function b(b,c,d,e,f){return void 0===f&&(f=!1),a.call(this,{left:b,top:c,right:d,bottom:e},f)||this}return k1(b,a),b}(lm),lo=function(){function a(a,b,c,d,e){this._imageDims=new k7(e.width,e.height),this._score=a,this._classScore=b,this._className=c,this._box=new lm(d).rescale(this._imageDims)}return Object.defineProperty(a.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"className",{get:function(){return this._className},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"box",{get:function(){return this._box},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageDims",{get:function(){return this._imageDims},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageWidth",{get:function(){return this.imageDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageHeight",{get:function(){return this.imageDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"relativeBox",{get:function(){return new lm(this._box).rescale(this.imageDims.reverse())},enumerable:!0,configurable:!0}),a.prototype.forSize=function(b,c){return new a(this.score,this.classScore,this.className,this.relativeBox,{width:b,height:c})},a}(),lp=function(a){function b(b,c,d){return a.call(this,b,b,"",c,d)||this}return k1(b,a),b.prototype.forSize=function(c,d){var e=a.prototype.forSize.call(this,c,d);return new b(e.score,e.relativeBox,e.imageDims)},b}(lo);function lq(a,b,c,d){void 0===d&&(d=!0);for(var e=b.map(function(a,b){return{score:a,boxIndex:b}}).sort(function(a,b){return a.score-b.score}).map(function(a){return a.boxIndex}),f=[];e.length>0;)!function(){var b=e.pop();f.push(b);for(var g=e,h=[],i=0;i<g.length;i++){var j=g[i],k=a[b],l=a[j];h.push(function(a,b,c){void 0===c&&(c=!0);var d=Math.max(0,Math.min(a.right,b.right)-Math.max(a.left,b.left))*Math.max(0,Math.min(a.bottom,b.bottom)-Math.max(a.top,b.top));return c?d/(a.area+b.area-d):d/Math.min(a.area,b.area)}(k,l,d))}e=e.filter(function(a,b){return h[b]<=c})}();return f}function lr(a,b){return b3(function(){var c=b[0],d=b[1],e=b[2],f=cQ([cL(k5(a.shape.slice(0,3),[1]),c),cL(k5(a.shape.slice(0,3),[1]),d),cL(k5(a.shape.slice(0,3),[1]),e)],3);return hY(a,f)})}function ls(a){return 1/(1+Math.exp(-a))}var lt=function(a){function b(b,c,d,e,f){return void 0===f&&(f=!1),a.call(this,{x:b,y:c,width:d,height:e},f)||this}return k1(b,a),b}(lm),lu=function(){function a(a,b,c){void 0===c&&(c=new k6(0,0));var d=b.width,e=b.height;this._imgDims=new k7(d,e),this._shift=c,this._positions=a.map(function(a){return a.mul(new k6(d,e)).add(c)})}return Object.defineProperty(a.prototype,"shift",{get:function(){return new k6(this._shift.x,this._shift.y)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageWidth",{get:function(){return this._imgDims.width},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"imageHeight",{get:function(){return this._imgDims.height},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"positions",{get:function(){return this._positions},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"relativePositions",{get:function(){var a=this;return this._positions.map(function(b){return b.sub(a._shift).div(new k6(a.imageWidth,a.imageHeight))})},enumerable:!0,configurable:!0}),a.prototype.forSize=function(a,b){return new this.constructor(this.relativePositions,{width:a,height:b})},a.prototype.shiftBy=function(a,b){return new this.constructor(this.relativePositions,this._imgDims,new k6(a,b))},a.prototype.shiftByPoint=function(a){return this.shiftBy(a.x,a.y)},a.prototype.align=function(a,b){if(void 0===b&&(b={}),a){var c=a instanceof lp?a.box.floor():new lm(a);return this.shiftBy(c.x,c.y).align(null,b)}var d=Object.assign({},{useDlibAlignment:!1,minBoxPadding:.2},b),e=d.useDlibAlignment,f=d.minBoxPadding;return e?this.alignDlib():this.alignMinBbox(f)},a.prototype.alignDlib=function(){var a=this.getRefPointsForAlignment(),b=a[0],c=a[1],d=a[2],e=function(a){return d.sub(a).magnitude()},f=Math.floor((e(b)+e(c))/2/.45),g=li(a),h=Math.floor(Math.max(0,g.x-.5*f)),i=Math.floor(Math.max(0,g.y-.43*f));return new lt(h,i,Math.min(f,this.imageWidth+h),Math.min(f,this.imageHeight+i))},a.prototype.alignMinBbox=function(a){var b,c,d,e=(c=(b=this.positions).map(function(a){return a.x}),d=b.map(function(a){return a.y}),new ln(c.reduce(function(a,b){return b<a?b:a},1/0),d.reduce(function(a,b){return b<a?b:a},1/0),c.reduce(function(a,b){return a<b?b:a},0),d.reduce(function(a,b){return a<b?b:a},0)));return e.pad(e.width*a,e.height*a)},a.prototype.getRefPointsForAlignment=function(){throw Error("getRefPointsForAlignment not implemented by base class")},a}(),lv=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.getRefPointsForAlignment=function(){var a=this.positions;return[a[0],a[1],li([a[3],a[4]])]},b}(lu),lw=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.getJawOutline=function(){return this.positions.slice(0,17)},b.prototype.getLeftEyeBrow=function(){return this.positions.slice(17,22)},b.prototype.getRightEyeBrow=function(){return this.positions.slice(22,27)},b.prototype.getNose=function(){return this.positions.slice(27,36)},b.prototype.getLeftEye=function(){return this.positions.slice(36,42)},b.prototype.getRightEye=function(){return this.positions.slice(42,48)},b.prototype.getMouth=function(){return this.positions.slice(48,68)},b.prototype.getRefPointsForAlignment=function(){return[this.getLeftEye(),this.getRightEye(),this.getMouth()].map(li)},b}(lu),lx=function(){function a(a,b){this._label=a,this._distance=b}return Object.defineProperty(a.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"distance",{get:function(){return this._distance},enumerable:!0,configurable:!0}),a.prototype.toString=function(a){return void 0===a&&(a=!0),""+this.label+(a?" ("+lf(this.distance)+")":"")},a}(),ly=function(a){function b(b,c){var d=a.call(this,b)||this;return d._label=c,d}return k1(b,a),b.assertIsValidLabeledBox=function(a,b){if(lm.assertIsValidBox(a,b),!lk(a.label))throw Error(b+" - expected property label ("+a.label+") to be a number")},Object.defineProperty(b.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),b}(lm),lz=function(){function a(a,b){if("string"!=typeof a)throw Error("LabeledFaceDescriptors - constructor expected label to be a string");if(!Array.isArray(b)||b.some(function(a){return!(a instanceof Float32Array)}))throw Error("LabeledFaceDescriptors - constructor expected descriptors to be an array of Float32Array");this._label=a,this._descriptors=b}return Object.defineProperty(a.prototype,"label",{get:function(){return this._label},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"descriptors",{get:function(){return this._descriptors},enumerable:!0,configurable:!0}),a.prototype.toJSON=function(){return{label:this.label,descriptors:this.descriptors.map(function(a){return Array.from(a)})}},a.fromJSON=function(b){var c=b.descriptors.map(function(a){return new Float32Array(a)});return new a(b.label,c)},a}();function lA(a,b,c,d){var e=ly.call(this,a,b)||this;return e._score=c,e._classScore=d,e}function lB(a){return a.detection instanceof lp}function lC(a,b){return Object.assign({},a,{detection:b})}k1(lA,ly),lA.assertIsValidPredictedBox=function(a,b){if(ly.assertIsValidLabeledBox(a,b),!ll(a.score)||!ll(a.classScore))throw Error(b+" - expected properties score ("+a.score+") and ("+a.classScore+") to be a number between [0, 1]")},Object.defineProperty(lA.prototype,"score",{get:function(){return this._score},enumerable:!0,configurable:!0}),Object.defineProperty(lA.prototype,"classScore",{get:function(){return this._classScore},enumerable:!0,configurable:!0});var lD=function(){if(!g)throw Error("getEnv - environment is not defined, check isNodejs() and isBrowser()");return g},lE=function(){return!1};function lF(a){return lE()||"string"!=typeof a?a:document.getElementById(a)}function lG(a){var b=lD(),c=b.Canvas;if(a instanceof b.CanvasRenderingContext2D)return a;var d=lF(a);if(!(d instanceof c))throw Error("resolveContext2d - expected canvas to be of instance of Canvas");var e=d.getContext("2d");if(!e)throw Error("resolveContext2d - canvas 2d context is null");return e}(b=h||(h={})).TOP_LEFT="TOP_LEFT",b.TOP_RIGHT="TOP_RIGHT",b.BOTTOM_LEFT="BOTTOM_LEFT",b.BOTTOM_RIGHT="BOTTOM_RIGHT";var lH=function(a){void 0===a&&(a={});var b=a.anchorPosition,c=a.backgroundColor,d=a.fontColor,e=a.fontSize,f=a.fontStyle,g=a.padding;this.anchorPosition=b||h.TOP_LEFT,this.backgroundColor=c||"rgba(0, 0, 0, 0.5)",this.fontColor=d||"rgba(255, 255, 255, 1)",this.fontSize=e||14,this.fontStyle=f||"Georgia",this.padding=g||4},lI=function(){function a(b,c,d){void 0===d&&(d={}),this.text="string"==typeof b?[b]:b instanceof a?b.text:b,this.anchor=c,this.options=new lH(d)}return a.prototype.measureWidth=function(a){var b=this.options.padding;return this.text.map(function(b){return a.measureText(b).width}).reduce(function(a,b){return a<b?b:a},0)+2*b},a.prototype.measureHeight=function(){var a=this.options,b=a.fontSize,c=a.padding;return this.text.length*b+2*c},a.prototype.getUpperLeft=function(a,b){var c=this.options.anchorPosition,d=c===h.BOTTOM_RIGHT||c===h.TOP_RIGHT,e=c===h.BOTTOM_LEFT||c===h.BOTTOM_RIGHT,f=this.measureWidth(a),g=this.measureHeight(),i=d?this.anchor.x-f:this.anchor.x,j=e?this.anchor.y-g:this.anchor.y;return b?{x:Math.max(Math.min(i,b.width-f),0),y:Math.max(Math.min(j,b.height-g),0)}:{x:i,y:j}},a.prototype.draw=function(a){var b=lF(a),c=lG(b),d=this.options,e=d.backgroundColor,f=d.fontColor,g=d.fontSize,h=d.fontStyle,i=d.padding;c.font=g+"px "+h;var j=this.measureWidth(c),k=this.measureHeight();c.fillStyle=e;var l=this.getUpperLeft(c,b);c.fillRect(l.x,l.y,j,k),c.fillStyle=f,this.text.forEach(function(a,b){var d=i+l.x,e=i+l.y+(b+1)*g;c.fillText(a,d,e)})},a}();a.s(["AnchorPosition",()=>h,"DrawTextField",()=>lI,"DrawTextFieldOptions",()=>lH],21060);var lJ=function(a){void 0===a&&(a={});var b=a.boxColor,c=a.lineWidth,d=a.label,e=a.drawLabelOptions;this.boxColor=b||"rgba(0, 0, 255, 1)",this.lineWidth=c||2,this.label=d;var f={anchorPosition:h.BOTTOM_LEFT,backgroundColor:this.boxColor};this.drawLabelOptions=new lH(Object.assign({},f,e))},lK=function(){function a(a,b){void 0===b&&(b={}),this.box=new lm(a),this.options=new lJ(b)}return a.prototype.draw=function(a){var b=lG(a),c=this.options,d=c.boxColor,e=c.lineWidth,f=this.box,g=f.x,h=f.y,i=f.width,j=f.height;b.strokeStyle=d,b.lineWidth=e,b.strokeRect(g,h,i,j);var k=this.options.label;k&&new lI([k],{x:g-e/2,y:h},this.options.drawLabelOptions).draw(a)},a}();function lL(a,b){(Array.isArray(b)?b:[b]).forEach(function(b){var c=b instanceof lp?b.score:lB(b)?b.detection.score:void 0;new lK(b instanceof lp?b.box:lB(b)?b.detection.box:new lm(b),{label:c?""+lf(c):void 0}).draw(a)})}function lM(a){var b=lD(),c=b.Image,d=b.Video;return a instanceof c&&a.complete||a instanceof d&&a.readyState>=3}function lN(a){var b=lD(),c=b.Image,d=b.Video;return a instanceof c?new k7(a.naturalWidth,a.naturalHeight):a instanceof d?new k7(a.videoWidth,a.videoHeight):new k7(a.width,a.height)}function lO(a){var b=a.width,c=a.height,d=(0,lD().createCanvasElement)();return d.width=b,d.height=c,d}function lP(a,b){var c=lD().ImageData;if(!(a instanceof c)&&!lM(a))throw Error("createCanvasFromMedia - media has not finished loading yet");var d=b||lN(a),e=d.width,f=d.height,g=lO({width:e,height:f});return a instanceof c?lG(g).putImageData(a,0,0):lG(g).drawImage(a,0,0,e,f),g}function lQ(a){var b=lD(),c=b.Image,d=b.Canvas,e=b.Video;return a instanceof c||a instanceof d||a instanceof e}a.s(["DrawBox",()=>lK,"DrawBoxOptions",()=>lJ],66787),a.s(["drawDetections",()=>lL],70037);var lR=function(){function a(a,b){var c=this;if(void 0===b&&(b=!1),this._imageTensors=[],this._canvases=[],this._treatAsBatchInput=!1,this._inputDimensions=[],!Array.isArray(a))throw Error("NetInput.constructor - expected inputs to be an Array of TResolvedNetInput or to be instanceof tf.Tensor4D, instead have "+a);this._treatAsBatchInput=b,this._batchSize=a.length,a.forEach(function(a,b){if(lb(a)){c._imageTensors[b]=a,c._inputDimensions[b]=a.shape;return}if(lc(a)){var d=a.shape[0];if(1!==d)throw Error("NetInput - tf.Tensor4D with batchSize "+d+" passed, but not supported in input array");c._imageTensors[b]=a,c._inputDimensions[b]=a.shape.slice(1);return}var e=a instanceof lD().Canvas?a:lP(a);c._canvases[b]=e,c._inputDimensions[b]=[e.height,e.width,3]})}return Object.defineProperty(a.prototype,"imageTensors",{get:function(){return this._imageTensors},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"canvases",{get:function(){return this._canvases},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"isBatchInput",{get:function(){return this.batchSize>1||this._treatAsBatchInput},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"batchSize",{get:function(){return this._batchSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"inputDimensions",{get:function(){return this._inputDimensions},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"reshapedInputDimensions",{get:function(){var a=this;return lj(this.batchSize,0,1).map(function(b,c){return a.getReshapedInputDimensions(c)})},enumerable:!0,configurable:!0}),a.prototype.getInput=function(a){return this.canvases[a]||this.imageTensors[a]},a.prototype.getInputDimensions=function(a){return this._inputDimensions[a]},a.prototype.getInputHeight=function(a){return this._inputDimensions[a][0]},a.prototype.getInputWidth=function(a){return this._inputDimensions[a][1]},a.prototype.getReshapedInputDimensions=function(a){if("number"!=typeof this.inputSize)throw Error("getReshapedInputDimensions - inputSize not set, toBatchTensor has not been called yet");return lh({width:this.getInputWidth(a),height:this.getInputHeight(a)},this.inputSize)},a.prototype.toBatchTensor=function(a,b){var c=this;return void 0===b&&(b=!0),this._inputSize=a,b3(function(){return dv(lj(c.batchSize,0,1).map(function(d){var e=c.getInput(d);if(e instanceof aF){var f,g,h=lc(e)?e:e.expandDims();return f=h,void 0===(g=b)&&(g=!1),((h=b3(function(){var a=f.shape.slice(1),b=a[0],c=a[1];if(b===c)return f;var d=Math.abs(b-c),e=b>c?2:1,h=function(a){var b=f.shape.slice();return b[e]=a,cL(b,0)},i=h(Math.round(d*(g?.5:1))),j=d-i.shape[e];return cQ([g&&j?h(j):null,f,i].filter(function(a){return!!a}).map(function(a){return a.toFloat()}),e)})).shape[1]!==a||h.shape[2]!==a)&&(h=jI.resizeBilinear(h,[a,a])),h.as3D(a,a,3)}if(e instanceof lD().Canvas)return kF.fromPixels(function(a,b,c){void 0===c&&(c=!1);var d=lD(),e=d.Image,f=d.Canvas;if(!(a instanceof e||a instanceof f))throw Error("imageToSquare - expected arg0 to be HTMLImageElement | HTMLCanvasElement");var g=lN(a),h=b/Math.max(g.height,g.width),i=h*g.width,j=h*g.height,k=lO({width:b,height:b}),l=a instanceof f?a:lP(a),m=Math.abs(i-j)/2,n=c&&i<j?m:0,o=c&&j<i?m:0;return lG(k).drawImage(l,n,o,i,j),k}(e,a,b));throw Error("toBatchTensor - at batchIdx "+d+", expected input to be instanceof tf.Tensor or instanceof HTMLCanvasElement, instead have "+e)}).map(function(a){return a.toFloat()})).as4D(c.batchSize,a,a,3)})},a}();function lS(a){return k3(this,void 0,void 0,function(){var b,c,d;return k4(this,function(e){switch(e.label){case 0:if(a instanceof lR)return[2,a];if(!(b=Array.isArray(a)?a:[a]).length)throw Error("toNetInput - empty array passed as input");return c=function(b){return Array.isArray(a)?" at input index "+b+":":""},(d=b.map(lF)).forEach(function(a,d){if(!lQ(a)&&!lb(a)&&!lc(a)){if("string"==typeof b[d])throw Error("toNetInput -"+c(d)+" string passed, but could not resolve HTMLElement for element id "+b[d]);throw Error("toNetInput -"+c(d)+" expected media to be of type HTMLImageElement | HTMLVideoElement | HTMLCanvasElement | tf.Tensor3D, or to be an element id")}if(lc(a)){var e=a.shape[0];if(1!==e)throw Error("toNetInput -"+c(d)+" tf.Tensor4D with batchSize "+e+" passed, but not supported in input array")}}),[4,Promise.all(d.map(function(a){return lQ(a)&&new Promise(function(b,c){if(a instanceof lD().Canvas||lM(a))return b();function d(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",d),a.currentTarget.removeEventListener("error",e),b(a))}function e(a){a.currentTarget&&(a.currentTarget.removeEventListener("load",d),a.currentTarget.removeEventListener("error",e),c(a))}a.addEventListener("load",d),a.addEventListener("error",e)})}))];case 1:return e.sent(),[2,new lR(d,Array.isArray(a))]}})})}function lT(a,b){return k3(this,void 0,void 0,function(){var c,d,e,f,g,h;return k4(this,function(i){switch(i.label){case 0:if(c=lD().Canvas,d=a,a instanceof c)return[3,5];return[4,lS(a)];case 1:if((e=i.sent()).batchSize>1)throw Error("extractFaces - batchSize > 1 not supported");if(!((f=e.getInput(0))instanceof c))return[3,2];return g=f,[3,4];case 2:return[4,function(a,b){return k3(this,void 0,void 0,function(){var b,c,d,e,f,g;return k4(this,function(h){switch(h.label){case 0:return b=lD().createCanvasElement(),d=(c=a.shape.slice(+!!lc(a)))[0],e=c[1],f=c[2],g=b3(function(){return a.as3D(d,e,f).toInt()}),[4,kF.toPixels(g,b)];case 1:return h.sent(),g.dispose(),[2,b]}})})}(f)];case 3:g=i.sent(),i.label=4;case 4:d=g,i.label=5;case 5:return h=lG(d),[2,b.map(function(a){return a instanceof lp?a.forSize(d.width,d.height).box.floor():a}).map(function(a){return a.clipAtImageBorders(d.width,d.height)}).map(function(a){var b=a.x,c=a.y,d=a.width,e=a.height,f=lO({width:d,height:e});return lG(f).putImageData(h.getImageData(b,c,d,e),0,0),f})]}})})}function lU(a,b){return k3(this,void 0,void 0,function(){return k4(this,function(c){if(!lb(a)&&!lc(a))throw Error("extractFaceTensors - expected image tensor to be 3D or 4D");if(lc(a)&&a.shape[0]>1)throw Error("extractFaceTensors - batchSize > 1 not supported");return[2,b3(function(){var c=a.shape.slice(+!!lc(a)),d=c[0],e=c[1],f=c[2];return b.map(function(a){return a instanceof lp?a.forSize(e,d).box:a}).map(function(a){return a.clipAtImageBorders(e,d)}).map(function(b){var c=b.x,g=b.y,h=b.width,i=b.height;return iN(a.as3D(d,e,f),[g,c,0],[i,h,f])})})]})})}function lV(a,b){var c=b+"-weights_manifest.json";if(!a)return{modelBaseUri:"",manifestUri:c};if("/"===a)return{modelBaseUri:"/",manifestUri:"/"+c};var d=a.startsWith("http://")?"http://":a.startsWith("https://")?"https://":"",e=(a=a.replace(d,"")).split("/").filter(function(a){return a}),f=a.endsWith(".json")?e[e.length-1]:c,g=d+(a.endsWith(".json")?e.slice(0,e.length-1):e).join("/");return{modelBaseUri:g=a.startsWith("/")?"/"+g:g,manifestUri:"/"===g?"/"+f:g+"/"+f}}var lW=function(){function a(a){this._name=a,this._params=void 0,this._paramMappings=[]}return Object.defineProperty(a.prototype,"params",{get:function(){return this._params},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"paramMappings",{get:function(){return this._paramMappings},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"isLoaded",{get:function(){return!!this.params},enumerable:!0,configurable:!0}),a.prototype.getParamFromPath=function(a){var b=this.traversePropertyPath(a);return b.obj[b.objProp]},a.prototype.reassignParamFromPath=function(a,b){var c=this.traversePropertyPath(a),d=c.obj,e=c.objProp;d[e].dispose(),d[e]=b},a.prototype.getParamList=function(){var a=this;return this._paramMappings.map(function(b){var c=b.paramPath;return{path:c,tensor:a.getParamFromPath(c)}})},a.prototype.getTrainableParams=function(){return this.getParamList().filter(function(a){return a.tensor instanceof aL})},a.prototype.getFrozenParams=function(){return this.getParamList().filter(function(a){return!(a.tensor instanceof aL)})},a.prototype.variable=function(){var a=this;this.getFrozenParams().forEach(function(b){var c=b.path,d=b.tensor;a.reassignParamFromPath(c,d.variable())})},a.prototype.freeze=function(){var a=this;this.getTrainableParams().forEach(function(b){var c=b.path,d=b.tensor,e=cz(d.dataSync());d.dispose(),a.reassignParamFromPath(c,e)})},a.prototype.dispose=function(a){void 0===a&&(a=!0),this.getParamList().forEach(function(b){if(a&&b.tensor.isDisposed)throw Error("param tensor has already been disposed for path "+b.path);b.tensor.dispose()}),this._params=void 0},a.prototype.serializeParams=function(){return new Float32Array(this.getParamList().map(function(a){return Array.from(a.tensor.dataSync())}).reduce(function(a,b){return a.concat(b)}))},a.prototype.load=function(a){return k3(this,void 0,void 0,function(){return k4(this,function(b){switch(b.label){case 0:if(a instanceof Float32Array)return this.extractWeights(a),[2];return[4,this.loadFromUri(a)];case 1:return b.sent(),[2]}})})},a.prototype.loadFromUri=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:if(a&&"string"!=typeof a)throw Error(this._name+".loadFromUri - expected model uri");return[4,function(a,b){return k3(this,void 0,void 0,function(){var c,d,e,f;return k4(this,function(g){switch(g.label){case 0:return d=(c=lV(a,b)).manifestUri,e=c.modelBaseUri,[4,function(a){return k3(this,void 0,void 0,function(){return k4(this,function(b){switch(b.label){case 0:return[4,function(a,b){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return[4,(0,lD().fetch)(a,void 0)];case 1:if(!((b=c.sent()).status<400))throw Error("failed to fetch: ("+b.status+") "+b.statusText+", from url: "+b.url);return[2,b]}})})}(a)];case 1:return[2,b.sent().json()]}})})}(d)];case 1:return f=g.sent(),[2,kD.loadWeights(f,e)]}})})}(a,this.getDefaultModelName())];case 1:return b=c.sent(),this.loadFromWeightMap(b),[2]}})})},a.prototype.loadFromDisk=function(a){return k3(this,void 0,void 0,function(){var b,c,d,e,f,g,h,i,j,k;return k4(this,function(l){switch(l.label){case 0:if(a&&"string"!=typeof a)throw Error(this._name+".loadFromDisk - expected model file path");return b=lD().readFile,d=(c=lV(a,this.getDefaultModelName())).manifestUri,e=c.modelBaseUri,f=function(a){return Promise.all(a.map(function(a){return b(a).then(function(a){return a.buffer})}))},g=kD.weightsLoaderFactory(f),j=(i=JSON).parse,[4,b(d)];case 1:return h=j.apply(i,[l.sent().toString()]),[4,g(h,e)];case 2:return k=l.sent(),this.loadFromWeightMap(k),[2]}})})},a.prototype.loadFromWeightMap=function(a){var b=this.extractParamsFromWeigthMap(a),c=b.paramMappings,d=b.params;this._paramMappings=c,this._params=d},a.prototype.extractWeights=function(a){var b=this.extractParams(a),c=b.paramMappings,d=b.params;this._paramMappings=c,this._params=d},a.prototype.traversePropertyPath=function(a){if(!this.params)throw Error("traversePropertyPath - model has no loaded params");var b=a.split("/").reduce(function(b,c){if(!b.nextObj.hasOwnProperty(c))throw Error("traversePropertyPath - object does not have property "+c+", for path "+a);return{obj:b.nextObj,objProp:c,nextObj:b.nextObj[c]}},{nextObj:this.params}),c=b.obj,d=b.objProp;if(!c||!d||!(c[d]instanceof aF))throw Error("traversePropertyPath - parameter is not a tensor, for path "+a);return{obj:c,objProp:d}},a}();function lX(a,b,c){return b3(function(){var d=is(a,b.depthwise_filter,b.pointwise_filter,c,"same");return hF(d,b.bias)})}function lY(a,b,c){return void 0===c&&(c=!1),b3(function(){var d=i2(c?hF(ik(a,b.conv0.filters,[2,2],"same"),b.conv0.bias):lX(a,b.conv0,[2,2])),e=lX(d,b.conv1,[1,1]),f=lX(i2(hF(d,e)),b.conv2,[1,1]);return i2(hF(d,hF(e,f)))})}function lZ(a,b,c,d){return void 0===c&&(c=!1),void 0===d&&(d=!0),b3(function(){var e=i2(c?hF(ik(a,b.conv0.filters,d?[2,2]:[1,1],"same"),b.conv0.bias):lX(a,b.conv0,d?[2,2]:[1,1])),f=lX(e,b.conv1,[1,1]),g=lX(i2(hF(e,f)),b.conv2,[1,1]),h=lX(i2(hF(e,hF(f,g))),b.conv3,[1,1]);return i2(hF(e,hF(f,hF(g,h))))})}function l$(a,b,c,d){return void 0===c&&(c="same"),void 0===d&&(d=!1),b3(function(){var e=hF(ik(a,b.filters,[1,1],c),b.bias);return d?i2(e):e})}function l_(a,b){Object.keys(a).forEach(function(c){b.some(function(a){return a.originalPath===c})||a[c].dispose()})}function l0(a,b){return function(c,d,e,f){var g=cF(a(c*d*e*e),[e,e,c,d]),h=cC(a(d));return b.push({paramPath:f+"/filters"},{paramPath:f+"/bias"}),{filters:g,bias:h}}}function l1(a,b){return function(c,d,e){var f=cD(a(c*d),[c,d]),g=cC(a(d));return b.push({paramPath:e+"/weights"},{paramPath:e+"/bias"}),{weights:f,bias:g}}}var l2=function(a,b,c){this.depthwise_filter=a,this.pointwise_filter=b,this.bias=c};function l3(a,b){return function(c,d,e){var f=cF(a(9*c),[3,3,c,1]),g=cF(a(c*d),[1,1,c,d]),h=cC(a(d));return b.push({paramPath:e+"/depthwise_filter"},{paramPath:e+"/pointwise_filter"},{paramPath:e+"/bias"}),new l2(f,g,h)}}function l4(a){return function(b){return new l2(a(b+"/depthwise_filter",4),a(b+"/pointwise_filter",4),a(b+"/bias",1))}}function l5(a,b){return function(c,d,e){var f=a[c];if(!k8(f,d))throw Error("expected weightMap["+c+"] to be a Tensor"+d+"D, instead have "+f);return b.push({originalPath:c,paramPath:e||c}),f}}function l6(a){var b=a;return{extractWeights:function(a){var c=b.slice(0,a);return b=b.slice(a),c},getRemainingWeights:function(){return b}}}function l7(a,b){var c=l0(a,b),d=l3(a,b);function e(a,b,e,f){return void 0===f&&(f=!1),{conv0:f?c(a,b,3,e+"/conv0"):d(a,b,e+"/conv0"),conv1:d(b,b,e+"/conv1"),conv2:d(b,b,e+"/conv2")}}return{extractDenseBlock3Params:e,extractDenseBlock4Params:function(a,b,c,f){void 0===f&&(f=!1);var g=e(a,b,c,f);return{conv0:g.conv0,conv1:g.conv1,conv2:g.conv2,conv3:d(b,b,c+"/conv3")}}}}function l8(a){return function(b){return{filters:a(b+"/filters",4),bias:a(b+"/bias",1)}}}function l9(a,b){var c=l5(a,b),d=l8(c),e=l4(c);return{extractDenseBlock3Params:function(a,b){return void 0===b&&(b=!1),{conv0:b?d(a+"/conv0"):e(a+"/conv0"),conv1:e(a+"/conv1"),conv2:e(a+"/conv2")}},extractDenseBlock4Params:function(a,b){return void 0===b&&(b=!1),{conv0:b?d(a+"/conv0"):e(a+"/conv0"),conv1:e(a+"/conv1"),conv2:e(a+"/conv2"),conv3:e(a+"/conv3")}}}}var ma=function(a){function b(){return a.call(this,"FaceFeatureExtractor")||this}return k1(b,a),b.prototype.forwardInput=function(a){var b=this.params;if(!b)throw Error("FaceFeatureExtractor - load model before inference");return b3(function(){var c=lZ(lr(a.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(cB(255)),b.dense0,!0);return c=lZ(c,b.dense1),c=lZ(c,b.dense2),c=iG(c=lZ(c,b.dense3),[7,7],[2,2],"valid")})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.getDefaultModelName=function(){return"face_feature_extractor_model"},b.prototype.extractParamsFromWeigthMap=function(a){var b,c,d;return d={dense0:(c=l9(a,b=[]).extractDenseBlock4Params)("dense0",!0),dense1:c("dense1"),dense2:c("dense2"),dense3:c("dense3")},l_(a,b),{params:d,paramMappings:b}},b.prototype.extractParams=function(a){return function(a){var b=[],c=l6(a),d=c.extractWeights,e=c.getRemainingWeights,f=l7(d,b).extractDenseBlock4Params,g=f(3,32,"dense0",!0),h=f(32,64,"dense1"),i=f(64,128,"dense2"),j=f(128,256,"dense3");if(0!==e().length)throw Error("weights remaing after extract: "+e().length);return{paramMappings:b,params:{dense0:g,dense1:h,dense2:i,dense3:j}}}(a)},b}(lW);function mb(a,b){return b3(function(){return hF(iv(a,b.weights),b.bias)})}function mc(a){var b={},c={};return Object.keys(a).forEach(function(d){(d.startsWith("fc")?c:b)[d]=a[d]}),{featureExtractorMap:b,classifierMap:c}}var md=function(a){function b(b,c){var d=a.call(this,b)||this;return d._faceFeatureExtractor=c,d}return k1(b,a),Object.defineProperty(b.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),b.prototype.runNet=function(a){var b=this,c=this.params;if(!c)throw Error(this._name+" - load model before inference");return b3(function(){var d=a instanceof lR?b.faceFeatureExtractor.forwardInput(a):a;return mb(d.as2D(d.shape[0],-1),c.fc)})},b.prototype.dispose=function(b){void 0===b&&(b=!0),this.faceFeatureExtractor.dispose(b),a.prototype.dispose.call(this,b)},b.prototype.loadClassifierParams=function(a){var b=this.extractClassifierParams(a),c=b.params,d=b.paramMappings;this._params=c,this._paramMappings=d},b.prototype.extractClassifierParams=function(a){return function(a,b,c){var d=[],e=l6(a),f=e.extractWeights,g=e.getRemainingWeights,h=l1(f,d)(b,c,"fc");if(0!==g().length)throw Error("weights remaing after extract: "+g().length);return{paramMappings:d,params:{fc:h}}}(a,this.getClassifierChannelsIn(),this.getClassifierChannelsOut())},b.prototype.extractParamsFromWeigthMap=function(a){var b,c,d,e=mc(a),f=e.featureExtractorMap,g=e.classifierMap;return this.faceFeatureExtractor.loadFromWeightMap(f),d={fc:{weights:(c=l5(g,b=[]))("fc/weights",2),bias:c("fc/bias",1)}},l_(g,b),{params:d,paramMappings:b}},b.prototype.extractParams=function(a){var b=this.getClassifierChannelsIn(),c=this.getClassifierChannelsOut(),d=c*b+c,e=a.slice(0,a.length-d),f=a.slice(a.length-d);return this.faceFeatureExtractor.extractWeights(e),this.extractClassifierParams(f)},b}(lW),me=["neutral","happy","sad","angry","fearful","disgusted","surprised"],mf=function(){function a(a){var b=this;if(7!==a.length)throw Error("FaceExpressions.constructor - expected probabilities.length to be 7, have: "+a.length);me.forEach(function(c,d){b[c]=a[d]})}return a.prototype.asSortedArray=function(){var a=this;return me.map(function(b){return{expression:b,probability:a[b]}}).sort(function(a,b){return b.probability-a.probability})},a}(),mg=function(a){function b(b){return void 0===b&&(b=new ma),a.call(this,"FaceExpressionNet",b)||this}return k1(b,a),b.prototype.forwardInput=function(a){var b=this;return b3(function(){return d_(b.runNet(a))})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.predictExpressions=function(a){return k3(this,void 0,void 0,function(){var b,c,d,e,f=this;return k4(this,function(g){switch(g.label){case 0:return[4,lS(a)];case 1:return b=g.sent(),[4,this.forwardInput(b)];case 2:return[4,Promise.all(dy(c=g.sent()).map(function(a){return k3(f,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return[4,a.data()];case 1:return b=c.sent(),a.dispose(),[2,b]}})})}))];case 3:return d=g.sent(),c.dispose(),e=d.map(function(a){return new mf(a)}),[2,b.isBatchInput?e:e[0]]}})})},b.prototype.getDefaultModelName=function(){return"face_expression_model"},b.prototype.getClassifierChannelsIn=function(){return 256},b.prototype.getClassifierChannelsOut=function(){return 7},b}(md);function mh(a,b){return Object.assign({},a,{expressions:b})}function mi(a,b,c,d){void 0===c&&(c=.1),(Array.isArray(b)?b:[b]).forEach(function(b){var e=b instanceof mf?b:b.expressions instanceof mf?b.expressions:void 0;if(!e)throw Error("drawFaceExpressions - expected faceExpressions to be FaceExpressions | WithFaceExpressions<{}> or array thereof");var f=e.asSortedArray().filter(function(a){return a.probability>c}),g=lB(b)?b.detection.box.bottomLeft:d||new k6(0,0);new lI(f.map(function(a){return a.expression+" ("+lf(a.probability)+")"}),g).draw(a)})}function mj(a){return lB(a)&&a.landmarks instanceof lu&&a.unshiftedLandmarks instanceof lu&&a.alignedRect instanceof lp}function mk(a,b){var c=a.detection.box,d=b.shiftBy(c.x,c.y),e=d.align(),f=a.detection.imageDims,g=new lp(a.detection.score,e.rescale(f.reverse()),f);return Object.assign({},a,{landmarks:d,unshiftedLandmarks:b,alignedRect:g})}a.s(["drawFaceExpressions",()=>mi],77763);var ml=function(a){void 0===a&&(a={});var b=a.drawLines,c=a.drawPoints,d=a.lineWidth,e=a.lineColor,f=a.pointSize,g=a.pointColor;this.drawLines=void 0===b||b,this.drawPoints=void 0===c||c,this.lineWidth=d||1,this.pointSize=f||2,this.lineColor=e||"rgba(0, 255, 255, 1)",this.pointColor=g||"rgba(255, 0, 255, 1)"},mm=function(){function a(a,b){void 0===b&&(b={}),this.faceLandmarks=a,this.options=new ml(b)}return a.prototype.draw=function(a){var b=lG(a),c=this.options,d=c.drawLines,e=c.drawPoints,f=c.lineWidth,g=c.lineColor,h=c.pointSize,i=c.pointColor;d&&this.faceLandmarks instanceof lw&&(b.strokeStyle=g,b.lineWidth=f,k_(b,this.faceLandmarks.getJawOutline()),k_(b,this.faceLandmarks.getLeftEyeBrow()),k_(b,this.faceLandmarks.getRightEyeBrow()),k_(b,this.faceLandmarks.getNose()),k_(b,this.faceLandmarks.getLeftEye(),!0),k_(b,this.faceLandmarks.getRightEye(),!0),k_(b,this.faceLandmarks.getMouth(),!0)),e&&(b.strokeStyle=i,b.fillStyle=i,this.faceLandmarks.positions.forEach(function(a){b.beginPath(),b.arc(a.x,a.y,h,0,2*Math.PI),b.fill()}))},a}();function mn(a,b){(Array.isArray(b)?b:[b]).forEach(function(b){var c=b instanceof lu?b:mj(b)?b.landmarks:void 0;if(!c)throw Error("drawFaceLandmarks - expected faceExpressions to be FaceLandmarks | WithFaceLandmarks<WithFaceDetection<{}>> or array thereof");new mm(c).draw(a)})}function mo(a,b,c){return hF(ik(a,b.filters,c,"same"),b.bias)}function mp(a,b,c){void 0===c&&(c=!0);var d=c?i2(a):a;return d=lX(d,b.separable_conv0,[1,1]),d=hF(d=iF(d=lX(i2(d),b.separable_conv1,[1,1]),[3,3],[2,2],"same"),mo(a,b.expansion_conv,[2,2]))}a.s(["DrawFaceLandmarks",()=>mm,"DrawFaceLandmarksOptions",()=>ml,"drawFaceLandmarks",()=>mn],25514),a.s([],52434),a.i(52434),a.i(44179),a.i(70037),a.i(77763),a.i(66787),a.i(25514),a.i(21060),a.s(["AnchorPosition",()=>h,"DrawBox",()=>lK,"DrawBoxOptions",()=>lJ,"DrawFaceLandmarks",()=>mm,"DrawFaceLandmarksOptions",()=>ml,"DrawTextField",()=>lI,"DrawTextFieldOptions",()=>lH,"drawContour",()=>k_,"drawDetections",()=>lL,"drawFaceExpressions",()=>mi,"drawFaceLandmarks",()=>mn],98248),a.i(98248),a.i(32547);var mq=function(a){function b(b){var c=a.call(this,"TinyXception")||this;return c._numMainBlocks=b,c}return k1(b,a),b.prototype.forwardInput=function(a){var b=this,c=this.params;if(!c)throw Error("TinyXception - load model before inference");return b3(function(){var d=i2(mo(lr(a.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(cB(256)),c.entry_flow.conv_in,[2,2]));return d=mp(d,c.entry_flow.reduction_block_0,!1),d=mp(d,c.entry_flow.reduction_block_1),lj(b._numMainBlocks,0,1).forEach(function(a){var b,e,f;b=d,e=c.middle_flow["main_block_"+a],f=lX(i2(b),e.separable_conv0,[1,1]),f=lX(i2(f),e.separable_conv1,[1,1]),d=f=hF(f=lX(i2(f),e.separable_conv2,[1,1]),b)}),d=i2(lX(d=mp(d,c.exit_flow.reduction_block),c.exit_flow.separable_conv,[1,1]))})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.getDefaultModelName=function(){return"tiny_xception_model"},b.prototype.extractParamsFromWeigthMap=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return b=a,c=this._numMainBlocks,i=(h={extractConvParams:e=l8(d=l5(b,g=[])),extractSeparableConvParams:f=l4(d),extractReductionBlockParams:function(a){return{separable_conv0:f(a+"/separable_conv0"),separable_conv1:f(a+"/separable_conv1"),expansion_conv:e(a+"/expansion_conv")}},extractMainBlockParams:function(a){return{separable_conv0:f(a+"/separable_conv0"),separable_conv1:f(a+"/separable_conv1"),separable_conv2:f(a+"/separable_conv2")}}}).extractConvParams,j=h.extractSeparableConvParams,k=h.extractReductionBlockParams,l=h.extractMainBlockParams,m=i("entry_flow/conv_in"),n=k("entry_flow/reduction_block_0"),o=k("entry_flow/reduction_block_1"),p={},lj(c,0,1).forEach(function(a){p["main_block_"+a]=l("middle_flow/main_block_"+a)}),q=k("exit_flow/reduction_block"),r=j("exit_flow/separable_conv"),l_(b,g),{params:{entry_flow:{conv_in:m,reduction_block_0:n,reduction_block_1:o},middle_flow:p,exit_flow:{reduction_block:q,separable_conv:r}},paramMappings:g}},b.prototype.extractParams=function(a){return function(a,b){var c,d,e=[],f=l6(a),g=f.extractWeights,h=f.getRemainingWeights,i={extractConvParams:c=l0(g,e),extractSeparableConvParams:d=l3(g,e),extractReductionBlockParams:function(a,b,e){return{separable_conv0:d(a,b,e+"/separable_conv0"),separable_conv1:d(b,b,e+"/separable_conv1"),expansion_conv:c(a,b,1,e+"/expansion_conv")}},extractMainBlockParams:function(a,b){return{separable_conv0:d(a,a,b+"/separable_conv0"),separable_conv1:d(a,a,b+"/separable_conv1"),separable_conv2:d(a,a,b+"/separable_conv2")}}},j=i.extractConvParams,k=i.extractSeparableConvParams,l=i.extractReductionBlockParams,m=i.extractMainBlockParams,n=j(3,32,3,"entry_flow/conv_in"),o=l(32,64,"entry_flow/reduction_block_0"),p=l(64,128,"entry_flow/reduction_block_1"),q={};lj(b,0,1).forEach(function(a){q["main_block_"+a]=m(128,"middle_flow/main_block_"+a)});var r=l(128,256,"exit_flow/reduction_block"),s=k(256,512,"exit_flow/separable_conv");if(0!==h().length)throw Error("weights remaing after extract: "+h().length);return{paramMappings:e,params:{entry_flow:{conv_in:n,reduction_block_0:o,reduction_block_1:p},middle_flow:q,exit_flow:{reduction_block:r,separable_conv:s}}}}(a,this._numMainBlocks)},b}(lW);(c=i||(i={})).FEMALE="female",c.MALE="male";var mr=function(a){function b(b){void 0===b&&(b=new mq(2));var c=a.call(this,"AgeGenderNet")||this;return c._faceFeatureExtractor=b,c}return k1(b,a),Object.defineProperty(b.prototype,"faceFeatureExtractor",{get:function(){return this._faceFeatureExtractor},enumerable:!0,configurable:!0}),b.prototype.runNet=function(a){var b=this,c=this.params;if(!c)throw Error(this._name+" - load model before inference");return b3(function(){var d=a instanceof lR?b.faceFeatureExtractor.forwardInput(a):a,e=iG(d,[7,7],[2,2],"valid").as2D(d.shape[0],-1);return{age:mb(e,c.fc.age).as1D(),gender:mb(e,c.fc.gender)}})},b.prototype.forwardInput=function(a){var b=this;return b3(function(){var c=b.runNet(a);return{age:c.age,gender:d_(c.gender)}})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.predictAgeAndGender=function(a){return k3(this,void 0,void 0,function(){var b,c,d,e,f,g=this;return k4(this,function(h){switch(h.label){case 0:return[4,lS(a)];case 1:return b=h.sent(),[4,this.forwardInput(b)];case 2:return d=dy((c=h.sent()).age),e=dy(c.gender),[4,Promise.all(d.map(function(a,b){return{ageTensor:a,genderTensor:e[b]}}).map(function(a){var b=a.ageTensor,c=a.genderTensor;return k3(g,void 0,void 0,function(){var a,d,e,f,g;return k4(this,function(h){switch(h.label){case 0:return[4,b.data()];case 1:return a=h.sent()[0],[4,c.data()];case 2:return f=(e=(d=h.sent()[0])>.5)?i.MALE:i.FEMALE,g=e?d:1-d,b.dispose(),c.dispose(),[2,{age:a,gender:f,genderProbability:g}]}})})}))];case 3:return f=h.sent(),c.age.dispose(),c.gender.dispose(),[2,b.isBatchInput?f:f[0]]}})})},b.prototype.getDefaultModelName=function(){return"age_gender_model"},b.prototype.dispose=function(b){void 0===b&&(b=!0),this.faceFeatureExtractor.dispose(b),a.prototype.dispose.call(this,b)},b.prototype.loadClassifierParams=function(a){var b=this.extractClassifierParams(a),c=b.params,d=b.paramMappings;this._params=c,this._paramMappings=d},b.prototype.extractClassifierParams=function(a){return function(a){var b=[],c=l6(a),d=c.extractWeights,e=c.getRemainingWeights,f=l1(d,b),g=f(512,1,"fc/age"),h=f(512,2,"fc/gender");if(0!==e().length)throw Error("weights remaing after extract: "+e().length);return{paramMappings:b,params:{fc:{age:g,gender:h}}}}(a)},b.prototype.extractParamsFromWeigthMap=function(a){var b=mc(a),c=b.featureExtractorMap,d=b.classifierMap;this.faceFeatureExtractor.loadFromWeightMap(c);var e=[],f=l5(d,e);function g(a){return{weights:f(a+"/weights",2),bias:f(a+"/bias",1)}}var h={fc:{age:g("fc/age"),gender:g("fc/gender")}};return l_(d,e),{params:h,paramMappings:e}},b.prototype.extractParams=function(a){var b=a.slice(0,a.length-1539),c=a.slice(a.length-1539);return this.faceFeatureExtractor.extractWeights(b),this.extractClassifierParams(c)},b}(lW),ms=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.postProcess=function(a,b,c){var d=c.map(function(a){var c=a.width,d=a.height,e=b/Math.max(d,c);return{width:c*e,height:d*e}}),e=d.length;return b3(function(){var c=function(a,b){return dv([cL([68],a),cL([68],b)],1).as2D(1,136).as1D()},f=function(a,b){var c=d[a],e=c.width,f=c.height;return b(e,f)?Math.abs(e-f)/2:0};return a.mul(cL([e,136],b)).sub(dv(Array.from(Array(e),function(a,b){return c(f(b,function(a,b){return a<b}),f(b,function(a,b){return b<a}))}))).div(dv(Array.from(Array(e),function(a,b){return c(d[b].width,d[b].height)})))})},b.prototype.forwardInput=function(a){var b=this;return b3(function(){var c=b.runNet(a);return b.postProcess(c,a.inputSize,a.inputDimensions.map(function(a){return{height:a[0],width:a[1]}}))})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.detectLandmarks=function(a){return k3(this,void 0,void 0,function(){var b,c,d,e=this;return k4(this,function(f){switch(f.label){case 0:return[4,lS(a)];case 1:return b=f.sent(),[4,Promise.all((c=b3(function(){return dy(e.forwardInput(b))})).map(function(a,c){return k3(e,void 0,void 0,function(){var d,e,f,g,h;return k4(this,function(i){switch(i.label){case 0:return f=(e=Array).from,[4,a.data()];case 1:return g=(d=f.apply(e,[i.sent()])).filter(function(a,b){return le(b)}),h=d.filter(function(a,b){return!le(b)}),[2,new lw(Array(68).fill(0).map(function(a,b){return new k6(g[b],h[b])}),{height:b.getInputHeight(c),width:b.getInputWidth(c)})]}})})}))];case 2:return d=f.sent(),c.forEach(function(a){return a.dispose()}),[2,b.isBatchInput?d:d[0]]}})})},b.prototype.getClassifierChannelsOut=function(){return 136},b}(md),mt=function(a){function b(b){return void 0===b&&(b=new ma),a.call(this,"FaceLandmark68Net",b)||this}return k1(b,a),b.prototype.getDefaultModelName=function(){return"face_landmark_68_model"},b.prototype.getClassifierChannelsIn=function(){return 256},b}(ms),mu=function(a){function b(){return a.call(this,"TinyFaceFeatureExtractor")||this}return k1(b,a),b.prototype.forwardInput=function(a){var b=this.params;if(!b)throw Error("TinyFaceFeatureExtractor - load model before inference");return b3(function(){var c=lY(lr(a.toBatchTensor(112,!0),[122.782,117.001,104.298]).div(cB(255)),b.dense0,!0);return c=lY(c,b.dense1),c=iG(c=lY(c,b.dense2),[14,14],[2,2],"valid")})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.getDefaultModelName=function(){return"face_feature_extractor_tiny_model"},b.prototype.extractParamsFromWeigthMap=function(a){var b,c,d;return d={dense0:(c=l9(a,b=[]).extractDenseBlock3Params)("dense0",!0),dense1:c("dense1"),dense2:c("dense2")},l_(a,b),{params:d,paramMappings:b}},b.prototype.extractParams=function(a){return function(a){var b=[],c=l6(a),d=c.extractWeights,e=c.getRemainingWeights,f=l7(d,b).extractDenseBlock3Params,g=f(3,32,"dense0",!0),h=f(32,64,"dense1"),i=f(64,128,"dense2");if(0!==e().length)throw Error("weights remaing after extract: "+e().length);return{paramMappings:b,params:{dense0:g,dense1:h,dense2:i}}}(a)},b}(lW),mv=function(a){function b(b){return void 0===b&&(b=new mu),a.call(this,"FaceLandmark68TinyNet",b)||this}return k1(b,a),b.prototype.getDefaultModelName=function(){return"face_landmark_68_tiny_model"},b.prototype.getClassifierChannelsIn=function(){return 128},b}(ms);function mw(a,b,c,d,e){void 0===e&&(e="same");var f,g=b.conv,h=g.filters,i=g.bias,j=ik(a,h,c,e);return j=hF(j,i),j=hF(hT(j,(f=b.scale).weights),f.biases),d?i2(j):j}function mx(a,b){return mw(a,b,[1,1],!1)}function my(a,b){return mw(a,b,[2,2],!0,"valid")}function mz(a,b){var c=mw(a,b.conv1,[1,1],!0);return i2(c=hF(c=mx(c,b.conv2),a))}function mA(a,b){var c=my(a,b.conv1);c=mx(c,b.conv2);var d=iG(a,2,2,"valid"),e=cK(d.shape),f=d.shape[3]!==c.shape[3];if(d.shape[1]!==c.shape[1]||d.shape[2]!==c.shape[2]){var g=k5(c.shape);g[1]=1;var h=k5((c=cQ([c,cK(g)],1)).shape);h[2]=1,c=cQ([c,cK(h)],2)}return i2(c=hF(d=f?cQ([d,e],3):d,c))}k1(function(){return null!==d&&d.apply(this,arguments)||this},d=mt);var mB=function(a){function b(){return a.call(this,"FaceRecognitionNet")||this}return k1(b,a),b.prototype.forwardInput=function(a){var b=this.params;if(!b)throw Error("FaceRecognitionNet - load model before inference");return b3(function(){var c=my(lr(a.toBatchTensor(150,!0).toFloat(),[122.782,117.001,104.298]).div(cB(256)),b.conv32_down);return c=mz(c=iF(c,3,2,"valid"),b.conv32_1),c=mz(c,b.conv32_2),c=mA(c=mz(c,b.conv32_3),b.conv64_down),c=mz(c,b.conv64_1),c=mz(c,b.conv64_2),c=mA(c=mz(c,b.conv64_3),b.conv128_down),c=mz(c,b.conv128_1),c=mA(c=mz(c,b.conv128_2),b.conv256_down),c=mz(c,b.conv256_1),iv((c=mA(c=mz(c,b.conv256_2),b.conv256_down_out)).mean([1,2]),b.fc)})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.computeFaceDescriptor=function(a){return k3(this,void 0,void 0,function(){var b,c,d,e=this;return k4(this,function(f){switch(f.label){case 0:return[4,lS(a)];case 1:return b=f.sent(),[4,Promise.all((c=b3(function(){return dy(e.forwardInput(b))})).map(function(a){return a.data()}))];case 2:return d=f.sent(),c.forEach(function(a){return a.dispose()}),[2,b.isBatchInput?d:d[0]]}})})},b.prototype.getDefaultModelName=function(){return"face_recognition_model"},b.prototype.extractParamsFromWeigthMap=function(a){return function(a){var b=[],c=function(a,b){var c=l5(a,b);function d(a){return{conv:{filters:c(a+"/conv/filters",4),bias:c(a+"/conv/bias",1)},scale:{weights:c(a+"/scale/weights",1),biases:c(a+"/scale/biases",1)}}}return{extractConvLayerParams:d,extractResidualLayerParams:function(a){return{conv1:d(a+"/conv1"),conv2:d(a+"/conv2")}}}}(a,b),d=c.extractConvLayerParams,e=c.extractResidualLayerParams,f=d("conv32_down"),g=e("conv32_1"),h=e("conv32_2"),i=e("conv32_3"),j=e("conv64_down"),k=e("conv64_1"),l=e("conv64_2"),m=e("conv64_3"),n=e("conv128_down"),o=e("conv128_1"),p=e("conv128_2"),q=e("conv256_down"),r=e("conv256_1"),s=e("conv256_2"),t=e("conv256_down_out"),u=a.fc;if(b.push({originalPath:"fc",paramPath:"fc"}),!la(u))throw Error("expected weightMap[fc] to be a Tensor2D, instead have "+u);return l_(a,b),{params:{conv32_down:f,conv32_1:g,conv32_2:h,conv32_3:i,conv64_down:j,conv64_1:k,conv64_2:l,conv64_3:m,conv128_down:n,conv128_1:o,conv128_2:p,conv256_down:q,conv256_1:r,conv256_2:s,conv256_down_out:t,fc:u},paramMappings:b}}(a)},b.prototype.extractParams=function(a){return function(a){var b=l6(a),c=b.extractWeights,d=b.getRemainingWeights,e=[],f=function(a,b){function c(c,d,e,f){var g,h,i,j,k,l;return{conv:(g=f+"/conv",h=function(b,c,d){var e=a(b),f=e.length/(c*d*d);if(ld(f))throw Error("depth has to be an integer: "+f+", weights.length: "+e.length+", numFilters: "+c+", filterSize: "+d);return b3(function(){return i5(cF(e,[c,f,d,d]),[2,3,1,0])})}(c,d,e),i=cC(a(d)),b.push({paramPath:g+"/filters"},{paramPath:g+"/bias"}),{filters:h,bias:i}),scale:(j=f+"/scale",k=cC(a(d)),l=cC(a(d)),b.push({paramPath:j+"/weights"},{paramPath:j+"/biases"}),{weights:k,biases:l})}}return{extractConvLayerParams:c,extractResidualLayerParams:function(a,b,d,e,f){return void 0===f&&(f=!1),{conv1:c((f?.5:1)*a,b,d,e+"/conv1"),conv2:c(a,b,d,e+"/conv2")}}}}(c,e),g=f.extractConvLayerParams,h=f.extractResidualLayerParams,i=g(4704,32,7,"conv32_down"),j=h(9216,32,3,"conv32_1"),k=h(9216,32,3,"conv32_2"),l=h(9216,32,3,"conv32_3"),m=h(36864,64,3,"conv64_down",!0),n=h(36864,64,3,"conv64_1"),o=h(36864,64,3,"conv64_2"),p=h(36864,64,3,"conv64_3"),q=h(147456,128,3,"conv128_down",!0),r=h(147456,128,3,"conv128_1"),s=h(147456,128,3,"conv128_2"),t=h(589824,256,3,"conv256_down",!0),u=h(589824,256,3,"conv256_1"),v=h(589824,256,3,"conv256_2"),w=h(589824,256,3,"conv256_down_out"),x=b3(function(){return i5(cD(c(32768),[128,256]),[1,0])});if(e.push({paramPath:"fc"}),0!==d().length)throw Error("weights remaing after extract: "+d().length);return{params:{conv32_down:i,conv32_1:j,conv32_2:k,conv32_3:l,conv64_down:m,conv64_1:n,conv64_2:o,conv64_3:p,conv128_down:q,conv128_1:r,conv128_2:s,conv256_down:t,conv256_1:u,conv256_2:v,conv256_down_out:w,fc:x},paramMappings:e}}(a)},b}(lW);function mC(a,b){return Object.assign({},a,{descriptor:b})}function mD(a,b){return Object.assign({},a,{age:b})}function mE(a,b,c){return Object.assign({},a,{gender:b,genderProbability:c})}var mF=function(){function a(a){var b=void 0===a?{}:a,c=b.minFaceSize,d=b.scaleFactor,e=b.maxNumScales,f=b.scoreThresholds,g=b.scaleSteps;if(this._name="MtcnnOptions",this._minFaceSize=c||20,this._scaleFactor=d||.709,this._maxNumScales=e||10,this._scoreThresholds=f||[.6,.7,.7],this._scaleSteps=g,"number"!=typeof this._minFaceSize||this._minFaceSize<0)throw Error(this._name+" - expected minFaceSize to be a number > 0");if("number"!=typeof this._scaleFactor||this._scaleFactor<=0||this._scaleFactor>=1)throw Error(this._name+" - expected scaleFactor to be a number between 0 and 1");if("number"!=typeof this._maxNumScales||this._maxNumScales<0)throw Error(this._name+" - expected maxNumScales to be a number > 0");if(!Array.isArray(this._scoreThresholds)||3!==this._scoreThresholds.length||this._scoreThresholds.some(function(a){return"number"!=typeof a}))throw Error(this._name+" - expected scoreThresholds to be an array of numbers of length 3");if(this._scaleSteps&&(!Array.isArray(this._scaleSteps)||this._scaleSteps.some(function(a){return"number"!=typeof a})))throw Error(this._name+" - expected scaleSteps to be an array of numbers")}return Object.defineProperty(a.prototype,"minFaceSize",{get:function(){return this._minFaceSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleFactor",{get:function(){return this._scaleFactor},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"maxNumScales",{get:function(){return this._maxNumScales},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scoreThresholds",{get:function(){return this._scoreThresholds},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleSteps",{get:function(){return this._scaleSteps},enumerable:!0,configurable:!0}),a}();function mG(a,b,c){return b3(function(){var d=ik(a,b.filters,c,"same");return gX(d=hF(d,b.batch_norm_offset),0,6)})}function mH(a,b){return b3(function(){var c=a.shape[0];return{boxPredictionEncoding:ds(l$(a,b.box_encoding_predictor),[c,-1,1,4]),classPrediction:ds(l$(a,b.class_predictor),[c,-1,3])}})}var mI=function(){function a(a){var b=void 0===a?{}:a,c=b.minConfidence,d=b.maxResults;if(this._name="SsdMobilenetv1Options",this._minConfidence=c||.5,this._maxResults=d||100,"number"!=typeof this._minConfidence||this._minConfidence<=0||this._minConfidence>=1)throw Error(this._name+" - expected minConfidence to be a number between 0 and 1");if("number"!=typeof this._maxResults)throw Error(this._name+" - expected maxResults to be a number")}return Object.defineProperty(a.prototype,"minConfidence",{get:function(){return this._minConfidence},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"maxResults",{get:function(){return this._maxResults},enumerable:!0,configurable:!0}),a}(),mJ=function(a){function b(){return a.call(this,"SsdMobilenetv1")||this}return k1(b,a),b.prototype.forwardInput=function(a){var b=this.params;if(!b)throw Error("SsdMobilenetv1 - load model before inference");return b3(function(){var c,d,e,f,g,h,i=(c=hY(hT(a.toBatchTensor(512,!1).toFloat(),cB(.007843137718737125)),cB(1)),d=b.mobilenetv1,b3(function(){var a=null,b=mG(c,d.conv_0,[2,2]);if([d.conv_1,d.conv_2,d.conv_3,d.conv_4,d.conv_5,d.conv_6,d.conv_7,d.conv_8,d.conv_9,d.conv_10,d.conv_11,d.conv_12,d.conv_13].forEach(function(c,d){var e,f,g=d+1,h=[2,4,6,12].some(function(a){return a===g})?[2,2]:[1,1];e=b,f=c.depthwise_conv,b=mG(b=b3(function(){var a=ip(e,f.filters,h,"same");return gX(a=hv(a,f.batch_norm_mean,f.batch_norm_variance,f.batch_norm_offset,f.batch_norm_scale,.0010000000474974513),0,6)}),c.pointwise_conv,[1,1]),11===g&&(a=b)}),null===a)throw Error("mobileNetV1 - output of conv layer 11 is null");return{out:b,conv11:a}})),j=(e=i.out,f=i.conv11,g=b.prediction_layer,b3(function(){var a=mG(e,g.conv_0,[1,1]),b=mG(a,g.conv_1,[2,2]),c=mG(b,g.conv_2,[1,1]),d=mG(c,g.conv_3,[2,2]),h=mG(d,g.conv_4,[1,1]),i=mG(h,g.conv_5,[2,2]),j=mG(i,g.conv_6,[1,1]),k=mG(j,g.conv_7,[2,2]),l=mH(f,g.box_predictor_0),m=mH(e,g.box_predictor_1),n=mH(b,g.box_predictor_2),o=mH(d,g.box_predictor_3),p=mH(i,g.box_predictor_4),q=mH(k,g.box_predictor_5);return{boxPredictions:cQ([l.boxPredictionEncoding,m.boxPredictionEncoding,n.boxPredictionEncoding,o.boxPredictionEncoding,p.boxPredictionEncoding,q.boxPredictionEncoding],1),classPredictions:cQ([l.classPrediction,m.classPrediction,n.classPrediction,o.classPrediction,p.classPrediction,q.classPrediction],1)}})),k=j.boxPredictions,l=j.classPredictions;return h=b.output_layer,b3(function(){var a,b,c,d,e,f,g,i,j,m,n,o,p,q=k.shape[0],r=(a=ds(dw(h.extra_dim,[q,1,1]),[-1,4]),b=ds(k,[-1,4]),g=(f=(d=[hY((c=dy(i5(a,[1,0])))[2],c[0]),hY(c[3],c[1])],e=[hF(c[0],hJ(d[0],cB(2))),hF(c[1],hJ(d[1],cB(2)))],{sizes:d,centers:e})).sizes,i=f.centers,m=hJ(hT(g_(hJ((j=dy(i5(b,[1,0])))[2],cB(5))),g[0]),cB(2)),n=hF(hT(hJ(j[0],cB(10)),g[0]),i[0]),o=hJ(hT(g_(hJ(j[3],cB(5))),g[1]),cB(2)),p=hF(hT(hJ(j[1],cB(10)),g[1]),i[1]),i5(dv([hY(n,m),hY(p,o),hF(n,m),hF(p,o)]),[1,0]));r=ds(r,[q,r.shape[0]/q,4]);var s=g9(iK(l,[0,0,1],[-1,-1,-1])),t=iK(s,[0,0,0],[-1,-1,1]);return t=ds(t,[q,t.shape[1]]),{boxes:dy(r),scores:dy(t)}})})},b.prototype.forward=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=this.forwardInput,[4,lS(a)];case 1:return[2,b.apply(this,[c.sent()])]}})})},b.prototype.locateFaces=function(a,b){return void 0===b&&(b={}),k3(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;return k4(this,function(w){switch(w.label){case 0:return d=(c=new mI(b)).maxResults,e=c.minConfidence,[4,lS(a)];case 1:for(f=w.sent(),h=(g=this.forwardInput(f)).boxes,i=g.scores,j=h[0],k=i[0],l=1;l<h.length;l++)h[l].dispose(),i[l].dispose();return o=(n=Array).from,[4,k.data()];case 2:var x,y,z,A,B,C;return m=o.apply(n,[w.sent()]),x=j,y=d,z=e,A=Math.min(y,x.shape[0]),B=m.map(function(a,b){return{score:a,boxIndex:b}}).filter(function(a){return a.score>z}).sort(function(a,b){return b.score-a.score}),C=[],B.forEach(function(a){if(!(C.length>=A)){for(var b=a.score,c=C.length-1;c>=0;--c){var d=function(a,b,c){var d=a.arraySync(),e=Math.min(d[b][0],d[b][2]),f=Math.min(d[b][1],d[b][3]),g=Math.max(d[b][0],d[b][2]),h=Math.max(d[b][1],d[b][3]),i=Math.min(d[c][0],d[c][2]),j=Math.min(d[c][1],d[c][3]),k=Math.max(d[c][0],d[c][2]),l=Math.max(d[c][1],d[c][3]),m=(g-e)*(h-f),n=(k-i)*(l-j);if(m<=0||n<=0)return 0;var o=Math.max(Math.min(g,k)-Math.max(e,i),0)*Math.max(Math.min(h,l)-Math.max(f,j),0);return o/(m+n-o)}(x,a.boxIndex,C[c]);if(0!==d&&(a.score*=d<=.5,a.score<=z))break}b===a.score&&C.push(a.boxIndex)}}),p=C,q=f.getReshapedInputDimensions(0),s=(r=f.inputSize)/q.width,t=r/q.height,u=j.arraySync(),v=p.map(function(a){var b=[Math.max(0,u[a][0]),Math.min(1,u[a][2])].map(function(a){return a*t}),c=b[0],d=b[1],e=[Math.max(0,u[a][1]),Math.min(1,u[a][3])].map(function(a){return a*s}),g=e[0],h=e[1];return new lp(m[a],new lt(g,c,h-g,d-c),{height:f.getInputHeight(0),width:f.getInputWidth(0)})}),j.dispose(),k.dispose(),[2,v]}})})},b.prototype.getDefaultModelName=function(){return"ssd_mobilenetv1_model"},b.prototype.extractParamsFromWeigthMap=function(a){return function(a){var b=[],c=function(a,b){var c=l5(a,b);function d(a,b,d){return{filters:c(a+"/Conv2d_"+b+"_pointwise/weights",4,d+"/filters"),batch_norm_offset:c(a+"/Conv2d_"+b+"_pointwise/convolution_bn_offset",1,d+"/batch_norm_offset")}}function e(a){var b="mobilenetv1/conv_"+a,e="MobilenetV1/Conv2d_"+a+"_depthwise",f=b+"/depthwise_conv";return{depthwise_conv:{filters:c(e+"/depthwise_weights",4,f+"/filters"),batch_norm_scale:c(e+"/BatchNorm/gamma",1,f+"/batch_norm_scale"),batch_norm_offset:c(e+"/BatchNorm/beta",1,f+"/batch_norm_offset"),batch_norm_mean:c(e+"/BatchNorm/moving_mean",1,f+"/batch_norm_mean"),batch_norm_variance:c(e+"/BatchNorm/moving_variance",1,f+"/batch_norm_variance")},pointwise_conv:d("MobilenetV1",a,b+"/pointwise_conv")}}function f(a,b){return{filters:c(a+"/weights",4,b+"/filters"),bias:c(a+"/biases",1,b+"/bias")}}function g(a){return{box_encoding_predictor:f("Prediction/BoxPredictor_"+a+"/BoxEncodingPredictor","prediction_layer/box_predictor_"+a+"/box_encoding_predictor"),class_predictor:f("Prediction/BoxPredictor_"+a+"/ClassPredictor","prediction_layer/box_predictor_"+a+"/class_predictor")}}return{extractMobilenetV1Params:function(){return{conv_0:d("MobilenetV1",0,"mobilenetv1/conv_0"),conv_1:e(1),conv_2:e(2),conv_3:e(3),conv_4:e(4),conv_5:e(5),conv_6:e(6),conv_7:e(7),conv_8:e(8),conv_9:e(9),conv_10:e(10),conv_11:e(11),conv_12:e(12),conv_13:e(13)}},extractPredictionLayerParams:function(){return{conv_0:d("Prediction",0,"prediction_layer/conv_0"),conv_1:d("Prediction",1,"prediction_layer/conv_1"),conv_2:d("Prediction",2,"prediction_layer/conv_2"),conv_3:d("Prediction",3,"prediction_layer/conv_3"),conv_4:d("Prediction",4,"prediction_layer/conv_4"),conv_5:d("Prediction",5,"prediction_layer/conv_5"),conv_6:d("Prediction",6,"prediction_layer/conv_6"),conv_7:d("Prediction",7,"prediction_layer/conv_7"),box_predictor_0:g(0),box_predictor_1:g(1),box_predictor_2:g(2),box_predictor_3:g(3),box_predictor_4:g(4),box_predictor_5:g(5)}}}}(a,b),d=c.extractMobilenetV1Params,e=c.extractPredictionLayerParams,f=a["Output/extra_dim"];if(b.push({originalPath:"Output/extra_dim",paramPath:"output_layer/extra_dim"}),!lb(f))throw Error("expected weightMap['Output/extra_dim'] to be a Tensor3D, instead have "+f);var g={mobilenetv1:d(),prediction_layer:e(),output_layer:{extra_dim:f}};return l_(a,b),{params:g,paramMappings:b}}(a)},b.prototype.extractParams=function(a){return function(a){var b=[],c=l6(a),d=c.extractWeights,e=c.getRemainingWeights,f=function(a,b){function c(c,d,e,f,g){var h=cF(a(c*d*e*e),[e,e,c,d]),i=cC(a(d));return b.push({paramPath:f+"/filters"},{paramPath:f+"/"+(g?"batch_norm_offset":"bias")}),{filters:h,bias:i}}function d(a,b,d,e){var f=c(a,b,d,e,!0);return{filters:f.filters,batch_norm_offset:f.bias}}function e(c,e,f){var g,h,i,j,k,l;return{depthwise_conv:(g=f+"/depthwise_conv",h=cF(a(9*c),[3,3,c,1]),i=cC(a(c)),j=cC(a(c)),k=cC(a(c)),l=cC(a(c)),b.push({paramPath:g+"/filters"},{paramPath:g+"/batch_norm_scale"},{paramPath:g+"/batch_norm_offset"},{paramPath:g+"/batch_norm_mean"},{paramPath:g+"/batch_norm_variance"}),{filters:h,batch_norm_scale:i,batch_norm_offset:j,batch_norm_mean:k,batch_norm_variance:l}),pointwise_conv:d(c,e,1,f+"/pointwise_conv")}}return{extractMobilenetV1Params:function(){return{conv_0:d(3,32,3,"mobilenetv1/conv_0"),conv_1:e(32,64,"mobilenetv1/conv_1"),conv_2:e(64,128,"mobilenetv1/conv_2"),conv_3:e(128,128,"mobilenetv1/conv_3"),conv_4:e(128,256,"mobilenetv1/conv_4"),conv_5:e(256,256,"mobilenetv1/conv_5"),conv_6:e(256,512,"mobilenetv1/conv_6"),conv_7:e(512,512,"mobilenetv1/conv_7"),conv_8:e(512,512,"mobilenetv1/conv_8"),conv_9:e(512,512,"mobilenetv1/conv_9"),conv_10:e(512,512,"mobilenetv1/conv_10"),conv_11:e(512,512,"mobilenetv1/conv_11"),conv_12:e(512,1024,"mobilenetv1/conv_12"),conv_13:e(1024,1024,"mobilenetv1/conv_13")}},extractPredictionLayerParams:function(){return{conv_0:d(1024,256,1,"prediction_layer/conv_0"),conv_1:d(256,512,3,"prediction_layer/conv_1"),conv_2:d(512,128,1,"prediction_layer/conv_2"),conv_3:d(128,256,3,"prediction_layer/conv_3"),conv_4:d(256,128,1,"prediction_layer/conv_4"),conv_5:d(128,256,3,"prediction_layer/conv_5"),conv_6:d(256,64,1,"prediction_layer/conv_6"),conv_7:d(64,128,3,"prediction_layer/conv_7"),box_predictor_0:{box_encoding_predictor:c(512,12,1,"prediction_layer/box_predictor_0/box_encoding_predictor"),class_predictor:c(512,9,1,"prediction_layer/box_predictor_0/class_predictor")},box_predictor_1:{box_encoding_predictor:c(1024,24,1,"prediction_layer/box_predictor_1/box_encoding_predictor"),class_predictor:c(1024,18,1,"prediction_layer/box_predictor_1/class_predictor")},box_predictor_2:{box_encoding_predictor:c(512,24,1,"prediction_layer/box_predictor_2/box_encoding_predictor"),class_predictor:c(512,18,1,"prediction_layer/box_predictor_2/class_predictor")},box_predictor_3:{box_encoding_predictor:c(256,24,1,"prediction_layer/box_predictor_3/box_encoding_predictor"),class_predictor:c(256,18,1,"prediction_layer/box_predictor_3/class_predictor")},box_predictor_4:{box_encoding_predictor:c(256,24,1,"prediction_layer/box_predictor_4/box_encoding_predictor"),class_predictor:c(256,18,1,"prediction_layer/box_predictor_4/class_predictor")},box_predictor_5:{box_encoding_predictor:c(128,24,1,"prediction_layer/box_predictor_5/box_encoding_predictor"),class_predictor:c(128,18,1,"prediction_layer/box_predictor_5/class_predictor")}}}}}(d,b),g=f.extractMobilenetV1Params,h=f.extractPredictionLayerParams,i=g(),j=h(),k=cE(d(20472),[1,5118,4]);if(b.push({paramPath:"output_layer/extra_dim"}),0!==e().length)throw Error("weights remaing after extract: "+e().length);return{params:{mobilenetv1:i,prediction_layer:j,output_layer:{extra_dim:k}},paramMappings:b}}(a)},b}(lW);k1(function(){return null!==e&&e.apply(this,arguments)||this},e=mJ);var mK=[new k6(.738768,.874946),new k6(2.42204,2.65704),new k6(4.30971,7.04493),new k6(10.246,4.59428),new k6(12.6868,11.8741)],mL=[new k6(1.603231,2.094468),new k6(6.041143,7.080126),new k6(2.882459,3.518061),new k6(4.266906,5.178857),new k6(9.041765,10.66308)],mM=[117.001,114.697,97.404],mN=function(a){return"number"==typeof a};function mO(a){return b3(function(){var b=hT(a,cB(.10000000149011612));return hF(i2(hY(a,b)),b)})}function mP(a,b){return b3(function(){var c=di(a,[[0,0],[1,1],[1,1],[0,0]]);return mO(c=hF(c=hT(c=hY(c=ik(c,b.conv.filters,[1,1],"valid"),b.bn.sub),b.bn.truediv),b.conv.bias))})}function mQ(a,b){return b3(function(){var c=di(a,[[0,0],[1,1],[1,1],[0,0]]);return mO(c=hF(c=is(c,b.depthwise_filter,b.pointwise_filter,[1,1],"valid"),b.bias))})}(f=j||(j={}))[f.XS=224]="XS",f[f.SM=320]="SM",f[f.MD=416]="MD",f[f.LG=608]="LG";var mR=function(){function a(a){var b=void 0===a?{}:a,c=b.inputSize,d=b.scoreThreshold;if(this._name="TinyYolov2Options",this._inputSize=c||416,this._scoreThreshold=d||.5,"number"!=typeof this._inputSize||this._inputSize%32!=0)throw Error(this._name+" - expected inputSize to be a number divisible by 32");if("number"!=typeof this._scoreThreshold||this._scoreThreshold<=0||this._scoreThreshold>=1)throw Error(this._name+" - expected scoreThreshold to be a number between 0 and 1")}return Object.defineProperty(a.prototype,"inputSize",{get:function(){return this._inputSize},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scoreThreshold",{get:function(){return this._scoreThreshold},enumerable:!0,configurable:!0}),a}(),mS=function(a){function b(b){var c=a.call(this,"TinyYolov2")||this;if(!b)throw Error("invalid config: "+b);if("boolean"!=typeof b.withSeparableConvs)throw Error("config.withSeparableConvs has to be a boolean, have: "+b.withSeparableConvs);if(!mN(b.iouThreshold)||b.iouThreshold<0||b.iouThreshold>1)throw Error("config.iouThreshold has to be a number between [0, 1], have: "+b.iouThreshold);if(!Array.isArray(b.classes)||!b.classes.length||!b.classes.every(function(a){return"string"==typeof a}))throw Error("config.classes has to be an array class names: string[], have: "+JSON.stringify(b.classes));if(!Array.isArray(b.anchors)||!b.anchors.length||!b.anchors.map(function(a){return a||{}}).every(function(a){return mN(a.x)&&mN(a.y)}))throw Error("config.anchors has to be an array of { x: number, y: number }, have: "+JSON.stringify(b.anchors));if(b.meanRgb&&(!Array.isArray(b.meanRgb)||3!==b.meanRgb.length||!b.meanRgb.every(mN)))throw Error("config.meanRgb has to be an array of shape [number, number, number], have: "+JSON.stringify(b.meanRgb));return c._config=b,c}return k1(b,a),Object.defineProperty(b.prototype,"config",{get:function(){return this._config},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"withClassScores",{get:function(){return this.config.withClassScores||this.config.classes.length>1},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"boxEncodingSize",{get:function(){return 5+(this.withClassScores?this.config.classes.length:0)},enumerable:!0,configurable:!0}),b.prototype.runTinyYolov2=function(a,b){var c=mP(a,b.conv0);return c=mP(c=iF(c,[2,2],[2,2],"same"),b.conv1),c=mP(c=iF(c,[2,2],[2,2],"same"),b.conv2),c=mP(c=iF(c,[2,2],[2,2],"same"),b.conv3),c=mP(c=iF(c,[2,2],[2,2],"same"),b.conv4),c=mP(c=iF(c,[2,2],[2,2],"same"),b.conv5),c=mP(c=iF(c,[2,2],[1,1],"same"),b.conv6),l$(c=mP(c,b.conv7),b.conv8,"valid",!1)},b.prototype.runMobilenet=function(a,b){var c=this.config.isFirstLayerConv2d?mO(l$(a,b.conv0,"valid",!1)):mQ(a,b.conv0);return c=mQ(c=iF(c,[2,2],[2,2],"same"),b.conv1),c=mQ(c=iF(c,[2,2],[2,2],"same"),b.conv2),c=mQ(c=iF(c,[2,2],[2,2],"same"),b.conv3),c=mQ(c=iF(c,[2,2],[2,2],"same"),b.conv4),c=mQ(c=iF(c,[2,2],[2,2],"same"),b.conv5),c=iF(c,[2,2],[1,1],"same"),c=b.conv6?mQ(c,b.conv6):c,l$(c=b.conv7?mQ(c,b.conv7):c,b.conv8,"valid",!1)},b.prototype.forwardInput=function(a,b){var c=this,d=this.params;if(!d)throw Error("TinyYolov2 - load model before inference");return b3(function(){var e=a.toBatchTensor(b,!1).toFloat();return e=(e=c.config.meanRgb?lr(e,c.config.meanRgb):e).div(cB(256)),c.config.withSeparableConvs?c.runMobilenet(e,d):c.runTinyYolov2(e,d)})},b.prototype.forward=function(a,b){return k3(this,void 0,void 0,function(){var c;return k4(this,function(d){switch(d.label){case 0:return c=this.forwardInput,[4,lS(a)];case 1:return[4,c.apply(this,[d.sent(),b])];case 2:return[2,d.sent()]}})})},b.prototype.detect=function(a,b){return void 0===b&&(b={}),k3(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o=this;return k4(this,function(p){switch(p.label){case 0:return d=(c=new mR(b)).inputSize,e=c.scoreThreshold,[4,lS(a)];case 1:return f=p.sent(),[4,this.forwardInput(f,d)];case 2:return g=p.sent(),h=b3(function(){return dy(g)[0].expandDims()}),i={width:f.getInputWidth(0),height:f.getInputHeight(0)},[4,this.extractBoxes(h,f.getReshapedInputDimensions(0),e)];case 3:return j=p.sent(),g.dispose(),h.dispose(),k=j.map(function(a){return a.box}),l=j.map(function(a){return a.score}),m=j.map(function(a){return a.classScore}),n=j.map(function(a){return o.config.classes[a.label]}),[2,lq(k.map(function(a){return a.rescale(d)}),l,this.config.iouThreshold,!0).map(function(a){return new lo(l[a],m[a],n[a],k[a],i)})]}})})},b.prototype.getDefaultModelName=function(){return""},b.prototype.extractParamsFromWeigthMap=function(a){return function(a,b){var c,d=[],e=function(a,b){var c=l5(a,b);function d(a){return{filters:c(a+"/filters",4),bias:c(a+"/bias",1)}}return{extractConvParams:d,extractConvWithBatchNormParams:function(a){var b;return{conv:d(a+"/conv"),bn:{sub:c((b=a+"/bn")+"/sub",1),truediv:c(b+"/truediv",1)}}},extractSeparableConvParams:l4(c)}}(a,d),f=e.extractConvParams,g=e.extractConvWithBatchNormParams,h=e.extractSeparableConvParams;if(b.withSeparableConvs){var i=b.filterSizes&&b.filterSizes.length||9;c={conv0:b.isFirstLayerConv2d?f("conv0"):h("conv0"),conv1:h("conv1"),conv2:h("conv2"),conv3:h("conv3"),conv4:h("conv4"),conv5:h("conv5"),conv6:i>7?h("conv6"):void 0,conv7:i>8?h("conv7"):void 0,conv8:f("conv8")}}else c={conv0:g("conv0"),conv1:g("conv1"),conv2:g("conv2"),conv3:g("conv3"),conv4:g("conv4"),conv5:g("conv5"),conv6:g("conv6"),conv7:g("conv7"),conv8:f("conv8")};return l_(a,d),{params:c,paramMappings:d}}(a,this.config)},b.prototype.extractParams=function(a){var c=this.config.filterSizes||b.DEFAULT_FILTER_SIZES,d=c?c.length:void 0;if(7!==d&&8!==d&&9!==d)throw Error("TinyYolov2 - expected 7 | 8 | 9 convolutional filters, but found "+d+" filterSizes in config");return function(a,b,c,d){var e,f,g=l6(a),h=g.extractWeights,i=g.getRemainingWeights,j=[],k={extractConvParams:e=l0(h,j),extractConvWithBatchNormParams:function(a,b,c){var d,f,g;return{conv:e(a,b,3,c+"/conv"),bn:(d=c+"/bn",f=cC(h(b)),g=cC(h(b)),j.push({paramPath:d+"/sub"},{paramPath:d+"/truediv"}),{sub:f,truediv:g})}},extractSeparableConvParams:l3(h,j)},l=k.extractConvParams,m=k.extractConvWithBatchNormParams,n=k.extractSeparableConvParams;if(b.withSeparableConvs){var o=d[0],p=d[1],q=d[2],r=d[3],s=d[4],t=d[5],u=d[6],v=d[7],w=d[8],x=b.isFirstLayerConv2d?l(o,p,3,"conv0"):n(o,p,"conv0"),y=n(p,q,"conv1"),z=n(q,r,"conv2"),A=n(r,s,"conv3"),B=n(s,t,"conv4"),C=n(t,u,"conv5"),D=v?n(u,v,"conv6"):void 0,E=w?n(v,w,"conv7"):void 0,F=l(w||v||u,5*c,1,"conv8");f={conv0:x,conv1:y,conv2:z,conv3:A,conv4:B,conv5:C,conv6:D,conv7:E,conv8:F}}else{var o=d[0],p=d[1],q=d[2],r=d[3],s=d[4],t=d[5],u=d[6],v=d[7],w=d[8],x=m(o,p,"conv0"),y=m(p,q,"conv1"),z=m(q,r,"conv2"),A=m(r,s,"conv3"),B=m(s,t,"conv4"),C=m(t,u,"conv5"),D=m(u,v,"conv6"),E=m(v,w,"conv7"),F=l(w,5*c,1,"conv8");f={conv0:x,conv1:y,conv2:z,conv3:A,conv4:B,conv5:C,conv6:D,conv7:E,conv8:F}}if(0!==i().length)throw Error("weights remaing after extract: "+i().length);return{params:f,paramMappings:j}}(a,this.config,this.boxEncodingSize,c)},b.prototype.extractBoxes=function(a,b,c){return k3(this,void 0,void 0,function(){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G=this;return k4(this,function(H){switch(H.label){case 0:return g=(f=Math.max(d=b.width,e=b.height))/d,h=f/e,i=a.shape[1],j=this.config.anchors.length,l=(k=b3(function(){var b=a.reshape([i,i,j,G.boxEncodingSize]);return[b.slice([0,0,0,0],[i,i,j,4]),b.slice([0,0,0,4],[i,i,j,1]),G.withClassScores?d_(b.slice([0,0,0,5],[i,i,j,G.config.classes.length]),3):cB(0)]}))[0],m=k[1],n=k[2],o=[],[4,m.array()];case 1:return p=H.sent(),[4,l.array()];case 2:q=H.sent(),r=0,H.label=3;case 3:if(!(r<i))return[3,12];s=0,H.label=4;case 4:if(!(s<i))return[3,11];t=0,H.label=5;case 5:if(!(t<j))return[3,10];if(u=ls(p[r][s][t][0]),!(!c||u>c))return[3,9];if(v=(s+ls(q[r][s][t][0]))/i*g,w=(r+ls(q[r][s][t][1]))/i*h,x=Math.exp(q[r][s][t][2])*this.config.anchors[t].x/i*g,y=Math.exp(q[r][s][t][3])*this.config.anchors[t].y/i*h,z=v-x/2,A=w-y/2,B={row:r,col:s,anchor:t},!this.withClassScores)return[3,7];return[4,this.extractPredictedClass(n,B)];case 6:return F=H.sent(),[3,8];case 7:F={classScore:1,label:0},H.label=8;case 8:D=(C=F).classScore,E=C.label,o.push(k2({box:new ln(z,A,z+x,A+y),score:u,classScore:u*D,label:E},B)),H.label=9;case 9:return t++,[3,5];case 10:return s++,[3,4];case 11:return r++,[3,3];case 12:return l.dispose(),m.dispose(),n.dispose(),[2,o]}})})},b.prototype.extractPredictedClass=function(a,b){return k3(this,void 0,void 0,function(){var c,d,e,f;return k4(this,function(g){switch(g.label){case 0:return c=b.row,d=b.col,e=b.anchor,[4,a.array()];case 1:return f=g.sent(),[2,Array(this.config.classes.length).fill(0).map(function(a,b){return f[c][d][e][b]}).map(function(a,b){return{classScore:a,label:b}}).reduce(function(a,b){return a.classScore>b.classScore?a:b})]}})})},b.DEFAULT_FILTER_SIZES=[3,16,32,64,128,256,512,1024,1024],b}(lW),mT=function(a){function b(b){void 0===b&&(b=!0);var c=Object.assign({},{withSeparableConvs:b,iouThreshold:.4,classes:["face"]},b?{anchors:mL,meanRgb:mM}:{anchors:mK,withClassScores:!0});return a.call(this,c)||this}return k1(b,a),Object.defineProperty(b.prototype,"withSeparableConvs",{get:function(){return this.config.withSeparableConvs},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),b.prototype.locateFaces=function(a,b){return k3(this,void 0,void 0,function(){return k4(this,function(c){switch(c.label){case 0:return[4,this.detect(a,b)];case 1:return[2,c.sent().map(function(a){return new lp(a.score,a.relativeBox,{width:a.imageWidth,height:a.imageHeight})})]}})})},b.prototype.getDefaultModelName=function(){return this.withSeparableConvs?"tiny_yolov2_separable_conv_model":"tiny_yolov2_model"},b.prototype.extractParamsFromWeigthMap=function(b){return a.prototype.extractParamsFromWeigthMap.call(this,b)},b}(mS),mU=function(a){function b(){var b=null!==a&&a.apply(this,arguments)||this;return b._name="TinyFaceDetectorOptions",b}return k1(b,a),b}(mR),mV=function(){function a(){}return a.prototype.then=function(a){return k3(this,void 0,void 0,function(){var b;return k4(this,function(c){switch(c.label){case 0:return b=a,[4,this.run()];case 1:return[2,b.apply(void 0,[c.sent()])]}})})},a.prototype.run=function(){return k3(this,void 0,void 0,function(){return k4(this,function(a){throw Error("ComposableTask - run is not implemented")})})},a}();function mW(a,b,c,d,e){return void 0===e&&(e=function(a){return a.alignedRect}),k3(this,void 0,void 0,function(){var f,g,h,i,j;return k4(this,function(k){switch(k.label){case 0:if(f=a.map(function(a){return mj(a)?e(a):a.detection}),h=d)return[3,5];if(!(b instanceof aF))return[3,2];return[4,lU(b,f)];case 1:return i=k.sent(),[3,4];case 2:return[4,lT(b,f)];case 3:i=k.sent(),k.label=4;case 4:h=i,k.label=5;case 5:return[4,c(g=h)];case 6:return j=k.sent(),g.forEach(function(a){return a instanceof aF&&a.dispose()}),[2,j]}})})}function mX(a,b,c,d,e){return k3(this,void 0,void 0,function(){var f=this;return k4(this,function(g){return[2,mW([a],b,function(a){return k3(f,void 0,void 0,function(){return k4(this,function(b){return[2,c(a[0])]})})},d,e)]})})}function mY(a,b){return{height:Math.floor(b[0]*a),width:Math.floor(b[1]*a)}}var mZ=function(a){function b(b,c,d,e){return a.call(this,{left:b,top:c,right:d,bottom:e},!0)||this}return k1(b,a),b}(lm);function m$(a){return b3(function(){return hT(hY(a,cB(127.5)),cB(.0078125))})}function m_(a,b){return b3(function(){return hF(i2(a),hT(b,g5(i2(g5(a)))))})}function m0(a,b,c){return void 0===c&&(c=!1),b3(function(){var d=l$(a,b.conv1,"valid");return d=l$(d=iF(d=m_(d,b.prelu1_alpha),c?[2,2]:[3,3],[2,2],"same"),b.conv2,"valid"),d=m_(d,b.prelu2_alpha),d=m_(d=l$(d=c?d:iF(d,[3,3],[2,2],"valid"),b.conv3,"valid"),b.prelu3_alpha)})}function m1(a,b,c){var d=c.width,e=c.height;return k3(this,void 0,void 0,function(){var c,f,g,h=this;return k4(this,function(i){switch(i.label){case 0:return c=lG(a),[4,Promise.all(b.map(function(b){return k3(h,void 0,void 0,function(){var d,e,f,g,h,i,j,k;return k4(this,function(l){return e=(d=b.padAtBorders(a.height,a.width)).y,f=d.ey,g=d.x,h=d.ex,i=g-1,j=e-1,k=c.getImageData(i,j,h-i,f-j),[2,lE()?lP(k):createImageBitmap(k)]})})}))];case 1:return f=i.sent(),g=[],f.forEach(function(a){var b=lG(lO({width:d,height:e}));b.drawImage(a,0,0,d,e);for(var c=b.getImageData(0,0,d,e).data,f=[],h=0;h<c.length;h+=4)f.push(c[h+2]),f.push(c[h+1]),f.push(c[h]);g.push(f)}),[2,g.map(function(a){return b3(function(){return m$(i5(cF(a,[1,d,e,3]),[0,2,1,3]).toFloat())})})]}})})}var m2=function(a){function b(){return a.call(this,"Mtcnn")||this}return k1(b,a),b.prototype.load=function(b){return k3(this,void 0,void 0,function(){return k4(this,function(c){return console.warn("mtcnn is deprecated and will be removed soon"),[2,a.prototype.load.call(this,b)]})})},b.prototype.loadFromDisk=function(b){return k3(this,void 0,void 0,function(){return k4(this,function(c){return console.warn("mtcnn is deprecated and will be removed soon"),[2,a.prototype.loadFromDisk.call(this,b)]})})},b.prototype.forwardInput=function(a,b){return void 0===b&&(b={}),k3(this,void 0,void 0,function(){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;return k4(this,function(w){switch(w.label){case 0:if(!(c=this.params))throw Error("Mtcnn - load model before inference");if(!(d=a.canvases[0]))throw Error("Mtcnn - inputCanvas is not defined, note that passing tensors into Mtcnn.forwardInput is not supported yet.");return e={},f=Date.now(),g=b3(function(){var a;return a=de(kF.fromPixels(d)).toFloat(),b3(function(){return dv(dy(a,3).reverse(),3)})}),h=function(a){return g.dispose(),e.total=Date.now()-f,a},j=(i=g.shape.slice(1))[0],k=i[1],m=(l=new mF(b)).minFaceSize,n=l.scaleFactor,o=l.maxNumScales,p=l.scoreThresholds,q=(l.scaleSteps||function(a,b,c){for(var d=c[0],e=c[1],f=12/a,g=[],h=Math.min(d,e)*f,i=0;h>=12;)g.push(f*Math.pow(b,i)),h*=b,i+=1;return g}(m,n,[j,k])).filter(function(a){var b=mY(a,[j,k]);return Math.min(b.width,b.height)>12}).slice(0,o),e.scales=q,e.pyramid=q.map(function(a){return mY(a,[j,k])}),r=Date.now(),[4,function(a,b,c,d,e){e.stage1=[];var f=b.map(function(b){return b3(function(){var c={scale:b},e=b3(function(){var c=mY(b,a.shape.slice(1)),d=c.height,e=c.width;return i5(m$(jI.resizeBilinear(a,[d,e])),[0,2,1,3])}),f=Date.now(),g=b3(function(){var a=m0(e,d,!0),b=l$(a,d.conv4_1,"valid"),c=de(iV(b,3),3);return{prob:d_(hY(b,c),3),regions:l$(a,d.conv4_2,"valid")}}),h=g.prob,i=g.regions;return c.pnet=Date.now()-f,{scoresTensor:dy(dy(h,3)[1])[0],regionsTensor:dy(i)[0],scale:b,statsForScale:c}})}).map(function(a){var b=a.scoresTensor,d=a.regionsTensor,f=a.scale,g=a.statsForScale,h=function(a,b,c,d){for(var e=[],f=a.arraySync(),g=0;g<a.shape[0];g++)for(var h=0;h<a.shape[1];h++)f[g][h]>=d&&e.push(new k6(h,g));return e.map(function(a){var d=new ln(Math.round((2*a.y+1)/c),Math.round((2*a.x+1)/c),Math.round((2*a.y+12)/c),Math.round((2*a.x+12)/c)),e=f[a.y][a.x],g=b.arraySync();return{cell:d,score:e,region:new mZ(g[a.y][a.x][0],g[a.y][a.x][1],g[a.y][a.x][2],g[a.y][a.x][3])}})}(b,d,f,c);if(b.dispose(),d.dispose(),!h.length)return e.stage1.push(g),[];var i=Date.now(),j=lq(h.map(function(a){return a.cell}),h.map(function(a){return a.score}),.5);return g.nms=Date.now()-i,g.numBoxes=j.length,e.stage1.push(g),j.map(function(a){return h[a]})}).reduce(function(a,b){return a.concat(b)},[]),g=[],h=[];if(f.length>0){var i=Date.now(),j=lq(f.map(function(a){return a.cell}),f.map(function(a){return a.score}),.7);e.stage1_nms=Date.now()-i,h=j.map(function(a){return f[a].score}),g=j.map(function(a){return f[a]}).map(function(a){var b=a.cell,c=a.region;return new ln(b.left+c.left*b.width,b.top+c.top*b.height,b.right+c.right*b.width,b.bottom+c.bottom*b.height).toSquare().round()})}return{boxes:g,scores:h}}(g,q,p[0],c.pnet,e)];case 1:if(s=w.sent(),e.total_stage1=Date.now()-r,!s.boxes.length)return[2,h({results:[],stats:e})];return e.stage2_numInputBoxes=s.boxes.length,r=Date.now(),[4,function(a,b,c,d,e){return k3(this,void 0,void 0,function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s;return k4(this,function(t){switch(t.label){case 0:return f=Date.now(),[4,m1(a,b,{width:24,height:24})];case 1:return g=t.sent(),e.stage2_extractImagePatches=Date.now()-f,f=Date.now(),h=g.map(function(a){var b=b3(function(){var b=m0(a,d),c=m_(mb(ds(b,[b.shape[0],d.fc1.weights.shape[0]]),d.fc1),d.prelu4_alpha),e=mb(c,d.fc2_1),f=de(iV(e,1),1),g=d_(hY(e,f),1),h=mb(c,d.fc2_2);return{scores:dy(g,1)[1],regions:h}});return a.dispose(),b}),e.stage2_rnet=Date.now()-f,i=h.length>1?cQ(h.map(function(a){return a.scores})):h[0].scores,l=(k=Array).from,[4,i.data()];case 2:return j=l.apply(k,[t.sent()]),i.dispose(),n=(m=j.map(function(a,b){return{score:a,idx:b}}).filter(function(a){return a.score>c}).map(function(a){return a.idx})).map(function(a){return b[a]}),o=m.map(function(a){return j[a]}),p=[],q=[],n.length>0&&(f=Date.now(),r=lq(n,o,.7),e.stage2_nms=Date.now()-f,s=r.map(function(a){var b=h[m[a]].regions.arraySync();return new mZ(b[0][0],b[0][1],b[0][2],b[0][3])}),q=r.map(function(a){return o[a]}),p=r.map(function(a,b){return n[a].calibrate(s[b])})),h.forEach(function(a){a.regions.dispose(),a.scores.dispose()}),[2,{boxes:p,scores:q}]}})})}(d,s.boxes,p[1],c.rnet,e)];case 2:if(t=w.sent(),e.total_stage2=Date.now()-r,!t.boxes.length)return[2,h({results:[],stats:e})];return e.stage3_numInputBoxes=t.boxes.length,r=Date.now(),[4,function(a,b,c,d,e){return k3(this,void 0,void 0,function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t;return k4(this,function(u){switch(u.label){case 0:return f=Date.now(),[4,m1(a,b,{width:48,height:48})];case 1:return g=u.sent(),e.stage3_extractImagePatches=Date.now()-f,f=Date.now(),h=g.map(function(a){var b=b3(function(){var b=m0(a,d),c=mb(ds(b=m_(b=l$(b=iF(b,[2,2],[2,2],"same"),d.conv4,"valid"),d.prelu4_alpha),[b.shape[0],d.fc1.weights.shape[0]]),d.fc1),e=m_(c,d.prelu5_alpha),f=mb(e,d.fc2_1),g=de(iV(f,1),1),h=d_(hY(f,g),1),i=mb(e,d.fc2_2),j=mb(e,d.fc2_3);return{scores:dy(h,1)[1],regions:i,points:j}});return a.dispose(),b}),e.stage3_onet=Date.now()-f,i=h.length>1?cQ(h.map(function(a){return a.scores})):h[0].scores,l=(k=Array).from,[4,i.data()];case 2:return j=l.apply(k,[u.sent()]),i.dispose(),n=(m=j.map(function(a,b){return{score:a,idx:b}}).filter(function(a){return a.score>c}).map(function(a){return a.idx})).map(function(a){var b=h[a].regions.arraySync();return new mZ(b[0][0],b[0][1],b[0][2],b[0][3])}),o=m.map(function(a,c){return b[a].calibrate(n[c])}),p=m.map(function(a){return j[a]}),q=[],r=[],s=[],o.length>0&&(f=Date.now(),t=lq(o,p,.7,!1),e.stage3_nms=Date.now()-f,q=t.map(function(a){return o[a]}),r=t.map(function(a){return p[a]}),s=t.map(function(a,b){return[,,,,,].fill(0).map(function(c,d){var e=h[a].points.arraySync();return new k6(e[0][d]*(q[b].width+1)+q[b].left,e[0][d+5]*(q[b].height+1)+q[b].top)})})),h.forEach(function(a){a.regions.dispose(),a.scores.dispose(),a.points.dispose()}),[2,{boxes:q,scores:r,points:s}]}})})}(d,t.boxes,p[2],c.onet,e)];case 3:return u=w.sent(),e.total_stage3=Date.now()-r,v=u.boxes.map(function(a,b){return mk(lC({},new lp(u.scores[b],new lt(a.left/k,a.top/j,a.width/k,a.height/j),{height:j,width:k})),new lv(u.points[b].map(function(b){return b.sub(new k6(a.left,a.top)).div(new k6(a.width,a.height))}),{width:a.width,height:a.height}))}),[2,h({results:v,stats:e})]}})})},b.prototype.forward=function(a,b){return void 0===b&&(b={}),k3(this,void 0,void 0,function(){var c;return k4(this,function(d){switch(d.label){case 0:return c=this.forwardInput,[4,lS(a)];case 1:return[4,c.apply(this,[d.sent(),b])];case 2:return[2,d.sent().results]}})})},b.prototype.forwardWithStats=function(a,b){return void 0===b&&(b={}),k3(this,void 0,void 0,function(){var c;return k4(this,function(d){switch(d.label){case 0:return c=this.forwardInput,[4,lS(a)];case 1:return[2,c.apply(this,[d.sent(),b])]}})})},b.prototype.getDefaultModelName=function(){return"mtcnn_model"},b.prototype.extractParamsFromWeigthMap=function(a){var b,c,d,e,f,g,h,i;return d=(c=function(a,b){var c=l5(a,b);function d(a){return{filters:c(a+"/weights",4,a+"/filters"),bias:c(a+"/bias",1)}}function e(a){return{weights:c(a+"/weights",2),bias:c(a+"/bias",1)}}function f(a){return{conv1:d(a+"/conv1"),prelu1_alpha:c(a+"/prelu1_alpha",1),conv2:d(a+"/conv2"),prelu2_alpha:c(a+"/prelu2_alpha",1),conv3:d(a+"/conv3"),prelu3_alpha:c(a+"/prelu3_alpha",1)}}return{extractPNetParams:function(){var a=f("pnet"),b=d("pnet/conv4_1"),c=d("pnet/conv4_2");return k2(k2({},a),{conv4_1:b,conv4_2:c})},extractRNetParams:function(){var a=f("rnet"),b=e("rnet/fc1"),d=c("rnet/prelu4_alpha",1),g=e("rnet/fc2_1"),h=e("rnet/fc2_2");return k2(k2({},a),{fc1:b,prelu4_alpha:d,fc2_1:g,fc2_2:h})},extractONetParams:function(){var a=f("onet"),b=d("onet/conv4"),g=c("onet/prelu4_alpha",1),h=e("onet/fc1"),i=c("onet/prelu5_alpha",1),j=e("onet/fc2_1"),k=e("onet/fc2_2"),l=e("onet/fc2_3");return k2(k2({},a),{conv4:b,prelu4_alpha:g,fc1:h,prelu5_alpha:i,fc2_1:j,fc2_2:k,fc2_3:l})}}}(a,b=[])).extractPNetParams,e=c.extractRNetParams,f=c.extractONetParams,g=d(),h=e(),i=f(),l_(a,b),{params:{pnet:g,rnet:h,onet:i},paramMappings:b}},b.prototype.extractParams=function(a){return function(a){var b=l6(a),c=b.extractWeights,d=b.getRemainingWeights,e=[],f=function(a,b){var c=l0(a,b),d=l1(a,b);function e(c,d){var e=cC(a(c));return b.push({paramPath:d}),e}function f(a,b,d){return void 0===d&&(d=!1),{conv1:c(a[0],a[1],3,b+"/conv1"),prelu1_alpha:e(a[1],b+"/prelu1_alpha"),conv2:c(a[1],a[2],3,b+"/conv2"),prelu2_alpha:e(a[2],b+"/prelu2_alpha"),conv3:c(a[2],a[3],d?2:3,b+"/conv3"),prelu3_alpha:e(a[3],b+"/prelu3_alpha")}}return{extractPNetParams:function(){var a=f([3,10,16,32],"pnet"),b=c(32,2,1,"pnet/conv4_1"),d=c(32,4,1,"pnet/conv4_2");return k2(k2({},a),{conv4_1:b,conv4_2:d})},extractRNetParams:function(){var a=f([3,28,48,64],"rnet",!0),b=d(576,128,"rnet/fc1"),c=e(128,"rnet/prelu4_alpha"),g=d(128,2,"rnet/fc2_1"),h=d(128,4,"rnet/fc2_2");return k2(k2({},a),{fc1:b,prelu4_alpha:c,fc2_1:g,fc2_2:h})},extractONetParams:function(){var a=f([3,32,64,64],"onet"),b=c(64,128,2,"onet/conv4"),g=e(128,"onet/prelu4_alpha"),h=d(1152,256,"onet/fc1"),i=e(256,"onet/prelu5_alpha"),j=d(256,2,"onet/fc2_1"),k=d(256,4,"onet/fc2_2"),l=d(256,10,"onet/fc2_3");return k2(k2({},a),{conv4:b,prelu4_alpha:g,fc1:h,prelu5_alpha:i,fc2_1:j,fc2_2:k,fc2_3:l})}}}(c,e),g=f.extractPNetParams,h=f.extractRNetParams,i=f.extractONetParams,j=g(),k=h(),l=i();if(0!==d().length)throw Error("weights remaing after extract: "+d().length);return{params:{pnet:j,rnet:k,onet:l},paramMappings:e}}(a)},b}(lW),m3=[new k6(1.603231,2.094468),new k6(6.041143,7.080126),new k6(2.882459,3.518061),new k6(4.266906,5.178857),new k6(9.041765,10.66308)],m4=[117.001,114.697,97.404],m5=function(a){function b(){return a.call(this,{withSeparableConvs:!0,iouThreshold:.4,classes:["face"],anchors:m3,meanRgb:m4,isFirstLayerConv2d:!0,filterSizes:[3,16,32,64,128,256,512]})||this}return k1(b,a),Object.defineProperty(b.prototype,"anchors",{get:function(){return this.config.anchors},enumerable:!0,configurable:!0}),b.prototype.locateFaces=function(a,b){return k3(this,void 0,void 0,function(){return k4(this,function(c){switch(c.label){case 0:return[4,this.detect(a,b)];case 1:return[2,c.sent().map(function(a){return new lp(a.score,a.relativeBox,{width:a.imageWidth,height:a.imageHeight})})]}})})},b.prototype.getDefaultModelName=function(){return"tiny_face_detector_model"},b.prototype.extractParamsFromWeigthMap=function(b){return a.prototype.extractParamsFromWeigthMap.call(this,b)},b}(mS),m6={ssdMobilenetv1:new mJ,tinyFaceDetector:new m5,tinyYolov2:new mT,mtcnn:new m2,faceLandmark68Net:new mt,faceLandmark68TinyNet:new mv,faceRecognitionNet:new mB,faceExpressionNet:new mg,ageGenderNet:new mr},m7=function(a){function b(b,c,d){var e=a.call(this)||this;return e.parentTask=b,e.input=c,e.extractedFaces=d,e}return k1(b,a),b}(mV),m8=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b,c=this;return k4(this,function(d){switch(d.label){case 0:return[4,this.parentTask];case 1:return[4,mW(a=d.sent(),this.input,function(a){return k3(c,void 0,void 0,function(){return k4(this,function(b){switch(b.label){case 0:return[4,Promise.all(a.map(function(a){return m6.faceExpressionNet.predictExpressions(a)}))];case 1:return[2,b.sent()]}})})},this.extractedFaces)];case 2:return b=d.sent(),[2,a.map(function(a,c){return mh(a,b[c])})]}})})},b.prototype.withAgeAndGender=function(){return new nd(this,this.input)},b}(m7),m9=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b;return k4(this,function(c){switch(c.label){case 0:return[4,this.parentTask];case 1:if(!(a=c.sent()))return[2];return[4,mX(a,this.input,function(a){return m6.faceExpressionNet.predictExpressions(a)},this.extractedFaces)];case 2:return b=c.sent(),[2,mh(a,b)]}})})},b.prototype.withAgeAndGender=function(){return new ne(this,this.input)},b}(m7),na=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.withAgeAndGender=function(){return new nf(this,this.input)},b.prototype.withFaceDescriptors=function(){return new ni(this,this.input)},b}(m8),nb=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.withAgeAndGender=function(){return new ng(this,this.input)},b.prototype.withFaceDescriptor=function(){return new nj(this,this.input)},b}(m9),nc=function(a){function b(b,c,d){var e=a.call(this)||this;return e.parentTask=b,e.input=c,e.extractedFaces=d,e}return k1(b,a),b}(mV),nd=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b,c=this;return k4(this,function(d){switch(d.label){case 0:return[4,this.parentTask];case 1:return[4,mW(a=d.sent(),this.input,function(a){return k3(c,void 0,void 0,function(){return k4(this,function(b){switch(b.label){case 0:return[4,Promise.all(a.map(function(a){return m6.ageGenderNet.predictAgeAndGender(a)}))];case 1:return[2,b.sent()]}})})},this.extractedFaces)];case 2:return b=d.sent(),[2,a.map(function(a,c){var d=b[c],e=d.age;return mD(mE(a,d.gender,d.genderProbability),e)})]}})})},b.prototype.withFaceExpressions=function(){return new m8(this,this.input)},b}(nc),ne=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b,c,d,e;return k4(this,function(f){switch(f.label){case 0:return[4,this.parentTask];case 1:if(!(a=f.sent()))return[2];return[4,mX(a,this.input,function(a){return m6.ageGenderNet.predictAgeAndGender(a)},this.extractedFaces)];case 2:return c=(b=f.sent()).age,d=b.gender,e=b.genderProbability,[2,mD(mE(a,d,e),c)]}})})},b.prototype.withFaceExpressions=function(){return new m9(this,this.input)},b}(nc),nf=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.withFaceExpressions=function(){return new na(this,this.input)},b.prototype.withFaceDescriptors=function(){return new ni(this,this.input)},b}(nd),ng=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.withFaceExpressions=function(){return new nb(this,this.input)},b.prototype.withFaceDescriptor=function(){return new nj(this,this.input)},b}(ne),nh=function(a){function b(b,c){var d=a.call(this)||this;return d.parentTask=b,d.input=c,d}return k1(b,a),b}(mV),ni=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a;return k4(this,function(b){switch(b.label){case 0:return[4,this.parentTask];case 1:return[4,mW(a=b.sent(),this.input,function(a){return Promise.all(a.map(function(a){return m6.faceRecognitionNet.computeFaceDescriptor(a)}))},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return[2,b.sent().map(function(b,c){return mC(a[c],b)})]}})})},b.prototype.withFaceExpressions=function(){return new na(this,this.input)},b.prototype.withAgeAndGender=function(){return new nf(this,this.input)},b}(nh),nj=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b;return k4(this,function(c){switch(c.label){case 0:return[4,this.parentTask];case 1:if(!(a=c.sent()))return[2];return[4,mX(a,this.input,function(a){return m6.faceRecognitionNet.computeFaceDescriptor(a)},null,function(a){return a.landmarks.align(null,{useDlibAlignment:!0})})];case 2:return b=c.sent(),[2,mC(a,b)]}})})},b.prototype.withFaceExpressions=function(){return new nb(this,this.input)},b.prototype.withAgeAndGender=function(){return new ng(this,this.input)},b}(nh),nk=function(a){function b(b,c,d){var e=a.call(this)||this;return e.parentTask=b,e.input=c,e.useTinyLandmarkNet=d,e}return k1(b,a),Object.defineProperty(b.prototype,"landmarkNet",{get:function(){return this.useTinyLandmarkNet?m6.faceLandmark68TinyNet:m6.faceLandmark68Net},enumerable:!0,configurable:!0}),b}(mV),nl=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b,c,d,e,f=this;return k4(this,function(g){switch(g.label){case 0:return[4,this.parentTask];case 1:if(b=(a=g.sent()).map(function(a){return a.detection}),!(this.input instanceof aF))return[3,3];return[4,lU(this.input,b)];case 2:return d=g.sent(),[3,5];case 3:return[4,lT(this.input,b)];case 4:d=g.sent(),g.label=5;case 5:return[4,Promise.all((c=d).map(function(a){return f.landmarkNet.detectLandmarks(a)}))];case 6:return e=g.sent(),c.forEach(function(a){return a instanceof aF&&a.dispose()}),[2,a.map(function(a,b){return mk(a,e[b])})]}})})},b.prototype.withFaceExpressions=function(){return new na(this,this.input)},b.prototype.withAgeAndGender=function(){return new nf(this,this.input)},b.prototype.withFaceDescriptors=function(){return new ni(this,this.input)},b}(nk),nm=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b,c,d,e;return k4(this,function(f){switch(f.label){case 0:return[4,this.parentTask];case 1:if(!(a=f.sent()))return[2];if(b=a.detection,!(this.input instanceof aF))return[3,3];return[4,lU(this.input,[b])];case 2:return d=f.sent(),[3,5];case 3:return[4,lT(this.input,[b])];case 4:d=f.sent(),f.label=5;case 5:return c=d,[4,this.landmarkNet.detectLandmarks(c[0])];case 6:return e=f.sent(),c.forEach(function(a){return a instanceof aF&&a.dispose()}),[2,mk(a,e)]}})})},b.prototype.withFaceExpressions=function(){return new nb(this,this.input)},b.prototype.withAgeAndGender=function(){return new ng(this,this.input)},b.prototype.withFaceDescriptor=function(){return new nj(this,this.input)},b}(nk),nn=function(a){function b(b,c){void 0===c&&(c=new mI);var d=a.call(this)||this;return d.input=b,d.options=c,d}return k1(b,a),b}(mV),no=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b,c,d;return k4(this,function(e){switch(e.label){case 0:if(a=this,b=a.input,!((c=a.options)instanceof mF))return[3,2];return[4,m6.mtcnn.forward(b,c)];case 1:return[2,e.sent().map(function(a){return a.detection})];case 2:if(!(d=c instanceof mU?function(a){return m6.tinyFaceDetector.locateFaces(a,c)}:c instanceof mI?function(a){return m6.ssdMobilenetv1.locateFaces(a,c)}:c instanceof mR?function(a){return m6.tinyYolov2.locateFaces(a,c)}:null))throw Error("detectFaces - expected options to be instance of TinyFaceDetectorOptions | SsdMobilenetv1Options | MtcnnOptions | TinyYolov2Options");return[2,d(b)]}})})},b.prototype.runAndExtendWithFaceDetections=function(){var a=this;return new Promise(function(b){return k3(a,void 0,void 0,function(){return k4(this,function(a){switch(a.label){case 0:return[4,this.run()];case 1:return[2,b(a.sent().map(function(a){return lC({},a)}))]}})})})},b.prototype.withFaceLandmarks=function(a){return void 0===a&&(a=!1),new nl(this.runAndExtendWithFaceDetections(),this.input,a)},b.prototype.withFaceExpressions=function(){return new m8(this.runAndExtendWithFaceDetections(),this.input)},b.prototype.withAgeAndGender=function(){return new nd(this.runAndExtendWithFaceDetections(),this.input)},b}(nn),np=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return k1(b,a),b.prototype.run=function(){return k3(this,void 0,void 0,function(){var a,b;return k4(this,function(c){switch(c.label){case 0:return[4,new no(this.input,this.options)];case 1:return b=(a=c.sent())[0],a.forEach(function(a){a.score>b.score&&(b=a)}),[2,b]}})})},b.prototype.runAndExtendWithFaceDetection=function(){var a=this;return new Promise(function(b){return k3(a,void 0,void 0,function(){var a;return k4(this,function(c){switch(c.label){case 0:return[4,this.run()];case 1:return[2,b((a=c.sent())?lC({},a):void 0)]}})})})},b.prototype.withFaceLandmarks=function(a){return void 0===a&&(a=!1),new nm(this.runAndExtendWithFaceDetection(),this.input,a)},b.prototype.withFaceExpressions=function(){return new m9(this.runAndExtendWithFaceDetection(),this.input)},b.prototype.withAgeAndGender=function(){return new ne(this.runAndExtendWithFaceDetection(),this.input)},b}(nn);function nq(a,b){void 0===b&&(b=.6),this._distanceThreshold=b;var c=Array.isArray(a)?a:[a];if(!c.length)throw Error("FaceRecognizer.constructor - expected atleast one input");var d=1,e=function(){return"person "+d++};this._labeledDescriptors=c.map(function(a){if(a instanceof lz)return a;if(a instanceof Float32Array)return new lz(e(),[a]);if(a.descriptor&&a.descriptor instanceof Float32Array)return new lz(e(),[a.descriptor]);throw Error("FaceRecognizer.constructor - expected inputs to be of type LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array | Array<LabeledFaceDescriptors | WithFaceDescriptor<any> | Float32Array>")})}Object.defineProperty(nq.prototype,"labeledDescriptors",{get:function(){return this._labeledDescriptors},enumerable:!0,configurable:!0}),Object.defineProperty(nq.prototype,"distanceThreshold",{get:function(){return this._distanceThreshold},enumerable:!0,configurable:!0}),nq.prototype.computeMeanDistance=function(a,b){return b.map(function(b){if(b.length!==a.length)throw Error("euclideanDistance: arr1.length !== arr2.length");var c=Array.from(b),d=Array.from(a);return Math.sqrt(c.map(function(a,b){return a-d[b]}).reduce(function(a,b){return a+Math.pow(b,2)},0))}).reduce(function(a,b){return a+b},0)/(b.length||1)},nq.prototype.matchDescriptor=function(a){var b=this;return this.labeledDescriptors.map(function(c){var d=c.descriptors;return new lx(c.label,b.computeMeanDistance(a,d))}).reduce(function(a,b){return a.distance<b.distance?a:b})},nq.prototype.findBestMatch=function(a){var b=this.matchDescriptor(a);return b.distance<this.distanceThreshold?b:new lx("unknown",b.distance)},nq.prototype.toJSON=function(){return{distanceThreshold:this.distanceThreshold,labeledDescriptors:this.labeledDescriptors.map(function(a){return a.toJSON()})}},nq.fromJSON=function(a){return new nq(a.labeledDescriptors.map(function(a){return lz.fromJSON(a)}),a.distanceThreshold)};var nr=a.i(46271),ns=a.i(86723),nt=a.i(74290),nu=a.i(1703),nv=a.i(14800),nw=a.i(91128),nx=l,ny=a.i(65802);function nz(a,b){if("function"==typeof a)return a(b);null!=a&&(a.current=b)}class nA extends nx.Component{getSnapshotBeforeUpdate(a){let b=this.props.childRef.current;if(b&&a.isPresent&&!this.props.isPresent){let a=b.offsetParent,c=(0,nw.isHTMLElement)(a)&&a.offsetWidth||0,d=this.props.sizeRef.current;d.height=b.offsetHeight||0,d.width=b.offsetWidth||0,d.top=b.offsetTop,d.left=b.offsetLeft,d.right=c-d.width-d.left}return null}componentDidUpdate(){}render(){return this.props.children}}function nB({children:a,isPresent:b,anchorX:c,root:d}){let e=(0,nx.useId)(),f=(0,nx.useRef)(null),g=(0,nx.useRef)({width:0,height:0,top:0,left:0,right:0}),{nonce:h}=(0,nx.useContext)(ny.MotionConfigContext),i=function(...a){return l.useCallback(function(...a){return b=>{let c=!1,d=a.map(a=>{let d=nz(a,b);return c||"function"!=typeof d||(c=!0),d});if(c)return()=>{for(let b=0;b<d.length;b++){let c=d[b];"function"==typeof c?c():nz(a[b],null)}}}}(...a),a)}(f,a?.ref);return(0,nx.useInsertionEffect)(()=>{let{width:a,height:i,top:j,left:k,right:l}=g.current;if(b||!f.current||!a||!i)return;let m="left"===c?`left: ${k}`:`right: ${l}`;f.current.dataset.motionPopId=e;let n=document.createElement("style");h&&(n.nonce=h);let o=d??document.head;return o.appendChild(n),n.sheet&&n.sheet.insertRule(`
          [data-motion-pop-id="${e}"] {
            position: absolute !important;
            width: ${a}px !important;
            height: ${i}px !important;
            ${m}px !important;
            top: ${j}px !important;
          }
        `),()=>{o.contains(n)&&o.removeChild(n)}},[b]),(0,k.jsx)(nA,{isPresent:b,childRef:f,sizeRef:g,children:nx.cloneElement(a,{ref:i})})}let nC=({children:a,initial:b,isPresent:c,onExitComplete:d,custom:e,presenceAffectsLayout:f,mode:g,anchorX:h,root:i})=>{let j=(0,nt.useConstant)(nD),m=(0,l.useId)(),n=!0,o=(0,l.useMemo)(()=>(n=!1,{id:m,initial:b,isPresent:c,custom:e,onExitComplete:a=>{for(let b of(j.set(a,!0),j.values()))if(!b)return;d&&d()},register:a=>(j.set(a,!1),()=>j.delete(a))}),[c,j,d]);return f&&n&&(o={...o}),(0,l.useMemo)(()=>{j.forEach((a,b)=>j.set(b,!1))},[c]),l.useEffect(()=>{c||j.size||!d||d()},[c]),"popLayout"===g&&(a=(0,k.jsx)(nB,{isPresent:c,anchorX:h,root:i,children:a})),(0,k.jsx)(nv.PresenceContext.Provider,{value:o,children:a})};function nD(){return new Map}var nE=a.i(20410);let nF=a=>a.key||"";function nG(a){let b=[];return l.Children.forEach(a,a=>{(0,l.isValidElement)(a)&&b.push(a)}),b}let nH=({children:a,custom:b,initial:c=!0,onExitComplete:d,presenceAffectsLayout:e=!0,mode:f="sync",propagate:g=!1,anchorX:h="left",root:i})=>{let[j,m]=(0,nE.usePresence)(g),n=(0,l.useMemo)(()=>nG(a),[a]),o=g&&!j?[]:n.map(nF),p=(0,l.useRef)(!0),q=(0,l.useRef)(n),r=(0,nt.useConstant)(()=>new Map),[s,t]=(0,l.useState)(n),[u,v]=(0,l.useState)(n);(0,nu.useIsomorphicLayoutEffect)(()=>{p.current=!1,q.current=n;for(let a=0;a<u.length;a++){let b=nF(u[a]);o.includes(b)?r.delete(b):!0!==r.get(b)&&r.set(b,!1)}},[u,o.length,o.join("-")]);let w=[];if(n!==s){let a=[...n];for(let b=0;b<u.length;b++){let c=u[b],d=nF(c);o.includes(d)||(a.splice(b,0,c),w.push(c))}return"wait"===f&&w.length&&(a=w),v(nG(a)),t(n),null}let{forceRender:x}=(0,l.useContext)(ns.LayoutGroupContext);return(0,k.jsx)(k.Fragment,{children:u.map(a=>{let l=nF(a),s=(!g||!!j)&&(n===u||o.includes(l));return(0,k.jsx)(nC,{isPresent:s,initial:(!p.current||!!c)&&void 0,custom:b,presenceAffectsLayout:e,mode:f,root:i,onExitComplete:s?void 0:()=>{if(!r.has(l))return;r.set(l,!0);let a=!0;r.forEach(b=>{b||(a=!1)}),a&&(x?.(),v(q.current),g&&m?.(),d&&d())},anchorX:h,children:a},l)})})};n.Chart.register(n.CategoryScale,n.LinearScale,n.PointElement,n.LineElement,n.BarElement,n.Title,n.Tooltip,n.Legend);let nI=3;function nJ({driverId:a}){let b=(0,l.useRef)(null),[c,d]=(0,l.useState)([]),[e,f]=(0,l.useState)(!1),[g,h]=(0,l.useState)(!1),i=(0,l.useRef)(null),j=(0,l.useRef)(0),n=(0,l.useRef)(!1),q=(0,l.useRef)(0),r=(0,l.useRef)(!1),s=(0,l.useRef)(0),t=(0,l.useRef)(0),u=(0,l.useRef)(0),v=(0,l.useRef)(0),{volume:w,bandEnergyLow:x,isSilent:y,isRunning:z,permissionGranted:A,start:B,stop:C}=p({autoStart:!0}),D=function(a){let[b,c]=(0,l.useState)(null);return(0,l.useEffect)(()=>{let b;async function d(){let e=a.current;if(!e){b=requestAnimationFrame(d);return}try{var f;let a=await (f=new mI({minConfidence:.5}),void 0===f&&(f=new mI),new np(e,f)).withFaceLandmarks().withFaceExpressions();a?.landmarks&&a.expressions&&c({landmarks:a.landmarks.positions,expressions:a.expressions})}catch(a){console.error("Face detection error:",a)}finally{b=requestAnimationFrame(d)}}return(async function(){await m6.ssdMobilenetv1.loadFromUri("/models"),await m6.faceLandmark68Net.loadFromUri("/models"),await m6.faceExpressionNet.loadFromUri("/models")})().then(d),()=>cancelAnimationFrame(b)},[]),b}(b),{status:E,drowsyScore:F,calibrationProgress:G,blinkCount:H,blinkDetected:I,dominantEmotion:J,continuousClose:K,perclos:L,soundWarning:M,startCalibration:N,stopCalibration:O,ear:P,mar:Q}=function(a,b=60,c){let d=c?.driverId??process.env.NEXT_PUBLIC_DRIVER_ID,[e,f]=(0,l.useState)("AWAKE"),[g,h]=(0,l.useState)(0),[i,j]=(0,l.useState)([]),[k,m]=(0,l.useState)([]),[n,o]=(0,l.useState)(0),[q,r]=(0,l.useState)(0),[s,t]=(0,l.useState)(!1),[u,v]=(0,l.useState)("neutral"),[w,x]=(0,l.useState)(!1),[y,z]=(0,l.useState)(!1),[A,B]=(0,l.useState)(0),[C,D]=(0,l.useState)(0),[E,F]=(0,l.useState)(0),{volume:G,bandEnergyLow:H,isSilent:I,isRunning:J,recentEnvelope:K,start:L,permissionGranted:M}=p({autoStart:c?.soundAutoStart??!0}),N=(0,l.useRef)(!1),O=(0,l.useRef)({closed:!1,lastChangeTs:Date.now()}),P=(0,l.useRef)([]),Q=(0,l.useRef)(0),R=(0,l.useRef)(null),S=(0,l.useRef)(null),T=(0,l.useRef)(0),U=(0,l.useRef)(null),V=(0,l.useRef)(!1),W=(0,l.useRef)(null),X=(0,l.useRef)([]),Y=(0,l.useRef)(null),Z=(0,l.useRef)(.26),$=(0,l.useRef)(.3),_=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y),aa=a=>{if(!a.length)return 0;let b=a.reduce((a,b)=>a+b,0)/a.length;return Math.sqrt(a.reduce((a,c)=>a+(c-b)*(c-b),0)/a.length)},ab=()=>{if(V.current=!1,W.current=null,X.current.length){let a=X.current.reduce((a,b)=>a+b,0)/X.current.length;Y.current=a,Z.current=Math.max(.12,.6*a),$.current=Math.max(Z.current+.04,.75*a),o(1)}else o(1)},ac=(0,l.useRef)(0),ad=(0,l.useRef)({}),ae=(0,l.useRef)(null),af=(0,l.useRef)(null),ag=(0,l.useRef)(null),ah=a=>({driverId:d??"",drowsiness:Number(g??0),emotion:u??"neutral",eyeAspectRatio:Number(C??0),mouthAspectRatio:Number(U.current??0),headPose:null,blinkDetected:s??!1,microExpression:null,speechVolume:Number(G??0),ts:new Date().toISOString(),...a}),ai=async(a,b=3)=>{if(!d||!navigator.onLine)return!1;ag.current?.abort();let c=new AbortController;ag.current=c;let e=JSON.stringify(a),f=300;for(let a=0;a<b;a++){try{let a=await fetch("/api/logs/driver",{method:"POST",headers:{"Content-Type":"application/json"},body:e,signal:c.signal});if(a.ok)return!0;await a.text().catch(()=>"")}catch(a){if(a?.name==="AbortError")break}await new Promise(a=>setTimeout(a,f)),f*=2}return!1},aj=(a=!1,b)=>{d&&(ae.current=ah(b),af.current&&(window.clearTimeout(af.current),af.current=null),a?(async()=>{let a=ae.current;!a||await ai(a)&&(ae.current=null)})():af.current=window.setTimeout(async()=>{let a=ae.current;!a||await ai(a)&&(ae.current=null)},5e3))};return(0,l.useEffect)(()=>()=>{af.current&&window.clearTimeout(af.current),ae.current&&ai(ah(),1).catch(()=>{}),ag.current?.abort()},[]),(0,l.useEffect)(()=>{if(!a)return;let c=Date.now();if(c-(ac.current||0)<180)return;ac.current=c;let{landmarks:d,expressions:i}=a,k=d.slice(36,42),l=d.slice(42,48),n=a=>(_(a[1],a[5])+_(a[2],a[4]))/(2*_(a[0],a[3])),p=(n(k)+n(l))/2;if(D(a=>Math.abs(a-p)>5e-4?p:a),V.current&&null!=W.current){X.current.push(p);let a=c-W.current,b=Math.min(1,a/1e4);o(a=>Math.abs(a-b)>.01?b:a),a>=1e4&&ab()}let q=Z.current,s=$.current,u=N.current?p<s:p<q;if(u!==O.current.closed){let a=O.current,b=c-a.lastChangeTs;a.closed?b>=250&&b<500&&(Q.current+=1,r(a=>a+1),t(!0),setTimeout(()=>t(!1),300)):t(!1),O.current={closed:u,lastChangeTs:c}}for(N.current=u,P.current.push({ts:c,closed:+!!u});P.current.length&&P.current[0].ts<c-3e4;)P.current.shift();let w=P.current.reduce((a,b)=>a+b.closed,0)/Math.max(1,P.current.length),y=O.current.lastChangeTs,A=(u?c-y:0)>=500,C=d.slice(60,68),E=Math.min(1,(_(C[2],C[6])+_(C[3],C[5])+_(C[1],C[7]))/(2*_(C[0],C[4]))/.55);F(a=>Math.abs(a-E)>5e-4?E:a),U.current=E;let G=k.reduce((a,b)=>({x:a.x+b.x/k.length,y:a.y+b.y/k.length}),{x:0,y:0}),I=l.reduce((a,b)=>({x:a.x+b.x/l.length,y:a.y+b.y/l.length}),{x:0,y:0}),J={x:(G.x+I.x)/2,y:(G.y+I.y)/2},L=d[30]??d[Math.floor(d.length/2)],M=L.x-J.x,Y=180/Math.PI*Math.atan2(L.y-J.y,Math.max(1e-6,M)),ae=0;if(null!=R.current&&null!=S.current){let a=(c-S.current)/1e3;if(a>0){let b=(Y-(R.current??Y))/a,c=.5*(R.currentVel??0)+.5*b;ae=c,R.currentVel=c}}R.current=Y,S.current=c;let af=Math.abs(Y),ag=Math.abs(ae),ah=0,ai=!1;try{let{envelope:a,times:b}=K(256);if(a&&a.length>=8){let c=a.map((a,b,c)=>{let d=Math.max(0,b-2),e=c.slice(d,b+1);return e.reduce((a,b)=>a+b,0)/e.length}),d=((a,b,c=14,d=150,e=1)=>{let f,g,h=[];if(!a.length)return h;let i=(f=[...a].sort((a,b)=>a-b),g=Math.floor(f.length/2),f.length%2==1?f[g]:(f[g-1]+f[g])/2),j=aa(a);for(let f=1;f<a.length-1;f++){let g=a[f];if(g>a[f-1]&&g>=a[f+1]){let a=b[f]??Date.now();if(h.length&&a-h[h.length-1].t<d)continue;(!(j>0)||g>=i+e*j)&&g>=c&&h.push({idx:f,t:a,v:g})}}return h})(c,b,14,150,1);if(((a,b=3,c=500)=>{if(a.length<b)return{ok:!1,intervals:[]};let d=[];for(let b=1;b<a.length;b++)d.push(a[b].t-a[b-1].t);let e=d.reduce((a,b)=>a+b,0)/d.length;return aa(d)<=c&&e>=200&&e<=2e3?{ok:!0,intervals:d}:{ok:!1,intervals:d}})(d,3,500).ok){let a=Math.min(1,d.length/6);ah+=+a,ai=!0}else(H??0)>.25&&(ah+=.5,ai=!0)}else(H??0)>.25&&(ah+=.4,ai=!0)}catch(a){}let ak=.8*(A?1:.9*!!u)+.5*Math.min(1,w/.12)+.35*E+.4*(Y>7&&ag>5||ag>10&&af>3.5?1:Math.min(1,Math.max(0,Y/30)))+.25*(ah=Math.max(0,Math.min(1,ah)));Number.isFinite(ak)||(ak=0),ak=Math.max(0,Math.min(1,ak));let al=(T.current??g??0)*.4+.6*ak;T.current=al,Math.abs((ad.current.drowsyScore??0)-al)>.005&&(ad.current.drowsyScore=al,h(al));let am=al>.5;j(a=>[...a.slice(-b+1),+!!am]),Math.abs((ad.current.perclos??0)-w)>.002&&(ad.current.perclos=w,B(w)),(ad.current.continuousClose??!1)!==A&&(ad.current.continuousClose=A,z(A));let an="neutral";if(i&&"object"==typeof i)try{an=Object.entries(i).reduce((a,b)=>a[1]>b[1]?a:b,["neutral",0])[0]??"neutral"}catch{an="neutral"}(ad.current.dominantEmotion??"")!==an?(ad.current.dominantEmotion=an,m(a=>[...a.slice(-b+1),an]),v(an)):m(a=>[...a.slice(-b+1),an]);let ao=am?"DROWSY":"AWAKE",ap=ao!==e;f(ao),(ad.current.blinkCount??0)!==Q.current&&(ad.current.blinkCount=Q.current,r(Q.current)),(ad.current.soundWarning??!1)!==ai&&(ad.current.soundWarning=ai,x(ai)),aj(!1),ap&&aj(!0),A&&aj(!0)},[a,H,G,I,J]),{status:e,drowsyScore:g,drowsyHistory:i,emotionHistory:k,calibrationProgress:n,blinkCount:q,blinkDetected:s,dominantEmotion:u,soundWarning:w,continuousClose:y,perclos:A,startCalibration:()=>{X.current=[],W.current=Date.now(),V.current=!0,o(0)},stopCalibration:ab,ear:C,mar:E}}(D,180,{driverId:a??process.env.NEXT_PUBLIC_DRIVER_ID,soundAutoStart:!0}),R=(a,b=nI)=>a.map((c,d)=>{let e=a.slice(Math.max(0,d-(b-1)),d+1);return e.reduce((a,b)=>a+b,0)/Math.max(1,e.length)});(0,l.useEffect)(()=>{},[]),(0,l.useEffect)(()=>{(async()=>{try{await B(),h(!0)}catch{}try{N()}catch{}})()},[]),(0,l.useEffect)(()=>{if(!D)return;let a=Date.now();d(b=>[...b.slice(-179),{id:a,ear:P??0,mar:Q??0,drowsyScore:F,speechVolume:Math.round((w??0)*100),lowBandPct:Math.round((x??0)*100),emotion:J??"neutral",blinkCount:H,isSilent:y,isRunning:z,continuousClose:K,perclos:L??0,timestamp:new Date(a).toLocaleTimeString(),ts:a}])},[D,F,w,x,H,J,y,z,K,L,P,Q]);let S=c.map(a=>a.timestamp),T=R(c.map(a=>a.drowsyScore??0)),U=R(c.map(a=>a.speechVolume??0)),V=R(c.map(a=>a.lowBandPct??0)),W={};c.forEach(a=>{let b=a.emotion||"neutral";W[b]=(W[b]||0)+1});let X=Object.keys(W),Y=Object.values(W),Z={hidden:{opacity:0,y:8},enter:{opacity:1,y:0,transition:{duration:.35}},exit:{opacity:0,y:8,transition:{duration:.25}}},$=async()=>{try{g?(C(),h(!1)):(await B(),h(!0))}catch(a){a?.message}};return(0,l.useEffect)(()=>{let a=i.current;if(!a)return;let b=e?.6:.8,c=s.current;if(s.current=F,c<b&&F>=b){j.current=Date.now();try{a.currentTime=0,a.play().catch(()=>{})}catch{}}},[F,e]),(0,l.useEffect)(()=>{let a=Date.now(),b=n.current,c=!!M;if(n.current=c,!b&&c){if(a-t.current<15e3)return;t.current=a}},[M]),(0,l.useEffect)(()=>{let a=Date.now(),b=q.current??0,c=Q??0;if(q.current=c,b<.7&&c>=.7){if(a-u.current<1e4)return;u.current=a}},[Q]),(0,l.useEffect)(()=>{let a=Date.now(),b=e?.18:.25,c=!!K||(L??0)>b||(P??1)<.18,d=r.current;if(r.current=c,!d&&c){if(a-v.current<8e3)return;v.current=a}},[K,L,P,e]),(0,k.jsxs)("div",{className:"p-6 space-y-6",children:[(0,k.jsxs)(nr.motion.div,{initial:"hidden",animate:"enter",variants:{hidden:{opacity:0,y:-8},enter:{opacity:1,y:0,transition:{duration:.4}}},className:"flex justify-between items-center",children:[(0,k.jsxs)("div",{children:[(0,k.jsx)("h1",{className:"text-2xl font-bold text-gray-900",children:"Live Driver Dashboard"}),(0,k.jsx)("p",{className:"text-sm text-gray-500",children:"Real-time drowsiness & audio monitoring"})]}),(0,k.jsxs)("div",{className:"flex items-center gap-3",children:[(0,k.jsxs)(nr.motion.button,{whileTap:{scale:.96},onClick:$,className:`px-4 py-2 rounded-lg font-medium shadow hover:shadow-md transition flex items-center gap-2 ${g?"bg-red-600 text-white":"bg-green-600 text-white"}`,children:[g?"Stop Mic":"Start Mic",(0,k.jsx)(nr.motion.span,{animate:{opacity:g?1:.3,scale:g?1.05:1},transition:{duration:.3},className:`w-2 h-2 rounded-full ${g?"bg-white":"bg-black/20"}`})]}),(0,k.jsx)(nr.motion.button,{whileHover:{scale:1.03},onClick:()=>{G>0&&G<1?O():N()},className:"px-3 py-2 bg-blue-600 text-white rounded-lg shadow hover:shadow-md transition",children:G>0&&G<1?"Stop Cal":"Calibrate"}),(0,k.jsx)(nr.motion.button,{whileHover:{scale:1.03},onClick:()=>f(a=>!a),className:`px-3 py-2 rounded-lg text-sm shadow hover:shadow-md transition ${e?"bg-indigo-700 text-white":"bg-gray-200 text-black"}`,children:e?"Demo ON":"Demo OFF"})]})]}),(0,k.jsxs)("div",{className:"grid lg:grid-cols-2 gap-6",children:[(0,k.jsxs)(nr.motion.div,{variants:Z,initial:"hidden",animate:"enter",className:"relative w-full h-96 rounded-2xl shadow-xl bg-black/5 overflow-hidden",children:[(0,k.jsx)(m,{videoRef:b,className:"w-full h-full object-cover rounded-2xl"}),(0,k.jsx)(nH,{children:F>=(e?.6:.8)&&(0,k.jsxs)(nr.motion.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},className:"absolute top-5 right-5 bg-red-600 text-white px-4 py-2 rounded-xl shadow-lg flex items-center gap-2 font-semibold text-sm",children:[" DROWSY ",(100*F).toFixed(0),"%"]})}),I&&(0,k.jsxs)(nr.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"absolute bottom-5 left-5 bg-blue-500 text-white px-3 py-1 rounded-xl shadow-md text-sm font-medium",children:[" Blink ",H]}),(0,k.jsxs)(nr.motion.div,{initial:{opacity:0},animate:{opacity:1},className:"absolute bottom-5 right-5 bg-white/90 text-black px-4 py-2 rounded-xl shadow-sm text-xs flex flex-col gap-0.5 font-medium",children:[(0,k.jsxs)("div",{children:[" Mic: ",A?"granted":"denied"]}),(0,k.jsxs)("div",{children:[" Audio: ",z?"running":"stopped"]})]})]}),(0,k.jsx)(nr.motion.div,{variants:Z,initial:"hidden",animate:"enter",className:"bg-white rounded-2xl shadow-md p-6 h-96 overflow-hidden hover:shadow-xl transition-all w-full",children:(0,k.jsx)("div",{className:"h-72",children:(0,k.jsx)(o.Line,{data:{labels:S,datasets:[{label:"EAR",data:R(c.map(a=>a.ear??0)),borderColor:"rgba(59, 130, 246, 1)",backgroundColor:"rgba(59, 130, 246, 0.2)",tension:.3,pointRadius:3,pointBackgroundColor:"rgba(59, 130, 246, 1)"},{label:"MAR",data:R(c.map(a=>a.mar??0)),borderColor:"rgba(239, 68, 68, 1)",backgroundColor:"rgba(239, 68, 68, 0.2)",tension:.3,pointRadius:3,pointBackgroundColor:"rgba(239, 68, 68, 1)"},{label:"Drowsiness",data:T,borderColor:"rgba(245, 158, 24, 1)",backgroundColor:"rgba(245, 158, 24, 0.2)",tension:.3,pointRadius:3,pointBackgroundColor:"rgba(245, 158, 24, 1)"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top",labels:{usePointStyle:!0,pointStyle:"circle",padding:16,color:"#4B5563",font:{size:12}}},tooltip:{mode:"index",intersect:!1,backgroundColor:"#1F2937",titleColor:"#F9FAFB",bodyColor:"#F9FAFB"}},scales:{y:{beginAtZero:!0,suggestedMax:1,ticks:{color:"#4B5563",stepSize:.1},grid:{color:"#E5E7EB"}},x:{ticks:{color:"#4B5563"},grid:{display:!1}}}}})})})]}),(0,k.jsxs)("div",{className:"grid lg:grid-cols-3 gap-6",children:[(0,k.jsxs)(nr.motion.div,{className:"bg-white rounded-2xl shadow-md p-6 hover:shadow-xl transition-all w-full h-64",variants:Z,children:[(0,k.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Audio Levels"}),(0,k.jsx)("div",{className:"h-44",children:(0,k.jsx)(o.Line,{data:{labels:S,datasets:[{label:"Volume",data:U,borderColor:"rgba(251, 190, 24, 1)",backgroundColor:"rgba(251, 190, 24, 0.2)",tension:.3,pointRadius:3,pointBackgroundColor:"rgba(251, 190, 24, 1)"},{label:"Low-band",data:V,borderColor:"rgba(139, 92, 246, 1)",backgroundColor:"rgba(139, 92, 246, 0.2)",tension:.3,pointRadius:3,pointBackgroundColor:"rgba(139, 92, 246, 1)"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top",labels:{usePointStyle:!0,pointStyle:"circle",padding:20,color:"#4B5563",font:{size:12}}},tooltip:{mode:"index",intersect:!1,backgroundColor:"#1F2937",titleColor:"#F9FAFB",bodyColor:"#F9FAFB"}},scales:{y:{beginAtZero:!0,max:100,ticks:{color:"#4B5563",stepSize:20},grid:{color:"#E5E7EB"}},x:{ticks:{color:"#4B5563"},grid:{display:!1}}}}})})]}),(0,k.jsxs)(nr.motion.div,{className:"bg-white rounded-2xl shadow-md p-6 hover:shadow-xl transition-all w-full h-64",variants:Z,children:[(0,k.jsx)("h3",{className:"text-lg font-bold text-gray-800 mb-4",children:"Driver Emotion"}),(0,k.jsx)("div",{className:"h-44",children:(0,k.jsx)(o.Bar,{data:{labels:X,datasets:[{label:"Frequency",data:Y,backgroundColor:X.map(a=>{switch(a.toLowerCase()){case"happy":return"#FBBF24";case"sad":return"#3B82F6";case"angry":return"#EF4444";case"neutral":return"#9CA3AF";case"surprised":return"#10B981";default:return"#6366F1"}}),borderRadius:8,barPercentage:.6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!0,backgroundColor:"#1F2937",titleColor:"#F9FAFB",bodyColor:"#F9FAFB"}},scales:{y:{beginAtZero:!0,ticks:{stepSize:1,color:"#4B5563"},grid:{color:"#E5E7EB"}},x:{ticks:{color:"#4B5563"},grid:{display:!1}}}}})})]}),(0,k.jsxs)(nr.motion.div,{className:"bg-white rounded-xl shadow p-4 h-64 hover:shadow-lg transition",variants:Z,children:[(0,k.jsx)("h2",{className:"text-md font-bold mb-2 text-gray-800",children:"Driver Metrics"}),(0,k.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,k.jsxs)("div",{className:"flex flex-col",children:[(0,k.jsx)("span",{className:"text-gray-500 text-sm",children:"Status"}),(0,k.jsx)("span",{className:`mt-1 font-semibold ${"AWAKE"===E?"text-green-600":"text-red-600"}`,children:E})]}),(0,k.jsxs)("div",{className:"flex flex-col",children:[(0,k.jsx)("span",{className:"text-gray-500 text-sm",children:"Drowsiness"}),(0,k.jsx)("div",{className:"mt-1 w-full bg-gray-200 rounded-full h-3",children:(0,k.jsx)("div",{className:"bg-yellow-400 h-3 rounded-full transition-all",style:{width:`${(100*F).toFixed(1)}%`}})}),(0,k.jsxs)("span",{className:"text-xs text-gray-600 mt-1",children:[(100*F).toFixed(1),"%"]})]}),(0,k.jsxs)("div",{className:"flex flex-col",children:[(0,k.jsx)("span",{className:"text-gray-500 text-sm",children:"Low-band"}),(0,k.jsx)("div",{className:"mt-1 w-full bg-gray-200 rounded-full h-3",children:(0,k.jsx)("div",{className:"bg-blue-400 h-3 rounded-full transition-all",style:{width:`${(100*x).toFixed(2)}%`}})}),(0,k.jsxs)("span",{className:"text-xs text-gray-600 mt-1",children:[(100*x).toFixed(2),"%"]})]}),(0,k.jsxs)("div",{className:"flex flex-col",children:[(0,k.jsx)("span",{className:"text-gray-500 text-sm",children:"Calibration"}),(0,k.jsx)("div",{className:"mt-1 w-full bg-gray-200 rounded-full h-3",children:(0,k.jsx)("div",{className:"bg-purple-400 h-3 rounded-full transition-all",style:{width:`${(100*G).toFixed(2)}%`}})}),(0,k.jsxs)("span",{className:"text-xs text-gray-600 mt-1",children:[(100*G).toFixed(2),"%"]})]}),(0,k.jsxs)("div",{className:"flex flex-col",children:[(0,k.jsx)("span",{className:"text-gray-500 text-sm",children:"PERCLOS"}),(0,k.jsx)("div",{className:"mt-1 w-full bg-gray-200 rounded-full h-3",children:(0,k.jsx)("div",{className:"bg-red-400 h-3 rounded-full transition-all",style:{width:`${Math.round((L??0)*100)}%`}})}),(0,k.jsxs)("span",{className:"text-xs text-gray-600 mt-1",children:[Math.round((L??0)*100),"%"]})]})]})]})]})]})}function nK(){let[a,b]=(0,l.useState)(null),[c,d]=(0,l.useState)(!0);return((0,l.useEffect)(()=>{(async()=>{let a=localStorage.getItem("token");if(!a){window.location.href="/login";return}try{let c=await fetch("/api/auth/me",{headers:{Authorization:`Bearer ${a}`}});if(!c.ok){window.location.href="/login";return}let d=await c.json();b(d.driver.id)}catch(a){console.error("Failed to fetch driver info:",a),window.location.href="/login"}finally{d(!1)}})()},[]),c)?(0,k.jsx)("div",{children:"Loading..."}):a?(0,k.jsx)(nJ,{driverId:a}):(0,k.jsx)("div",{children:"Unauthorized"})}a.s(["default",()=>nK],7910)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__99587779._.js.map